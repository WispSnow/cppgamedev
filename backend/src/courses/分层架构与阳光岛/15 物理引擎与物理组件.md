# ç‰©ç†å¼•æ“ä¸ç‰©ç†ç»„ä»¶

<div class="video-container">
  <div id="bilibili" class="video-content">
    <!-- Bç«™åµŒå…¥ï¼šä½¿ç”¨ https æ˜ç¡®åè®®ï¼ˆé¿å… file:// æˆ– http å¯¼è‡´è¢«æµè§ˆå™¨æ‹¦æˆªï¼‰ -->
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV1ihuFzeExR&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

[åœ¨ Bilibili ä¸Šè§‚çœ‹](https://www.bilibili.com/video/BV1ihuFzeExR)

## ğŸ“Œ é—®é¢˜èƒŒæ™¯

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åŠ è½½åˆ°åœºæ™¯ä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯ **é™æ­¢çš„**ã€‚å®ƒä»¬è¢«æ”¾ç½®åœ¨å“ªé‡Œï¼Œå°±æ°¸è¿œåœåœ¨å“ªé‡Œã€‚ä¸ºäº†è®©æˆ‘ä»¬çš„ä¸–ç•Œ **"æ´»"** èµ·æ¥ï¼Œè®©è§’è‰²èƒ½å¤Ÿè·³è·ƒï¼Œè®©ç‰©ä½“èƒ½å¤Ÿä¸‹è½ï¼Œæˆ‘ä»¬å¿…é¡»å¼•å…¥ **ç‰©ç†çš„æ¦‚å¿µ**ã€‚

### âš™ï¸ é™æ€ä¸–ç•Œ vs åŠ¨æ€ä¸–ç•Œ

| é™æ€ä¸–ç•Œï¼ˆå½“å‰çŠ¶æ€ï¼‰ | åŠ¨æ€ä¸–ç•Œï¼ˆç›®æ ‡ï¼‰ |
|---------------------|-----------------|
| âŒ å¯¹è±¡æ°¸è¿œé™æ­¢ä¸åŠ¨ | âœ… å¯¹è±¡å—é‡åŠ›å½±å“ä¸‹è½ |
| âŒ æ— æ³•æ¨¡æ‹Ÿè·³è·ƒ | âœ… è§’è‰²å¯ä»¥è·³è·ƒã€ç§»åŠ¨ |
| âŒ æ— é€Ÿåº¦å’ŒåŠ é€Ÿåº¦ | âœ… æ”¯æŒé€Ÿåº¦ã€åŠ é€Ÿåº¦è®¡ç®— |
| âŒ æ— ç‰©ç†äº¤äº’ | âœ… ç‰©ä½“é—´å¯ä»¥ç¢°æ’äº¤äº’ |

### ğŸ¯ æœ¬è¯¾ç›®æ ‡

æœ¬èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªç®€å•çš„ **2D ç‰©ç†å¼•æ“**ã€‚å®ƒå°†è´Ÿè´£ï¼š

- ğŸŒ æ¨¡æ‹Ÿé‡åŠ›
- ğŸƒ è®¡ç®—é€Ÿåº¦å’ŒåŠ é€Ÿåº¦
- ğŸ“ æ›´æ–°ç‰©ä½“ä½ç½®

è¿™å°†ä¸ºæˆ‘ä»¬åç»­å®ç°ç¢°æ’æ£€æµ‹å’Œè§’è‰²æ§åˆ¶å™¨æ‰“ä¸‹åšå®çš„åŸºç¡€ã€‚æˆ‘ä»¬å°†éµå¾ªä¸ä¹‹å‰æ¨¡å—åŒ–è®¾è®¡ç›¸åŒçš„æ€è·¯ï¼Œåˆ›å»ºä¸€ä¸ªä¸­å¿ƒåŒ–çš„ `PhysicsEngine` å’Œé™„åŠ åˆ° `GameObject` ä¸Šçš„ `PhysicsComponent`ã€‚

<img src="https://theorhythm.top/gamedev/SL/SL.056.webp" alt="ç‰©ç†å¼•æ“ä¸ç‰©ç†ç»„ä»¶" style="display: block; margin: auto; width: 700px;" />

---

## 1. PhysicsEngineï¼šç‰©ç†ä¸–ç•Œçš„"ä¸Šå¸"

`PhysicsEngine` æ˜¯ä¸€ä¸ªå…¨å±€æ¨¡å—ï¼Œå®ƒä¸å…³å¿ƒæŸä¸ªç‰¹å®š GameObject çš„é€»è¾‘ï¼Œåªè´Ÿè´£æ ¹æ®ç‰©ç†è§„åˆ™æ›´æ–°æ‰€æœ‰å‚ä¸ç‰©ç†æ¨¡æ‹Ÿçš„ç‰©ä½“ã€‚

### æ ¸å¿ƒèŒè´£

| èŒè´£ | è¯´æ˜ |
|------|------|
| **ç»´æŠ¤ç»„ä»¶åˆ—è¡¨** | ç»´æŠ¤ä¸€ä¸ªæ‰€æœ‰ `PhysicsComponent` çš„åˆ—è¡¨ |
| **æ–½åŠ é‡åŠ›** | åœ¨æ¯ä¸€å¸§ï¼Œéå†è¿™ä¸ªåˆ—è¡¨ï¼Œä¸ºå—é‡åŠ›çš„ç‰©ä½“æ–½åŠ é‡åŠ› |
| **æ›´æ–°é€Ÿåº¦** | æ ¹æ®ç‰©ä½“çš„å—åŠ›æƒ…å†µå’Œè´¨é‡ï¼Œæ›´æ–°å…¶é€Ÿåº¦ |
| **æ›´æ–°ä½ç½®** | æ ¹æ®ç‰©ä½“çš„é€Ÿåº¦ï¼Œæ›´æ–°å…¶ä½ç½® |

### ç‰©ç†æ¨¡æ‹Ÿæµç¨‹

```
æ¯å¸§æ›´æ–°å¾ªç¯
    â†“
éå†æ‰€æœ‰ PhysicsComponent
    â†“
å—é‡åŠ›ï¼Ÿâ†’ æ–½åŠ é‡åŠ› F = g Ã— m
    â†“
è®¡ç®—åŠ é€Ÿåº¦ a = F / m
    â†“
æ›´æ–°é€Ÿåº¦ v += a Ã— Î”t
    â†“
æ›´æ–°ä½ç½® p += v Ã— Î”t
    â†“
é™åˆ¶æœ€å¤§é€Ÿåº¦
```

---

### engine/physics/physics_engine.h

```cpp
#pragma once
#include <vector>
#include "glm/vec2.hpp"

namespace engine::component {
    class PhysicsComponent;
}

namespace engine::physics {

/**
 * @brief è´Ÿè´£ç®¡ç†å’Œæ¨¡æ‹Ÿç‰©ç†è¡Œä¸ºåŠç¢°æ’æ£€æµ‹ã€‚
 */
class PhysicsEngine {
private:
    std::vector<engine::component::PhysicsComponent*> components_; ///< @brief æ³¨å†Œçš„ç‰©ç†ç»„ä»¶å®¹å™¨ï¼Œéæ‹¥æœ‰æŒ‡é’ˆ
    glm::vec2 gravity_ = {0.0f, 980.0f};        ///< @brief é»˜è®¤é‡åŠ›å€¼ (åƒç´ /ç§’^2, ç›¸å½“äº100åƒç´ å¯¹åº”ç°å®1m)
    float max_speed_ = 500.0f;                  ///< @brief æœ€å¤§é€Ÿåº¦ (åƒç´ /ç§’)

public:
    PhysicsEngine() = default;

    // ç¦æ­¢æ‹·è´å’Œç§»åŠ¨
    PhysicsEngine(const PhysicsEngine&) = delete;
    PhysicsEngine& operator=(const PhysicsEngine&) = delete;
    PhysicsEngine(PhysicsEngine&&) = delete;
    PhysicsEngine& operator=(PhysicsEngine&&) = delete;

    void registerComponent(engine::component::PhysicsComponent* component);     ///< @brief æ³¨å†Œç‰©ç†ç»„ä»¶
    void unregisterComponent(engine::component::PhysicsComponent* component);   ///< @brief æ³¨é”€ç‰©ç†ç»„ä»¶

    void update(float delta_time);      ///< @brief æ ¸å¿ƒå¾ªç¯ï¼šæ›´æ–°æ‰€æœ‰æ³¨å†Œçš„ç‰©ç†ç»„ä»¶çš„çŠ¶æ€

    // è®¾ç½®å™¨/è·å–å™¨
    void setGravity(const glm::vec2& gravity) { gravity_ = gravity; }   ///< @brief è®¾ç½®å…¨å±€é‡åŠ›åŠ é€Ÿåº¦
    const glm::vec2& getGravity() const { return gravity_; }            ///< @brief è·å–å½“å‰çš„å…¨å±€é‡åŠ›åŠ é€Ÿåº¦
    void setMaxSpeed(float max_speed) { max_speed_ = max_speed; }       ///< @brief è®¾ç½®æœ€å¤§é€Ÿåº¦
    float getMaxSpeed() const { return max_speed_; }                    ///< @brief è·å–å½“å‰çš„æœ€å¤§é€Ÿåº¦
};

} // namespace engine::physics
```

### engine/physics/physics_engine.cpp

```cpp
#include "physics_engine.h"
#include "../component/physics_component.h"
#include "../component/transform_component.h"
#include "../object/game_object.h"
#include <algorithm>
#include <spdlog/spdlog.h>
#include "glm/common.hpp"

namespace engine::physics {

void PhysicsEngine::registerComponent(engine::component::PhysicsComponent* component) {
    components_.push_back(component);
    spdlog::trace("ç‰©ç†ç»„ä»¶æ³¨å†Œå®Œæˆã€‚");
}

void PhysicsEngine::unregisterComponent(engine::component::PhysicsComponent* component) {
    // ä½¿ç”¨ remove-erase æ–¹æ³•å®‰å…¨åœ°ç§»é™¤æŒ‡é’ˆ
    auto it = std::remove(components_.begin(), components_.end(), component);
    components_.erase(it, components_.end());
    spdlog::trace("ç‰©ç†ç»„ä»¶æ³¨é”€å®Œæˆã€‚");
}

void PhysicsEngine::update(float delta_time) {
    // éå†æ‰€æœ‰æ³¨å†Œçš„ç‰©ç†ç»„ä»¶
    for (auto* pc : components_) {
        if (!pc || !pc->isEnabled()) { // æ£€æŸ¥ç»„ä»¶æ˜¯å¦æœ‰æ•ˆå’Œå¯ç”¨
            continue;
        }

        // åº”ç”¨é‡åŠ› (å¦‚æœç»„ä»¶å—é‡åŠ›å½±å“)ï¼šF = g * m
        if (pc->isUseGravity()) {
            pc->addForce(gravity_ * pc->getMass());
        }
        /* è¿˜å¯ä»¥æ·»åŠ å…¶å®ƒåŠ›å½±å“ï¼Œæ¯”å¦‚é£åŠ›ã€æ‘©æ“¦åŠ›ç­‰ï¼Œç›®å‰ä¸è€ƒè™‘ */
        
        // æ›´æ–°é€Ÿåº¦ï¼š v += a * dtï¼Œå…¶ä¸­ a = F / m
        pc->velocity_ += (pc->getForce() / pc->getMass()) * delta_time;
        pc->clearForce(); // æ¸…é™¤å½“å‰å¸§çš„åŠ›

        // æ›´æ–°ä½ç½®ï¼šS += v * dt
        auto* tc = pc->getTransform();
        if (tc) {
            tc->translate(pc->velocity_ * delta_time);
        }

        // é™åˆ¶æœ€å¤§é€Ÿåº¦ï¼šv = min(v, max_speed)
        pc->velocity_ = glm::clamp(pc->velocity_, -max_speed_, max_speed_);
    }
}

} // namespace engine::physics
```

### ğŸ”‘ å…³é”®å®ç°ï¼šæ¬§æ‹‰ç§¯åˆ†

`update` æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç®€å•çš„ **æ¬§æ‹‰ç§¯åˆ†**ï¼ˆEuler Integrationï¼‰æ¥æ¨¡æ‹Ÿç‰©ç†è¿åŠ¨ï¼Œè¿™æ˜¯æ¸¸æˆç‰©ç†ä¸­æœ€åŸºç¡€å’Œå¸¸ç”¨çš„æ–¹æ³•ã€‚

#### ç‰©ç†å…¬å¼

| å…¬å¼ | è¯´æ˜ | ä»£ç å®ç° |
|------|------|----------|
| **F = g Ã— m** | é‡åŠ› = é‡åŠ›åŠ é€Ÿåº¦ Ã— è´¨é‡ | `gravity_ * pc->getMass()` |
| **a = F / m** | åŠ é€Ÿåº¦ = åŠ› / è´¨é‡ | `pc->getForce() / pc->getMass()` |
| **v += a Ã— Î”t** | é€Ÿåº¦ = é€Ÿåº¦ + åŠ é€Ÿåº¦ Ã— æ—¶é—´ | `velocity_ += a * delta_time` |
| **p += v Ã— Î”t** | ä½ç½® = ä½ç½® + é€Ÿåº¦ Ã— æ—¶é—´ | `translate(velocity_ * delta_time)` |

#### å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `gravity_` | `(0, 980)` | é‡åŠ›åŠ é€Ÿåº¦ï¼ˆåƒç´ /ç§’Â²ï¼‰ï¼Œç›¸å½“äº 100 åƒç´ å¯¹åº”ç°å® 1 ç±³ |
| `max_speed_` | `500` | æœ€å¤§é€Ÿåº¦é™åˆ¶ï¼ˆåƒç´ /ç§’ï¼‰ï¼Œé˜²æ­¢é€Ÿåº¦è¿‡å¿«å¯¼è‡´ç©¿é€ |

> ğŸ’¡ **ä¸ºä»€ä¹ˆæ˜¯ 980ï¼Ÿ** ç°å®ä¸–ç•Œçš„é‡åŠ›åŠ é€Ÿåº¦çº¦ä¸º 9.8 m/sÂ²ã€‚å¦‚æœæˆ‘ä»¬è®¾å®š 100 åƒç´  = 1 ç±³ï¼Œé‚£ä¹ˆé‡åŠ›åŠ é€Ÿåº¦å°±æ˜¯ 980 åƒç´ /sÂ²ã€‚

---

## 2. PhysicsComponentï¼šèµ‹äºˆç‰©ä½“ç‰©ç†å±æ€§

å¦‚æœè¯´ `PhysicsEngine` æ˜¯ä¸Šå¸ï¼Œé‚£ä¹ˆ `PhysicsComponent` å°±æ˜¯èµ‹äºˆ GameObject **çµé­‚** çš„ä½¿è€…ã€‚ä»»ä½•æƒ³è¦å‚ä¸ç‰©ç†æ¨¡æ‹Ÿçš„ GameObject éƒ½å¿…é¡»æ‹¥æœ‰è¿™ä¸ªç»„ä»¶ã€‚

### æ ¸å¿ƒèŒè´£

| èŒè´£ | è¯´æ˜ |
|------|------|
| **å­˜å‚¨ç‰©ç†å±æ€§** | å­˜å‚¨ç‰©ä½“çš„è´¨é‡ï¼ˆ`mass_`ï¼‰ã€é€Ÿåº¦ï¼ˆ`velocity_`ï¼‰ã€å½“å‰å—åŠ›ï¼ˆ`force_`ï¼‰ |
| **æ³¨å†Œåˆ°å¼•æ“** | åœ¨è¢«åˆ›å»ºæ—¶ï¼ˆ`init`ï¼‰ï¼Œå°†è‡ªå·±æ³¨å†Œåˆ° `PhysicsEngine` ä¸­ |
| **ä»å¼•æ“æ³¨é”€** | åœ¨è¢«é”€æ¯æ—¶ï¼ˆ`clean`ï¼‰ï¼Œä» `PhysicsEngine` ä¸­æ³¨é”€è‡ªå·± |

### ç”Ÿå‘½å‘¨æœŸ

```
ç»„ä»¶åˆ›å»º
    â†“
init() è°ƒç”¨
    â†“
æ³¨å†Œåˆ° PhysicsEngine
    â†“
æ¯å¸§è¢« PhysicsEngine æ›´æ–°
    â†“
clean() è°ƒç”¨
    â†“
ä» PhysicsEngine æ³¨é”€
```

---

### engine/component/physics_component.h

```cpp
#pragma once
#include "component.h"
#include "glm/vec2.hpp"

namespace engine::physics {
    class PhysicsEngine;
}

namespace engine::component {
class TransformComponent;

/**
 * @brief ç®¡ç†GameObjectçš„ç‰©ç†å±æ€§
 *
 * å­˜å‚¨é€Ÿåº¦ã€è´¨é‡ã€åŠ›å’Œé‡åŠ›è®¾ç½®ã€‚ä¸PhysicsEngineäº¤äº’ã€‚
 */
class PhysicsComponent final: public Component {
    friend class engine::object::GameObject;
public:
    glm::vec2 velocity_ = {0.0f, 0.0f};             ///< @brief ç‰©ä½“çš„é€Ÿåº¦ï¼Œè®¾ä¸ºå…¬å…±æˆå‘˜å˜é‡ï¼Œæ–¹ä¾¿PhysicsEngineè®¿é—®æ›´æ–°

private:
    engine::physics::PhysicsEngine* physics_engine_ = nullptr;  ///< @brief æŒ‡å‘PhysicsEngineçš„æŒ‡é’ˆ
    TransformComponent* transform_ = nullptr;                   ///< @brief TransformComponentçš„ç¼“å­˜æŒ‡é’ˆ

    glm::vec2 force_ = {0.0f, 0.0f};                            ///< @brief å½“å‰å¸§å—åˆ°çš„åŠ›
    float mass_ = 1.0f;                             ///< @brief ç‰©ä½“è´¨é‡ï¼ˆé»˜è®¤1.0ï¼‰
    bool use_gravity_ = true;                       ///< @brief ç‰©ä½“æ˜¯å¦å—é‡åŠ›å½±å“
    bool enabled_ = true;                           ///< @brief ç»„ä»¶æ˜¯å¦æ¿€æ´»

public:
    /**
     * @brief æ„é€ å‡½æ•°  
     * 
     * @param physics_engine æŒ‡å‘PhysicsEngineçš„æŒ‡é’ˆï¼Œä¸èƒ½ä¸ºnullptr
     * @param use_gravity ç‰©ä½“æ˜¯å¦å—é‡åŠ›å½±å“ï¼Œé»˜è®¤true
     * @param mass ç‰©ä½“è´¨é‡ï¼Œé»˜è®¤1.0
     */
    PhysicsComponent(engine::physics::PhysicsEngine* physics_engine, bool use_gravity = true, float mass = 1.0f);
    ~PhysicsComponent() override = default;

    // åˆ é™¤å¤åˆ¶/ç§»åŠ¨æ“ä½œ
    PhysicsComponent(const PhysicsComponent&) = delete;
    PhysicsComponent& operator=(const PhysicsComponent&) = delete;
    PhysicsComponent(PhysicsComponent&&) = delete;
    PhysicsComponent& operator=(PhysicsComponent&&) = delete;

    // PhysicsEngineä½¿ç”¨çš„ç‰©ç†æ–¹æ³•
    void addForce(const glm::vec2& force) { if (enabled_) force_ += force; }    ///< @brief æ·»åŠ åŠ›
    void clearForce() { force_ = {0.0f, 0.0f}; }                                ///< @brief æ¸…é™¤åŠ›
    const glm::vec2& getForce() const { return force_; }                        ///< @brief è·å–å½“å‰åŠ›
    float getMass() const { return mass_; }                                     ///< @brief è·å–è´¨é‡
    bool isEnabled() const { return enabled_; }                                 ///< @brief è·å–ç»„ä»¶æ˜¯å¦å¯ç”¨
    bool isUseGravity() const { return use_gravity_; }                          ///< @brief è·å–ç»„ä»¶æ˜¯å¦å—é‡åŠ›å½±å“

    // è®¾ç½®å™¨/è·å–å™¨
    void setEnabled(bool enabled) { enabled_ = enabled; }                       ///< @brief è®¾ç½®ç»„ä»¶æ˜¯å¦å¯ç”¨
    void setMass(float mass) { mass_ = (mass >= 0.0f) ? mass : 1.0f; }          ///< @brief è®¾ç½®è´¨é‡ï¼Œè´¨é‡ä¸èƒ½ä¸ºè´Ÿ
    void setUseGravity(bool use_gravity) { use_gravity_ = use_gravity; }        ///< @brief è®¾ç½®ç»„ä»¶æ˜¯å¦å—é‡åŠ›å½±å“
    void setVelocity(const glm::vec2& velocity) { velocity_ = velocity; }       ///< @brief è®¾ç½®é€Ÿåº¦
    const glm::vec2& getVelocity() const { return velocity_; }                  ///< @brief è·å–å½“å‰é€Ÿåº¦
    TransformComponent* getTransform() const { return transform_; }             ///< @brief è·å–TransformComponentæŒ‡é’ˆ

private:
    // æ ¸å¿ƒå¾ªç¯æ–¹æ³•
    void init() override;
    void update(float, engine::core::Context&) override {}
    void clean() override;
};

} // namespace engine::component
```

### engine/component/physics_component.cpp

```cpp
#include "physics_component.h"
#include "transform_component.h"
#include "../object/game_object.h"
#include "../physics/physics_engine.h"
#include <spdlog/spdlog.h>

namespace engine::component {

PhysicsComponent::PhysicsComponent(engine::physics::PhysicsEngine* physics_engine, bool use_gravity, float mass)
    : physics_engine_(physics_engine), mass_(mass >= 0.0f ? mass : 1.0f), use_gravity_(use_gravity) {
    if (!physics_engine_) {
        spdlog::error("PhysicsComponentæ„é€ å‡½æ•°ä¸­ï¼ŒPhysicsEngineæŒ‡é’ˆä¸èƒ½ä¸ºnullptrï¼");
    }
    spdlog::trace("ç‰©ç†ç»„ä»¶åˆ›å»ºå®Œæˆï¼Œè´¨é‡: {}, ä½¿ç”¨é‡åŠ›: {}", mass_, use_gravity_);
}

void PhysicsComponent::init() {
    if (!owner_) {
        spdlog::error("ç‰©ç†ç»„ä»¶åˆå§‹åŒ–å‰éœ€è¦ä¸€ä¸ªGameObjectä½œä¸ºæ‰€æœ‰è€…ï¼");
        return;
    }
    if (!physics_engine_) {
        spdlog::error("ç‰©ç†ç»„ä»¶åˆå§‹åŒ–æ—¶ï¼ŒPhysicsEngineæœªæ­£ç¡®åˆå§‹åŒ–ã€‚");
        return;
    }
    transform_ = owner_->getComponent<TransformComponent>();
    if (!transform_) {
        spdlog::warn("ç‰©ç†ç»„ä»¶åˆå§‹åŒ–æ—¶ï¼ŒåŒä¸€GameObjectä¸Šæ²¡æœ‰æ‰¾åˆ°TransformComponentç»„ä»¶ã€‚");
    }
    // æ³¨å†Œåˆ°PhysicsEngine
    physics_engine_->registerComponent(this);
    spdlog::trace("ç‰©ç†ç»„ä»¶åˆå§‹åŒ–å®Œæˆã€‚");
}

void PhysicsComponent::clean() 
{
    physics_engine_->unregisterComponent(this);
    spdlog::trace("ç‰©ç†ç»„ä»¶æ¸…ç†å®Œæˆã€‚");
}

} // namespace engine::component
```

### ğŸ—ï¸ è®¾è®¡æ¨¡å¼ï¼šæ³¨å†Œ-é€šçŸ¥æ¨¡å¼

è¿™ç§ **"ç»„ä»¶å‘ä¸­å¿ƒç³»ç»Ÿæ³¨å†Œ"** çš„è®¾è®¡æ¨¡å¼éå¸¸é‡è¦ï¼Œå®ƒå®ç°äº† **é«˜å†…èšå’Œä½è€¦åˆ**ï¼š

```
PhysicsEngine
    â†•ï¸ é€šè¿‡ PhysicsComponent é€šä¿¡
GameObject

ä¼˜åŠ¿ï¼š
- PhysicsEngine ä¸éœ€è¦çŸ¥é“ GameObject çš„å­˜åœ¨
- GameObject ä¸éœ€è¦çŸ¥é“ PhysicsEngine çš„å­˜åœ¨
- ä¸¤è€…é€šè¿‡ PhysicsComponent è¿™ä¸ªæ¡¥æ¢è¿æ¥
```

| æ¨¡å— | èŒè´£ | ä¾èµ– |
|------|------|------|
| `PhysicsEngine` | å…¨å±€ç‰©ç†æ¨¡æ‹Ÿ | åªçŸ¥é“ `PhysicsComponent` |
| `PhysicsComponent` | æ¡¥æ¥å±‚ | è¿æ¥ Engine å’Œ GameObject |
| `GameObject` | æ¸¸æˆå®ä½“ | åªç®¡ç†ç»„ä»¶ï¼Œä¸çŸ¥é“ Engine |

---

## 3. æ•´åˆåˆ°å¼•æ“æ ¸å¿ƒ

æˆ‘ä»¬éœ€è¦åœ¨ `GameApp` ä¸­åˆ›å»º `PhysicsEngine` å®ä¾‹ï¼Œå¹¶é€šè¿‡ `Context` å°†å…¶æä¾›ç»™æ¸¸æˆçš„å…¶ä»–éƒ¨åˆ†ã€‚

### åˆå§‹åŒ– PhysicsEngine

#### engine/core/game_app.cppï¼ˆæ›´æ–°ï¼‰

```cpp
// ... in GameApp::init() ...
    // ...
    if (!initInputManager()) return false;
    if (!initPhysicsEngine()) return false; // æ–°å¢

    if (!initContext()) return false;
    if (!initSceneManager()) return false;
    // ...

// ... a new method in GameApp ...
bool GameApp::initPhysicsEngine()
{
    try {
        physics_engine_ = std::make_unique<engine::physics::PhysicsEngine>();
    }
    catch (const std::exception& e) {
        spdlog::error("åˆå§‹åŒ–ç‰©ç†å¼•æ“å¤±è´¥: {}", e.what());
        return false;
    }
    return true;
}
```

### æ›´æ–° Context

åŒæ—¶ï¼Œæ›´æ–° `Context` çš„æ„é€ å‡½æ•°ï¼Œè®©å®ƒæŒæœ‰ `PhysicsEngine` çš„å¼•ç”¨ã€‚

```cpp
// engine/core/context.h
class Context final {
public:
    Context(
        // ... å…¶ä»–å‚æ•° ...
        engine::physics::PhysicsEngine& physics_engine
    )
        : /* ... */
        , physics_engine_(physics_engine)
    {}
    
    engine::physics::PhysicsEngine& getPhysicsEngine() const { 
        return physics_engine_; 
    }

private:
    // ...
    engine::physics::PhysicsEngine& physics_engine_;
};
```

### æ›´æ–°åœºæ™¯å¾ªç¯

æœ€åï¼Œä¹Ÿæ˜¯ **æœ€é‡è¦çš„ä¸€æ­¥**ï¼Œæ˜¯åœ¨åœºæ™¯æ›´æ–°å¾ªç¯çš„ **æœ€å¼€å§‹** è°ƒç”¨ç‰©ç†å¼•æ“çš„æ›´æ–°ã€‚

#### engine/scene/scene.cppï¼ˆæ›´æ–°ï¼‰

```cpp
// ...
void Scene::update(float delta_time) {
    if (!is_initialized_) return;
    
    // **é¦–å…ˆæ›´æ–°ç‰©ç†å¼•æ“**
    context_.getPhysicsEngine().update(delta_time);

    // ç„¶åå†æ›´æ–°æ‰€æœ‰æ¸¸æˆå¯¹è±¡
    for (auto it = game_objects_.begin(); it != game_objects_.end();) {
        // ... (åŸæœ‰çš„GameObjectæ›´æ–°å’Œæ¸…ç†é€»è¾‘) ...
    }

    processPendingAdditions();
}
// ...
```

### âš ï¸ æ›´æ–°é¡ºåºçš„é‡è¦æ€§

è¿™ä¸ªé¡ºåº **è‡³å…³é‡è¦**ã€‚æˆ‘ä»¬å¿…é¡»ä¿è¯åœ¨æ‰§è¡Œä»»ä½•æ¸¸æˆé€»è¾‘ï¼ˆå¦‚ AIã€ç©å®¶è¾“å…¥å“åº”ï¼‰ä¹‹å‰ï¼Œæ‰€æœ‰ç‰©ä½“çš„ä½ç½®éƒ½å·²ç»è¢«ç‰©ç†å¼•æ“æ›´æ–°åˆ°äº†å½“å‰å¸§çš„æœ€æ–°çŠ¶æ€ã€‚

```
æ­£ç¡®é¡ºåºï¼š
1ï¸âƒ£ PhysicsEngine.update()    â† æ›´æ–°æ‰€æœ‰ç‰©ä½“çš„ç‰©ç†çŠ¶æ€
2ï¸âƒ£ GameObject.update()       â† æ‰§è¡Œæ¸¸æˆé€»è¾‘
3ï¸âƒ£ GameObject.render()       â† æ¸²æŸ“

é”™è¯¯é¡ºåºä¼šå¯¼è‡´ï¼š
âŒ ç‰©ç†çŠ¶æ€å’Œæ¸²æŸ“ä¸åŒæ­¥
âŒ è¾“å…¥å“åº”å»¶è¿Ÿä¸€å¸§
âŒ ç¢°æ’æ£€æµ‹ä½ç½®é”™è¯¯
```

---

## 4. æµ‹è¯•ç‰©ç†æ•ˆæœ

ç°åœ¨ï¼Œè®©æˆ‘ä»¬ç»™ `GameScene` ä¸­çš„æµ‹è¯•ç®±å­æ·»åŠ  `PhysicsComponent`ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚

### src/game/scene/game_scene.cppï¼ˆæ›´æ–°ï¼‰

```cpp
// ...
#include "../../engine/component/physics_component.h"
#include "../../engine/physics/physics_engine.h"
// ...

// in GameScene::createTestObject()
void GameScene::createTestObject() {
    // ...
    auto test_object = std::make_unique<engine::object::GameObject>("test_object");
    test_object_ = test_object.get(); // ç¼“å­˜æŒ‡é’ˆä»¥ä¾¿æµ‹è¯•

    test_object->addComponent<engine::component::TransformComponent>(glm::vec2(100.0f, 100.0f));
    test_object->addComponent<engine::component::SpriteComponent>("assets/textures/Props/big-crate.png", context_.getResourceManager());
    
    // **æ–°å¢ï¼šæ·»åŠ ç‰©ç†ç»„ä»¶**
    test_object->addComponent<engine::component::PhysicsComponent>(&context_.getPhysicsEngine());

    addGameObject(std::move(test_object));
}

// in GameScene::handleInput()
void GameScene::handleInput() {
    Scene::handleInput();
    TestObject(); // æ›¿æ¢ testCamera()
}

// new test function in GameScene
void GameScene::TestObject()
{
    if (!test_object_) return;
    auto& input_manager = context_.getInputManager();
    auto* physics_comp = test_object_->getComponent<engine::component::PhysicsComponent>();
    if (!physics_comp) return;
    
    // å·¦å³ç§»åŠ¨æš‚æ—¶è¿˜æ˜¯ç›´æ¥æ”¹å˜ä½ç½®
    if (input_manager.isActionDown("move_left")) {
        test_object_->getComponent<engine::component::TransformComponent>()->translate(glm::vec2(-2, 0));
    }
    if (input_manager.isActionDown("move_right")) {
        test_object_->getComponent<engine::component::TransformComponent>()->translate(glm::vec2(2, 0));
    }

    // æŒ‰ä¸‹è·³è·ƒé”®æ—¶ï¼Œç»™äºˆä¸€ä¸ªå‘ä¸Šçš„ç¬æ—¶é€Ÿåº¦
    if (input_manager.isActionPressed("jump")) {
        physics_comp->setVelocity(glm::vec2(physics_comp->getVelocity().x, -400));
    }
}
```

### âœ… ç¼–è¯‘ä¸è¿è¡Œ

ç¼–è¯‘å¹¶è¿è¡Œæ¸¸æˆã€‚ä½ ä¼šçœ‹åˆ°ï¼š

```
è¿è¡Œæ•ˆæœï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             â”‚
â”‚         ğŸ“¦ â† åˆå§‹ä½ç½®       â”‚
â”‚         â†“                   â”‚
â”‚         â†“ å—é‡åŠ›åŠ é€Ÿä¸‹è½    â”‚
â”‚         â†“                   â”‚
â”‚         ğŸ“¦                  â”‚
â”‚         â†“                   â”‚
â”‚        ğŸ“¦ğŸ’¨ â† æŒ‰Jè·³è·ƒ       â”‚
â”‚       â†‘                     â”‚
â”‚      â†‘ å‘ä¸ŠæŠ›ç‰©çº¿           â”‚
â”‚     â†‘                       â”‚
â”‚    ğŸ“¦                       â”‚
â”‚   â†“ ç„¶åå†æ¬¡ä¸‹è½            â”‚
â”‚  â†“                          â”‚
â”‚ ğŸ“¦ â† ç©¿è¿‡åœ°é¢ï¼ˆæš‚æ—¶ï¼‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä½ ä¼šçœ‹åˆ°ç®±å­åœ¨é‡åŠ›çš„ä½œç”¨ä¸‹å¼€å§‹åŠ é€Ÿä¸‹è½ï¼** ä½ å¯ä»¥ï¼š

- â¬…ï¸â¡ï¸ **æŒ‰å·¦å³é”®**ï¼šç›´æ¥ç§»åŠ¨ç®±å­ä½ç½®
- â¬†ï¸ **æŒ‰è·³è·ƒé”®ï¼ˆJ æˆ–ç©ºæ ¼ï¼‰**ï¼šç»™ç®±å­ä¸€ä¸ªå‘ä¸Šçš„åˆé€Ÿåº¦ï¼Œå®ƒä¼šå‘ä¸Šè·³èµ·ç„¶åå†æ¬¡è½ä¸‹

> âš ï¸ **æ³¨æ„**ï¼šç®±å­ç°åœ¨ä¼šç›´æ¥ç©¿è¿‡åœ°é¢ï¼ˆå› ä¸ºæˆ‘ä»¬è¿˜æ²¡åšç¢°æ’æ£€æµ‹ï¼‰ï¼Œä½†è¿™æ˜¯æ­£å¸¸çš„ï¼

---

## ğŸ¯ ç³»ç»Ÿæ¶æ„æ€»ç»“

### å®Œæ•´çš„ç‰©ç†ç³»ç»Ÿæ¶æ„

```
GameApp
    â†“ åˆ›å»º
PhysicsEngineï¼ˆå…¨å±€å•ä¾‹ï¼‰
    â†‘ æ³¨å†Œ
    â†“ æ›´æ–°
PhysicsComponentï¼ˆç»„ä»¶ï¼‰
    â†“ ä¿®æ”¹
TransformComponentï¼ˆä½ç½®ï¼‰
    â†“ æ¸²æŸ“
å±å¹•æ˜¾ç¤º
```

### æ ¸å¿ƒæˆå°±

æˆ‘ä»¬æˆåŠŸåœ°ï¼š

1. âœ… **å®ç°ç‰©ç†å¼•æ“**ï¼šå…¨å±€çš„ç‰©ç†æ¨¡æ‹Ÿç³»ç»Ÿ
2. âœ… **åˆ›å»ºç‰©ç†ç»„ä»¶**ï¼šèµ‹äºˆ GameObject ç‰©ç†å±æ€§
3. âœ… **æ³¨å†Œ-é€šçŸ¥æ¨¡å¼**ï¼šé«˜å†…èšä½è€¦åˆçš„æ¶æ„
4. âœ… **æ¬§æ‹‰ç§¯åˆ†**ï¼šåŸºç¡€çš„ç‰©ç†è¿åŠ¨æ¨¡æ‹Ÿ
5. âœ… **é‡åŠ›æ¨¡æ‹Ÿ**ï¼šç‰©ä½“è‡ªç„¶ä¸‹è½æ•ˆæœ
6. âœ… **é€Ÿåº¦æ§åˆ¶**ï¼šæ”¯æŒç¬æ—¶é€Ÿåº¦è®¾ç½®ï¼ˆè·³è·ƒï¼‰

### ç‰©ç†å…¬å¼åº”ç”¨

| ç‰©ç†æ¦‚å¿µ | å…¬å¼ | ä»£ç å®ç° |
|---------|------|----------|
| **ç‰›é¡¿ç¬¬äºŒå®šå¾‹** | F = ma | `force = gravity * mass` |
| **åŠ é€Ÿåº¦** | a = F/m | `acceleration = force / mass` |
| **é€Ÿåº¦ç§¯åˆ†** | v = vâ‚€ + at | `velocity += acceleration * dt` |
| **ä½ç½®ç§¯åˆ†** | s = sâ‚€ + vt | `position += velocity * dt` |

### è®¾è®¡äº®ç‚¹

| ç‰¹æ€§ | å®ç° | ä¼˜åŠ¿ |
|------|------|------|
| **ä¸­å¿ƒåŒ–ç®¡ç†** | PhysicsEngine ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç‰©ç†ç»„ä»¶ | æ€§èƒ½ä¼˜åŒ–ã€ç»Ÿä¸€è§„åˆ™ |
| **ç»„ä»¶åŒ–è®¾è®¡** | PhysicsComponent å¯é€‰æ·»åŠ  | çµæ´»æ€§é«˜ |
| **è‡ªåŠ¨æ³¨å†Œ** | ç»„ä»¶ init æ—¶è‡ªåŠ¨æ³¨å†Œ | æ— éœ€æ‰‹åŠ¨ç®¡ç† |
| **å¯é…ç½®å‚æ•°** | é‡åŠ›ã€è´¨é‡ã€æœ€å¤§é€Ÿåº¦å¯è°ƒæ•´ | é€‚åº”ä¸åŒæ¸¸æˆéœ€æ±‚ |

---

## ğŸ“š æ€»ç»“

æˆ‘ä»¬å·²ç»ä¸ºæ¸¸æˆä¸–ç•Œæ³¨å…¥äº†ç‰©ç†è§„åˆ™ï¼Œè®©å®ƒçœŸæ­£"åŠ¨"èµ·æ¥äº†ï¼

**å…³é”®è¦ç‚¹ï¼š**
- âš™ï¸ PhysicsEngine ç®¡ç†å…¨å±€ç‰©ç†æ¨¡æ‹Ÿ
- ğŸ§© PhysicsComponent èµ‹äºˆå¯¹è±¡ç‰©ç†å±æ€§
- ğŸ“ æ¬§æ‹‰ç§¯åˆ†å®ç°åŸºç¡€ç‰©ç†è¿åŠ¨
- ğŸŒ é‡åŠ›ã€é€Ÿåº¦ã€åŠ é€Ÿåº¦å®Œæ•´æ¨¡æ‹Ÿ
- ğŸ”— æ³¨å†Œ-é€šçŸ¥æ¨¡å¼å®ç°è§£è€¦
- â±ï¸ æ­£ç¡®çš„æ›´æ–°é¡ºåºè‡³å…³é‡è¦

> ğŸ’¡ **è®¾è®¡å“²å­¦**ï¼šä¸€ä¸ªå¥½çš„ç‰©ç†å¼•æ“ä¸éœ€è¦éå¸¸å¤æ‚çš„æ•°å­¦ï¼Œå…³é”®åœ¨äºæ¸…æ™°çš„æ¶æ„å’Œæ­£ç¡®çš„æ›´æ–°é¡ºåºã€‚æˆ‘ä»¬çš„ç®€å•æ¬§æ‹‰ç§¯åˆ†å·²ç»è¶³ä»¥æ”¯æ’‘ä¸€ä¸ªæœ‰è¶£çš„ 2D å¹³å°æ¸¸æˆï¼

ä»ä¸‹ä¸€è¯¾å¼€å§‹ï¼Œæˆ‘ä»¬å°†ä¸ºè¿™ä¸ªåŠ¨æ€çš„ä¸–ç•Œæ·»åŠ ç¢°æ’æ£€æµ‹ï¼Œè®©ç‰©ä½“ä¸å†ç©¿é€ï¼Œè®©è§’è‰²èƒ½å¤ŸçœŸæ­£åœ°ç«™åœ¨åœ°é¢ä¸Šï¼ğŸ’¥ğŸ®
