# åŠ¨ç”»ç»„ä»¶ä¸åŠ¨ç”»è½½å…¥

<div class="video-container">
  <div id="bilibili" class="video-content">
    <!-- Bç«™åµŒå…¥ï¼šä½¿ç”¨ https æ˜ç¡®åè®®ï¼ˆé¿å… file:// æˆ– http å¯¼è‡´è¢«æµè§ˆå™¨æ‹¦æˆªï¼‰ -->
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV1TT8jzmE5q&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

[åœ¨ Bilibili ä¸Šè§‚çœ‹](https://www.bilibili.com/video/BV1TT8jzmE5q)

## ğŸ“Œ é—®é¢˜èƒŒæ™¯

æˆ‘ä»¬å·²ç»æˆåŠŸå®ç°äº†ç©å®¶çš„çŠ¶æ€æœºç³»ç»Ÿï¼Œç©å®¶å¯ä»¥åœ¨ä¸åŒçŠ¶æ€ï¼ˆIdleã€Walkã€Jumpã€Fallï¼‰ä¹‹é—´æµç•…åˆ‡æ¢ã€‚ä½†ç›®å‰ç©å®¶çœ‹èµ·æ¥è¿˜æ˜¯é™æ€çš„â€”â€”æ— è®ºæ˜¯ç«™ç«‹è¿˜æ˜¯è¡Œèµ°ï¼Œæ˜¾ç¤ºçš„éƒ½æ˜¯åŒä¸€å¼ å›¾ç‰‡ã€‚

### âš ï¸ å½“å‰çš„é—®é¢˜

```
é™æ€è§’è‰²é—®é¢˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ğŸ§ â† ç«™ç«‹ï¼ˆé™æ€ï¼‰      â”‚
â”‚   ğŸ§ â† è¡Œèµ°ï¼ˆé™æ€ï¼‰      â”‚
â”‚   ğŸ§ â† è·³è·ƒï¼ˆé™æ€ï¼‰      â”‚
â”‚                          â”‚
â”‚ âŒ æ²¡æœ‰åŠ¨ç”»æ•ˆæœ          â”‚
â”‚ âŒ ç¼ºä¹ç”Ÿå‘½åŠ›            â”‚
â”‚ âŒ åŠ¨ç”»æ•°æ®ç¡¬ç¼–ç         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| é—®é¢˜ | è¯´æ˜ | å½±å“ |
|------|------|------|
| **æ— åŠ¨ç”»æ’­æ”¾** | è§’è‰²å§‹ç»ˆæ˜¾ç¤ºåŒä¸€å¸§ | ç¼ºä¹ç”ŸåŠ¨æ„Ÿ |
| **æ•°æ®ç¡¬ç¼–ç ** | åŠ¨ç”»æ•°æ®å†™åœ¨ä»£ç ä¸­ | éš¾ä»¥è°ƒæ•´å’Œä¿®æ”¹ |
| **çŠ¶æ€ä¸åŠ¨ç”»åˆ†ç¦»** | çŠ¶æ€åˆ‡æ¢ä¸å½±å“æ˜¾ç¤º | è§†è§‰åé¦ˆç¼ºå¤± |

### ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šæ•°æ®é©±åŠ¨çš„åŠ¨ç”»ç³»ç»Ÿ

**æ ¸å¿ƒæ€æƒ³**ï¼š
1. åœ¨ Tiled ç¼–è¾‘å™¨ä¸­å®šä¹‰åŠ¨ç”»æ•°æ®ï¼ˆJSON æ ¼å¼ï¼‰
2. åˆ›å»ºé€šç”¨çš„åŠ¨ç”»æ’­æ”¾ç»„ä»¶
3. å°†çŠ¶æ€æœºä¸åŠ¨ç”»ç³»ç»Ÿè”åŠ¨

```
åŠ¨ç”»ç³»ç»Ÿæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tiled ç¼–è¾‘å™¨ â”‚ â† å®šä¹‰åŠ¨ç”»æ•°æ®ï¼ˆJSONï¼‰
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LevelLoader  â”‚ â† è§£æåŠ¨ç”»æ•°æ®
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AnimationComponentâ”‚ â† æ’­æ”¾åŠ¨ç”»
â”‚ + Animation       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SpriteComponentâ”‚ â† æ›´æ–°æ˜¾ç¤ºå¸§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¯ æœ¬è¯¾ç›®æ ‡

| ç›®æ ‡ | è¯´æ˜ |
|------|------|
| **æ•°æ®é©±åŠ¨è®¾è®¡** | ä½¿ç”¨ Tiled è‡ªå®šä¹‰å±æ€§å®šä¹‰åŠ¨ç”»æ•°æ® |
| **æ„å»ºåŠ¨ç”»æ ¸å¿ƒç±»** | åˆ›å»º Animation å’Œ AnimationComponent |
| **æ‰©å±•å…³å¡åŠ è½½å™¨** | è‡ªåŠ¨è§£æåŠ¨ç”»æ•°æ®å¹¶é…ç½®ç»„ä»¶ |
| **çŠ¶æ€ä¸åŠ¨ç”»è”åŠ¨** | ä¸åŒçŠ¶æ€æ’­æ”¾ä¸åŒåŠ¨ç”» |

---

## 1. æ•°æ®é©±åŠ¨ï¼šåœ¨ Tiled ä¸­å®šä¹‰åŠ¨ç”»

è®©åŠ¨ç”»æ•°æ®ä¸ä»£ç åˆ†ç¦»æ˜¯ä¸€ç§éå¸¸ä¸“ä¸šå’Œé«˜æ•ˆçš„åšæ³•ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ Tiled å›¾å—ç¼–è¾‘å™¨ä¸­ä¸ºæ¯ä¸ªè§’è‰²ï¼ˆå›¾å—ï¼‰å®šä¹‰å®ƒçš„åŠ¨ç”»ã€‚

### ğŸ’¡ è®¾è®¡æ€æƒ³

```
æ•°æ®é©±åŠ¨çš„ä¼˜åŠ¿ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼ ç»Ÿæ–¹å¼ï¼ˆç¡¬ç¼–ç ï¼‰   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âŒ ä¿®æ”¹éœ€è¦é‡æ–°ç¼–è¯‘  â”‚
â”‚ âŒ ç¾æœ¯æ— æ³•ç‹¬ç«‹è°ƒæ•´  â”‚
â”‚ âŒ éš¾ä»¥ç®¡ç†å¤šä¸ªè§’è‰²  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®é©±åŠ¨ï¼ˆTiledï¼‰   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… å®æ—¶è°ƒæ•´ä¸ç”¨ç¼–è¯‘  â”‚
â”‚ âœ… ç¾æœ¯å¯ç‹¬ç«‹å·¥ä½œ    â”‚
â”‚ âœ… ç»Ÿä¸€ç®¡ç†æ‰€æœ‰åŠ¨ç”»  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tiled è‡ªå®šä¹‰å±æ€§

æˆ‘ä»¬æ‰“å¼€ `assets/maps/actor.tsj` è¿™ä¸ªå›¾å—é›†æ–‡ä»¶ï¼Œä¸ºè§’è‰²æ·»åŠ ä¸€ä¸ªåä¸º `animation` çš„è‡ªå®šä¹‰å±æ€§ã€‚

#### assets/maps/actor.tsj

```json
{
 "name":"animation",
 "type":"string",
 "value":"{\n  \"idle\": {\"duration\": 200, \"row\":0, \"frames\":[0,1,2,3,2,1]},\n  \"walk\": {\"row\":1, \"frames\":[0,1,2,3,4,5]},\n  \"climb\":{\"row\":2, \"frames\":[0,1,2,3]},\n  \"hurt\": {\"row\":4, \"frames\":[0,1]},\n  \"jump\": {\"row\":5, \"frames\":[0]},\n  \"fall\": {\"row\":5, \"frames\":[1]}\n}"
}
```

### JSON ç»“æ„è§£æ

æ ¼å¼åŒ–åçš„ JSON å¦‚ä¸‹ï¼š

```json
{
  "idle": {
    "duration": 200,
    "row": 0,
    "frames": [0, 1, 2, 3, 2, 1]
  },
  "walk": {
    "row": 1,
    "frames": [0, 1, 2, 3, 4, 5]
  },
  "climb": {
    "row": 2,
    "frames": [0, 1, 2, 3]
  },
  "hurt": {
    "row": 4,
    "frames": [0, 1]
  },
  "jump": {
    "row": 5,
    "frames": [0]
  },
  "fall": {
    "row": 5,
    "frames": [1]
  }
}
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| **åŠ¨ç”»åç§°** | `string` | âœ… | é¡¶çº§é”®åï¼Œå¦‚ `"idle"`, `"walk"` |
| **duration** | `int` | âŒ | æ¯å¸§æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤ 100ms |
| **row** | `int` | âŒ | åŠ¨ç”»æ‰€åœ¨çš„è¡Œå·ï¼Œé»˜è®¤ç¬¬ 0 è¡Œ |
| **frames** | `array` | âœ… | å¸§ç´¢å¼•æ•°ç»„ï¼Œè¡¨ç¤ºåŠ¨ç”»åºåˆ— |

### å¯è§†åŒ–è¯´æ˜

```
ç²¾çµå›¾å¸ƒå±€ï¼ˆå‡è®¾æ¯å¸§ 32x32ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚ 0  â”‚ 1  â”‚ 2  â”‚ 3  â”‚ 4  â”‚ 5  â”‚ â† row 0: idle åŠ¨ç”»
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚ 0  â”‚ 1  â”‚ 2  â”‚ 3  â”‚ 4  â”‚ 5  â”‚ â† row 1: walk åŠ¨ç”»
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚ 0  â”‚ 1  â”‚ 2  â”‚ 3  â”‚    â”‚    â”‚ â† row 2: climb åŠ¨ç”»
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜

idle åŠ¨ç”»æ’­æ”¾é¡ºåºï¼š
frame 0 â†’ frame 1 â†’ frame 2 â†’ frame 3 â†’ frame 2 â†’ frame 1 â†’ å¾ªç¯
```

### åŠ¨ç”»ç¤ºä¾‹

| åŠ¨ç”» | è¡Œå· | å¸§åºåˆ— | æ•ˆæœ |
|------|------|--------|------|
| **idle** | 0 | `[0,1,2,3,2,1]` | ç«™ç«‹å‘¼å¸åŠ¨ç”»ï¼ˆæ¥å›æ‘†åŠ¨ï¼‰ |
| **walk** | 1 | `[0,1,2,3,4,5]` | è¡Œèµ°å¾ªç¯ |
| **jump** | 5 | `[0]` | å•å¸§è·³è·ƒå§¿åŠ¿ |
| **fall** | 5 | `[1]` | å•å¸§ä¸‹è½å§¿åŠ¿ |

### ğŸ’¡ æ‰©å±•æ€§

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ **ä¸ä¿®æ”¹ä»»ä½•ä»£ç ** çš„æƒ…å†µä¸‹ï¼š
- âœ… è°ƒæ•´åŠ¨ç”»é€Ÿåº¦ï¼ˆä¿®æ”¹ `duration`ï¼‰
- âœ… å¢åŠ æˆ–åˆ é™¤åŠ¨ç”»å¸§
- âœ… æ·»åŠ å…¨æ–°çš„åŠ¨ç”»
- âœ… ä¸ºä¸åŒè§’è‰²å®šä¹‰ä¸åŒåŠ¨ç”»

æˆ‘ä»¬å·²ç»ä¸º **é’è›™ã€è€é¹°ã€è´Ÿé¼ ** ç­‰å…¶ä»–è§’è‰²ä¹Ÿæ·»åŠ äº†ç±»ä¼¼çš„åŠ¨ç”»æ•°æ®ã€‚

---

## 2. å¼•æ“æ ¸å¿ƒï¼šAnimation ä¸ AnimationComponent

<img src="https://theorhythm.top/gamedev/SL/SL.068.webp" alt="åŠ¨ç”»ç»„ä»¶ç±»å›¾å…³ç³»" style="display: block; margin: auto; width: 700px;" />

ä¸ºäº†åœ¨å¼•æ“ä¸­å®ç°åŠ¨ç”»æ’­æ”¾ï¼Œæˆ‘ä»¬éœ€è¦ä¸¤ä¸ªæ–°çš„æ ¸å¿ƒç±»ï¼š

### æ¶æ„è®¾è®¡

| ç±» | èŒè´£ | è¯´æ˜ |
|---|------|------|
| **Animation** | æ•°æ®å®¹å™¨ | å­˜å‚¨å•ä¸ªåŠ¨ç”»ç‰‡æ®µçš„æ‰€æœ‰å¸§ä¿¡æ¯ |
| **AnimationComponent** | æ’­æ”¾å™¨ | ç®¡ç†å¤šä¸ªåŠ¨ç”»ï¼Œæ§åˆ¶æ’­æ”¾å’Œåˆ‡æ¢ |

```
ç±»å…³ç³»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GameObject       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SpriteComponent  â”‚ â† æ˜¾ç¤ºå½“å‰å¸§
â”‚ AnimationComponentâ”‚ â† ç®¡ç†æ‰€æœ‰åŠ¨ç”»
â”‚   â”œâ”€ Animation   â”‚ â† "idle" åŠ¨ç”»
â”‚   â”œâ”€ Animation   â”‚ â† "walk" åŠ¨ç”»
â”‚   â””â”€ Animation   â”‚ â† "jump" åŠ¨ç”»
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2.1 æ•°æ®å®¹å™¨ï¼šAnimation ç±»

è¿™ä¸ªç±»çº¯ç²¹ç”¨æ¥å­˜å‚¨ä¸€ä¸ªåŠ¨ç”»ç‰‡æ®µçš„æ•°æ®ï¼Œæ¯”å¦‚ `"walk"` åŠ¨ç”»çš„æ‰€æœ‰å¸§ä¿¡æ¯å’Œæ€»æ—¶é•¿ã€‚

#### src/engine/render/animation.hï¼ˆæ–°å»ºæ–‡ä»¶ï¼‰

```cpp
#pragma once
#include <SDL3/SDL_rect.h>
#include <vector>
#include <string>

namespace engine::render {

/**
 * @brief ä»£è¡¨åŠ¨ç”»ä¸­çš„å•ä¸ªå¸§ã€‚
 */
struct AnimationFrame {
    SDL_FRect source_rect;    ///< @brief çº¹ç†å›¾é›†ä¸Šæ­¤å¸§çš„åŒºåŸŸ
    float duration;           ///< @brief æ­¤å¸§æ˜¾ç¤ºçš„æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰
};

/**
 * @brief ç®¡ç†ä¸€ç³»åˆ—åŠ¨ç”»å¸§ã€‚
 */
class Animation final {
private:
    std::string name_;
    std::vector<AnimationFrame> frames_;
    float total_duration_ = 0.0f;
    bool loop_ = true;

public:
    Animation(const std::string& name = "default", bool loop = true);
    ~Animation() = default;

    void addFrame(const SDL_FRect& source_rect, float duration);
    const AnimationFrame& getFrame(float time) const;
    
    // ... Getters and Setters ...
    const std::string& getName() const { return name_; }
    float getTotalDuration() const { return total_duration_; }
    bool isLooping() const { return loop_; }
    bool isEmpty() const { return frames_.empty(); }
};

} // namespace engine::render
```

#### src/engine/render/animation.cppï¼ˆæ–°å»ºæ–‡ä»¶ï¼‰

```cpp
#include "animation.h"
#include <glm/common.hpp>
#include <spdlog/spdlog.h>

namespace engine::render {

// ... æ„é€ å‡½æ•° ...

void Animation::addFrame(const SDL_FRect& source_rect, float duration) {
    if (duration <= 0.0f) { /* ... */ }
    frames_.push_back({source_rect, duration});
    total_duration_ += duration;
}

const AnimationFrame& Animation::getFrame(float time) const {
    if (frames_.empty()) { /* ... é”™è¯¯å¤„ç† ... */ }

    float current_time = time;

    if (loop_ && total_duration_ > 0.0f) {
        // å¯¹å¾ªç¯åŠ¨ç”»ä½¿ç”¨æ¨¡è¿ç®—è·å–æœ‰æ•ˆæ—¶é—´
        current_time = glm::mod(time, total_duration_);
    } else {
        // å¯¹äºéå¾ªç¯åŠ¨ç”»ï¼Œå¦‚æœæ—¶é—´è¶…è¿‡æ€»æ—¶é•¿ï¼Œåˆ™åœç•™åœ¨æœ€åä¸€å¸§
        if (current_time >= total_duration_) {
            return frames_.back();
        }
    }

    // éå†å¸§ä»¥æ‰¾åˆ°æ­£ç¡®çš„å¸§
    float accumulated_time = 0.0f;
    for (const auto& frame : frames_) {
        accumulated_time += frame.duration;
        if (current_time < accumulated_time) {
            return frame;
        }
    }
    
    // ... å®‰å…¨è¿”å› ...
    return frames_.back();
}

} // namespace engine::render
```

### Animation æ ¸å¿ƒæ–¹æ³•

| æ–¹æ³• | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|
| `addFrame()` | æ·»åŠ å¸§ | å°†å¸§åŠ å…¥åºåˆ—ï¼Œç´¯åŠ æ€»æ—¶é•¿ |
| `getFrame(time)` | è·å–å½“å‰å¸§ | æ ¹æ®æ—¶é—´è®¡ç®—åº”æ˜¾ç¤ºå“ªä¸€å¸§ |

### getFrame() ç®—æ³•è¯¦è§£

```
æ—¶é—´åˆ°å¸§çš„æ˜ å°„ï¼š
å‡è®¾åŠ¨ç”»æœ‰ 3 å¸§ï¼Œæ¯å¸§ 0.1 ç§’
total_duration = 0.3 ç§’

å¾ªç¯æ¨¡å¼ï¼š
time = 0.05s â†’ frame 0
time = 0.15s â†’ frame 1
time = 0.25s â†’ frame 2
time = 0.35s â†’ 0.05s (mod) â†’ frame 0
time = 0.45s â†’ 0.15s (mod) â†’ frame 1
...å¾ªç¯æ’­æ”¾

éå¾ªç¯æ¨¡å¼ï¼š
time = 0.35s â†’ è¶…è¿‡ 0.3s â†’ åœåœ¨ frame 2
```

### ç®—æ³•æ­¥éª¤

| æ­¥éª¤ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| **1. æ£€æŸ¥ç©ºå¸§** | `frames_.empty()` | é˜²æ­¢å´©æºƒ |
| **2. è®¡ç®—æœ‰æ•ˆæ—¶é—´** | å¾ªç¯ï¼š`time % total_duration` | å°†æ—¶é—´æ˜ å°„åˆ°ä¸€ä¸ªå‘¨æœŸå†… |
| | éå¾ªç¯ï¼š`min(time, total_duration)` | è¶…æ—¶åˆ™åœåœ¨æœ€åä¸€å¸§ |
| **3. éå†æŸ¥æ‰¾** | ç´¯åŠ æ¯å¸§æ—¶é•¿ | æ‰¾åˆ°å½“å‰æ—¶é—´å¯¹åº”çš„å¸§ |
| **4. è¿”å›å¸§** | `return frame` | è¿”å›å¸§æ•°æ® |

---

### 2.2 åŠ¨ç”»æ’­æ”¾å™¨ï¼šAnimationComponent

è¿™æ˜¯ä¸€ä¸ªç»„ä»¶ï¼Œå®ƒå°†è¢«æ·»åŠ åˆ°éœ€è¦æ’­æ”¾åŠ¨ç”»çš„ `GameObject` ä¸Šã€‚å®ƒè´Ÿè´£ç®¡ç†ä¸€ä¸ªå¯¹è±¡æ‰€æœ‰çš„åŠ¨ç”»ç‰‡æ®µï¼ˆæ¯”å¦‚ç©å®¶çš„ `"idle"`, `"walk"`, `"jump"` ç­‰ï¼‰ï¼Œå¹¶æ§åˆ¶å½“å‰æ’­æ”¾å“ªä¸€ä¸ªã€‚

#### src/engine/component/animation_component.hï¼ˆæ–°å»ºæ–‡ä»¶ï¼‰

```cpp
#pragma once
#include "./component.h"
#include <string>
#include <unordered_map>
#include <memory>

namespace engine::render {
    class Animation;
}
namespace engine::component {
    class SpriteComponent;
}

namespace engine::component {

class AnimationComponent : public Component {
    // ...
private:
    std::unordered_map<std::string, std::unique_ptr<engine::render::Animation>> animations_;
    SpriteComponent* sprite_component_ = nullptr;
    engine::render::Animation* current_animation_ = nullptr;

    float animation_timer_ = 0.0f;
    bool is_playing_ = false;
    // ...

public:
    void addAnimation(std::unique_ptr<engine::render::Animation> animation);
    void playAnimation(const std::string& name);
    // ... å…¶ä»–æ–¹æ³• ...

protected:
    void init() override;
    void update(float, engine::core::Context&) override;
};

} // namespace engine::component
```

#### src/engine/component/animation_component.cppï¼ˆæ–°å»ºæ–‡ä»¶ï¼‰

```cpp
#include "animation_component.h"
#include "sprite_component.h"
#include "../object/game_object.h"
#include "../render/animation.h"
// ...

namespace engine::component {

// ...
void AnimationComponent::init() {
    // ...
    sprite_component_ = owner_->getComponent<SpriteComponent>();
    if (!sprite_component_) {
        spdlog::error("AnimationComponent éœ€è¦ SpriteComponentï¼Œä½†æœªæ‰¾åˆ°ã€‚");
    }
}

void AnimationComponent::update(float delta_time, engine::core::Context&) {
    if (!is_playing_ || !current_animation_ || !sprite_component_ || current_animation_->isEmpty()) {
        return;
    }

    // æ¨è¿›è®¡æ—¶å™¨
    animation_timer_ += delta_time;

    // æ ¹æ®æ—¶é—´è·å–å½“å‰å¸§
    const auto& current_frame = current_animation_->getFrame(animation_timer_);

    // æ›´æ–°ç²¾çµç»„ä»¶çš„æºçŸ©å½¢
    sprite_component_->setSourceRect(current_frame.source_rect);

    // ... å¤„ç†éå¾ªç¯åŠ¨ç”»ç»“æŸçš„é€»è¾‘ ...
}

void AnimationComponent::addAnimation(std::unique_ptr<engine::render::Animation> animation) {
    if (!animation) return;
    std::string name = animation->getName();
    animations_[name] = std::move(animation);
}

void AnimationComponent::playAnimation(const std::string& name) {
    auto it = animations_.find(name);
    if (it == animations_.end()) { /* ... é”™è¯¯å¤„ç† ... */ return; }

    // å¦‚æœå·²ç»åœ¨æ’­æ”¾ç›¸åŒçš„åŠ¨ç”»ï¼Œåˆ™ä¸é‡æ–°å¼€å§‹
    if (current_animation_ == it->second.get() && is_playing_) {
        return;
    }

    current_animation_ = it->second.get();
    animation_timer_ = 0.0f; // é‡ç½®è®¡æ—¶å™¨
    is_playing_ = true;

    // ç«‹å³å°†ç²¾çµæ›´æ–°åˆ°ç¬¬ä¸€å¸§
    if (sprite_component_ && !current_animation_->isEmpty()) {
        const auto& first_frame = current_animation_->getFrame(0.0f);
        sprite_component_->setSourceRect(first_frame.source_rect);
    }
}
// ...
}
```

### AnimationComponent å·¥ä½œæµç¨‹

```
AnimationComponent ç”Ÿå‘½å‘¨æœŸï¼š
    â†“
init()
    â†’ è·å– SpriteComponent æŒ‡é’ˆ
    â†“
addAnimation("idle")
addAnimation("walk")
addAnimation("jump")
    â†’ å­˜å…¥ animations_ å“ˆå¸Œè¡¨
    â†“
playAnimation("walk")
    â†’ è®¾ç½® current_animation_
    â†’ é‡ç½® animation_timer_ = 0
    â†’ ç«‹å³æ˜¾ç¤ºç¬¬ä¸€å¸§
    â†“
update(delta_time) - æ¯å¸§è°ƒç”¨
    â†’ animation_timer_ += delta_time
    â†’ è°ƒç”¨ current_animation_->getFrame(timer)
    â†’ sprite_component_->setSourceRect(frame.source_rect)
    â†’ ç”»é¢æ˜¾ç¤ºå¯¹åº”å¸§
    â†“
å¾ªç¯æ’­æ”¾...
```

### å…³é”®æ–¹æ³•è¯¦è§£

| æ–¹æ³• | æ—¶æœº | æ“ä½œ |
|------|------|------|
| **init()** | ç»„ä»¶åˆå§‹åŒ–æ—¶ | è·å– `SpriteComponent` æŒ‡é’ˆ |
| **addAnimation()** | åŠ è½½é˜¶æ®µ | å°†åŠ¨ç”»å­˜å…¥å“ˆå¸Œè¡¨ `animations_` |
| **playAnimation()** | çŠ¶æ€åˆ‡æ¢æ—¶ | è®¾ç½®å½“å‰åŠ¨ç”»ï¼Œé‡ç½®è®¡æ—¶å™¨ |
| **update()** | æ¯å¸§ | ç´¯åŠ æ—¶é—´ï¼Œè·å–å½“å‰å¸§ï¼Œæ›´æ–°æ˜¾ç¤º |

### ğŸ’¡ è®¾è®¡äº®ç‚¹

**é¿å…é‡å¤æ’­æ”¾**ï¼š
```cpp
if (current_animation_ == it->second.get() && is_playing_) {
    return;  // å·²åœ¨æ’­æ”¾ï¼Œä¸é‡æ–°å¼€å§‹
}
```

**ç«‹å³æ˜¾ç¤ºç¬¬ä¸€å¸§**ï¼š
```cpp
const auto& first_frame = current_animation_->getFrame(0.0f);
sprite_component_->setSourceRect(first_frame.source_rect);
```

---

## 3. å…³å¡è½½å…¥å™¨å‡çº§

ç°åœ¨æˆ‘ä»¬æœ‰äº†åŠ¨ç”»ç³»ç»Ÿï¼Œä½†è¿˜éœ€è¦è®© `LevelLoader` èƒ½å¤Ÿç†è§£æˆ‘ä»¬åœ¨ Tiled é‡Œå®šä¹‰çš„ JSON æ•°æ®ï¼Œå¹¶è‡ªåŠ¨åˆ›å»ºã€é…ç½®å¥½ `Animation` å’Œ `AnimationComponent`ã€‚

### å‡çº§æ€è·¯

```
LevelLoader å‡çº§æµç¨‹ï¼š
    â†“
1. è¯»å– Tiled å¯¹è±¡çš„ "animation" å±æ€§
    â†“
2. è§£æ JSON å­—ç¬¦ä¸²
    â†“
3. ä¸º GameObject æ·»åŠ  AnimationComponent
    â†“
4. éå† JSON ä¸­çš„æ¯ä¸ªåŠ¨ç”»ç‰‡æ®µ
    â†“
5. ä¸ºæ¯ä¸ªç‰‡æ®µåˆ›å»º Animation å¯¹è±¡
    â†“
6. è®¡ç®—æ¯å¸§çš„ source_rect
    â†“
7. å°†æ‰€æœ‰ Animation æ·»åŠ åˆ° AnimationComponent
```

### src/engine/scene/level_loader.cppï¼ˆæ›´æ–°ï¼‰

```cpp
void LevelLoader::loadObjectLayer(const nlohmann::json& layer_json, Scene& scene)
{
    // ...
    // éå†å¯¹è±¡æ•°æ®
    for (const auto& object : objects) {
            // è·å–é‡åŠ›ä¿¡æ¯å¹¶è®¾ç½®
            // ...
            // è·å–åŠ¨ç”»ä¿¡æ¯å¹¶è®¾ç½®
            auto anim_string = getTileProperty<std::string>(tile_json, "animation");
            if (anim_string) {
                // è§£æstringä¸ºJSONå¯¹è±¡
                nlohmann::json anim_json;
                try {
                    anim_json = nlohmann::json::parse(anim_string.value());
                } catch (const nlohmann::json::parse_error& e) {
                    spdlog::error("è§£æåŠ¨ç”» JSON å­—ç¬¦ä¸²å¤±è´¥: {}", e.what());
                    continue;  // è·³è¿‡æ­¤å¯¹è±¡
                }
                // æ·»åŠ AnimationComponent
                auto* ac = game_object->addComponent<engine::component::AnimationComponent>();
                // æ·»åŠ åŠ¨ç”»åˆ° AnimationComponent
                addAnimation(anim_json, ac, src_size);
            }

            // æ·»åŠ åˆ°åœºæ™¯ä¸­
            scene.addGameObject(std::move(game_object));
            spdlog::info("åŠ è½½å¯¹è±¡: '{}' å®Œæˆ", object_name);
        }
    }
}

void LevelLoader::addAnimation(const nlohmann::json& anim_json, engine::component::AnimationComponent *ac, const glm::vec2& sprite_size)
{
    // æ£€æŸ¥ anim_json å¿…é¡»æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸” ac ä¸èƒ½ä¸º nullptr
    if (!anim_json.is_object() || !ac) {
        spdlog::error("æ— æ•ˆçš„åŠ¨ç”» JSON æˆ– AnimationComponent æŒ‡é’ˆã€‚");
        return;
    }
    // éå†åŠ¨ç”» JSON å¯¹è±¡ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹ï¼ˆåŠ¨ç”»åç§° : åŠ¨ç”»ä¿¡æ¯ï¼‰
    for (const auto& anim : anim_json.items()) {
        const std::string& anim_name = anim.key();
        const auto& anim_info = anim.value();
        if (!anim_info.is_object()) {
            spdlog::warn("åŠ¨ç”» '{}' çš„ä¿¡æ¯æ— æ•ˆæˆ–ä¸ºç©ºã€‚", anim_name);
            continue;
        }
        // è·å–å¯èƒ½å­˜åœ¨çš„åŠ¨ç”»å¸§ä¿¡æ¯
        auto duration_ms = anim_info.value("duration", 100);        // é»˜è®¤æŒç»­æ—¶é—´ä¸º100æ¯«ç§’
        auto duration = static_cast<float>(duration_ms) / 1000.0f;  // è½¬æ¢ä¸ºç§’
        auto row = anim_info.value("row", 0);                       // é»˜è®¤è¡Œæ•°ä¸º0
        // å¸§ä¿¡æ¯ï¼ˆæ•°ç»„ï¼‰æ˜¯å¿…é¡»å­˜åœ¨çš„
        if (!anim_info.contains("frames") || !anim_info["frames"].is_array()) {
            spdlog::warn("åŠ¨ç”» '{}' ç¼ºå°‘ 'frames' æ•°ç»„ã€‚", anim_name);
            continue;
        }
        // åˆ›å»ºä¸€ä¸ªAnimationå¯¹è±¡ (é»˜è®¤ä¸ºå¾ªç¯æ’­æ”¾)
        auto animation = std::make_unique<engine::render::Animation>(anim_name);

        // éå†æ•°ç»„å¹¶è¿›è¡Œæ·»åŠ å¸§ä¿¡æ¯åˆ°animationå¯¹è±¡
        for (const auto& frame : anim_info["frames"]) {
            if (!frame.is_number_integer()) {
                spdlog::warn("åŠ¨ç”» {} ä¸­ frames æ•°ç»„æ ¼å¼é”™è¯¯ï¼", anim_name);
                continue;;
            }
            auto column = frame.get<int>();
            // è®¡ç®—æºçŸ©å½¢
            SDL_FRect src_rect = { 
                column * sprite_size.x, 
                row * sprite_size.y, 
                sprite_size.x, 
                sprite_size.y 
            };
            // æ·»åŠ åŠ¨ç”»å¸§åˆ° Animation
            animation->addFrame(src_rect, duration);
        }
        // å°† Animation å¯¹è±¡æ·»åŠ åˆ° AnimationComponent ä¸­
        ac->addAnimation(std::move(animation));
    }
}
```

### addAnimation() è¯¦è§£

| æ­¥éª¤ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| **1. éªŒè¯å‚æ•°** | æ£€æŸ¥ JSON å’ŒæŒ‡é’ˆæœ‰æ•ˆæ€§ | é˜²æ­¢ç©ºæŒ‡é’ˆ |
| **2. éå†åŠ¨ç”»** | `for (auto& anim : anim_json)` | å¤„ç†æ¯ä¸ªåŠ¨ç”»ç‰‡æ®µ |
| **3. è¯»å–å±æ€§** | `duration`, `row`, `frames` | è·å–åŠ¨ç”»å‚æ•° |
| **4. åˆ›å»º Animation** | `make_unique<Animation>()` | ä¸ºæ¯ä¸ªç‰‡æ®µåˆ›å»ºå¯¹è±¡ |
| **5. éå†å¸§æ•°ç»„** | `for (auto& frame : frames)` | å¤„ç†æ¯ä¸€å¸§ |
| **6. è®¡ç®—çŸ©å½¢** | `{col * w, row * h, w, h}` | ç¡®å®šçº¹ç†åŒºåŸŸ |
| **7. æ·»åŠ å¸§** | `animation->addFrame()` | å­˜å…¥åŠ¨ç”»å¯¹è±¡ |
| **8. æ³¨å†ŒåŠ¨ç”»** | `ac->addAnimation()` | æ·»åŠ åˆ°ç»„ä»¶ |

### æºçŸ©å½¢è®¡ç®—

```
ç²¾çµå›¾åæ ‡è®¡ç®—ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ (0,0)          (w,0)     â”‚
â”‚   â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”     â”‚
â”‚   â”‚0,0â”‚1,0â”‚2,0â”‚3,0â”‚     â”‚ â† row 0
â”‚   â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤     â”‚
â”‚   â”‚0,1â”‚1,1â”‚2,1â”‚3,1â”‚     â”‚ â† row 1
â”‚   â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¸§ [row=1, col=2] çš„çŸ©å½¢ï¼š
x = col * sprite_size.x = 2 * 32 = 64
y = row * sprite_size.y = 1 * 32 = 32
width = sprite_size.x = 32
height = sprite_size.y = 32

ç»“æœï¼šSDL_FRect{64, 32, 32, 32}
```

---

## 4. è¿æ¥çŠ¶æ€æœºä¸åŠ¨ç”»

æœ€æ¿€åŠ¨äººå¿ƒçš„éƒ¨åˆ†æ¥äº†ï¼æˆ‘ä»¬çš„ `PlayerComponent` å·²ç»æœ‰äº†çŠ¶æ€æœºï¼Œç°åœ¨åªéœ€è¦åœ¨çŠ¶æ€åˆ‡æ¢æ—¶ï¼Œè°ƒç”¨ `AnimationComponent` çš„ `playAnimation` æ–¹æ³•å³å¯ã€‚

### ğŸ’¡ è”åŠ¨æ€è·¯

```
çŠ¶æ€ä¸åŠ¨ç”»è”åŠ¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IdleState    â”‚ â†’ enter() â†’ playAnimation("idle")
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ æŒ‰ä¸‹ç§»åŠ¨é”®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WalkState    â”‚ â†’ enter() â†’ playAnimation("walk")
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ æŒ‰ä¸‹è·³è·ƒé”®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JumpState    â”‚ â†’ enter() â†’ playAnimation("jump")
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ é€Ÿåº¦å‘ä¸‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FallState    â”‚ â†’ enter() â†’ playAnimation("fall")
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4.1 åœ¨ PlayerState åŸºç±»ä¸­æä¾›ä¾¿åˆ©å‡½æ•°

ä¸ºäº†é¿å…åœ¨æ¯ä¸ªå…·ä½“çš„çŠ¶æ€ç±»ï¼ˆIdle, Walk...ï¼‰ä¸­éƒ½é‡å¤å†™è·å– `AnimationComponent` å¹¶æ’­æ”¾çš„ä»£ç ï¼Œæˆ‘ä»¬åœ¨åŸºç±» `PlayerState` ä¸­æä¾›ä¸€ä¸ªè¾…åŠ©å‡½æ•°ã€‚

#### src/game/component/state/player_state.hï¼ˆæ›´æ–°ï¼‰

```cpp
class PlayerState {
    // ...
public:
    // ...
    void playAnimation(const std::string& animation_name);      ///< @brief æ’­æ”¾æŒ‡å®šåç§°çš„åŠ¨ç”»ï¼Œä½¿ç”¨  AnimationComponent çš„æ–¹æ³•
    // ...
};
```

#### src/game/component/state/player_state.cppï¼ˆæ–°å»ºæ–‡ä»¶ï¼‰

```cpp
#include "player_state.h"
#include "../player_component.h"
#include "../../../engine/component/animation_component.h"
#include "../../../engine/object/game_object.h"
#include <spdlog/spdlog.h>

namespace game::component::state {

void PlayerState::playAnimation(const std::string& animation_name) {
    if (!player_component_) { /* ... */ return; }
    
    auto animation_component = player_component_->getAnimationComponent();
    if (!animation_component) { /* ... */ return; }

    animation_component->playAnimation(animation_name);
}

} // namespace game::component::state
```

### è¾…åŠ©å‡½æ•°çš„ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **ä»£ç å¤ç”¨** | é¿å…åœ¨æ¯ä¸ªçŠ¶æ€ä¸­é‡å¤ç›¸åŒé€»è¾‘ |
| **ç»Ÿä¸€æ¥å£** | æ‰€æœ‰çŠ¶æ€ä½¿ç”¨ç›¸åŒæ–¹å¼æ’­æ”¾åŠ¨ç”» |
| **æ˜“äºç»´æŠ¤** | åªéœ€ä¿®æ”¹ä¸€å¤„å³å¯å½±å“æ‰€æœ‰çŠ¶æ€ |
| **ç©ºæŒ‡é’ˆæ£€æŸ¥** | é›†ä¸­å¤„ç†é”™è¯¯æƒ…å†µ |

---

### 4.2 åœ¨å…·ä½“çŠ¶æ€çš„ enter() ä¸­æ’­æ”¾åŠ¨ç”»

ç°åœ¨ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æ¯ä¸ªå…·ä½“çŠ¶æ€çš„ `enter()` æ–¹æ³•ä¸­ï¼Œè°ƒç”¨è¿™ä¸ªæ–°çš„è¾…åŠ©å‡½æ•°å³å¯ã€‚

```cpp
// src/game/component/state/idle_state.cpp
void IdleState::enter() {
    playAnimation("idle");  // æ’­æ”¾å¾…æœºåŠ¨ç”»
}

// src/game/component/state/walk_state.cpp
void WalkState::enter() {
    playAnimation("walk");  // æ’­æ”¾æ­¥è¡ŒåŠ¨ç”»
}
```

å¯¹ `JumpState` å’Œ `FallState` åšåŒæ ·ä¿®æ”¹ï¼Œåˆ†åˆ«åœ¨ `enter()` ä¸­è°ƒç”¨ `playAnimation("jump")` å’Œ `playAnimation("fall")`ã€‚

### çŠ¶æ€ä¸åŠ¨ç”»æ˜ å°„

| çŠ¶æ€ | åŠ¨ç”» | æ•ˆæœ |
|------|------|------|
| **IdleState** | `"idle"` | ç«™ç«‹å‘¼å¸åŠ¨ç”» |
| **WalkState** | `"walk"` | è¡Œèµ°å¾ªç¯åŠ¨ç”» |
| **JumpState** | `"jump"` | è·³è·ƒå§¿åŠ¿ï¼ˆå•å¸§ï¼‰ |
| **FallState** | `"fall"` | ä¸‹è½å§¿åŠ¿ï¼ˆå•å¸§ï¼‰ |

---

### 4.3 åœ¨ PlayerComponent ä¸­ç¼“å­˜ AnimationComponent

æœ€åï¼Œåˆ«å¿˜äº†è®© `PlayerComponent` ä¿å­˜ `AnimationComponent` çš„æŒ‡é’ˆä½œä¸ºæˆå‘˜å˜é‡ï¼Œå¹¶åœ¨åˆå§‹åŒ–æ—¶èµ‹å€¼ã€‚

```cpp
// src/game/component/player_component.h
class PlayerComponent final : public engine::component::Component {
private:
    // ...
    engine::component::AnimationComponent* animation_component_ = nullptr;
}

// src/game/component/player_component.cpp
void PlayerComponent::init() {
    // ...
    // è·å–å¿…è¦çš„ç»„ä»¶
    // ...
    animation_component_ = owner_->getComponent<engine::component::AnimationComponent>();
    // ...
}

```

### å®Œæ•´çš„ç»„ä»¶ä¾èµ–å…³ç³»

```
PlayerComponent ä¾èµ–çš„ç»„ä»¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PlayerComponent  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â†’ TransformComponent*     â† ä½ç½®å˜æ¢
â”‚ â†’ PhysicsComponent*       â† ç‰©ç†çŠ¶æ€
â”‚ â†’ SpriteComponent*        â† ç²¾çµæ˜¾ç¤º
â”‚ â†’ AnimationComponent*  â† åŠ¨ç”»æ’­æ”¾ï¼ˆæ–°å¢ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. æ¿€æ´»å…¶ä»–è§’è‰²åŠ¨ç”»

ç©å®¶å·²ç»åŠ¨èµ·æ¥äº†ï¼Œæ¸¸æˆé‡Œçš„å…¶ä»–è§’è‰²å’Œé“å…·ä¹Ÿä¸€æ ·ã€‚æˆ‘ä»¬åœ¨ `GameScene` ä¸­å¢åŠ ä¸€ä¸ª `initEnemyAndItem` å‡½æ•°ï¼Œåœ¨å…³å¡åŠ è½½å®Œæˆåï¼Œéå†æ‰€æœ‰å¯¹è±¡ï¼Œä¸ºå®ƒä»¬æ’­æ”¾é»˜è®¤åŠ¨ç”»ã€‚

### src/game/scene/game_scene.cppï¼ˆæ›´æ–°ï¼‰

```cpp
// ...
bool GameScene::initEnemyAndItem()
{
    bool success = true;
    for (auto& game_object : game_objects_){
        if (game_object->getName() == "eagle"){
            if (auto* ac = game_object->getComponent<engine::component::AnimationComponent>(); ac){
                ac->playAnimation("fly");
            } else { /* ... */ }
        }
        if (game_object->getName() == "frog"){
            if (auto* ac = game_object->getComponent<engine::component::AnimationComponent>(); ac){
                ac->playAnimation("idle");
            } else { /* ... */ }
        }
        // ... å¯¹ Opossum å’Œ Item åšåŒæ ·å¤„ç†
    }
    return success;
}
```

### è§’è‰²åŠ¨ç”»é…ç½®

| è§’è‰² | é»˜è®¤åŠ¨ç”» | è¯´æ˜ |
|------|---------|------|
| **eagle** | `"fly"` | è€é¹°é£è¡ŒåŠ¨ç”» |
| **frog** | `"idle"` | é’è›™å¾…æœºåŠ¨ç”» |
| **opossum** | `"idle"` | è´Ÿé¼ å¾…æœºåŠ¨ç”» |
| **item** | `"idle"` | é“å…·é—ªçƒåŠ¨ç”» |

### åˆå§‹åŒ–æµç¨‹

```
GameScene å®Œæ•´åˆå§‹åŒ–ï¼š
    â†“
initLevel()
    â†’ åŠ è½½åœ°å›¾
    â†’ æ³¨å†Œç¢°æ’å±‚
    â†“
initPlayer()
    â†’ æ·»åŠ  PlayerComponent
    â†’ çŠ¶æ€æœºè‡ªåŠ¨ç®¡ç†åŠ¨ç”»
    â†“
initEnemyAndItem()  â† æ–°å¢
    â†’ éå†æ‰€æœ‰å¯¹è±¡
    â†’ æ’­æ”¾é»˜è®¤åŠ¨ç”»
    â†“
Scene::init()
    â†’ å¯åŠ¨æ¸¸æˆå¾ªç¯
```

---

## âœ… ç¼–è¯‘ä¸è¿è¡Œ

ç¼–è¯‘å¹¶è¿è¡Œæ¸¸æˆï¼Œä½ å°†çœ‹åˆ°ä¸€ä¸ªå……æ»¡ç”Ÿæœºçš„ä¸–ç•Œï¼

```
è¿è¡Œæ•ˆæœï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ§â†’ğŸƒ ç©å®¶è¡Œèµ°åŠ¨ç”»      â”‚
â”‚   â†‘                      â”‚
â”‚  ğŸ¦… è€é¹°é£è¡Œ             â”‚
â”‚   â†“                      â”‚
â”‚ ğŸ¸ é’è›™å‘¼å¸              â”‚
â”‚   â†“                      â”‚
â”‚ ğŸ’ é“å…·é—ªçƒ              â”‚
â”‚                          â”‚
â”‚ âœ… æ‰€æœ‰è§’è‰²éƒ½åœ¨åŠ¨ï¼      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä½ ä¼šçœ‹åˆ°ï¼š**
- âœ… ç©å®¶æ ¹æ®æ“ä½œæ’­æ”¾ä¸åŒåŠ¨ç”»ï¼ˆç«™ç«‹ã€è¡Œèµ°ã€è·³è·ƒã€ä¸‹è½ï¼‰
- âœ… æ•Œäººæ’­æ”¾å„è‡ªçš„å¾…æœº/ç§»åŠ¨åŠ¨ç”»
- âœ… é“å…·æ’­æ”¾é—ªçƒåŠ¨ç”»
- âœ… æ‰€æœ‰åŠ¨ç”»æµç•…å¾ªç¯æ’­æ”¾
- âœ… çŠ¶æ€åˆ‡æ¢æ—¶åŠ¨ç”»è‡ªåŠ¨åˆ‡æ¢

---

## ğŸ¯ ç³»ç»Ÿæ¶æ„æ€»ç»“

### å®Œæ•´çš„åŠ¨ç”»ç³»ç»Ÿæµç¨‹

```
1. Tiled ç¼–è¾‘å™¨
   â†“ å®šä¹‰ animation å±æ€§ï¼ˆJSONï¼‰
2. å›¾å—é›† .tsj æ–‡ä»¶
   â†“ å­˜å‚¨åŠ¨ç”»æ•°æ®
3. LevelLoader
   â†“ è§£æ JSON å­—ç¬¦ä¸²
   â†“ åˆ›å»º Animation å¯¹è±¡
   â†“ æ·»åŠ åˆ° AnimationComponent
4. GameObject
   â†“ æŒæœ‰ AnimationComponent
5. çŠ¶æ€æœºï¼ˆPlayerStateï¼‰
   â†“ enter() è°ƒç”¨ playAnimation()
6. AnimationComponent
   â†“ è®¾ç½® current_animation_
   â†“ update() ç´¯åŠ æ—¶é—´
7. Animation
   â†“ getFrame(time) è®¡ç®—å½“å‰å¸§
8. SpriteComponent
   â†“ setSourceRect() æ›´æ–°æ˜¾ç¤º
9. å±å¹•æ˜¾ç¤º
   â†’ åŠ¨ç”»æ’­æ”¾ï¼
```

### æ ¸å¿ƒæˆå°±

æˆ‘ä»¬æˆåŠŸåœ°ï¼š

1. âœ… **æ•°æ®é©±åŠ¨è®¾è®¡**ï¼šåŠ¨ç”»æ•°æ®åœ¨ Tiled ä¸­å®šä¹‰
2. âœ… **é€šç”¨åŠ¨ç”»ç³»ç»Ÿ**ï¼šAnimation + AnimationComponent
3. âœ… **è‡ªåŠ¨åŠ è½½é…ç½®**ï¼šLevelLoader è§£æå¹¶é…ç½®
4. âœ… **çŠ¶æ€åŠ¨ç”»è”åŠ¨**ï¼šçŠ¶æ€åˆ‡æ¢è‡ªåŠ¨æ’­æ”¾å¯¹åº”åŠ¨ç”»
5. âœ… **ç¨‹åºç¾æœ¯åˆ†ç¦»**ï¼šç¾æœ¯å¯ç‹¬ç«‹è°ƒæ•´åŠ¨ç”»
6. âœ… **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ æ–°åŠ¨ç”»æ— éœ€ä¿®æ”¹ä»£ç 

### ç³»ç»Ÿä¼˜åŠ¿

| ç‰¹æ€§ | è¯´æ˜ | ä¼˜åŠ¿ |
|------|------|------|
| **æ•°æ®é©±åŠ¨** | JSON å®šä¹‰åŠ¨ç”» | å®æ—¶è°ƒæ•´ï¼Œæ— éœ€ç¼–è¯‘ |
| **ç»„ä»¶åŒ–** | AnimationComponent | ä»»ä½•å¯¹è±¡éƒ½å¯æ·»åŠ åŠ¨ç”» |
| **è‡ªåŠ¨åŒ–** | LevelLoader è‡ªåŠ¨é…ç½® | å‡å°‘æ‰‹åŠ¨ä»£ç  |
| **è§£è€¦** | çŠ¶æ€ä¸åŠ¨ç”»åˆ†ç¦» | å„è‡ªç‹¬ç«‹å¼€å‘ |
| **é€šç”¨æ€§** | é€‚ç”¨äºæ‰€æœ‰è§’è‰² | å¤ç”¨æ€§å¼º |

### æ¶æ„å¯¹æ¯”

```
ä¼ ç»Ÿæ–¹å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»£ç ç¡¬ç¼–ç åŠ¨ç”»  â”‚
â”‚ if (state)      â”‚
â”‚   setFrame(0)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
âŒ ä¿®æ”¹éœ€è¦é‡æ–°ç¼–è¯‘
âŒ ç¾æœ¯æ— æ³•ç‹¬ç«‹å·¥ä½œ
âŒ éš¾ä»¥ç®¡ç†

æ•°æ®é©±åŠ¨æ–¹å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tiled å®šä¹‰     â”‚ â† ç¾æœ¯è°ƒæ•´
â”‚ â†“              â”‚
â”‚ è‡ªåŠ¨åŠ è½½       â”‚ â† ç¨‹åºå®ç°
â”‚ â†“              â”‚
â”‚ çŠ¶æ€è”åŠ¨       â”‚ â† è‡ªåŠ¨æ’­æ”¾
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
âœ… æ— éœ€é‡æ–°ç¼–è¯‘
âœ… ç¾æœ¯ç¨‹åºåˆ†ç¦»
âœ… æ˜“äºç®¡ç†æ‰©å±•
```

---

## ğŸ“š æ€»ç»“

æˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ª **å¼ºå¤§ä¸”æ•°æ®é©±åŠ¨çš„åŠ¨ç”»ç³»ç»Ÿ**ï¼

**å…³é”®è¦ç‚¹ï¼š**
- ğŸ¬ åœ¨ Tiled ä¸­ç”¨ JSON å®šä¹‰åŠ¨ç”»æ•°æ®
- ğŸ“¦ Animation ç±»å­˜å‚¨å¸§æ•°æ®å’Œæ—¶é•¿
- ğŸ® AnimationComponent ç®¡ç†å’Œæ’­æ”¾åŠ¨ç”»
- ğŸ”„ LevelLoader è‡ªåŠ¨è§£æå¹¶é…ç½®
- ğŸ¯ çŠ¶æ€æœº enter() è§¦å‘åŠ¨ç”»æ’­æ”¾
- âš¡ æ¯å¸§ update() æ¨è¿›åŠ¨ç”»æ—¶é—´

> ğŸ’¡ **è®¾è®¡å“²å­¦**ï¼šæ•°æ®é©±åŠ¨è®¾è®¡æ˜¯ç°ä»£æ¸¸æˆå¼•æ“çš„æ ¸å¿ƒç†å¿µä¹‹ä¸€ã€‚é€šè¿‡å°†åŠ¨ç”»æ•°æ®ä»ä»£ç ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œæ”¾å…¥å¯è§†åŒ–ç¼–è¾‘å™¨ï¼Œæˆ‘ä»¬å®ç°äº†ç¨‹åºä¸ç­–åˆ’/ç¾æœ¯çš„è§£è€¦ã€‚ç¨‹åºå‘˜åªéœ€è¦å®ç°é€šç”¨çš„åŠ¨ç”»æ’­æ”¾ç³»ç»Ÿï¼Œè€Œç¾æœ¯äººå‘˜å¯ä»¥åœ¨ Tiled ä¸­è‡ªç”±è°ƒæ•´æ¯ä¸ªè§’è‰²çš„åŠ¨ç”»ï¼Œæ— éœ€ç­‰å¾…ç¨‹åºå‘˜ã€‚è¿™ç§å·¥ä½œæµæå¤§åœ°æé«˜äº†å¼€å‘æ•ˆç‡ï¼

---

## ğŸš€ ä¸‹ä¸€æ­¥å±•æœ›

ç°åœ¨æ¸¸æˆä¸–ç•Œå……æ»¡äº†ç”Ÿæœºï¼ä½†è§’è‰²ä¹‹é—´è¿˜æ— æ³•äº¤äº’ï¼š

- â“ å¦‚ä½•å®ç°ç”Ÿå‘½å€¼ç³»ç»Ÿï¼Ÿ
- â“ å¦‚ä½•å¤„ç†è§’è‰²å—ä¼¤å’Œæ­»äº¡ï¼Ÿ
- â“ å¦‚ä½•è®©ç©å®¶ä¸æ•Œäººäº§ç”Ÿäº¤äº’ï¼Ÿ

ä¸‹ä¸€è¯¾ï¼Œæˆ‘ä»¬å°†å®ç° **ç”Ÿå‘½ç»„ä»¶ä¸æ­»ä¼¤çŠ¶æ€**ï¼š

- â¤ï¸ ç”Ÿå‘½å€¼ç³»ç»Ÿ
- ğŸ’¥ ä¼¤å®³å¤„ç†
- âš°ï¸ æ­»äº¡çŠ¶æ€
- ğŸ”„ å—ä¼¤åŠ¨ç”»

è®©æ¸¸æˆçœŸæ­£"ç©"èµ·æ¥ï¼ğŸ®ğŸŒŸ