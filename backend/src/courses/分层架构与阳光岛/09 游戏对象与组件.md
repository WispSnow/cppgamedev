# æ¸¸æˆå¯¹è±¡ä¸ç»„ä»¶

<div class="video-container">
  <div id="bilibili" class="video-content">
    <!-- Bç«™åµŒå…¥ï¼šä½¿ç”¨ https æ˜ç¡®åè®®ï¼ˆé¿å… file:// æˆ– http å¯¼è‡´è¢«æµè§ˆå™¨æ‹¦æˆªï¼‰ -->
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV1d53szuEnL&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

[åœ¨ Bilibili ä¸Šè§‚çœ‹](https://www.bilibili.com/video/BV1d53szuEnL)

## ğŸ“Œ é—®é¢˜èƒŒæ™¯

åœ¨å‰é¢çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å·²ç»æŠŠå¼•æ“çš„åº•å±‚åŸºç¡€è®¾æ–½æ­å»ºå®Œæ¯•ã€‚ç°åœ¨ï¼Œæ˜¯æ—¶å€™æ„å»ºæˆ‘ä»¬æ¸¸æˆä¸–ç•Œçš„"åŸå­"äº†ã€‚åœ¨è¿‡å»çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šä¸ºç©å®¶ã€æ•Œäººã€å­å¼¹åˆ†åˆ«åˆ›å»º `Player` ç±»ã€`Enemy` ç±»ã€`Bullet` ç±»ï¼Œå¹¶é€šè¿‡ç»§æ‰¿æ¥å…±äº«åŠŸèƒ½ã€‚

### âš ï¸ ä¼ ç»Ÿç»§æ‰¿çš„é—®é¢˜

è¿™ç§æ–¹å¼åœ¨é¡¹ç›®å˜å¤§åï¼Œä¼šè¿…é€Ÿæ¼”å˜æˆå¤æ‚æ··ä¹±çš„ **"ç»§æ‰¿ä¹‹ç½‘"**ï¼š

```
Entity (åŸºç±»)
â”œâ”€â”€ MovableEntity
â”‚   â”œâ”€â”€ Player
â”‚   â”‚   â””â”€â”€ PoweredUpPlayer
â”‚   â”œâ”€â”€ Enemy
â”‚   â”‚   â”œâ”€â”€ FlyingEnemy
â”‚   â”‚   â””â”€â”€ WalkingEnemy
â”‚   â””â”€â”€ Projectile
â””â”€â”€ StaticEntity
    â”œâ”€â”€ Wall
    â””â”€â”€ Decoration
```

è¿™ç§è®¾è®¡çš„é—®é¢˜ï¼š
- âŒ åŠŸèƒ½éš¾ä»¥å¤ç”¨ï¼ˆæ¯”å¦‚è®©æ•Œäººä¹Ÿèƒ½"å¼ºåŒ–"ï¼‰
- âŒ ç»§æ‰¿å±‚æ¬¡æ·±ï¼Œä¿®æ”¹å›°éš¾
- âŒ ä»£ç è€¦åˆåº¦é«˜ï¼Œä¸å¤Ÿçµæ´»

æœ¬èŠ‚è¯¾ï¼Œæˆ‘ä»¬å°†å½»åº•æ‹¥æŠ±åœ¨ç¬¬ä¸‰è¯¾ä¸­æå‡ºçš„ **"ç»„åˆä¼˜äºç»§æ‰¿"** çš„è®¾è®¡å“²å­¦ï¼Œæ­å»ºèµ·æ•´ä¸ªå¼•æ“çš„æ ¸å¿ƒâ€”â€”**æ¸¸æˆå¯¹è±¡ï¼ˆGameObjectï¼‰ä¸ç»„ä»¶ï¼ˆComponentï¼‰ç³»ç»Ÿ**ã€‚

---

## 1. æ ¸å¿ƒæ€æƒ³

### ğŸ§© ç»„ä»¶åŒ–è®¾è®¡ï¼ˆComponent-Based Designï¼‰

<img src="https://theorhythm.top/gamedev/SL/SL.039.webp" alt="æ¸¸æˆå¯¹è±¡ä¸ç»„ä»¶" style="display: block; margin: auto; width: 700px;" />

#### GameObjectï¼ˆæ¸¸æˆå¯¹è±¡ï¼‰

å®ƒæœ¬èº«ä¸æ˜¯ä»»ä½•å…·ä½“çš„ä¸œè¥¿ï¼Œä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ª **ç©ºçš„å®¹å™¨** æˆ–ä¸€ä¸ª **"ç§¯æœ¨åº•åº§"**ã€‚

- å®ƒçš„å”¯ä¸€èŒè´£å°±æ˜¯ç®¡ç†ä¸€å †"åŠŸèƒ½æ¨¡å—"
- å®ƒæ‹¥æœ‰ä¸€ä¸ªåå­—ï¼ˆ`name`ï¼‰å’Œæ ‡ç­¾ï¼ˆ`tag`ï¼‰æ¥æ ‡è¯†è‡ªå·±

#### Componentï¼ˆç»„ä»¶ï¼‰

è¿™å°±æ˜¯æˆ‘ä»¬çš„ **"åŠŸèƒ½æ¨¡å—"**ï¼Œæ¯ä¸€å—ç§¯æœ¨ã€‚æ¯ä¸ªç»„ä»¶éƒ½åªè´Ÿè´£ä¸€é¡¹å•ä¸€çš„åŠŸèƒ½ã€‚

### ğŸ’¡ å¦‚ä½•ä½¿ç”¨ç»„ä»¶

| éœ€æ±‚ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| æƒ³è®©ä¸€ä¸ª GameObject æ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼Ÿ | ç»™å®ƒæ·»åŠ ä¸€ä¸ª `SpriteComponent` |
| æƒ³è®©å®ƒæ‹¥æœ‰ç‰©ç†ç‰¹æ€§å¹¶èƒ½ä¸ä¸–ç•Œç¢°æ’ï¼Ÿ | ç»™å®ƒæ·»åŠ ä¸€ä¸ª `PhysicsComponent` |
| æƒ³è®©å®ƒå“åº”ç©å®¶çš„è¾“å…¥ï¼Ÿ | ç»™å®ƒæ·»åŠ ä¸€ä¸ª `PlayerInputComponent` |

### âœ¨ ç»„åˆçš„åŠ›é‡

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬çš„ **"ç©å®¶"** ä¸å†æ˜¯ä¸€ä¸ªå·¨å¤§çš„ `Player` ç±»ï¼Œè€Œæ˜¯ï¼š

```
GameObject("Player")
â”œâ”€â”€ SpriteComponent        // æ˜¾ç¤ºç²¾çµ
â”œâ”€â”€ PhysicsComponent       // ç‰©ç†ç‰¹æ€§
â”œâ”€â”€ PlayerInputComponent   // æ¥æ”¶è¾“å…¥
â”œâ”€â”€ HealthComponent        // ç”Ÿå‘½å€¼
â””â”€â”€ AnimationComponent     // åŠ¨ç”»æ§åˆ¶
```

> ğŸ¯ **è¿™ç§è®¾è®¡çš„çµæ´»æ€§æ˜¯æ— ä¸ä¼¦æ¯”çš„**ï¼šæƒ³åˆ›å»ºä¸€ä¸ª"ä¼šé£çš„æ•Œäºº"ï¼Ÿåªéœ€å¤ç”¨ `SpriteComponent` å’Œ `AIComponent`ï¼Œä¸éœ€è¦å†™æ–°ç±»ï¼

---

## 2. æ–°çš„é¡¹ç›®ç»“æ„

æˆ‘ä»¬å°†åœ¨ `src/engine/` ä¸‹åˆ›å»ºä¸¤ä¸ªæ–°çš„ç›®å½•ï¼Œåˆ†åˆ«ç”¨äºå­˜æ”¾ GameObject å’Œ Component ç›¸å…³çš„ä»£ç ã€‚

```
â””â”€â”€ src/
    â””â”€â”€ engine/
        â”œâ”€â”€ core/          // æ ¸å¿ƒç³»ç»Ÿï¼ˆå·²æœ‰ï¼‰
        â”œâ”€â”€ resource/      // èµ„æºç®¡ç†ï¼ˆå·²æœ‰ï¼‰
        â”œâ”€â”€ render/        // æ¸²æŸ“ç³»ç»Ÿï¼ˆå·²æœ‰ï¼‰
        â”œâ”€â”€ input/         // è¾“å…¥ç®¡ç†ï¼ˆå·²æœ‰ï¼‰
        â”œâ”€â”€ object/        // ğŸ†• æ¸¸æˆå¯¹è±¡
        â”‚   â”œâ”€â”€ game_object.h
        â”‚   â””â”€â”€ game_object.cpp
        â””â”€â”€ component/     // ğŸ†• ç»„ä»¶ç³»ç»Ÿ
            â””â”€â”€ component.h
```

---

## 3. Component åŸºç±»

æˆ‘ä»¬é¦–å…ˆå®šä¹‰æ‰€æœ‰ç»„ä»¶çš„"å§‹ç¥–"â€”â€”`Component` åŸºç±»ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„æŠ½è±¡ç±»ï¼Œå®ƒå®šä¹‰äº†æ‰€æœ‰ç»„ä»¶éƒ½å¿…é¡»éµå®ˆçš„ **"ç”Ÿå‘½å‘¨æœŸ"** çº¦å®šã€‚

### component.h

```cpp
#pragma once
// å‰ç½®å£°æ˜
namespace engine::object {
    class GameObject;
}

namespace engine::component {

/**
 * @brief ç»„ä»¶çš„æŠ½è±¡åŸºç±»ã€‚
 *
 * æ‰€æœ‰å…·ä½“ç»„ä»¶éƒ½åº”ä»æ­¤ç±»ç»§æ‰¿ã€‚
 * å®šä¹‰äº†ç»„ä»¶ç”Ÿå‘½å‘¨æœŸä¸­å¯èƒ½è°ƒç”¨çš„é€šç”¨æ–¹æ³•ã€‚
 */
class Component {
    friend class engine::object::GameObject;        // å®ƒéœ€è¦è°ƒç”¨Componentçš„initæ–¹æ³•

protected:
    engine::object::GameObject* owner_ = nullptr;   ///< @brief æŒ‡å‘æ‹¥æœ‰æ­¤ç»„ä»¶çš„ GameObject

public:
    Component() = default;
    virtual ~Component() = default;         ///< @brief è™šææ„å‡½æ•°ç¡®ä¿æ­£ç¡®æ¸…ç†æ´¾ç”Ÿç±»

    // ç¦æ­¢æ‹·è´å’Œç§»åŠ¨ï¼Œç»„ä»¶é€šå¸¸ä¸åº”è¢«æ‹·è´æˆ–ç§»åŠ¨ï¼ˆæ›´æ”¹owner_å°±ç›¸å½“äºç§»åŠ¨ï¼‰
    Component(const Component&) = delete;
    Component& operator=(const Component&) = delete;
    Component(Component&&) = delete;
    Component& operator=(Component&&) = delete;

    void setOwner(engine::object::GameObject* owner) { owner_ = owner; }    ///< @brief è®¾ç½®æ‹¥æœ‰æ­¤ç»„ä»¶çš„ GameObject
    engine::object::GameObject* getOwner() const { return owner_; }         ///< @brief è·å–æ‹¥æœ‰æ­¤ç»„ä»¶çš„ GameObject

protected:
    // å…³é”®å¾ªç¯å‡½æ•°ï¼Œå…¨éƒ¨è®¾ä¸ºä¿æŠ¤ï¼Œåªæœ‰ GameObject éœ€è¦ï¼ˆå¯ä»¥ï¼‰è°ƒç”¨ (æœªæ¥å°†å…¶ä¸­ä¸€ä¸ªæ”¹ä¸º = 0 ä»¥å®ç°æŠ½è±¡ç±»)
    virtual void init() {}                      ///< @brief ä¿ç•™ä¸¤æ®µåˆå§‹åŒ–çš„æœºåˆ¶ï¼ŒGameObject æ·»åŠ ç»„ä»¶æ—¶è‡ªåŠ¨è°ƒç”¨ï¼Œä¸éœ€è¦å¤–éƒ¨è°ƒç”¨
    virtual void handleInput() {}               ///< @brief å¤„ç†è¾“å…¥
    virtual void update(float) {}               ///< @brief æ›´æ–°
    virtual void render() {}                    ///< @brief æ¸²æŸ“
    virtual void clean() {}                     ///< @brief æ¸…ç†
};

} // namespace engine::component
```

### å…³é”®è®¾è®¡è¯´æ˜

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| `owner_` | ä¸€ä¸ªæŒ‡å‘æ‹¥æœ‰å®ƒçš„ GameObject çš„æŒ‡é’ˆã€‚è¿™è®©ç»„ä»¶å¯ä»¥åœ¨éœ€è¦æ—¶è®¿é—®å®ƒçš„"ä¸»äºº"çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œè·å–ä¸»äººçš„ä½ç½®ï¼‰ |
| `virtual ~Component()` | è™šææ„å‡½æ•°æ˜¯å¿…é¡»çš„ï¼Œä»¥ç¡®ä¿å½“æˆ‘ä»¬é€šè¿‡åŸºç±»æŒ‡é’ˆåˆ é™¤æ´¾ç”Ÿç±»å¯¹è±¡æ—¶ï¼Œèƒ½å¤Ÿæ­£ç¡®åœ°è°ƒç”¨æ´¾ç”Ÿç±»çš„ææ„å‡½æ•° |
| **ç”Ÿå‘½å‘¨æœŸå‡½æ•°** | `init()`, `handleInput()`, `update()`, `render()`, `clean()`ã€‚è¿™äº›è™šå‡½æ•°å°†è¢« GameObject åœ¨é€‚å½“çš„æ—¶å€™ï¼ˆå¦‚ä¸»å¾ªç¯çš„ä¸åŒé˜¶æ®µï¼‰è°ƒç”¨ |
| `protected` | æˆ‘ä»¬æŠŠç”Ÿå‘½å‘¨æœŸå‡½æ•°è®¾ä¸º `protected`ï¼Œå› ä¸ºåªæœ‰ GameObject æ‰æœ‰æƒè°ƒç”¨å®ƒä»¬ï¼ˆé€šè¿‡ `friend` å£°æ˜ï¼‰ |

---

## 4. GameObject ç±»ï¼šç»„ä»¶çš„ç®¡ç†è€…

`GameObject` æ˜¯è¿™ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒï¼Œä¹Ÿæ˜¯æŠ€æœ¯ä¸Šæœ€å¤æ‚çš„éƒ¨åˆ†ã€‚å®ƒéœ€è¦èƒ½å¤Ÿ **åŠ¨æ€åœ°ã€ç±»å‹å®‰å…¨åœ°** æ·»åŠ ã€è·å–ã€æ£€æŸ¥å’Œç§»é™¤ä»»ä½•ç±»å‹çš„ç»„ä»¶ã€‚

### game_object.h

è¿™æ˜¯ GameObject çš„å¤´æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«äº†å¤§é‡çš„ **C++ æ¨¡æ¿å…ƒç¼–ç¨‹æŠ€å·§**ï¼Œè®©æˆ‘ä»¬æ¥é€ä¸€è§£æï¼š

```cpp
#pragma once
#include "../component/component.h" 
#include <memory>
#include <unordered_map>
#include <typeindex>        // ç”¨äºç±»å‹ç´¢å¼•
#include <utility>          // ç”¨äºå®Œç¾è½¬å‘
#include <spdlog/spdlog.h>

namespace engine::object {

/**
 * @brief æ¸¸æˆå¯¹è±¡ç±»ï¼Œè´Ÿè´£ç®¡ç†æ¸¸æˆå¯¹è±¡çš„ç»„ä»¶ã€‚
 * 
 * è¯¥ç±»ç®¡ç†æ¸¸æˆå¯¹è±¡çš„ç»„ä»¶ï¼Œå¹¶æä¾›æ·»åŠ ã€è·å–ã€æ£€æŸ¥å’Œç§»é™¤ç»„ä»¶çš„åŠŸèƒ½ã€‚
 * å®ƒè¿˜æä¾›æ›´æ–°å’Œæ¸²æŸ“æ¸¸æˆå¯¹è±¡çš„æ–¹æ³•ã€‚
 */
class GameObject final {
private:
    std::string name_;          ///< @brief åç§°
    std::string tag_;           ///< @brief æ ‡ç­¾
    std::unordered_map<std::type_index, std::unique_ptr<engine::component::Component>> components_;  ///< @brief ç»„ä»¶åˆ—è¡¨
    bool need_remove_ = false;  ///< @brief å»¶è¿Ÿåˆ é™¤çš„æ ‡è¯†ï¼Œå°†æ¥ç”±åœºæ™¯ç±»è´Ÿè´£åˆ é™¤

public:

    GameObject(const std::string& name = "", const std::string& tag = "");  ///< @brief æ„é€ å‡½æ•°ã€‚é»˜è®¤åç§°ä¸ºç©ºï¼Œæ ‡ç­¾ä¸ºç©º

    // ç¦æ­¢æ‹·è´å’Œç§»åŠ¨ï¼Œç¡®ä¿å”¯ä¸€æ€§ (é€šå¸¸æ¸¸æˆå¯¹è±¡ä¸åº”éšæ„æ‹·è´)
    GameObject(const GameObject&) = delete;
    GameObject& operator=(const GameObject&) = delete;
    GameObject(GameObject&&) = delete;
    GameObject& operator=(GameObject&&) = delete;

    // setters and getters
    void setName(const std::string& name) { name_ = name; }                 ///< @brief è®¾ç½®åç§°
    const std::string& getName() const { return name_; }                    ///< @brief è·å–åç§°
    void setTag(const std::string& tag) { tag_ = tag; }                     ///< @brief è®¾ç½®æ ‡ç­¾
    const std::string& getTag() const { return tag_; }                      ///< @brief è·å–æ ‡ç­¾
    void setNeedRemove(bool need_remove) { need_remove_ = need_remove; }    ///< @brief è®¾ç½®æ˜¯å¦éœ€è¦åˆ é™¤
    bool isNeedRemove() const { return need_remove_; }                      ///< @brief è·å–æ˜¯å¦éœ€è¦åˆ é™¤

    /**
     * @brief æ·»åŠ ç»„ä»¶ (é‡Œé¢ä¼šå®Œæˆç»„ä»¶çš„init())
     * 
     * @tparam T ç»„ä»¶ç±»å‹
     * @tparam Args ç»„ä»¶æ„é€ å‡½æ•°å‚æ•°ç±»å‹
     * @param args ç»„ä»¶æ„é€ å‡½æ•°å‚æ•°
     * @return ç»„ä»¶æŒ‡é’ˆ
     */
    template <typename T, typename... Args>
    T* addComponent(Args&&... args) {
        // æ£€æµ‹ç»„ä»¶æ˜¯å¦åˆæ³•ã€‚  /*  static_assert(condition, message)ï¼šé™æ€æ–­è¨€ï¼Œåœ¨ç¼–è¯‘æœŸæ£€æµ‹ï¼Œæ— ä»»ä½•æ€§èƒ½å½±å“ */
                            /* std::is_base_of<Base, Derived>::value -- åˆ¤æ–­ Base ç±»å‹æ˜¯å¦æ˜¯ Derived ç±»å‹çš„åŸºç±» */
        static_assert(std::is_base_of<engine::component::Component, T>::value, "T å¿…é¡»ç»§æ‰¿è‡ª Component");
        // è·å–ç±»å‹æ ‡è¯†ã€‚     /* typeid(T) -- ç”¨äºè·å–ä¸€ä¸ªè¡¨è¾¾å¼æˆ–ç±»å‹çš„è¿è¡Œæ—¶ç±»å‹ä¿¡æ¯ (RTTI), è¿”å› std::type_info& */
                            /* std::type_index -- é’ˆå¯¹std::type_infoå¯¹è±¡çš„åŒ…è£…å™¨ï¼Œä¸»è¦è®¾è®¡ç”¨æ¥ä½œä¸ºå…³è”å®¹å™¨ï¼ˆå¦‚ std::mapï¼‰çš„é”®ã€‚*/
        auto type_index = std::type_index(typeid(T));
        // å¦‚æœç»„ä»¶å·²ç»å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›ç»„ä»¶æŒ‡é’ˆ
        if (hasComponent<T>()) {
            return getComponent<T>();
        }
        // å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºç»„ä»¶     /* std::forward -- ç”¨äºå®ç°å®Œç¾è½¬å‘ã€‚ä¼ é€’å¤šä¸ªå‚æ•°çš„æ—¶å€™ä½¿ç”¨...æ ‡è¯† */
        auto new_component = std::make_unique<T>(std::forward<Args>(args)...);
        T* ptr = new_component.get();                               // å…ˆè·å–è£¸æŒ‡é’ˆä»¥ä¾¿è¿”å›
        new_component->setOwner(this);                              // è®¾ç½®ç»„ä»¶çš„æ‹¥æœ‰è€…
        components_[type_index] = std::move(new_component);         // ç§»åŠ¨ç»„ä»¶   ï¼ˆnew_component å˜ä¸ºç©ºï¼Œä¸å¯å†ä½¿ç”¨ï¼‰
        ptr->init();                                                // åˆå§‹åŒ–ç»„ä»¶ ï¼ˆå› æ­¤å¿…é¡»ç”¨ptrè€Œä¸èƒ½ç”¨new_componentï¼‰
        spdlog::debug("GameObject::addComponent: {} added component {}", name_, typeid(T).name());
        return ptr;                                                 // è¿”å›éæ‹¥æœ‰æŒ‡é’ˆ
    }

    /**
     * @brief è·å–ç»„ä»¶
     * 
     * @tparam T ç»„ä»¶ç±»å‹
     * @return ç»„ä»¶æŒ‡é’ˆ
     */
    template <typename T>
    T* getComponent() const {
        static_assert(std::is_base_of<engine::component::Component, T>::value, "T å¿…é¡»ç»§æ‰¿è‡ª Component");
        auto type_index = std::type_index(typeid(T));
        auto it = components_.find(type_index);
        if (it != components_.end()) {
            // è¿”å›unique_ptrçš„è£¸æŒ‡é’ˆã€‚(è‚¯å®šæ˜¯Tç±»å‹, static_castå…¶å®å¹¶æ— å¿…è¦ï¼Œä½†ä¿ç•™å¯ä»¥ä½¿æˆ‘ä»¬æ„å›¾æ›´æ¸…æ™°)
            return static_cast<T*>(it->second.get());
        }
        return nullptr;
    }

    /**
     * @brief æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç»„ä»¶
     * 
     * @tparam T ç»„ä»¶ç±»å‹
     * @return æ˜¯å¦å­˜åœ¨ç»„ä»¶
     */
    template <typename T>
    bool hasComponent() const {
        static_assert(std::is_base_of<engine::component::Component, T>::value, "T å¿…é¡»ç»§æ‰¿è‡ª Component");
        // containsæ–¹æ³•ä¸º C++20 æ–°å¢
        return components_.contains(std::type_index(typeid(T)));
    }

    /**
     * @brief ç§»é™¤ç»„ä»¶
     * 
     * @tparam T ç»„ä»¶ç±»å‹
     */
    template <typename T>
    void removeComponent() {
        static_assert(std::is_base_of<engine::component::Component, T>::value, "T å¿…é¡»ç»§æ‰¿è‡ª Component");
        auto type_index = std::type_index(typeid(T));
        auto it = components_.find(type_index);
        if (it != components_.end()) {
            it->second->clean();
            components_.erase(it);
        }
    }

    // å…³é”®å¾ªç¯å‡½æ•°
    void update(float delta_time);                ///< @brief æ›´æ–°æ‰€æœ‰ç»„ä»¶
    void render();                                ///< @brief æ¸²æŸ“æ‰€æœ‰ç»„ä»¶
    void clean();                                 ///< @brief æ¸…ç†æ‰€æœ‰ç»„ä»¶
    void handleInput();                           ///< @brief å¤„ç†è¾“å…¥

};

} // namespace engine::object
```

### ğŸ” å…³é”®æŠ€æœ¯è§£æ

#### 1. ç»„ä»¶å­˜å‚¨

```cpp
std::unordered_map<std::type_index, std::unique_ptr<engine::component::Component>> components_;
```

æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª `unordered_map` æ¥å­˜å‚¨ç»„ä»¶ï¼š

| å…ƒç´  | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| **Key** | `std::type_index` | ä½¿ç”¨ç»„ä»¶çš„ç±»å‹æœ¬èº«ä½œä¸ºé”®ã€‚`std::type_index(typeid(T))` å¯ä»¥ä¸ºä»»ä½•ç±»å‹ `T`ï¼ˆå¦‚ `SpriteComponent`ï¼‰ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ã€å¯å“ˆå¸Œçš„æ ‡è¯† |
| **Value** | `std::unique_ptr<Component>` | GameObject æ‹¥æœ‰å®ƒçš„æ‰€æœ‰ç»„ä»¶ã€‚ä½¿ç”¨ `std::unique_ptr` å¯ä»¥ç¡®ä¿å½“ GameObject è¢«é”€æ¯æ—¶ï¼Œå®ƒæ‰€æ‹¥æœ‰çš„æ‰€æœ‰ç»„ä»¶éƒ½ä¼šè¢«è‡ªåŠ¨ã€å®‰å…¨åœ°é”€æ¯ï¼Œå®Œç¾ç¬¦åˆ RAII åŸåˆ™ |

#### 2. addComponent\<T, ...\>()

è¿™æ˜¯æœ€å…³é”®çš„æ¨¡æ¿å‡½æ•°ï¼š

```cpp
template <typename T, typename... Args>
T* addComponent(Args&&... args);
```

**æ¨¡æ¿å‚æ•°è§£æï¼š**

- `template <typename T, typename... Args>`: è¿™æ˜¯ä¸€ä¸ª **å¯å˜å‚æ•°æ¨¡æ¿**ï¼Œæ„å‘³ç€æˆ‘ä»¬å¯ä»¥ç”¨ä»»æ„æ•°é‡å’Œç±»å‹çš„å‚æ•°æ¥æ„é€ ä¸€ä¸ªç»„ä»¶

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```cpp
// æ— å‚æ•°æ„é€ 
obj.addComponent<HealthComponent>();

// å•å‚æ•°æ„é€ 
obj.addComponent<SpriteComponent>("player.png");

// å¤šå‚æ•°æ„é€ 
obj.addComponent<SpriteComponent>("player.png", rect, layer);
```

**å…³é”®æŠ€æœ¯ï¼š**

| æŠ€æœ¯ | è¯´æ˜ |
|------|------|
| `static_assert(...)` | é™æ€æ–­è¨€ï¼Œåœ¨ç¼–è¯‘æœŸè¿›è¡Œæ£€æŸ¥ã€‚å®ƒç¡®ä¿ä»»ä½•è¯•å›¾æ·»åŠ åˆ° GameObject çš„ç±»å‹ `T` éƒ½å¿…é¡»æ˜¯ `Component` çš„æ´¾ç”Ÿç±»ã€‚å¦‚æœä¸æ˜¯ï¼Œç¼–è¯‘å°†ç›´æ¥å¤±è´¥å¹¶ç»™å‡ºæ˜ç¡®çš„é”™è¯¯ä¿¡æ¯ |
| `std::forward<Args>(args)...` | **å®Œç¾è½¬å‘**ã€‚å®ƒèƒ½å°†å‚æ•°ä»¥åŸå§‹çš„å€¼ç±»åˆ«ï¼ˆå·¦å€¼æˆ–å³å€¼ï¼‰è½¬å‘ç»™ç»„ä»¶çš„æ„é€ å‡½æ•°ï¼Œä¿è¯äº†æ•ˆç‡å’Œæ­£ç¡®æ€§ |

**æ‰§è¡Œæµç¨‹ï¼š**

```
1. æ£€æŸ¥ç»„ä»¶æ˜¯å¦å·²å­˜åœ¨
2. åˆ›å»ºæ–°çš„ unique_ptr
3. è·å–å…¶è£¸æŒ‡é’ˆï¼ˆç”¨äºè¿”å›å’Œè°ƒç”¨ initï¼‰
4. è®¾ç½® owner
5. å°† unique_ptr çš„æ‰€æœ‰æƒç§»åŠ¨åˆ° map ä¸­
6. è°ƒç”¨æ–°ç»„ä»¶çš„ init() æ–¹æ³•
```

#### 3. getComponent\<T\>() & hasComponent\<T\>()

è¿™ä¸¤ä¸ªå‡½æ•°åˆ©ç”¨ `type_index` åœ¨ map ä¸­è¿›è¡Œå¿«é€ŸæŸ¥æ‰¾ï¼š

```cpp
// è·å–ç»„ä»¶
auto* sprite = player->getComponent<SpriteComponent>();
if (sprite) {
    sprite->setTexture("new_texture.png");
}

// æ£€æŸ¥ç»„ä»¶æ˜¯å¦å­˜åœ¨
if (player->hasComponent<HealthComponent>()) {
    // ç©å®¶æœ‰ç”Ÿå‘½å€¼ç³»ç»Ÿ
}
```

---

### game_object.cpp

å®ç°æ–‡ä»¶ç›¸å¯¹ç®€å•ï¼Œå®ƒä¸»è¦è´Ÿè´£å°† GameObject çš„ `update`, `render`, `handleInput` ç­‰è°ƒç”¨ **è½¬å‘** ç»™å®ƒæ‰€æ‹¥æœ‰çš„æ¯ä¸€ä¸ªç»„ä»¶ã€‚

```cpp
#include "game_object.h"
#include "../render/renderer.h"
#include "../input/input_manager.h" 
#include "../render/camera.h"
#include <spdlog/spdlog.h>

namespace engine::object {
GameObject::GameObject(const std::string &name, const std::string &tag): name_(name), tag_(tag)
{
    spdlog::trace("GameObject created: {} {}", name_, tag_);
}

void GameObject::update(float delta_time) {
    // éå†æ‰€æœ‰ç»„ä»¶å¹¶è°ƒç”¨å®ƒä»¬çš„ update æ–¹æ³•
    for (auto& pair : components_) {
        pair.second->update(delta_time);
    }
}

void GameObject::render() {
    // éå†æ‰€æœ‰ç»„ä»¶å¹¶è°ƒç”¨å®ƒä»¬çš„ render æ–¹æ³•
    for (auto& pair : components_) {
        pair.second->render();
    }
}

void GameObject::clean() {
    spdlog::trace("Cleaning GameObject...");
    // éå†æ‰€æœ‰ç»„ä»¶å¹¶è°ƒç”¨å®ƒä»¬çš„ clean æ–¹æ³•
    for (auto& pair : components_) {
        pair.second->clean();
    }
    components_.clear(); // æ¸…ç©º map, unique_ptr ä¼šè‡ªåŠ¨é‡Šæ”¾å†…å­˜
}

void GameObject::handleInput() {
    // éå†æ‰€æœ‰ç»„ä»¶å¹¶è°ƒç”¨å®ƒä»¬çš„ handleInput æ–¹æ³•
    for (auto& pair : components_) {
        pair.second->handleInput();
    }
}


} // namespace engine::object 
```

**å…³é”®ç‚¹ï¼š**
- éå† `components_` è¿™ä¸ª map
- è°ƒç”¨æ¯ä¸ªç»„ä»¶å¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°
- è‡ªåŠ¨ç®¡ç†ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ›å»ºã€é”€æ¯ï¼‰

---

## 5. é›†æˆä¸æµ‹è¯•

æœ€åï¼Œæˆ‘ä»¬åœ¨ `GameApp` ä¸­æ·»åŠ ä¸€ä¸ªç®€å•çš„ `testGameObject()` å‡½æ•°ã€‚

### æµ‹è¯•ä»£ç 

```cpp
// game_app.h
class GameApp final {
private:
    void testGameObject();  // æµ‹è¯•å‡½æ•°å£°æ˜
    // ...
};
```

```cpp
// game_app.cpp
bool GameApp::init() {
    // ...
    testGameObject();
    return true;
}

void GameApp::testGameObject()
{
    engine::object::GameObject game_object("test_game_object");
    game_object.addComponent<engine::component::Component>();
}
```

### âœ… ç¼–è¯‘ä¸è¿è¡Œ

1. ç¡®ä¿ `game_object.cpp` å·²æ·»åŠ åˆ° `CMakeLists.txt`
2. ç¼–è¯‘å¹¶è¿è¡Œé¡¹ç›®
3. åœ¨æ§åˆ¶å°ä¸­ï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š

```
[debug] GameObject::addComponent: test_game_object added component ...
```

è™½ç„¶è¿™ä¸ªç»„ä»¶ä»€ä¹ˆä¹Ÿä¸åšï¼Œä½†è¿™ä¸ªè¿‡ç¨‹èƒ½å¤Ÿå®Œæ•´åœ°æµ‹è¯•æˆ‘ä»¬çš„æ¨¡æ¿å‡½æ•°å’Œæ‰€æœ‰æƒç®¡ç†æœºåˆ¶ã€‚

---

## ğŸ¯ ç³»ç»Ÿæ¶æ„æ€»ç»“

### æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”

| ä¼ ç»Ÿç»§æ‰¿æ–¹å¼ | ç»„ä»¶åŒ–æ–¹å¼ |
|-------------|-----------|
| Player ç±»åŒ…å«æ‰€æœ‰åŠŸèƒ½ | GameObject + å¤šä¸ªç‹¬ç«‹ç»„ä»¶ |
| é€šè¿‡ç»§æ‰¿å…±äº«ä»£ç  | é€šè¿‡ç»„åˆå¤ç”¨ç»„ä»¶ |
| ä¿®æ”¹å›°éš¾ï¼Œç‰µä¸€å‘åŠ¨å…¨èº« | çµæ´»ç»„è£…ï¼Œéšæ„æ­é… |
| ç»§æ‰¿å±‚æ¬¡æ·± | æ‰å¹³åŒ–ç»“æ„ |

### è®¾è®¡ä¼˜åŠ¿

- âœ… **é«˜åº¦çµæ´»**ï¼šä»»æ„ç»„åˆç»„ä»¶åˆ›å»ºä¸åŒå¯¹è±¡
- âœ… **æ˜“äºæ‰©å±•**ï¼šæ–°å¢åŠŸèƒ½åªéœ€æ·»åŠ æ–°ç»„ä»¶
- âœ… **ä»£ç å¤ç”¨**ï¼šç»„ä»¶å¯åœ¨ä¸åŒå¯¹è±¡é—´å…±äº«
- âœ… **è§£è€¦åˆ**ï¼šç»„ä»¶ä¹‹é—´ç›¸äº’ç‹¬ç«‹
- âœ… **ç±»å‹å®‰å…¨**ï¼šç¼–è¯‘æœŸç±»å‹æ£€æŸ¥
- âœ… **å†…å­˜å®‰å…¨**ï¼šRAII åŸåˆ™ï¼Œè‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ

### æœªæ¥å±•æœ›

ä»ä¸‹ä¸€è¯¾å¼€å§‹ï¼Œæˆ‘ä»¬å°†ï¼š

1. åˆ›å»ºå„ç§å…·ä½“çš„ç»„ä»¶ï¼ˆ`SpriteComponent`, `TransformComponent` ç­‰ï¼‰
2. ä¸å†ç›´æ¥åˆ›å»º `Player` æˆ– `Enemy` ç±»
3. é€šè¿‡åˆ›å»º `GameObject` å¹¶ä¸ºå…¶è£…é…ä¸åŒçš„ç»„ä»¶ï¼Œæ¥ **"ç»„è£…"** å‡ºæˆ‘ä»¬æ¸¸æˆä¸–ç•Œä¸­çš„ä¸‡äº‹ä¸‡ç‰©

---

## ğŸ® æ€»ç»“

æˆ‘ä»¬å·²ç»æˆåŠŸåœ°æ­å»ºäº†å¼•æ“ä¸­ **æœ€æ ¸å¿ƒã€æœ€å¼ºå¤§çš„ç³»ç»Ÿ**ï¼

**å…³é”®æˆå°±ï¼š**
- ğŸ—ï¸ å®ç°äº†å®Œæ•´çš„ Component-Based æ¶æ„
- ğŸ”§ æŒæ¡äº† C++ æ¨¡æ¿å…ƒç¼–ç¨‹æŠ€å·§
- ğŸ¯ å»ºç«‹äº†ç±»å‹å®‰å…¨çš„ç»„ä»¶ç®¡ç†ç³»ç»Ÿ
- ğŸš€ ä¸ºæ¸¸æˆå¯¹è±¡çš„åˆ›å»ºå¥ å®šäº†åšå®åŸºç¡€

> ğŸ’¡ **è®¾è®¡å“²å­¦**ï¼š"ç»„åˆä¼˜äºç»§æ‰¿" ä¸ä»…ä»…æ˜¯ä¸€å¥å£å·ï¼Œè€Œæ˜¯æ„å»ºçµæ´»ã€å¯ç»´æŠ¤æ¸¸æˆå¼•æ“çš„æ ¸å¿ƒåŸåˆ™ï¼
