# ç“¦ç‰‡åœ°å›¾å±‚ç¢°æ’è§£æ

<div class="video-container">
  <div id="bilibili" class="video-content">
    <!-- Bç«™åµŒå…¥ï¼šä½¿ç”¨ https æ˜ç¡®åè®®ï¼ˆé¿å… file:// æˆ– http å¯¼è‡´è¢«æµè§ˆå™¨æ‹¦æˆªï¼‰ -->
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV1fDuczzETa&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

[åœ¨ Bilibili ä¸Šè§‚çœ‹](https://www.bilibili.com/video/BV1fDuczzETa)

## ğŸ“Œ é—®é¢˜èƒŒæ™¯

æˆ‘ä»¬å·²ç»æˆåŠŸåœ°è®©ç‰©ç†å¼•æ“èƒ½å¤Ÿæ£€æµ‹åˆ°ç‰©ä½“é—´çš„é‡å ã€‚ç°åœ¨ï¼Œæ˜¯æ—¶å€™è®©è¿™äº›ç¢°æ’ **äº§ç”Ÿå®é™…æ•ˆæœ** äº†ã€‚æœ¬èŠ‚è¯¾æˆ‘ä»¬å°†å®ç° **ç¢°æ’è§£æï¼ˆCollision Resolutionï¼‰**ï¼Œé¦–å…ˆè§£å†³æœ€æ ¸å¿ƒçš„éœ€æ±‚ï¼šè®©åŠ¨æ€çš„æ¸¸æˆå¯¹è±¡èƒ½å¤Ÿä¸é™æ€çš„ç“¦ç‰‡åœ°å›¾å±‚ï¼ˆå¦‚åœ°é¢ã€å¢™å£ï¼‰å‘ç”ŸçœŸå®çš„ç‰©ç†äº¤äº’ï¼Œè€Œä¸æ˜¯ç›´æ¥ç©¿è¿‡å»ã€‚

### âš ï¸ å½“å‰çš„é—®é¢˜

```
ç©¿é€é—®é¢˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ğŸ‘¤             â”‚
â”‚       â†“ ä¸‹è½        â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”        â”‚
â”‚  â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“ ç©¿é€ï¼  â”‚
â”‚      ğŸ‘¤ â† æ‰ä¸‹å»äº†  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¯ æœ¬è¯¾ç›®æ ‡

| ç›®æ ‡ | è¯´æ˜ |
|------|------|
| **å®šä¹‰å®ä½“ç“¦ç‰‡** | åœ¨ Tiled ä¸­æ ‡è®°å“ªäº›ç“¦ç‰‡æ˜¯å¯ç¢°æ’çš„ |
| **è¯»å–ç“¦ç‰‡å±æ€§** | è®©å¼•æ“ç†è§£ç“¦ç‰‡çš„ `solid` å±æ€§ |
| **ç“¦ç‰‡ç¢°æ’æ£€æµ‹** | é«˜æ•ˆæ£€æµ‹åŠ¨æ€å¯¹è±¡ä¸ç“¦ç‰‡çš„ç¢°æ’ |
| **è½´åˆ†ç¦»è§£æ** | åˆ†åˆ«å¤„ç† X å’Œ Y è½´çš„ç¢°æ’ |
| **é€Ÿåº¦æ§åˆ¶** | é€šè¿‡ç‰©ç†å¼•æ“ç»Ÿä¸€ç®¡ç†è¿åŠ¨ |

---

## 1. åœ¨ Tiled ä¸­å®šä¹‰"å®ä½“"

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥å‘Šè¯‰å¼•æ“ï¼Œå“ªäº›ç“¦ç‰‡æ˜¯ **"å®ä½“"ï¼ˆSolidï¼‰**ï¼Œå“ªäº›åªæ˜¯èƒŒæ™¯ã€‚Tiled çš„ **è‡ªå®šä¹‰å±æ€§ï¼ˆCustom Propertiesï¼‰** åŠŸèƒ½å°±æ˜¯ä¸ºæ­¤è€Œç”Ÿçš„ã€‚

### ğŸ“ æ“ä½œæ­¥éª¤

| æ­¥éª¤ | æ“ä½œ |
|------|------|
| **1. æ‰“å¼€å›¾å—é›†** | åœ¨ Tiled ä¸­ï¼Œæ‰“å¼€ä½ çš„å›¾å—é›†ï¼ˆ`.tsj` æ–‡ä»¶ï¼‰ |
| **2. é€‰æ‹©ç“¦ç‰‡** | é€‰æ‹©ä¸€ä¸ªä½ å¸Œæœ›ä½œä¸º"å®ä½“"çš„ç“¦ç‰‡ï¼ˆä¾‹å¦‚ï¼Œä¸€å—è‰åœ°ï¼‰ |
| **3. æ·»åŠ å±æ€§** | åœ¨å·¦ä¾§çš„"å±æ€§"é¢æ¿ä¸­ï¼Œç‚¹å‡»åŠ å·ï¼ˆ+ï¼‰æŒ‰é’®ï¼Œæ·»åŠ ä¸€ä¸ªæ–°å±æ€§ |
| **4. è®¾ç½®å±æ€§** | å°†å±æ€§ç±»å‹è®¾ç½®ä¸º `bool`ï¼Œåç§°è®¾ç½®ä¸º `solid`ï¼Œå¹¶å‹¾é€‰å…¶å€¼ï¼ˆè®¾ç½®ä¸º `true`ï¼‰ |
| **5. ä¿å­˜** | ä¿å­˜å›¾å—é›† |

### JSON ç»“æ„

ä¿å­˜å›¾å—é›†åï¼Œè¿™ä¸ªä¿¡æ¯ä¼šè¢«è®°å½•åœ¨ JSON æ–‡ä»¶ä¸­ï¼š

```json
// tileset.tsj
"tiles": [
    {
        "id": 0,
        "properties": [
            {
                "name": "solid",
                "type": "bool",
                "value": true
            }
        ]
    }
]
```

### å¯è§†åŒ–æ•ˆæœ

```
Tiled ç¼–è¾‘å™¨ä¸­ï¼š
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ âš«â”‚ âšªâ”‚ âš«â”‚ âšªâ”‚  âš« = solid: true (å®ä½“ç“¦ç‰‡)
â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤  âšª = æ™®é€šç“¦ç‰‡ (å¯ç©¿è¿‡)
â”‚ âšªâ”‚ âš«â”‚ âšªâ”‚ âš«â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
```

---

## 2. è¯»å–ç“¦ç‰‡ç±»å‹ï¼ˆLevelLoaderï¼‰

ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦è®© `LevelLoader` èƒ½å¤Ÿè¯»å–å¹¶ç†è§£è¿™ä¸ª `solid` å±æ€§ã€‚

### è§£ææ€è·¯æ›´æ–°

```
Tiled åœ°å›¾è§£ææ€è·¯ï¼ˆæ›´æ–°ï¼‰
    â†“
é€šè¿‡ data æ•°ç»„ä¸­çš„ gid æŸ¥æ‰¾æ‰€éœ€ä¿¡æ¯
    â†“
è·å–å›¾å—é›†ä¸­çš„ "tiles" æ•°ç»„
    â†“
æŸ¥æ‰¾å¯¹åº” tile çš„ "properties" æ•°ç»„
    â†“
è¯»å– "solid" å±æ€§å€¼
    â†“
è®¾ç½® TileInfo çš„ TileType
```

### ç“¦ç‰‡ç±»å‹æšä¸¾

é¦–å…ˆå®šä¹‰ç“¦ç‰‡ç±»å‹ï¼š

```cpp
// engine/component/tile_layer_component.h
namespace engine::component {

enum class TileType {
    NORMAL,     // æ™®é€šç“¦ç‰‡ï¼ˆèƒŒæ™¯ï¼Œä¸ç¢°æ’ï¼‰
    SOLID,      // å®ä½“ç“¦ç‰‡ï¼ˆå¯ç¢°æ’ï¼‰
    // æœªæ¥å¯ä»¥æ·»åŠ æ›´å¤šç±»å‹ï¼Œå¦‚ ONE_WAY_PLATFORM, SPIKE ç­‰
};

struct TileInfo {
    engine::render::Sprite sprite;
    TileType type = TileType::NORMAL;
    
    TileInfo() = default;
    TileInfo(engine::render::Sprite s, TileType t = TileType::NORMAL)
        : sprite(std::move(s)), type(t) {}
};

}
```

---

### engine/scene/level_loader.hï¼ˆæ›´æ–°ï¼‰

```cpp
// ...
namespace engine::component {
struct TileInfo;
enum class TileType; // å‰å‘å£°æ˜
}

class LevelLoader final {
// ...
private:
    // ...
    engine::component::TileType getTileType(const nlohmann::json& tile_json);
    engine::component::TileType getTileTypeById(const nlohmann::json& tileset_json, int local_id);
    engine::component::TileInfo getTileInfoByGid(int gid);
    // ...
};
```

### engine/scene/level_loader.cppï¼ˆæ›´æ–°ï¼‰

```cpp
// ...
engine::component::TileType LevelLoader::getTileType(const nlohmann::json &tile_json)
{
    if (tile_json.contains("properties")) {
        for (const auto& property : tile_json["properties"]) {
            if (property.value("name", "") == "solid") {
                return property.value("value", false) ? engine::component::TileType::SOLID : engine::component::TileType::NORMAL;
            }
        }
    }
    return engine::component::TileType::NORMAL;
}

engine::component::TileType LevelLoader::getTileTypeById(const nlohmann::json &tileset_json, int local_id)
{
    if (tileset_json.contains("tiles")) {
        for (const auto& tile : tileset_json["tiles"]) {
            if (tile.value("id", -1) == local_id) {
                return getTileType(tile);
            }
        }
    }
    return engine::component::TileType::NORMAL;
}

engine::component::TileInfo LevelLoader::getTileInfoByGid(int gid)
{
    // ... (æŸ¥æ‰¾å›¾å—é›†çš„é€»è¾‘ä¸å˜) ...
    // åœ¨æ‰¾åˆ°å¯¹åº”çš„å›¾å—é›†å’Œlocal_idå:
    if (tileset.contains("image")) { // å•ä¸€å›¾ç‰‡å›¾å—é›†
        // ... (è®¡ç®—æºçŸ©å½¢)
        auto tile_type = getTileTypeById(tileset, local_id);
        return engine::component::TileInfo(sprite, tile_type);
    } else { // å¤šå›¾ç‰‡å›¾å—é›†
        // ... (åœ¨tilesæ•°ç»„ä¸­æŸ¥æ‰¾å¯¹åº”çš„tile_json)
        auto tile_type = getTileType(tile_json);
        return engine::component::TileInfo(sprite, tile_type);
    }
    // ...
}
```

### æ–¹æ³•èŒè´£

| æ–¹æ³• | èŒè´£ |
|------|------|
| `getTileType()` | ä»å•ä¸ª tile çš„ JSON ä¸­è§£æ `properties` æ•°ç»„ï¼Œæå– `solid` å±æ€§ |
| `getTileTypeById()` | æ ¹æ® local_id åœ¨å›¾å—é›†çš„ tiles æ•°ç»„ä¸­æŸ¥æ‰¾å¯¹åº”çš„ tileï¼Œç„¶åè°ƒç”¨ `getTileType()` |
| `getTileInfoByGid()` | æ›´æ–°ååœ¨åˆ›å»º `TileInfo` æ—¶èƒ½æ­£ç¡®è®¾ç½® `TileType` |

æˆ‘ä»¬æ·»åŠ äº†ä¸¤ä¸ªè¾…åŠ©å‡½æ•°æ¥è§£æ `properties` æ•°ç»„ï¼Œå¹¶æ›´æ–° `getTileInfoByGid`ï¼Œä½¿å…¶åœ¨åˆ›å»º `TileInfo` æ—¶èƒ½æ­£ç¡®è®¾ç½® `TileType`ã€‚

---

## 3. ç‰©ç†å¼•æ“ä¸ç“¦ç‰‡å±‚çš„äº¤äº’

`PhysicsEngine` éœ€è¦çŸ¥é“å“ªäº› `TileLayerComponent` æ˜¯éœ€è¦å‚ä¸ç¢°æ’æ£€æµ‹çš„ã€‚æˆ‘ä»¬å°†ä¸ºæ­¤æ·»åŠ æ³¨å†Œ/æ³¨é”€æœºåˆ¶ã€‚

### engine/physics/physics_engine.hï¼ˆæ›´æ–°ï¼‰

```cpp
// ...
namespace engine::component {
    class PhysicsComponent;
    class TileLayerComponent; // å‰å‘å£°æ˜
}

class PhysicsEngine {
private:
    // ...
    std::vector<engine::component::TileLayerComponent*> collision_tile_layers_; // æ–°å¢

public:
    // ...
    // æ–°å¢ï¼šæ³¨å†Œ/æ³¨é”€ç¢°æ’ç“¦ç‰‡å±‚
    void registerCollisionLayer(engine::component::TileLayerComponent* layer);
    void unregisterCollisionLayer(engine::component::TileLayerComponent* layer);

private:
    // ...
    // æ–°å¢ï¼šç“¦ç‰‡ç¢°æ’è§£æå‡½æ•°
    void resolveTileCollisions(engine::component::PhysicsComponent* pc, float delta_time);
};
```

### src/game/scene/game_scene.cppï¼ˆæ³¨å†Œå›¾å±‚ï¼‰

```cpp
// ... in GameScene::init()
void GameScene::init() {
    // ... (åŠ è½½å…³å¡) ...

    // æ³¨å†Œ"main"å±‚åˆ°ç‰©ç†å¼•æ“
    auto* main_layer_obj = findGameObjectByName("main");
    if (main_layer_obj) {
        auto* tile_layer_comp = main_layer_obj->getComponent<engine::component::TileLayerComponent>();
        if (tile_layer_comp) {
            context_.getPhysicsEngine().registerCollisionLayer(tile_layer_comp);
            spdlog::info("å·²å°† 'main' å±‚æ³¨å†Œåˆ°ç‰©ç†å¼•æ“è¿›è¡Œç¢°æ’æ£€æµ‹ã€‚");
        }
    }

    // ... (åˆ›å»ºæµ‹è¯•å¯¹è±¡) ...
}
```

### æ³¨å†Œæœºåˆ¶

```
åœºæ™¯åˆå§‹åŒ–
    â†“
æŸ¥æ‰¾åœ°å›¾å›¾å±‚ GameObject
    â†“
è·å– TileLayerComponent
    â†“
æ³¨å†Œåˆ° PhysicsEngine
    â†“
PhysicsEngine ç»´æŠ¤ collision_tile_layers_ åˆ—è¡¨
```

---

## 4. æ ¸å¿ƒï¼šè½´åˆ†ç¦»ç¢°æ’è§£æç®—æ³•

ç°åœ¨åˆ°äº† **æœ€æ ¸å¿ƒçš„éƒ¨åˆ†**ã€‚å½“ä¸€ä¸ªç‰©ä½“å°†è¦ç§»åŠ¨åˆ°ä¸€ä¸ªæ–°ä½ç½®æ—¶ï¼Œæˆ‘ä»¬å¦‚ä½•åˆ¤æ–­å®ƒæ˜¯å¦ä¼šæ’ä¸Šç“¦ç‰‡ï¼Œä»¥åŠå¦‚ä½•é˜»æ­¢å®ƒï¼Ÿ

æˆ‘ä»¬å°†ä½¿ç”¨ä¸€ç§ç»å…¸è€Œé«˜æ•ˆçš„æ–¹æ³•ï¼š**è½´åˆ†ç¦»ç¢°æ’è§£æï¼ˆAxis-Separated Collision Resolutionï¼‰**ã€‚

### ğŸ’¡ æ ¸å¿ƒæ€æƒ³

å°†ç‰©ä½“çš„ç§»åŠ¨åˆ†è§£ä¸º **æ°´å¹³ï¼ˆX è½´ï¼‰** å’Œ **å‚ç›´ï¼ˆY è½´ï¼‰** ä¸¤ä¸ªç‹¬ç«‹çš„éƒ¨åˆ†ï¼š

1. **å…ˆå¤„ç† Y è½´ç¢°æ’**ï¼Œæ ¡æ­£å…¶ä½ç½®
2. **å†ç”¨æ ¡æ­£åçš„ä½ç½®å¤„ç† X è½´ç¢°æ’**

### ä¸ºä»€ä¹ˆè¦åˆ†ç¦»ï¼Ÿ

| ä¸åˆ†ç¦» | è½´åˆ†ç¦» |
|--------|--------|
| âŒ å¯¹è§’ç§»åŠ¨æ—¶éš¾ä»¥åˆ¤æ–­ç¢°æ’æ–¹å‘ | âœ… æ¸…æ™°çš„ç¢°æ’æ–¹å‘åˆ¤æ–­ |
| âŒ å¯èƒ½å‡ºç°"å¡ä½"çš„æƒ…å†µ | âœ… è‡ªç„¶çš„æ»‘å¢™æ•ˆæœ |
| âŒ å¤æ‚çš„ç¢°æ’å“åº”è®¡ç®— | âœ… ç®€å•é«˜æ•ˆçš„ç®—æ³• |

### å¯è§†åŒ–è¯´æ˜

```
ä¸åˆ†ç¦»å¤„ç†ï¼š
  â”Œâ”€â”€â”€â”
  â”‚ â†˜ â”‚ å¯¹è§’ç§»åŠ¨
  â””â”€â”€â”€â”˜
     â–“â–“  æ’å¢™ â†’ å¡ä½ï¼

è½´åˆ†ç¦»å¤„ç†ï¼š
  â”Œâ”€â”€â”€â”
  â”‚ â†“ â”‚ 1. å…ˆå¤„ç†Yè½´
  â””â”€â”€â”€â”˜
  â”â”â”â”  è½åœ°ï¼
  â–“â–“â–“â–“
  
  â”Œâ”€â”€â”€â”
  â”‚ â†’ â”‚ 2. å†å¤„ç†Xè½´
  â””â”€â”€â”€â”˜
  â–“     æ’å¢™ â†’ åœæ­¢Xç§»åŠ¨ï¼Œä½†ç»§ç»­Yç§»åŠ¨ï¼ˆæ»‘å¢™ï¼‰
```

---

### ç®—æ³•è¯¦è§£

#### æ£€æµ‹ç‚¹ç­–ç•¥

| ç§»åŠ¨æ–¹å‘ | æ£€æµ‹ç‚¹ | åŸå›  |
|---------|--------|------|
| **å‘ä¸‹ç§»åŠ¨** | å·¦ä¸‹è§’ + å³ä¸‹è§’ | æ£€æµ‹è„šä¸‹çš„ç“¦ç‰‡ |
| **å‘ä¸Šç§»åŠ¨** | å·¦ä¸Šè§’ + å³ä¸Šè§’ | æ£€æµ‹å¤´é¡¶çš„ç“¦ç‰‡ |
| **å‘å³ç§»åŠ¨** | å³ä¸Šè§’ + å³ä¸‹è§’ | æ£€æµ‹å³ä¾§çš„ç“¦ç‰‡ |
| **å‘å·¦ç§»åŠ¨** | å·¦ä¸Šè§’ + å·¦ä¸‹è§’ | æ£€æµ‹å·¦ä¾§çš„ç“¦ç‰‡ |

#### ç“¦ç‰‡åæ ‡è®¡ç®—

```
ä¸–ç•Œåæ ‡ â†’ ç“¦ç‰‡åæ ‡
tile_x = floor(world_x / tile_size_x)
tile_y = floor(world_y / tile_size_y)

ç¤ºä¾‹ï¼š
ç‰©ä½“ä½ç½® = (135, 250)
ç“¦ç‰‡å°ºå¯¸ = (32, 32)
ç“¦ç‰‡åæ ‡ = (floor(135/32), floor(250/32)) = (4, 7)
```

---

### engine/physics/physics_engine.cppï¼ˆæ ¸å¿ƒé€»è¾‘æ›´æ–°ï¼‰

```cpp
void PhysicsEngine::update(float delta_time) {
    collision_pairs_.clear();

    for (auto* pc : components_) {
        if (!pc || !pc->isEnabled()) {
            continue;
        }

        // åº”ç”¨é‡åŠ›
        if (pc->isUseGravity()) {
            pc->addForce(gravity_ * pc->getMass());
        }

        // æ›´æ–°é€Ÿåº¦
        pc->velocity_ += (pc->getForce() / pc->getMass()) * delta_time;
        pc->clearForce();

        // **æ—§çš„ä½ç½®æ›´æ–°é€»è¾‘è¢«ç§»é™¤ï¼Œç§»å…¥ä¸‹é¢çš„è§£æå‡½æ•°ä¸­**
        // tc->translate(pc->velocity_ * delta_time);

        // **æ–°å¢ï¼šå¤„ç†ç“¦ç‰‡å±‚ç¢°æ’**
        resolveTileCollisions(pc, delta_time);
    }
    
    checkObjectCollisions();
}

void PhysicsEngine::resolveTileCollisions(engine::component::PhysicsComponent* pc, float delta_time) {
    auto* obj = pc->getOwner();
    auto* tc = obj ? obj->getComponent<TransformComponent>() : nullptr;
    auto* cc = obj ? obj->getComponent<ColliderComponent>() : nullptr;
    if (!tc || !cc || !cc->isActive() || cc->isTrigger()) return;

    auto world_aabb = cc->getWorldAABB();
    auto obj_pos = world_aabb.position;
    auto obj_size = world_aabb.size;
    auto ds = pc->velocity_ * delta_time; // æ½œåœ¨ä½ç§»
    auto new_obj_pos = obj_pos + ds;      // æ½œåœ¨æ–°ä½ç½®

    for (auto* layer : collision_tile_layers_) {
        auto tile_size = layer->getTileSize();
        auto tolerance = 1.0f; // é¿å…æµ®ç‚¹æ•°è¯¯å·®

        // --- 1. Yè½´ç¢°æ’è§£æ ---
        if (ds.y > 0) { // å‘ä¸‹ç§»åŠ¨
            // æ£€æŸ¥å·¦ä¸‹è§’å’Œå³ä¸‹è§’
            auto tile_y = static_cast<int>(floor((new_obj_pos.y + obj_size.y) / tile_size.y));
            auto tile_x_left = static_cast<int>(floor(obj_pos.x / tile_size.x));
            auto tile_x_right = static_cast<int>(floor((obj_pos.x + obj_size.x - tolerance) / tile_size.x));
            
            if (layer->getTileTypeAt({tile_x_left, tile_y}) == TileType::SOLID || layer->getTileTypeAt({tile_x_right, tile_y}) == TileType::SOLID) {
                new_obj_pos.y = tile_y * tile_size.y - obj_size.y; // åœåœ¨åœ°é¢ä¸Š
                pc->velocity_.y = 0; // å‚ç›´é€Ÿåº¦æ¸…é›¶
            }
        } else if (ds.y < 0) { // å‘ä¸Šç§»åŠ¨
            // ... æ£€æŸ¥å·¦ä¸Šè§’å’Œå³ä¸Šè§’ (é€»è¾‘ç±»ä¼¼) ...
            new_obj_pos.y = (tile_y + 1) * tile_size.y; // é¡¶åœ¨å¤©èŠ±æ¿ä¸Š
            pc->velocity_.y = 0;
        }

        // --- 2. Xè½´ç¢°æ’è§£æ ---
        // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å·²ç»ç»è¿‡Yè½´æ ¡æ­£çš„`new_obj_pos.y`æ¥åšåˆ¤æ–­
        if (ds.x > 0) { // å‘å³ç§»åŠ¨
            // æ£€æŸ¥å³ä¸Šè§’å’Œå³ä¸‹è§’
            auto tile_x = static_cast<int>(floor((new_obj_pos.x + obj_size.x) / tile_size.x));
            auto tile_y_top = static_cast<int>(floor(new_obj_pos.y / tile_size.y));
            auto tile_y_bottom = static_cast<int>(floor((new_obj_pos.y + obj_size.y - tolerance) / tile_size.y));

            if (layer->getTileTypeAt({tile_x, tile_y_top}) == TileType::SOLID || layer->getTileTypeAt({tile_x, tile_y_bottom}) == TileType::SOLID) {
                new_obj_pos.x = tile_x * tile_size.x - obj_size.x; // åœåœ¨å¢™è¾¹
                pc->velocity_.x = 0;
            }
        } else if (ds.x < 0) { // å‘å·¦ç§»åŠ¨
            // ... æ£€æŸ¥å·¦ä¸Šè§’å’Œå·¦ä¸‹è§’ (é€»è¾‘ç±»ä¼¼) ...
            new_obj_pos.x = (tile_x + 1) * tile_size.x; // åœåœ¨å¢™è¾¹
            pc->velocity_.x = 0;
        }
    }

    // --- 3. æ›´æ–°æœ€ç»ˆä½ç½® ---
    tc->setPosition(new_obj_pos);
    pc->velocity_ = glm::clamp(pc->velocity_, -max_speed_, max_speed_);
}
```

### ç®—æ³•æ­¥éª¤è¯¦è§£

<img src="https://theorhythm.top/gamedev/SL/SL.060.webp" alt="ç“¦ç‰‡å±‚ç¢°æ’" style="display: block; margin: auto; width: 700px;" />

| æ­¥éª¤ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| **1. è·å–å½“å‰çŠ¶æ€** | è·å–ç‰©ä½“çš„ç¢°æ’ç›’ã€ä½ç½®ã€å°ºå¯¸ | åŸºç¡€æ•°æ®å‡†å¤‡ |
| **2. è®¡ç®—æ½œåœ¨ä½ç½®** | `new_pos = pos + velocity * dt` | å¦‚æœæ²¡æœ‰ç¢°æ’ä¼šåˆ°è¾¾çš„ä½ç½® |
| **3. Y è½´ç¢°æ’æ£€æµ‹** | æ£€æµ‹è„šä¸‹/å¤´é¡¶çš„ç“¦ç‰‡ | å…ˆå¤„ç†å‚ç›´æ–¹å‘ |
| **4. Y è½´ä½ç½®æ ¡æ­£** | å¦‚æœç¢°æ’ï¼Œè°ƒæ•´ Y åæ ‡å¹¶æ¸…é›¶ Y é€Ÿåº¦ | ç«™åœ¨åœ°é¢æˆ–é¡¶åˆ°å¤©èŠ±æ¿ |
| **5. X è½´ç¢°æ’æ£€æµ‹** | ä½¿ç”¨æ ¡æ­£åçš„ Y åæ ‡æ£€æµ‹å·¦å³ç“¦ç‰‡ | å†å¤„ç†æ°´å¹³æ–¹å‘ |
| **6. X è½´ä½ç½®æ ¡æ­£** | å¦‚æœç¢°æ’ï¼Œè°ƒæ•´ X åæ ‡å¹¶æ¸…é›¶ X é€Ÿåº¦ | è´´å¢™åœæ­¢ |
| **7. åº”ç”¨æœ€ç»ˆä½ç½®** | `setPosition(new_pos)` | æ›´æ–°ç‰©ä½“ä½ç½® |

### å…³é”®ç»†èŠ‚

#### 1. Toleranceï¼ˆå®¹å·®ï¼‰

```cpp
auto tolerance = 1.0f; // é¿å…æµ®ç‚¹æ•°è¯¯å·®
auto tile_x_right = static_cast<int>(floor((obj_pos.x + obj_size.x - tolerance) / tile_size.x));
```

**åŸå› **ï¼šé˜²æ­¢æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜å¯¼è‡´ç‰©ä½“å¡åœ¨ä¸¤ä¸ªç“¦ç‰‡ä¹‹é—´ã€‚

#### 2. ä½ç½®æ ¡æ­£å…¬å¼

```cpp
// å‘ä¸‹ç¢°æ’ï¼šåœåœ¨åœ°é¢ä¸Š
new_obj_pos.y = tile_y * tile_size.y - obj_size.y;

// å‘å³ç¢°æ’ï¼šåœåœ¨å¢™è¾¹
new_obj_pos.x = tile_x * tile_size.x - obj_size.x;
```

**é€»è¾‘**ï¼š
- `tile_y * tile_size.y`ï¼šç“¦ç‰‡é¡¶éƒ¨çš„ä¸–ç•Œåæ ‡
- å‡å»ç‰©ä½“å°ºå¯¸ï¼šå¾—åˆ°ç‰©ä½“å·¦ä¸Šè§’åº”è¯¥åœ¨çš„ä½ç½®

#### 3. é€Ÿåº¦æ¸…é›¶

```cpp
pc->velocity_.y = 0; // è½åœ°æ—¶æ¸…é›¶å‚ç›´é€Ÿåº¦
pc->velocity_.x = 0; // æ’å¢™æ—¶æ¸…é›¶æ°´å¹³é€Ÿåº¦
```

**æ•ˆæœ**ï¼š
- è½åœ°åä¸å†ç»§ç»­ä¸‹æ²‰
- æ’å¢™åå¯ä»¥æ²¿å¢™æ»‘åŠ¨ï¼ˆå¦ä¸€è½´é€Ÿåº¦ä¿ç•™ï¼‰

---

## 5. åˆ‡æ¢åˆ°é€Ÿåº¦æ§åˆ¶

æœ€åï¼Œä¸ºäº†è®©ç‰©ç†å¼•æ“ **å®Œå…¨æ¥ç®¡è¿åŠ¨**ï¼Œæˆ‘ä»¬éœ€è¦æ”¹å˜æµ‹è¯•ä»£ç çš„é€»è¾‘ï¼šä¸å†ç›´æ¥ä¿®æ”¹ `Transform` çš„ä½ç½®ï¼Œè€Œæ˜¯ä¿®æ”¹ `PhysicsComponent` çš„é€Ÿåº¦ã€‚

### src/game/scene/game_scene.cppï¼ˆæ›´æ–°ï¼‰

```cpp
// ...
void GameScene::TestObject()
{
    if (!test_object_) return;
    auto& input_manager = context_.getInputManager();
    auto* pc = test_object_->getComponent<engine::component::PhysicsComponent>();
    if (!pc) return;

    // æ°´å¹³ç§»åŠ¨: ç›´æ¥è®¾ç½®é€Ÿåº¦
    if (input_manager.isActionDown("move_left")) {
        pc->velocity_.x = -100.0f;
    } else if (input_manager.isActionDown("move_right")) {
        pc->velocity_.x = 100.0f;
    } else {
        // æ¨¡æ‹Ÿæ‘©æ“¦åŠ›ï¼Œè®©ç‰©ä½“åœä¸‹æ¥
        pc->velocity_.x *= 0.9f;
    }

    // è·³è·ƒ: ç»™äºˆä¸€ä¸ªå‘ä¸Šçš„ç¬æ—¶é€Ÿåº¦
    if (input_manager.isActionPressed("jump")) {
        pc->velocity_.y = -400.0f;
    }
}
```

### æ§åˆ¶æ–¹å¼å¯¹æ¯”

| æ–¹å¼ | æ—§æ–¹æ³• | æ–°æ–¹æ³• |
|------|--------|--------|
| **ç§»åŠ¨** | ç›´æ¥ä¿®æ”¹ `Transform.position` | è®¾ç½® `Physics.velocity` |
| **è·³è·ƒ** | è®¾ç½®é€Ÿåº¦ï¼ˆå·²æ˜¯æ–°æ–¹æ³•ï¼‰ | è®¾ç½®é€Ÿåº¦ |
| **åœæ­¢** | æ— ï¼ˆæŒç»­ç§»åŠ¨ï¼‰ | æ‘©æ“¦åŠ›æ¨¡æ‹Ÿï¼ˆ`velocity *= 0.9`ï¼‰ |
| **ä¼˜åŠ¿** | ç®€å•ç›´æ¥ | âœ… ç‰©ç†å¼•æ“ç»Ÿä¸€ç®¡ç†<br>âœ… è‡ªåŠ¨å¤„ç†ç¢°æ’<br>âœ… æ›´çœŸå®çš„ç‰©ç†æ•ˆæœ |

### æ‘©æ“¦åŠ›æ¨¡æ‹Ÿ

```cpp
pc->velocity_.x *= 0.9f;
```

**æ•ˆæœ**ï¼š
- æ¯å¸§é€Ÿåº¦è¡°å‡åˆ° 90%
- è®©ç‰©ä½“é€æ¸åœä¸‹æ¥
- æ¨¡æ‹Ÿåœ°é¢æ‘©æ“¦åŠ›

---

## âœ… ç¼–è¯‘ä¸è¿è¡Œ

ç¼–è¯‘å¹¶è¿è¡Œæ¸¸æˆã€‚ä½ ä¼šçœ‹åˆ°ï¼š

```
è¿è¡Œæ•ˆæœï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ğŸ‘¤ â† è·³è·ƒ          â”‚
â”‚      â†‘                   â”‚
â”‚     â†‘                    â”‚
â”‚    â†‘                     â”‚
â”‚   ğŸ‘¤ â† å·¦å³ç§»åŠ¨          â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”            â”‚
â”‚  â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“ â† ä¸å†ç©¿é€ï¼ â”‚
â”‚                          â”‚
â”‚  ç«™åœ¨åœ°é¢ä¸Šäº†ï¼ğŸ‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä½ ä¼šçœ‹åˆ°ï¼š**
- âœ… ç‰©ä½“å—é‡åŠ›ä¸‹è½
- âœ… ç«™åœ¨åœ°é¢ä¸Šä¸å†ç©¿é€
- âœ… è·³è·ƒåè½å›åœ°é¢
- âœ… æ’å¢™æ—¶åœæ­¢æ°´å¹³ç§»åŠ¨
- âœ… å¯ä»¥æ²¿å¢™æ»‘åŠ¨

---

## ğŸ¯ ç³»ç»Ÿæ¶æ„æ€»ç»“

### å®Œæ•´çš„ç¢°æ’è§£ææµç¨‹

```
1. Tiled ç¼–è¾‘å™¨
   â†“ è®¾ç½® solid å±æ€§
2. JSON æ–‡ä»¶
   â†“ LevelLoader è¯»å–
3. TileLayerComponent
   â†“ å­˜å‚¨ TileInfo (åŒ…å« TileType)
4. æ³¨å†Œåˆ° PhysicsEngine
   â†“
5. æ¯å¸§ç‰©ç†æ›´æ–°
   â†“ è®¡ç®—é€Ÿåº¦
6. resolveTileCollisions()
   â†“ Y è½´æ£€æµ‹ â†’ X è½´æ£€æµ‹
7. ä½ç½®æ ¡æ­£ + é€Ÿåº¦æ¸…é›¶
   â†“
8. æ›´æ–° Transform.position
```

### æ ¸å¿ƒæˆå°±

æˆ‘ä»¬æˆåŠŸåœ°ï¼š

1. âœ… **å®šä¹‰å®ä½“ç“¦ç‰‡**ï¼šåœ¨ Tiled ä¸­æ ‡è®°å¯ç¢°æ’ç“¦ç‰‡
2. âœ… **å±æ€§è§£æ**ï¼šè¯»å–å¹¶ç†è§£ç“¦ç‰‡çš„ `solid` å±æ€§
3. âœ… **æ³¨å†Œæœºåˆ¶**ï¼šå°†ç“¦ç‰‡å±‚æ³¨å†Œåˆ°ç‰©ç†å¼•æ“
4. âœ… **è½´åˆ†ç¦»ç®—æ³•**ï¼šå®ç°é«˜æ•ˆçš„ç¢°æ’è§£æ
5. âœ… **é€Ÿåº¦æ§åˆ¶**ï¼šç»Ÿä¸€çš„ç‰©ç†é©±åŠ¨è¿åŠ¨
6. âœ… **çœŸå®äº¤äº’**ï¼šç‰©ä½“ä¸å†ç©¿é€åœ°é¢å’Œå¢™å£

### ç®—æ³•ä¼˜åŠ¿

| ç‰¹æ€§ | è¯´æ˜ | ä¼˜åŠ¿ |
|------|------|------|
| **è½´åˆ†ç¦»** | åˆ†åˆ«å¤„ç† X å’Œ Y è½´ | æ¸…æ™°çš„ç¢°æ’æ–¹å‘ï¼Œè‡ªç„¶çš„æ»‘å¢™æ•ˆæœ |
| **é«˜æ•ˆæ£€æµ‹** | åªæ£€æµ‹ç›¸å…³çš„å‡ ä¸ªç“¦ç‰‡ | O(1) è€Œé O(n)ï¼Œé€‚åˆå¤§åœ°å›¾ |
| **ç²¾ç¡®å®šä½** | ç›´æ¥è®¡ç®—ç“¦ç‰‡åæ ‡ | æ— éœ€éå†æ‰€æœ‰ç“¦ç‰‡ |
| **å®¹å·®å¤„ç†** | é¿å…æµ®ç‚¹æ•°è¯¯å·® | æ›´ç¨³å®šçš„ç¢°æ’ |

### æ€§èƒ½åˆ†æ

```
å¯¹è±¡å±‚ç¢°æ’ï¼šO(nÂ²) - é€‚ç”¨äºå°‘é‡å¯¹è±¡
ç“¦ç‰‡å±‚ç¢°æ’ï¼šO(1)  - æ¯ä¸ªç‰©ä½“åªæ£€æµ‹å‘¨å›´çš„ç“¦ç‰‡

åœ°å›¾è§„æ¨¡ï¼š1000+ ç“¦ç‰‡
æ£€æµ‹æ¬¡æ•°ï¼šâ‰ˆ 4 ä¸ªç“¦ç‰‡/ç‰©ä½“
æ€§èƒ½ï¼šâš¡ æå¿«ï¼
```

---

## ğŸ“š æ€»ç»“

æˆ‘ä»¬å·²ç»å®ç°äº†ç“¦ç‰‡åœ°å›¾å±‚çš„ç¢°æ’è§£æï¼

**å…³é”®è¦ç‚¹ï¼š**
- ğŸ·ï¸ Tiled è‡ªå®šä¹‰å±æ€§æ ‡è®°å®ä½“ç“¦ç‰‡
- ğŸ“– LevelLoader è§£æç“¦ç‰‡ç±»å‹
- ğŸ“ æ³¨å†Œæœºåˆ¶è¿æ¥ç“¦ç‰‡å±‚å’Œç‰©ç†å¼•æ“
- ğŸ”€ è½´åˆ†ç¦»ç®—æ³•æ¸…æ™°å¤„ç†ç¢°æ’
- ğŸ® é€Ÿåº¦æ§åˆ¶å®ç°çœŸå®ç‰©ç†
- âš¡ é«˜æ•ˆæ£€æµ‹é€‚åˆå¤§å‹åœ°å›¾

> ğŸ’¡ **è®¾è®¡å“²å­¦**ï¼šè½´åˆ†ç¦»ç¢°æ’è§£æä¸ä»…é«˜æ•ˆï¼Œè€Œä¸”äº§ç”Ÿçš„ç‰©ç†æ•ˆæœéå¸¸è‡ªç„¶ã€‚è¿™æ˜¯ 2D å¹³å°æ¸¸æˆä¸­æœ€å¸¸ç”¨çš„ç¢°æ’ç®—æ³•ä¹‹ä¸€ï¼Œç®€å•ä½†å¼ºå¤§ï¼

---

## ğŸš€ ä¸‹ä¸€æ­¥å±•æœ›

ç°åœ¨æˆ‘ä»¬çš„ç‰©ä½“å¯ä»¥ä¸ç“¦ç‰‡åœ°å›¾æ­£ç¡®äº¤äº’äº†ï¼ä½†è¿˜æœ‰ä¸€äº›é—®é¢˜ï¼š

- â“ å¦‚æœä¸¤ä¸ªåŠ¨æ€å¯¹è±¡ï¼ˆå¦‚ç©å®¶å’Œæ•Œäººï¼‰ç¢°æ’å‘¢ï¼Ÿ
- â“ å¦‚ä½•å®ç°å•å‘å¹³å°ï¼ˆåªèƒ½ä»ä¸‹æ–¹ç©¿è¿‡ï¼‰ï¼Ÿ
- â“ å¦‚ä½•æ”¯æŒæ–œå¡ï¼Ÿ

ä¸‹ä¸€è¯¾ï¼Œæˆ‘ä»¬å°†å®ç° **åŠ¨æ€å¯¹è±¡ä¹‹é—´çš„ç¢°æ’è§£æ**ï¼š

- ğŸ® ç©å®¶ä¸æ•Œäººçš„ç¢°æ’
- âš”ï¸ æ”»å‡»åˆ¤å®š
- ğŸ’° é“å…·æ‹¾å–

è®©æˆ‘ä»¬ç»§ç»­å®Œå–„è¿™ä¸ªç‰©ç†ä¸–ç•Œï¼ğŸ’¥ğŸ®
