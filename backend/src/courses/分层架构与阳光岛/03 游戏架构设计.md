# 游戏架构设计

<div class="video-container">
  <div id="bilibili" class="video-content">
    <!-- B站嵌入：使用 https 明确协议（避免 file:// 或 http 导致被浏览器拦截） -->
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV126NdzcEz6&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

[在 Bilibili 上观看](https://www.bilibili.com/video/BV126NdzcEz6)

## 📖 概述

万丈高楼平地起，一个优秀、稳固的架构是大型项目成功的基石。在前两节课中，我们已经备齐了所需的"建筑材料"——开发环境和基础库。从今天开始，我们将正式绘制"阳光岛"这座大厦的蓝图。

与前两期教程不同，这次我们不再是简单地堆砌功能，而是要从顶层设计出发，构建一个**清晰、可扩展、可维护**的游戏引擎。本节课不涉及太多代码实现，但其中阐述的思想和原则将贯穿我们整个开发过程，至关重要。

## 🧩 核心设计原则：组合优于继承
### 🤔 继承的问题

在面向对象编程中，我们常常通过"继承"来复用代码和扩展功能。例如，一个 `Player` 类继承自 `Character` 类，一个 `Enemy` 类也继承自 `Character` 类。然而，当游戏变得复杂时，深度的继承关系网会迅速变得混乱不堪，导致"菱形继承"等问题，代码也会变得僵硬、难以修改。

因此，在"阳光岛"项目中，我们将遵循一个更现代、更灵活的设计原则——**组合优于继承 (Composition over Inheritance)**。

### 🎯 组件化设计

我们将引入**组件化设计 (Component-based Design)** 的思想。在这种模式下：

- 📦 **游戏对象 (GameObject)** - 本身只是一个空壳，一个容器。它不包含任何具体的游戏逻辑

- 🔧 **组件 (Component)** - 是负责单一功能的、可复用的模块。例如：
  - `TransformComponent` 负责位置、旋转和缩放
  - `SpriteComponent` 负责渲染精灵图
  - `PhysicsComponent` 负责物理行为

一个游戏对象（比如玩家）的功能，不再是通过继承一个庞大的 `Player` 基类来实现，而是通过向一个空的 `GameObject` 中添加（组合）不同的组件来动态定义。

<img src="https://theorhythm.top/gamedev/SL/SL.016.webp" alt="组合优于继承" style="display: block; margin: auto; width: 700px;" />

### ✨ 设计优势

这种设计的优势显而易见：

- 📐 **扁平化的继承链** - 继承层次非常浅（通常最多一次），避免了复杂继承带来的问题

- 🔄 **高度灵活性** - 想让一个静态的石头拥有物理效果？给它添加一个 `PhysicsComponent` 即可，无需修改石头类的代码。想让敌人能播放动画？给它添加一个 `AnimationComponent`

- ♻️ **高复用性** - `PhysicsComponent` 可以给玩家用，也可以给敌人、移动平台、掉落的道具用

## 🏛️ 宏观蓝图：游戏分层架构
为了让引擎和游戏逻辑解耦，我们将整个项目划分为**四个层次**。这种分层结构确保了每一层只关注自己的职责，使得代码库更加清晰和模块化。

<img src="https://theorhythm.top/gamedev/SL/SL.018.webp" alt="游戏分层架构" style="display: block; margin: auto; width: 700px;" />

### 📚 四个层次详解

#### 1️⃣ 平台抽象层 (Platform Abstraction Layer)

- 📦 **内容** - SDL3、SDL_image、SDL_mixer等第三方底层库
- 🎯 **职责** - 提供与操作系统交互的基础能力，如窗口创建、图形渲染、音频播放、输入处理等
- 🔧 **我们的工作** - 我们不修改这一层，而是直接使用它提供的接口

#### 2️⃣ 引擎核心层 (Engine Core Layer)

- 📦 **内容** - 场景管理、渲染模块、物理引擎、资源管理、UI管理、游戏对象/组件基类等
- 🎯 **职责** - 基于平台抽象层，封装出通用的、与具体游戏玩法无关的功能模块。这一层就像一个装满乐高积木的"工具箱"
- 🔧 **我们的工作** - 这是我们本期课程重点构建的第一部分。我们的目标是让这一层足够通用，理论上可以用它来开发任何类型的2D游戏

#### 3️⃣ 游戏逻辑层 (Game Logic Layer)

- 📦 **内容** - 为"阳光岛"定制的具体场景（如主菜单、游戏关卡）、具体组件（如玩家控制器、敌人AI）、具体游戏对象和游戏数据
- 🎯 **职责** - 使用引擎核心层提供的"积木"，来"搭建"出"阳光岛"这款游戏的具体玩法和逻辑
- 🔧 **我们的工作** - 这是我们重点构建的第二部分。这一层决定了我们的游戏是什么样子，玩起来怎么样

#### 4️⃣ 工具层 (Tool Layer)

- 📦 **内容** - Tiled地图编辑器等外部工具
- 🎯 **职责** - 辅助游戏内容的创作，例如关卡设计。这些工具生成的数据（如JSON格式的地图文件）将被游戏逻辑层读取和使用
- 🔧 **我们的工作** - 我们不开发工具本身，但需要编写代码来解析工具生成的数据

## 🔄 引擎内部结构：模块解耦与协作

在引擎核心层内部，我们还会进一步将功能划分为多个相对独立的模块，并通过清晰的调用流程将它们组织起来。

<img src="https://theorhythm.top/gamedev/SL/SL.020.webp" alt="阳光岛游戏框架" style="display: block; margin: auto; width: 800px;" />

### 🎯 核心流程

上图展示了游戏主循环中三大核心流程（`handleEvent`, `update`, `render`）如何在各个模块间传递：

- 🎮 **Game Class (游戏主类)** - 作为程序的入口和"总指挥"，它拥有主循环，并负责创建和驱动各个管理器

- 🎬 **场景管理 (Scene Manager)** - 负责管理所有场景（Scene），并确保在任何时候只有一个（或多个）场景处于活动状态。它将主循环的调用传递给当前活动的场景

- 🎭 **场景 (Scene Class)** - 一个场景就是一个独立的游戏状态，例如主菜单场景、游戏场景、暂停场景。它拥有一系列游戏对象（GameObject），并将调用分发给每一个对象

- 📦 **游戏对象 (GameObject)** - 将调用进一步分发给它所拥有的每一个组件（Component）

- ⚙️ **独立模块 (Physics / UI)** - 像物理引擎和UI管理器这样的系统，会独立于场景-对象-组件这条主线进行更新。Game类会在主循环的update阶段单独调用物理引擎的update，物理引擎会遍历所有注册给它的物理组件并更新它们的状态。UI系统同理

- 🛠️ **封装的工具模块** - 资源管理、音频播放、渲染模块将被封装成易于使用的单例或全局访问点，供引擎的任何部分调用

### 💡 设计思路

通过这种方式，我们将复杂的系统分解为一系列定义明确、职责单一的类和模块，极大地提升了代码的可读性、可维护性和复用性。

---

## 📋 总结

在开始编写引擎代码之前，让我们再次明确本课程的架构设计思路：

<img src="https://theorhythm.top/gamedev/SL/SL.021.webp" alt="游戏架构设计总结" style="display: block; margin: auto; width: 600px;" />

### 🎯 核心要点

- ✅ **组件化设计** - 通过组合而非继承来构建功能，实现扁平化的继承链

- ✅ **四层架构** - 项目分为清晰的四层架构：
  - 🏗️ 引擎核心层负责提供基础的"积木"
  - 🎮 游戏逻辑层负责用这些"积木"来"搭建"我们的游戏

- ✅ **现代C++规范** - 在整个开发过程中，遵循现代C++的设计规范，如RAII、智能指针、异常安全等，编写出健壮、高效的代码

### 💪 展望

这套架构设计是许多商业游戏引擎的简化版本，但"麻雀虽小，五脏俱全"。掌握了这套思想，你不仅能完成"阳光岛"，更能为你将来构建更复杂、更庞大的游戏世界打下坚实的基础。

### 🔜 下一步

在下一课 **"04 主循环与帧率控制"** 中，我们将着手创建 `Game` 类，实现我们引擎的"心脏"——游戏主循环。