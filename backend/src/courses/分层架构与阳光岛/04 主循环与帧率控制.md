# ä¸»å¾ªç¯ä¸å¸§ç‡æ§åˆ¶

<div class="video-container">
  <div id="bilibili" class="video-content">
    <!-- Bç«™åµŒå…¥ï¼šä½¿ç”¨ https æ˜ç¡®åè®®ï¼ˆé¿å… file:// æˆ– http å¯¼è‡´è¢«æµè§ˆå™¨æ‹¦æˆªï¼‰ -->
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV18TKPzdEE9&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

[åœ¨ Bilibili ä¸Šè§‚çœ‹](https://www.bilibili.com/video/BV18TKPzdEE9)

## ğŸ“– æ¦‚è¿°

ä»æœ¬èŠ‚è¯¾å¼€å§‹ï¼Œæˆ‘ä»¬å°†æ­£å¼ä»é›¶å¼€å§‹ç¼–å†™â€œé˜³å…‰å²›â€é¡¹ç›®çš„ä»£ç ã€‚ç†è®ºçš„è“å›¾å·²ç»ç»˜åˆ¶å®Œæ¯•ï¼Œç°åœ¨æ˜¯æ—¶å€™æ‰“ä¸‹ç¬¬ä¸€è¡Œåœ°åŸºäº†ã€‚æœ¬è¯¾çš„æ ¸å¿ƒä»»åŠ¡æ˜¯æ„å»ºèµ·æ•´ä¸ªæ¸¸æˆçš„â€œå¿ƒè„â€â€”â€”æ¸¸æˆä¸»å¾ªç¯ (Game Loop)ï¼Œå¹¶å®ç°ç¨³å®šçš„å¸§ç‡æ§åˆ¶ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

æˆ‘ä»¬å°†è¯¾ç¨‹åˆ†ä¸ºä¸Šä¸‹ä¸¤éƒ¨åˆ†ï¼š

- **Part 1ï¼šæ„å»ºä¸»å¾ªç¯** - åˆ›å»ºä¸€ä¸ª`GameApp`ç±»ï¼Œè´Ÿè´£åˆå§‹åŒ–SDLã€åˆ›å»ºçª—å£ï¼Œå¹¶è¿è¡Œä¸€ä¸ªåŸºæœ¬çš„ã€èƒ½å¤Ÿå“åº”é€€å‡ºäº‹ä»¶çš„æ¸¸æˆå¾ªç¯ã€‚

- **Part 2ï¼šå®ç°å¸§ç‡æ§åˆ¶** - åœ¨ä¸»å¾ªç¯çš„åŸºç¡€ä¸Šï¼Œç²¾ç¡®è®¡ç®—æ¯å¸§çš„è€—æ—¶ï¼ˆ`delta_time`ï¼‰ï¼Œå¹¶å­¦ä¹ å¦‚ä½•å°†å¸§ç‡ç¨³å®šåœ¨ç›®æ ‡å€¼ï¼ˆå¦‚60 FPSï¼‰ã€‚åˆ¶

## ğŸš€ Part 1ï¼šæ„å»ºä¸»å¾ªç¯

### ğŸ® æ¸¸æˆä¸»å¾ªç¯åŸç†

æ¸¸æˆä¸»å¾ªç¯æ˜¯ä¸€ä¸ªæŒç»­è¿è¡Œçš„å¾ªç¯ï¼Œç›´åˆ°ç©å®¶é€‰æ‹©é€€å‡ºã€‚åœ¨æ¯ä¸€æ¬¡å¾ªç¯ä¸­ï¼Œæ¸¸æˆéƒ½éœ€è¦å¤„ç†ä¸‰ä»¶å¤§äº‹ï¼š

1. **å¤„ç†è¾“å…¥ (Handle Events)** - æ£€æŸ¥ç©å®¶æ˜¯å¦æœ‰ä»»ä½•æ“ä½œï¼Œå¦‚æŒ‰é”®ã€ç§»åŠ¨é¼ æ ‡æˆ–å…³é—­çª—å£
2. **æ›´æ–°çŠ¶æ€ (Update)** - æ ¹æ®è¾“å…¥å’Œæ—¶é—´æµé€ï¼Œæ›´æ–°æ¸¸æˆä¸­æ‰€æœ‰å¯¹è±¡çš„ä½ç½®ã€çŠ¶æ€ç­‰  
3. **æ¸²æŸ“ç”»é¢ (Render)** - å°†æ›´æ–°åçš„æ¸¸æˆä¸–ç•Œç»˜åˆ¶åˆ°å±å¹•ä¸Š

ç°åœ¨ï¼Œè®©æˆ‘ä»¬é€šè¿‡ä»£ç æ¥å®ç°è¿™ä¸ªæ ¸å¿ƒç»“æ„ã€‚

### ğŸ“ æ–°çš„é¡¹ç›®ç»“æ„

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è§„åˆ’å¥½é¡¹ç›®çš„ç›®å½•ç»“æ„ï¼Œä»¥ä¿è¯ä»£ç çš„æ¸…æ™°å’Œæ¨¡å—åŒ–ã€‚åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºå¦‚ä¸‹ç»“æ„ï¼š

```
â””â”€â”€ SunnyLand/
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ engine/
    â”‚   â”‚   â””â”€â”€ core/
    â”‚   â”‚       â”œâ”€â”€ game_app.cpp
    â”‚   â”‚       â””â”€â”€ game_app.h
    â”‚   â””â”€â”€ main.cpp
    â””â”€â”€ CMakeLists.txt
```

#### ğŸ“‚ ç›®å½•è¯´æ˜

- `src/engine/`: è¿™ä¸ªç›®å½•å°†å­˜æ”¾æˆ‘ä»¬æ‰€æœ‰çš„å¼•æ“å±‚ä»£ç 
- `src/engine/core/`: å­˜æ”¾å¼•æ“æœ€æ ¸å¿ƒçš„ç»„ä»¶ï¼Œ`GameApp`å°±æ˜¯ç¬¬ä¸€ä¸ª
- `src/`: `main.cpp`ä½œä¸ºç¨‹åºçš„å…¥å£ï¼Œä¿æŒç®€æ´

### ğŸ’– GameAppç±»ï¼šæ¸¸æˆçš„å¿ƒè„

æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª`GameApp`ç±»ï¼Œå®ƒå°†ä½œä¸ºæ•´ä¸ªåº”ç”¨ç¨‹åºçš„ç®¡ç†è€…ï¼Œå°è£…æ‰€æœ‰ä¸SDLåˆå§‹åŒ–ã€çª—å£ç®¡ç†å’Œä¸»å¾ªç¯ç›¸å…³çš„é€»è¾‘ã€‚

#### ğŸ”§ å¤´æ–‡ä»¶ (game_app.h)

è¿™æ˜¯`GameApp`ç±»çš„å£°æ˜ã€‚å®ƒå®šä¹‰äº†ç±»çš„ç»“æ„å’Œå…¬å…±æ¥å£ã€‚

```CPP
#pragma once

// å‰å‘å£°æ˜, å‡å°‘å¤´æ–‡ä»¶çš„ä¾èµ–ï¼Œå¢åŠ ç¼–è¯‘é€Ÿåº¦
struct SDL_Window;
struct SDL_Renderer;

namespace engine::core {

/**
 * @brief ä¸»æ¸¸æˆåº”ç”¨ç¨‹åºç±»ï¼Œåˆå§‹åŒ–SDLï¼Œç®¡ç†æ¸¸æˆå¾ªç¯ã€‚
 */
class GameApp final {
private:
    SDL_Window* window_ = nullptr;
    SDL_Renderer* sdl_renderer_ = nullptr;
    bool is_running_ = false;

public:
    GameApp();
    ~GameApp();

    /**
     * @brief è¿è¡Œæ¸¸æˆåº”ç”¨ç¨‹åºï¼Œå…¶ä¸­ä¼šè°ƒç”¨init()ï¼Œç„¶åè¿›å…¥ä¸»å¾ªç¯ï¼Œç¦»å¼€å¾ªç¯åè‡ªåŠ¨è°ƒç”¨close()ã€‚
     */
    void run();

    // ç¦æ­¢æ‹·è´å’Œç§»åŠ¨
    GameApp(const GameApp&) = delete;
    GameApp& operator=(const GameApp&) = delete;
    GameApp(GameApp&&) = delete;
    GameApp& operator=(GameApp&&) = delete;

private:
    [[nodiscard]] bool init();
    void handleEvents();
    void update(float delta_time);
    void render();
    void close();
};

} // namespace engine::core
```

##### ğŸ”‘ å…³é”®è®¾è®¡è¦ç‚¹

- **å‰å‘å£°æ˜ (Forward Declaration)** - æˆ‘ä»¬ä½¿ç”¨`struct SDL_Window;`æ¥å‰å‘å£°æ˜SDLçš„ç±»å‹ï¼Œè€Œä¸æ˜¯ç›´æ¥åŒ…å«`<SDL3/SDL.h>`ã€‚è¿™æ ·åšå¯ä»¥å‡å°‘å¤´æ–‡ä»¶ä¾èµ–ï¼ŒåŠ å¿«ç¼–è¯‘é€Ÿåº¦

- **å‘½åç©ºé—´ (Namespace)** - æ‰€æœ‰å¼•æ“ä»£ç éƒ½å°†æ”¾åœ¨`engine`å‘½åç©ºé—´ä¸‹ï¼Œ`core`æ˜¯å…¶å­å‘½åç©ºé—´ï¼Œæœ‰åŠ©äºé¿å…å‘½åå†²çª

- **ç¦æ­¢æ‹·è´/ç§»åŠ¨** - é€šè¿‡`= delete`ï¼Œæˆ‘ä»¬æ˜ç¡®ç¦æ­¢äº†`GameApp`å¯¹è±¡çš„æ‹·è´å’Œç§»åŠ¨ã€‚è¿™æ˜¯ä¸€ç§è‰¯å¥½çš„å®è·µï¼Œå› ä¸ºæˆ‘ä»¬çš„ç¨‹åºä¸­åº”è¯¥åªå­˜åœ¨ä¸€ä¸ª`GameApp`å®ä¾‹

- **ç”Ÿå‘½å‘¨æœŸæ–¹æ³•** - `init`, `handleEvents`, `update`, `render`, `close`è¿™äº›ç§æœ‰æ–¹æ³•æ¸…æ™°åœ°å®šä¹‰äº†æ¸¸æˆå¾ªç¯çš„å„ä¸ªé˜¶æ®µ

#### âš™ï¸ å®ç°æ–‡ä»¶ (game_app.cpp)

è¿™é‡Œæ˜¯`GameApp`ç±»æ–¹æ³•çš„å…·ä½“å®ç°ã€‚

```CPP
#include "game_app.h"
#include <SDL3/SDL.h>
#include <spdlog/spdlog.h>

namespace engine::core {

GameApp::GameApp() = default;

GameApp::~GameApp() {
    if (is_running_) {
        spdlog::warn("GameApp è¢«é”€æ¯æ—¶æ²¡æœ‰æ˜¾å¼å…³é—­ã€‚ç°åœ¨å…³é—­ã€‚ ...");
        close();
    }
}

void GameApp::run() {
    if (!init()) {
        spdlog::error("åˆå§‹åŒ–å¤±è´¥ï¼Œæ— æ³•è¿è¡Œæ¸¸æˆã€‚");
        return;
    }

    while (is_running_) {
        float delta_time = 0.01f; // æ¯å¸§çš„æ—¶é—´é—´éš”ï¼ˆä¸´æ—¶è®¾å®šï¼‰
        handleEvents();
        update(delta_time);
        render();
    }

    close();
}

bool GameApp::init() {
    spdlog::trace("åˆå§‹åŒ– GameApp ...");
    if (!SDL_Init(SDL_INIT_VIDEO | SDL_INIT_AUDIO)) {
        spdlog::error("SDL åˆå§‹åŒ–å¤±è´¥! SDLé”™è¯¯: {}", SDL_GetError());
        return false;
    }

    window_ = SDL_CreateWindow("SunnyLand", 1280, 720, SDL_WINDOW_RESIZABLE);
    if (window_ == nullptr) {
        spdlog::error("æ— æ³•åˆ›å»ºçª—å£! SDLé”™è¯¯: {}", SDL_GetError());
        return false;
    }

    sdl_renderer_ = SDL_CreateRenderer(window_, nullptr);
    if (sdl_renderer_ == nullptr) {
        spdlog::error("æ— æ³•åˆ›å»ºæ¸²æŸ“å™¨! SDLé”™è¯¯: {}", SDL_GetError());
        return false;
    }

    is_running_ = true;
    return true;
}

void GameApp::handleEvents() {
    SDL_Event event;
    while (SDL_PollEvent(&event)) {
        if (event.type == SDL_EVENT_QUIT) {
            is_running_ = false;
        }
    }
}

void GameApp::update(float /* delta_time */) {
    // æ¸¸æˆé€»è¾‘æ›´æ–°ï¼Œæš‚æ—¶ä¸ºç©º
}

void GameApp::render() {
    // æ¸²æŸ“ä»£ç ï¼Œæš‚æ—¶ä¸ºç©º
}

void GameApp::close() {
    spdlog::trace("å…³é—­ GameApp ...");
    if (sdl_renderer_ != nullptr) {
        SDL_DestroyRenderer(sdl_renderer_);
        sdl_renderer_ = nullptr;
    }
    if (window_ != nullptr) {
        SDL_DestroyWindow(window_);
        window_ = nullptr;
    }
    SDL_Quit();
    is_running_ = false;
}

} // namespace engine::core
```

##### ğŸ”„ æ ¸å¿ƒæ–¹æ³•è§£æ

- **æ„é€ /ææ„å‡½æ•°** - æˆ‘ä»¬éµå¾ª**RAII (Resource Acquisition Is Initialization)**åŸåˆ™ã€‚æ„é€ å‡½æ•°ä»€ä¹ˆéƒ½ä¸åšï¼Œä½†ææ„å‡½æ•°ä¼šæ£€æŸ¥æ¸¸æˆæ˜¯å¦ä»åœ¨è¿è¡Œï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨`close()`æ¥ç¡®ä¿èµ„æºè¢«æ­£ç¡®é‡Šæ”¾ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼

- **`run()` æ–¹æ³•** - è¿™æ˜¯ç±»çš„å…¬å…±å…¥å£ç‚¹ã€‚å®ƒé¦–å…ˆè°ƒç”¨`init()`è¿›è¡Œåˆå§‹åŒ–ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™è¿›å…¥`while (is_running_)`ä¸»å¾ªç¯ã€‚å¾ªç¯ç»“æŸï¼ˆå³`is_running_`å˜ä¸ºfalseæ—¶ï¼‰ï¼Œè‡ªåŠ¨è°ƒç”¨`close()`è¿›è¡Œæ¸…ç†

- **`init()` æ–¹æ³•** - è´Ÿè´£æ‰€æœ‰åˆå§‹åŒ–å·¥ä½œã€‚å®ƒåˆå§‹åŒ–SDLçš„è§†é¢‘å’ŒéŸ³é¢‘å­ç³»ç»Ÿï¼Œåˆ›å»ºçª—å£ (`SDL_CreateWindow`) å’Œæ¸²æŸ“å™¨ (`SDL_CreateRenderer`)ã€‚æ¯ä¸€æ­¥æ“ä½œéƒ½ä¼´éšç€ä¸¥æ ¼çš„é”™è¯¯æ£€æŸ¥ï¼Œå¹¶é€šè¿‡spdlogè¾“å‡ºé”™è¯¯ä¿¡æ¯

- **`handleEvents()` æ–¹æ³•** - ä½¿ç”¨`SDL_PollEvent`æ¥è½®è¯¢äº‹ä»¶é˜Ÿåˆ—ã€‚ç›®å‰ï¼Œå®ƒåªå¤„ç†`SDL_EVENT_QUIT`äº‹ä»¶ï¼ˆä¾‹å¦‚ç‚¹å‡»çª—å£çš„å…³é—­æŒ‰é’®ï¼‰ï¼Œæ¥æ”¶åˆ°è¯¥äº‹ä»¶åï¼Œå°†`is_running_`è®¾ç½®ä¸ºfalseï¼Œä»è€Œç»ˆæ­¢ä¸»å¾ªç¯

- **`update()` ä¸ `render()` æ–¹æ³•** - è¿™ä¸¤ä¸ªæ–¹æ³•ç›®å‰æ˜¯ç©ºçš„ã€‚å®ƒä»¬æ˜¯æœªæ¥æ·»åŠ æ¸¸æˆé€»è¾‘å’Œæ¸²æŸ“ä»£ç çš„å ä½ç¬¦ã€‚æ³¨æ„`update`æ–¹æ³•æ¥æ”¶ä¸€ä¸ª`delta_time`å‚æ•°ï¼Œæˆ‘ä»¬æš‚æ—¶ç¡¬ç¼–ç äº†å®ƒçš„å€¼ï¼Œåœ¨ç¬¬äºŒéƒ¨åˆ†ä¼šç²¾ç¡®è®¡ç®—å®ƒ

- **`close()` æ–¹æ³•** - è´Ÿè´£é‡Šæ”¾æ‰€æœ‰åœ¨`init()`ä¸­ç”³è¯·çš„èµ„æºï¼Œé¡ºåºä¸ç”³è¯·æ—¶ç›¸åï¼šå…ˆé”€æ¯æ¸²æŸ“å™¨ï¼Œå†é”€æ¯çª—å£ï¼Œæœ€åè°ƒç”¨`SDL_Quit()`å…³é—­æ•´ä¸ªSDLåº“

### ç¨‹åºå…¥å£ä¸ç¼–è¯‘é…ç½®
main.cpp
ç¨‹åºçš„å…¥å£æ–‡ä»¶éå¸¸ç®€å•ã€‚å®ƒçš„å”¯ä¸€èŒè´£å°±æ˜¯åˆ›å»ºGameAppå¯¹è±¡å¹¶è°ƒç”¨å…¶run()æ–¹æ³•ã€‚
```CPP
#include "engine/core/game_app.h"

int main(int /* argc */, char* /* argv */[]) {
    engine::core::GameApp app;
    app.run();
    return 0;
}
```

CMakeLists.txt
è¿™ä¸ªæ–‡ä»¶å‘Šè¯‰CMakeå¦‚ä½•ç¼–è¯‘æˆ‘ä»¬çš„é¡¹ç›®ã€‚å®ƒè®¾ç½®äº†C++æ ‡å‡†ï¼Œæ‰¾åˆ°äº†æ‰€æœ‰ä¾èµ–çš„åº“ï¼ˆSDL3, spdlogç­‰ï¼‰ï¼Œç„¶åå°†æˆ‘ä»¬çš„æºæ–‡ä»¶ç¼–è¯‘æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶æŠŠæ‰€æœ‰åº“é“¾æ¥è¿›å»ã€‚

```cmake
# æ ‡é¢˜
cmake_minimum_required(VERSION 3.10.0)
project(SunnyLand VERSION 0.1.0 LANGUAGES C CXX)

# è®¾ç½®C++æ ‡å‡†
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED True)

# è®¾ç½®ç¼–è¯‘é€‰é¡¹
if (MSVC)
    add_compile_options(/W4)
else()
    add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# è®¾ç½®ç¼–è¯‘è¾“å‡ºç›®å½•
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY_DEBUG ${CMAKE_SOURCE_DIR})
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY_RELEASE ${CMAKE_SOURCE_DIR})

set(TARGET ${PROJECT_NAME}-${CMAKE_SYSTEM_NAME})

# æŸ¥æ‰¾å¹¶è½½å…¥Cmakeé¢„è®¾
find_package(SDL3 REQUIRED)
find_package(SDL3_image REQUIRED)
find_package(SDL3_mixer REQUIRED)
find_package(SDL3_ttf REQUIRED)
find_package(glm REQUIRED)
find_package(nlohmann_json REQUIRED)
find_package(spdlog REQUIRED)

# æ·»åŠ å¯æ‰§è¡Œæ–‡ä»¶
add_executable(${TARGET} 
                src/main.cpp
                src/engine/core/game_app.cpp
                )

# é“¾æ¥åº“
target_link_libraries(${TARGET}
                        ${SDL3_LIBRARIES}
                        SDL3_image::SDL3_image
                        SDL3_mixer::SDL3_mixer
                        SDL3_ttf::SDL3_ttf
                        glm::glm
                        nlohmann_json::nlohmann_json
                        spdlog::spdlog
                        )
```

### è¿è¡Œä¸æµ‹è¯•
ç°åœ¨ï¼Œé…ç½®å¥½CMakeå¹¶ç¼–è¯‘é¡¹ç›®ã€‚å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªæ ‡é¢˜ä¸ºâ€œSunnyLandâ€ï¼Œå¤§å°ä¸º1280x720çš„ç©ºç™½çª—å£å‡ºç°ã€‚ä½ å¯ä»¥éšæ„æ‹–åŠ¨ã€ç¼©æ”¾å®ƒï¼Œå½“ä½ ç‚¹å‡»å…³é—­æŒ‰é’®æ—¶ï¼Œç¨‹åºä¼šä¼˜é›…åœ°é€€å‡ºï¼Œæ§åˆ¶å°ä¸ä¼šæœ‰ä»»ä½•é”™è¯¯ä¿¡æ¯ã€‚

æˆ‘ä»¬å·²ç»æˆåŠŸåœ°æ„å»ºèµ·äº†æ¸¸æˆå¼•æ“çš„éª¨æ¶ï¼è™½ç„¶å±å¹•ä¸Šè¿˜ç©ºæ— ä¸€ç‰©ï¼Œä½†è¿™ä¸ªç¨³å®šè¿è¡Œçš„ä¸»å¾ªç¯ï¼Œæ˜¯æˆ‘ä»¬æœªæ¥æ·»åŠ æ‰€æœ‰ç²¾å½©åŠŸèƒ½çš„åŸºç¡€ã€‚

åœ¨è¯¾ç¨‹çš„ä¸‹ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†è®©è¿™ä¸ªå¾ªç¯å˜å¾—æ›´åŠ â€œæ™ºèƒ½â€ï¼Œä¸ºå®ƒåŠ ä¸Šç²¾ç¡®çš„å¸§ç‡æ§åˆ¶ã€‚

---

## â±ï¸ Part 2ï¼šå®ç°å¸§ç‡æ§åˆ¶

### âš ï¸ é—®é¢˜åˆ†æ

åœ¨ç¬¬ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬çš„ä¸»å¾ªç¯è™½ç„¶èƒ½è·‘ï¼Œä½†å­˜åœ¨ä¸€ä¸ªä¸¥é‡é—®é¢˜ï¼š`delta_time`è¢«ç¡¬ç¼–ç ä¸ºäº†`0.01f`ã€‚è¿™æ„å‘³ç€æ— è®ºç”µè„‘æ€§èƒ½å¦‚ä½•ï¼Œæˆ‘ä»¬éƒ½å‡è®¾æ¯å¸§èŠ±è´¹å›ºå®šçš„æ—¶é—´ã€‚è¿™ä¼šå¯¼è‡´ï¼š

- ğŸš€ **é«˜æ€§èƒ½ç”µè„‘** - æ¸¸æˆè¿è¡Œè¿‡å¿«
- ğŸŒ **ä½æ€§èƒ½ç”µè„‘** - æ¸¸æˆè¿è¡Œå˜æ…¢

### ğŸ¯ è§£å†³æ–¹æ¡ˆ

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¸å¸§ç‡æ— å…³çš„ç‰©ç†æ›´æ–°ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œå°±å¿…é¡»ç²¾ç¡®æµ‹é‡ä¸Šä¸€å¸§åˆ°å½“å‰å¸§æ‰€ç»è¿‡çš„æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´å°±æ˜¯**DeltaTime**ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ–°çš„æ ¸å¿ƒç±»ï¼š`Time`ã€‚ç‡ç¨³å®šåœ¨ç›®æ ‡å€¼ï¼ˆå¦‚60 FPSï¼‰ã€‚

### ğŸµ 1. Timeç±»ï¼šå¼•æ“çš„èŠ‚æ‹å™¨

`Time`ç±»å°†è´Ÿè´£æ‰€æœ‰ä¸æ—¶é—´ç›¸å…³çš„è®¡ç®—ã€‚å®ƒä¼šåœ¨æ¯å¸§å¼€å§‹æ—¶è¢«è°ƒç”¨ï¼Œè®¡ç®—å‡ºDeltaTimeï¼Œå¹¶æä¾›ä¸€ä¸ªé€‰é¡¹æ¥å°†æ¸¸æˆå¸§ç‡ç¨³å®šåœ¨ä¸€ä¸ªç›®æ ‡å€¼ï¼ˆä¾‹å¦‚144 FPSï¼‰ã€‚

#### ğŸ”§ å¤´æ–‡ä»¶ (time.h)

`Time`ç±»çš„å£°æ˜ï¼Œå®šä¹‰äº†å…¶æ¥å£ã€‚

```CPP
#pragma once
#include <SDL3/SDL_stdinc.h>    // ç”¨äº Uint64

namespace engine::core {

/**
 * @brief ç®¡ç†æ¸¸æˆå¾ªç¯ä¸­çš„æ—¶é—´ï¼Œè®¡ç®—å¸§é—´æ—¶é—´å·® (DeltaTime)ã€‚
 *
 * ä½¿ç”¨ SDL çš„é«˜ç²¾åº¦æ€§èƒ½è®¡æ•°å™¨æ¥ç¡®ä¿æ—¶é—´æµ‹é‡çš„å‡†ç¡®æ€§ã€‚
 * æä¾›è·å–ç¼©æ”¾å’Œæœªç¼©æ”¾ DeltaTime çš„æ–¹æ³•ï¼Œä»¥åŠè®¾ç½®æ—¶é—´ç¼©æ”¾å› å­çš„èƒ½åŠ›ã€‚
 */
class Time final{
private:
    Uint64 last_time_ = 0;         ///< @brief ä¸Šä¸€å¸§çš„æ—¶é—´æˆ³ (ç”¨äºè®¡ç®— delta)
    Uint64 frame_start_time_ = 0;  ///< @brief å½“å‰å¸§å¼€å§‹çš„æ—¶é—´æˆ³ (ç”¨äºå¸§ç‡é™åˆ¶)
    double delta_time_ = 0.0;      ///< @brief æœªç¼©æ”¾çš„å¸§é—´æ—¶é—´å·® (ç§’)
    double time_scale_ = 1.0;      ///< @brief æ—¶é—´ç¼©æ”¾å› å­

    // å¸§ç‡é™åˆ¶ç›¸å…³
    int target_fps_ = 0;             ///< @brief ç›®æ ‡ FPS (0 è¡¨ç¤ºä¸é™åˆ¶)
    double target_frame_time_ = 0.0; ///< @brief ç›®æ ‡æ¯å¸§æ—¶é—´ (ç§’)

public:
    Time();

    // ç®€å•èµ·è§ï¼Œç›´æ¥åˆ é™¤æ‹·è´ã€ç§»åŠ¨å’Œèµ‹å€¼è¿ç®—ç¬¦
    Time(const Time&) = delete;
    Time& operator=(const Time&) = delete;
    Time(Time&&) = delete;
    Time& operator=(Time&&) = delete;

    /**
     * @brief æ¯å¸§å¼€å§‹æ—¶è°ƒç”¨ï¼Œæ›´æ–°å†…éƒ¨æ—¶é—´çŠ¶æ€å¹¶è®¡ç®— DeltaTimeã€‚
     */
    void update();

    /**
     * @brief è·å–ç»è¿‡æ—¶é—´ç¼©æ”¾è°ƒæ•´åçš„å¸§é—´æ—¶é—´å·® (DeltaTime)ã€‚
     *
     * @return double ç¼©æ”¾åçš„ DeltaTime (ç§’)ã€‚
     */
    float getDeltaTime() const;

    /**
     * @brief è·å–æœªç»è¿‡æ—¶é—´ç¼©æ”¾çš„åŸå§‹å¸§é—´æ—¶é—´å·®ã€‚
     *
     * @return double æœªç¼©æ”¾çš„ DeltaTime (ç§’)ã€‚
     */
    float getUnscaledDeltaTime() const;

    /**
     * @brief è®¾ç½®æ—¶é—´ç¼©æ”¾å› å­ã€‚
     *
     * @param scale æ—¶é—´ç¼©æ”¾å€¼ã€‚1.0 ä¸ºæ­£å¸¸é€Ÿåº¦ï¼Œ< 1.0 ä¸ºæ…¢åŠ¨ä½œï¼Œ> 1.0 ä¸ºå¿«è¿›ã€‚
     *              ä¸å…è®¸è´Ÿå€¼ã€‚
     */
    void setTimeScale(float scale);

    /**
     * @brief è·å–å½“å‰çš„æ—¶é—´ç¼©æ”¾å› å­ã€‚
     *
     * @return float å½“å‰çš„æ—¶é—´ç¼©æ”¾å› å­ã€‚
     */
    float getTimeScale() const;

    /**
     * @brief è®¾ç½®ç›®æ ‡å¸§ç‡ã€‚
     *
     * @param fps ç›®æ ‡æ¯ç§’å¸§æ•°ã€‚è®¾ç½®ä¸º 0 è¡¨ç¤ºä¸é™åˆ¶å¸§ç‡ã€‚è´Ÿå€¼å°†è¢«è§†ä¸º 0ã€‚
     */
    void setTargetFps(int fps);

    /**
     * @brief è·å–å½“å‰è®¾ç½®çš„ç›®æ ‡å¸§ç‡ã€‚
     *
     * @return int ç›®æ ‡ FPSï¼Œ0 è¡¨ç¤ºä¸é™åˆ¶ã€‚
     */
    int getTargetFps() const;

private:
    /**
     * @brief update ä¸­è°ƒç”¨ï¼Œç”¨äºé™åˆ¶å¸§ç‡ã€‚å¦‚æœè®¾ç½®äº† target_fps_ > 0ï¼Œä¸”å½“å‰å¸§æ‰§è¡Œæ—¶é—´å°äºç›®æ ‡å¸§æ—¶é—´ï¼Œåˆ™ä¼šè°ƒç”¨ SDL_DelayNS() æ¥ç­‰å¾…å‰©ä½™æ—¶é—´ã€‚
     * 
     * @param current_delta_time å½“å‰å¸§çš„æ‰§è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
     */
    void limitFrameRate(float current_delta_time);
};

} // namespace engine::core
```

##### ğŸ“Š æ ¸å¿ƒåŠŸèƒ½

- å®ƒä¼šè®°å½•ä¸Šä¸€å¸§å’Œå½“å‰å¸§çš„æ—¶é—´æˆ³ï¼Œç”¨äºè®¡ç®—`delta_time_`
- æä¾›äº†`getDeltaTime()`å’Œ`getUnscaledDeltaTime()`ï¼Œå‰è€…å—`time_scale_`å½±å“ï¼ˆç”¨äºå®ç°æ…¢åŠ¨ä½œ/å¿«è¿›ï¼‰ï¼Œåè€…åˆ™è¿”å›åŸå§‹çš„å¸§è€—æ—¶
- æä¾›äº†`setTargetFps()`æ¥è®¾ç½®ç›®æ ‡å¸§ç‡ï¼Œå¦‚æœè®¾ä¸º0åˆ™ä¸é™åˆ¶å¸§ç‡

#### âš™ï¸ å®ç°æ–‡ä»¶ (time.cpp)

`Time`ç±»çš„å…·ä½“å®ç°ã€‚

```CPP
#include "time.h"
#include <spdlog/spdlog.h>
#include <SDL3/SDL_timer.h>    // ç”¨äº SDL_GetTicksNS()

namespace engine::core {

Time::Time() {
    // åˆå§‹åŒ– last_time_ å’Œ frame_start_time_ ä¸ºå½“å‰æ—¶é—´ï¼Œé¿å…ç¬¬ä¸€å¸§ DeltaTime è¿‡å¤§
    last_time_ = SDL_GetTicksNS();
    frame_start_time_ = last_time_;
    spdlog::trace("Time åˆå§‹åŒ–ã€‚Last time: {}", last_time_);
}

void Time::update() {
    
    frame_start_time_ = SDL_GetTicksNS();   // è®°å½•è¿›å…¥ update æ—¶çš„æ—¶é—´æˆ³
    auto current_delta_time = static_cast<double>(frame_start_time_ - last_time_) / 1000000000.0;
    if (target_frame_time_ > 0.0){      // å¦‚æœè®¾ç½®äº†ç›®æ ‡å¸§ç‡ï¼Œåˆ™é™åˆ¶å¸§ç‡ï¼›å¦åˆ™delta_time_ = current_delta_time
        limitFrameRate(current_delta_time);
    } else {
        delta_time_ = current_delta_time;
    }

    last_time_ = SDL_GetTicksNS(); // è®°å½•ç¦»å¼€ update æ—¶çš„æ—¶é—´æˆ³
}

void Time::limitFrameRate(float current_delta_time) {
    // å¦‚æœå½“å‰å¸§è€—è´¹çš„æ—¶é—´å°äºç›®æ ‡å¸§æ—¶é—´ï¼Œåˆ™ç­‰å¾…å‰©ä½™æ—¶é—´
    if (current_delta_time < target_frame_time_) {
        double time_to_wait = target_frame_time_ - current_delta_time;
        Uint64 ns_to_wait = static_cast<Uint64>(time_to_wait * 1000000000.0);
        SDL_DelayNS(ns_to_wait);
        delta_time_ = static_cast<double>(SDL_GetTicksNS() - last_time_) / 1000000000.0;
    }
}

float Time::getDeltaTime() const {
    return delta_time_ * time_scale_;
}

float Time::getUnscaledDeltaTime() const {
    return delta_time_;
}

void Time::setTimeScale(float scale) {
    if (scale < 0.0) {
        spdlog::warn("Time scale ä¸èƒ½ä¸ºè´Ÿã€‚Clamping to 0.");
        scale = 0.0; // é˜²æ­¢è´Ÿæ—¶é—´ç¼©æ”¾
    }
    time_scale_ = scale;
}

float Time::getTimeScale() const {
    return time_scale_;
}

void Time::setTargetFps(int fps) {
    if (fps < 0) {
        spdlog::warn("Target FPS ä¸èƒ½ä¸ºè´Ÿã€‚Setting to 0 (unlimited).");
        target_fps_ = 0;
    } else {
        target_fps_ = fps;
    }

    if (target_fps_ > 0) {
        target_frame_time_ = 1.0 / static_cast<double>(target_fps_);
        spdlog::info("Target FPS è®¾ç½®ä¸º: {} (Frame time: {:.6f}s)", target_fps_, target_frame_time_);
    } else {
        target_frame_time_ = 0.0;
        spdlog::info("Target FPS è®¾ç½®ä¸º: Unlimited");
    }
}

int Time::getTargetFps() const {
    return target_fps_;
}

} // namespace engine::core 
```

##### â° é«˜ç²¾åº¦è®¡æ—¶

æˆ‘ä»¬ä½¿ç”¨`SDL_GetTicksNS()`ï¼Œå®ƒè¿”å›è‡ªSDLåˆå§‹åŒ–ä»¥æ¥çš„çº³ç§’æ•°ï¼ˆ`Uint64`ï¼‰ï¼Œè¿™ä¸ºæˆ‘ä»¬æä¾›äº†éå¸¸é«˜çš„è®¡æ—¶ç²¾åº¦ã€‚

##### ğŸ”„ update() é€»è¾‘

1. è®°å½•å½“å‰æ—¶é—´æˆ³
2. è®¡ç®—å½“å‰å¸§å®é™…èŠ±è´¹çš„æ—¶é—´ `current_delta_time`
3. å¦‚æœè®¾ç½®äº†ç›®æ ‡å¸§ç‡ï¼Œåˆ™è¿›å…¥`limitFrameRate`

##### ğŸ¯ limitFrameRate() é€»è¾‘

1. æ¯”è¾ƒå½“å‰å¸§è€—æ—¶`current_delta_time`å’Œç›®æ ‡å¸§è€—æ—¶`target_frame_time_`
2. å¦‚æœå½“å‰å¸§"è·‘å¾—å¤ªå¿«"ï¼ˆè€—æ—¶æ›´å°‘ï¼‰ï¼Œå°±ç”¨`SDL_DelayNS()`"æš‚åœ"ç¨‹åºï¼Œç­‰å¾…è¡¥è¶³å‰©ä½™çš„æ—¶é—´
3. ç­‰å¾…ç»“æŸåï¼Œé‡æ–°è®¡ç®—æœ€ç»ˆçš„`delta_time_`ï¼Œæ­¤æ—¶å®ƒä¼šéå¸¸æ¥è¿‘`target_frame_time_`

### ğŸ”— 2. å°†Timeé›†æˆåˆ°GameAppä¸­

ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªæ–°çš„`Time`æ¨¡å—é›†æˆåˆ°æˆ‘ä»¬çš„ä¸»åº”ç”¨ç±»ä¸­ã€‚

#### ğŸ“ game_app.h ä¿®æ”¹

åœ¨`GameApp`ä¸­æ·»åŠ ä¸€ä¸ª`std::unique_ptr<engine::core::Time> time_;`æˆå‘˜ã€‚ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ`unique_ptr`å¯ä»¥ç¡®ä¿`Time`å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç”±`GameApp`ç‹¬å ç®¡ç†ï¼Œå¹¶åœ¨`GameApp`é”€æ¯æ—¶è‡ªåŠ¨é‡Šæ”¾å†…å­˜ã€‚

#### ğŸ”§ game_app.cpp ä¿®æ”¹

- åœ¨`GameApp`çš„æ„é€ å‡½æ•°ä¸­ï¼Œåˆ›å»º`Time`çš„å®ä¾‹ï¼š`time_ = std::make_unique<Time>();`
- åœ¨`run()`æ–¹æ³•çš„ä¸»å¾ªç¯ä¸­ï¼Œç”¨ä»¥ä¸‹é€»è¾‘æ›¿æ¢æ‰ç¡¬ç¼–ç çš„`delta_time`ï¼š

```cpp
time_->update();
float delta_time = time_->getDeltaTime();
```

æˆ‘ä»¬è¿˜åœ¨`run()`ä¸­ä¸´æ—¶åŠ å…¥äº†`time_->setTargetFps(144);`æ¥æµ‹è¯•å¸§ç‡é™åˆ¶åŠŸèƒ½ã€‚

### ğŸ”¨ 3. æ›´æ–°CMakeLists.txt

æœ€åï¼Œä¸è¦å¿˜è®°å°†æ–°åˆ›å»ºçš„`time.cpp`æ–‡ä»¶æ·»åŠ åˆ°`CMakeLists.txt`çš„ `add_executable` ä¸­ï¼Œè¿™æ ·CMakeæ‰èƒ½æ‰¾åˆ°å¹¶ç¼–è¯‘å®ƒã€‚

### ğŸ§ª 4. å†æ¬¡è¿è¡Œä¸æµ‹è¯•

é‡æ–°ç¼–è¯‘å¹¶è¿è¡Œé¡¹ç›®ã€‚ä»è§†è§‰ä¸Šçœ‹ï¼Œçª—å£å’Œä¹‹å‰æ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚ä½†ç°åœ¨ï¼Œæˆ‘ä»¬çš„æ¸¸æˆå¾ªç¯å·²ç»æ‹¥æœ‰äº†ä¸€ä¸ªç²¾ç¡®çš„èŠ‚æ‹å™¨ã€‚

#### ğŸ” æµ‹è¯•æ–¹æ³•

ä½ å¯ä»¥å°è¯•åœ¨`game_app.cpp`çš„`run()`å¾ªç¯ä¸­å–æ¶ˆä¸‹é¢è¿™è¡Œä»£ç çš„æ³¨é‡Šï¼š

```cpp
// spdlog::info("delta_time: {}", delta_time);
```

ç„¶åå†æ¬¡è¿è¡Œï¼Œä½ ä¼šçœ‹åˆ°æ§åˆ¶å°ä»¥æå¿«çš„é€Ÿåº¦æ‰“å°å‡ºæ¯å¸§çš„è€—æ—¶ï¼Œè¿™ä¸ªå€¼åº”è¯¥éå¸¸æ¥è¿‘ `1 / 144 â‰ˆ 0.00694` ç§’ã€‚ä½ ä¹Ÿå¯ä»¥å°è¯•å°†`setTargetFps`æ”¹ä¸º60ï¼Œçœ‹çœ‹è¿™ä¸ªå€¼çš„å˜åŒ–ã€‚

### ğŸ‰ æ€»ç»“

è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº†å¼•æ“æœ€æ ¸å¿ƒçš„ä¸¤ä¸ªéƒ¨åˆ†ï¼š**ä¸€ä¸ªå¥å£®çš„ä¸»å¾ªç¯å’Œä¸€ä¸ªç²¾ç¡®çš„å¸§ç‡æ§åˆ¶å™¨**ã€‚æˆ‘ä»¬å·²ç»ä¸ºåç»­æ‰€æœ‰åŠ¨æ€çš„æ¸¸æˆé€»è¾‘æ‰“ä¸‹äº†åšå®çš„æ—¶é—´åŸºç¡€ã€‚