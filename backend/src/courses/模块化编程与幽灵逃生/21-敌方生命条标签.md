# 敌方生命条标签

<link rel="stylesheet" href="/css/videoStyles.css" />

<div class="video-container">
  <div class="video-tabs">
    <a href="#bilibili" class="video-tab bilibili-tab">哔哩哔哩</a>
    <a href="#youtube" class="video-tab youtube-tab">YouTube</a>
  </div>

  <div id="youtube" class="video-content">
    <iframe 
      class="video-frame"
      src="https://www.youtube.com/embed/_Xo6CRwg7ZI?si=2EcHHYM5GRGXjVJ4" 
      frameborder="0" 
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
      allowfullscreen>
    </iframe>
  </div>
  
  <div id="bilibili" class="video-content">
    <iframe 
      class="video-frame"
      src="//player.bilibili.com/player.html?bvid=BV1tKZbYyEuz&page=1&autoplay=0&danmaku=0&high_quality=1" 
      scrolling="no" 
      border="0" 
      frameborder="no" 
      framespacing="0" 
      allowfullscreen="true">
    </iframe>
  </div>
</div>

在游戏中，视觉反馈是玩家理解游戏状态的重要方式。生命值是角色最基本的属性之一，通过直观的生命条显示，玩家可以快速了解敌人的健康状况，从而做出相应的战略决策。在本课中，我们将设计并实现一个生命条组件，用于显示敌人的当前生命值百分比。

<img src="https://theorhythm.top/gamedev/GE/21-敌方生命条标签1.PNG" style='width: 800px;' />

## 一、生命条的设计需求

我们的生命条组件需要满足以下几个基本需求：

1. **动态显示**：实时反映角色当前的生命值百分比
2. **颜色变化**：根据生命值百分比变化颜色，提供直观的视觉反馈
   - 高生命值（>70%）：绿色
   - 中等生命值（30%-70%）：黄色
   - 低生命值（<30%）：红色
3. **位置灵活**：可以附加到任何游戏对象上，并设置相对位置
4. **自动更新**：随着角色生命值的变化自动更新显示

## 二、AffiliateBar组件设计

首先，我们设计一个`AffiliateBar`类作为生命条组件的基础。这个类继承自`ObjectAffiliate`，可以附加到任何游戏对象上。

```cpp
// affiliate_bar.h
#ifndef AFFILIATE_BAR_H
#define AFFILIATE_BAR_H

#include "../core/object_affiliate.h"

class AffiliateBar : public ObjectAffiliate
{
protected:
    float percentage_ = 1.0f;
    SDL_FColor color_high_ = {0, 1, 0, 1};  // 绿色
    SDL_FColor color_mid_ = {1, 0.65, 0, 1};   // 橙色
    SDL_FColor color_low_ = {1, 0, 0, 1};   // 红色

public:
    static AffiliateBar* addAffiliateBarChild(ObjectScreen* parrent, glm::vec2 size, Anchor anchor = Anchor::CENTER);
    virtual void render() override;

    // getters and setters
    float getPercentage() const { return percentage_; }
    void setPercentage(float percentage) { percentage_ = percentage; }

    SDL_FColor getColorHigh() const { return color_high_; }
    void setColorHigh(SDL_FColor color) { color_high_ = color; }
    SDL_FColor getColorMid() const { return color_mid_; }
    void setColorMid(SDL_FColor color) { color_mid_ = color; }
    SDL_FColor getColorLow() const { return color_low_; }
    void setColorLow(SDL_FColor color) { color_low_ = color; }
};

#endif // AFFILIATE_BAR_H
```

`AffiliateBar`类包含以下关键属性：

- `percentage_`：当前显示的百分比值，范围从0到1
- `color_high_`、`color_mid_`、`color_low_`：不同生命值状态对应的颜色

此外，我们声明了一个静态工厂方法`addAffiliateBarChild`和一个`render`方法来实现生命条的渲染。

## 三、AffiliateBar组件实现

接下来，我们实现`AffiliateBar`类的具体功能：

```cpp
// affiliate_bar.cpp
#include "affiliate_bar.h"

AffiliateBar *AffiliateBar::addAffiliateBarChild(ObjectScreen *parrent, glm::vec2 size, Anchor anchor)
{
    auto bar = new AffiliateBar();
    bar->init();
    bar->setAnchor(anchor);
    
    bar->setSize(size);
    if (parrent){
        bar->setParent(parrent);
        parrent->addChild(bar);
    }
    return bar;
}

void AffiliateBar::render()
{
    auto pos = parrent_->getRenderPosition() + offset_;
    if (percentage_ > 0.7f){
        game_.renderHBar(pos, size_, percentage_, color_high_);
    } else if (percentage_ > 0.3f){
        game_.renderHBar(pos, size_, percentage_, color_mid_);
    } else {
        game_.renderHBar(pos, size_, percentage_, color_low_);
    }
}
```

这里我们实现了两个关键方法：

1. **addAffiliateBarChild**：工厂方法，用于创建和初始化一个`AffiliateBar`实例。它设置了父对象、大小和锚点，并将生命条添加为父对象的子对象。

2. **render**：渲染方法，根据当前百分比和对应的颜色渲染生命条。它使用了游戏引擎的`renderHBar`方法来绘制水平条形。

## 四、Game类中添加渲染函数

为了支持生命条的渲染，我们需要在`Game`类中添加一个`renderHBar`方法：

```cpp
// game.h (添加函数声明)
void renderHBar(const glm::vec2& position, const glm::vec2& size, float percent, SDL_FColor color);

// game.cpp (实现函数)
void Game::renderHBar(const glm::vec2 &position, const glm::vec2 &size, float percent, SDL_FColor fcolor)
{
    SDL_SetRenderDrawColorFloat(renderer_, fcolor.r, fcolor.g, fcolor.b, fcolor.a);
    SDL_FRect boundary_rect = {
        position.x,
        position.y,
        size.x,
        size.y
    };
    SDL_FRect fill_rect = {
        position.x,
        position.y,
        size.x * percent,
        size.y
    };
    SDL_RenderRect(renderer_, &boundary_rect);
    SDL_RenderFillRect(renderer_, &fill_rect);
    SDL_SetRenderDrawColorFloat(renderer_, 0, 0, 0, 1);
}
```

`renderHBar`方法接受四个参数：位置、大小、百分比和颜色。它绘制一个边框矩形，然后根据百分比填充内部一部分。这样，当百分比发生变化时，填充的部分也会相应变化，从而实现动态生命条的效果。

## 五、Actor类中集成生命条

为了让所有角色（包括玩家和敌人）都能使用生命条，我们需要在`Actor`类中集成生命条功能：

```cpp
// actor.h（添加成员变量和函数）
protected:
    AffiliateBar* health_bar_ = nullptr;  // 生命条

public:
    virtual void update(float dt) override;
    void setHealthBar(AffiliateBar* health_bar) { health_bar_ = health_bar; }
    AffiliateBar* getHealthBar() const { return health_bar_; }

private:
    void updateHealthBar();
```

```cpp
// actor.cpp（添加函数实现）
#include "actor.h"
#include "scene.h"
#include "../raw/stats.h"
#include "../affiliate/affiliate_bar.h"

void Actor::update(float dt)
{
    ObjectWorld::update(dt);
    updateHealthBar();
}

void Actor::updateHealthBar()
{
    if (!stats_ || !health_bar_) return;
    health_bar_->setPercentage(stats_->getHealth() / stats_->getMaxHealth());
}
```

我们在`Actor`类中添加了一个`health_bar_`成员变量和相关的getter/setter方法。同时，我们添加了`updateHealthBar`方法来实时更新生命条的显示百分比，并在每帧的`update`方法中调用它。

## 六、为敌人添加生命条

最后，我们需要在敌人初始化时创建并设置生命条：

```cpp
// enemy.cpp（修改init方法）
void Enemy::init()
{
    Actor::init();
    
    // ... 其他初始化代码 ...
    
    auto size = anim_normal_->getSize();
    health_bar_ = AffiliateBar::addAffiliateBarChild(this, glm::vec2(size.x - 10, 10), Anchor::BOTTOM_CENTER);
    health_bar_->setOffset(health_bar_->getOffset() + glm::vec2(0, size.y/2.0f - 5.0f));
    
    setType(ObjectType::ENEMY);
}
```

在敌人的`init`方法中，我们创建了一个生命条，并将其添加为敌人的子对象。我们设置了生命条的大小和锚点，并调整了偏移量，使其位于敌人的底部中央位置。

## 七、最终效果

我们的实现使得敌人的生命条可以根据当前生命值实时更新显示，并根据生命值百分比变化颜色。这使得玩家可以直观地了解敌人的健康状况，从而做出更加明智的战略决策。

<img src="https://theorhythm.top/gamedev/GE/21-敌方生命条标签截图.png" style='width: 600px;' />

## 总结

在本课中，我们实现了一个动态的敌方生命条系统：

1. 设计并实现了`AffiliateBar`组件，用于显示生命值百分比
2. 在`Game`类中添加了`renderHBar`方法，用于绘制水平条形
3. 在`Actor`类中集成了生命条功能，实现了自动更新
4. 为敌人添加了生命条，并设置了合适的位置和大小
5. 实现了生命条根据生命值百分比变化颜色的功能

生命条的实现使得游戏更加直观和用户友好，玩家可以通过视觉效果快速了解敌人的状态，从而提升游戏体验。

## 练习

1. **生命条动画**：添加生命值变化的平滑过渡动画
2. **状态标志**：在生命条旁边添加图标，显示角色的特殊状态（如中毒、虚弱等）
3. **垂直生命条**：实现一个垂直方向的生命条