# 最后的完善

<link rel="stylesheet" href="/css/videoStyles.css" />

<div class="video-container">
  <div class="video-tabs">
    <a href="#bilibili" class="video-tab bilibili-tab">哔哩哔哩</a>
    <a href="#youtube" class="video-tab youtube-tab">YouTube</a>
  </div>

  <div id="youtube" class="video-content">
    <iframe 
      class="video-frame"
      src="https://www.youtube.com/embed/beDn1g77Mqg?si=sNwewya6BtRXn5dZ" 
      frameborder="0" 
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
      allowfullscreen>
    </iframe>
  </div>

  <div id="bilibili" class="video-content">
    <iframe 
      class="video-frame"
      src="//player.bilibili.com/player.html?bvid=BV1xZwWeuEgX&page=1&autoplay=0&danmaku=0&high_quality=1" 
      scrolling="no" 
      border="0" 
      frameborder="no" 
      framespacing="0" 
      allowfullscreen="true">
    </iframe>
  </div>
</div>

在前面的章节中，我们已经实现了太空战机游戏的所有核心功能，包括飞机移动、射击、敌机生成、碰撞检测、得分系统、音效播放，以及最近添加的得分榜保存与读取功能。在这最后一章中，我们将对游戏进行一些最终的完善，使其更加用户友好和专业化。

<img src="https://theorhythm.top/gamedev/SS/30 最后的完善.PNG" style='width: 800px;' />

## 游戏界面的完善

### 1. 全屏模式切换

大多数现代游戏都支持在窗口模式和全屏模式之间切换，这使玩家可以根据自己的偏好来选择游戏的显示方式。让我们为我们的游戏添加这一功能。

首先，在`Game`类中添加一个标志来跟踪当前是否处于全屏模式：

```cpp
// Game.h
private:
    // ...其他成员...
    bool isFullscreen = false;
```

然后，在`Game::handleEvent`方法中，添加代码来监听F4键，并在按下时切换全屏模式：

```cpp
void Game::handleEvent(SDL_Event *event)
{
    while (SDL_PollEvent(event))
    {
        if (event->type == SDL_QUIT)
        {
            isRunning = false;
        }
        if (event->type == SDL_KEYDOWN){
            if (event->key.keysym.scancode == SDL_SCANCODE_F4){
                isFullscreen = !isFullscreen;
                if (isFullscreen){
                    SDL_SetWindowFullscreen(window, SDL_WINDOW_FULLSCREEN);
                }else{
                    SDL_SetWindowFullscreen(window, 0);
                }
            }
        }
        currentScene->handleEvent(event);
    }
}
```

这段代码检测F4键的按下，并在每次按下时切换全屏状态。当切换到全屏模式时，我们使用`SDL_SetWindowFullscreen`函数并传入`SDL_WINDOW_FULLSCREEN`标志；当切换回窗口模式时，我们传入0（表示无标志）。

### 2. 保持游戏画面的正确比例

当游戏切换到全屏模式时，一个常见的问题是游戏画面可能会被拉伸或压缩，导致图像失真。为了解决这个问题，我们可以使用SDL的逻辑分辨率功能，确保游戏始终以我们设计的比例显示。

在`Game::init`方法中，在创建渲染器之后，添加以下代码：

```cpp
// 创建渲染器
renderer = SDL_CreateRenderer(window, -1, SDL_RENDERER_ACCELERATED);
if (renderer == nullptr) {
    SDL_LogError(SDL_LOG_CATEGORY_ERROR, "Renderer could not be created! SDL_Error: %s\n", SDL_GetError());
    isRunning = false;
}
// 设置逻辑分辨率
SDL_RenderSetLogicalSize(renderer, windowWidth, windowHeight);
```

`SDL_RenderSetLogicalSize`函数告诉SDL，无论实际窗口或屏幕大小如何，我们都希望以指定的逻辑宽度和高度（在这里是`windowWidth`和`windowHeight`）来渲染内容。这样，当切换到全屏模式时，SDL会自动添加黑边（如有必要）以保持正确的纵横比，而不是拉伸图像。

## 补充结束场景的背景音乐

在之前的章节中，我们实现了主游戏场景和标题场景的背景音乐，但结束场景还没有添加音乐。为了提供完整的游戏体验，我们需要在结束场景中也添加背景音乐。

首先，在`SceneEnd`类中添加一个变量来存储背景音乐：

```cpp
// SceneEnd.h
private:
    // ...其他成员...
    Mix_Music* bgm;
```

然后，在`SceneEnd::init`方法中，载入并播放背景音乐：

```cpp
void SceneEnd::init()
{
    // 载入背景音乐
    bgm = Mix_LoadMUS("assets/music/06_Battle_in_Space_Intro.ogg");
    if (!bgm) {
        SDL_LogError(SDL_LOG_PRIORITY_ERROR, "Failed to load music: %s", Mix_GetError());
    }
    Mix_PlayMusic(bgm, -1);

    if (!SDL_IsTextInputActive()){
        SDL_StartTextInput();
    }
    if (!SDL_IsTextInputActive()){
        SDL_LogError(SDL_LOG_PRIORITY_ERROR, "Failed to start text input: %s", SDL_GetError());
    }
}
```

在这个方法中，我们：
1. 使用`Mix_LoadMUS`函数载入背景音乐文件
2. 检查音乐是否成功载入，如果没有，记录错误
3. 使用`Mix_PlayMusic`函数播放音乐，第二个参数`-1`表示无限循环播放

最后，在`SceneEnd::clean`方法中，停止并释放背景音乐资源：

```cpp
void SceneEnd::clean()
{
    if (bgm != nullptr){
        Mix_HaltMusic();
        Mix_FreeMusic(bgm);
    }
}
```

这个方法做了两件事：
1. 使用`Mix_HaltMusic`函数停止当前正在播放的音乐
2. 使用`Mix_FreeMusic`函数释放音乐资源

通过这些代码，我们确保了当玩家进入结束场景时，会听到背景音乐，增强游戏的氛围。同时，当离开结束场景时，音乐会被正确地停止和清理，避免资源泄漏。

## 游戏开发的最后阶段

在游戏开发的最后阶段，除了添加全屏模式和保持正确比例外，通常还会进行以下工作：

1. **性能优化**：确保游戏在各种硬件上都能流畅运行。
   
2. **错误修复**：彻底测试游戏，修复所有已知的错误和问题。
   
3. **用户界面完善**：确保所有菜单、按钮和提示都清晰易用。
   
4. **游戏平衡调整**：根据测试反馈调整游戏的难度和平衡性。
   
5. **发布准备**：准备发布包、文档和安装说明等。

## 完成效果

通过这些最后的完善，我们的游戏现在更加专业和用户友好：

1. 玩家可以通过按F4键在窗口模式和全屏模式之间切换。
   
2. 无论是在窗口模式还是全屏模式下，游戏画面都保持正确的比例。
   
3. 全屏模式提供了更加沉浸的游戏体验。

4. 所有场景（包括结束场景）都有背景音乐，提供完整的听觉体验。

## 练习

1. 添加一个设置菜单，允许玩家调整音量、全屏模式和其他游戏选项。

2. 实现多种分辨率选项，让玩家可以选择不同的游戏分辨率。

3. 添加一个游戏暂停功能，在玩家按下ESC键时暂停游戏并显示暂停菜单。
