# 键盘控制飞机移动

<link rel="stylesheet" href="/css/videoStyles.css" />

<div class="video-container">
  <div class="video-tabs">
    <a href="#bilibili" class="video-tab bilibili-tab">哔哩哔哩</a>
    <a href="#youtube" class="video-tab youtube-tab">YouTube</a>
  </div>

  <div id="youtube" class="video-content">
    <iframe 
      class="video-frame"
      src="https://www.youtube.com/embed/iF-2W5WgotU?si=5L1YwjJuK-2-GFV8" 
      frameborder="0" 
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
      allowfullscreen>
    </iframe>
  </div>

  <div id="bilibili" class="video-content">
    <iframe 
      class="video-frame"
      src="//player.bilibili.com/player.html?bvid=BV1rn6gY6Ez6&page=1&autoplay=0&danmaku=0&high_quality=1" 
      scrolling="no" 
      border="0" 
      frameborder="no" 
      framespacing="0" 
      allowfullscreen="true">
    </iframe>
  </div>
</div>

在上一课中，我们成功地在游戏窗口中显示了玩家飞机，并将`Game`类改造为单例模式，方便全局访问。然而，目前的飞机只能静态地显示在屏幕上，无法进行任何交互。在这一课中，我们将实现键盘控制，使玩家能够使用键盘移动飞机。

<img src="https://theorhythm.top/gamedev/SS/11 键盘控制飞机移动.PNG" style='width: 800px;' />

## SDL 键盘输入处理

SDL提供了两种主要的键盘输入处理方法：

1. **事件驱动方式**：通过`SDL_Event`处理按键按下和释放事件（`SDL_KEYDOWN`和`SDL_KEYUP`）。
2. **状态查询方式**：通过`SDL_GetKeyboardState()`函数查询当前键盘的状态。

在本课中，我们将使用状态查询方式，因为它更适合实现平滑的移动控制。状态查询方式可以检测到多个键同时按下的情况，并且不会因为事件循环的处理速度而错过按键。

## 更新 SceneMain 类

首先，我们需要在`SceneMain`类中添加一个新方法`keyboardControl()`，专门用于处理键盘输入：

```cpp
// SceneMain.h
#ifndef SCENE_MAIN_H
#define SCENE_MAIN_H

#include "Scene.h"
#include "Object.h"

class Game;

class SceneMain : public Scene {
public:
    SceneMain();
    ~SceneMain();

    void update() override;
    void render() override;
    void handleEvent(SDL_Event* event) override;
    void init() override;
    void clean() override;

    void keyboardControl();  // 新增方法

private:
    Game &game;
    Player player;
    
};

#endif // SCENE_MAIN_H
```

然后，在`SceneMain.cpp`中实现这个方法，并在`update()`方法中调用它：

```cpp
// SceneMain.cpp 更新
void SceneMain::update()
{
    keyboardControl();  // 在每次更新时处理键盘输入
}

void SceneMain::keyboardControl()
{
    auto keyboardState = SDL_GetKeyboardState(NULL);
    if (keyboardState[SDL_SCANCODE_W]){
        player.position.y -= 1;
    }
    if (keyboardState[SDL_SCANCODE_S]){
        player.position.y += 1;
    }
    if (keyboardState[SDL_SCANCODE_A]){
        player.position.x -= 1;
    }
    if (keyboardState[SDL_SCANCODE_D]){
        player.position.x += 1;
    }
    
    // 限制飞机的移动范围
    if (player.position.x < 0){
        player.position.x = 0;
    }
    if (player.position.x > game.getWindowWidth() - player.width){
        player.position.x = game.getWindowWidth() - player.width;
    }
    if (player.position.y < 0){
        player.position.y = 0;
    }
    if (player.position.y > game.getWindowHeight() - player.height){
        player.position.y = game.getWindowHeight() - player.height;
    }
}
```

## 实现分析

让我们详细分析一下实现的键盘控制功能：

### 1. 获取键盘状态

```cpp
auto keyboardState = SDL_GetKeyboardState(NULL);
```

`SDL_GetKeyboardState()`函数返回一个指向表示当前键盘状态的数组的指针。数组中的每个元素对应一个键，如果该键被按下，则对应的元素值为1，否则为0。

### 2. 检测按键并移动飞机

```cpp
if (keyboardState[SDL_SCANCODE_W]){
    player.position.y -= 1;
}
if (keyboardState[SDL_SCANCODE_S]){
    player.position.y += 1;
}
if (keyboardState[SDL_SCANCODE_A]){
    player.position.x -= 1;
}
if (keyboardState[SDL_SCANCODE_D]){
    player.position.x += 1;
}
```

我们使用WASD键来控制飞机的移动：
- W键：向上移动（y坐标减小）
- S键：向下移动（y坐标增大）
- A键：向左移动（x坐标减小）
- D键：向右移动（x坐标增大）

注意，我们在这里使用的是扫描码（SDL_SCANCODE_*）而不是键码（SDLK_*）。扫描码是与物理键盘位置相关的，不受键盘布局和语言设置的影响，因此更适合用于游戏控制。

### 3. 边界检测

```cpp
// 限制飞机的移动范围
if (player.position.x < 0){
    player.position.x = 0;
}
if (player.position.x > game.getWindowWidth() - player.width){
    player.position.x = game.getWindowWidth() - player.width;
}
if (player.position.y < 0){
    player.position.y = 0;
}
if (player.position.y > game.getWindowHeight() - player.height){
    player.position.y = game.getWindowHeight() - player.height;
}
```

我们添加了边界检测代码，确保飞机不会移出游戏窗口。当飞机到达窗口边缘时，它会被阻止继续移动。

## SDL键盘输入的其他功能

除了本课实现的基本键盘控制外，SDL还提供了其他丰富的输入处理功能：

1. **键盘事件**：可以通过SDL_Event捕获具体的按键事件，如按下、释放等。
2. **按键修饰符**：可以检测Shift、Ctrl、Alt等修饰键的状态。
3. **文本输入**：SDL提供了专门的文本输入事件，支持各种语言的输入。
4. **键盘焦点**：可以控制窗口是否接收键盘输入。

## 总结

在本课中，我们实现了游戏中的键盘控制功能，使玩家能够使用WASD键移动飞机。我们使用了SDL的键盘状态查询方式，结合边界检测，确保飞机能够流畅地在游戏窗口内移动。

主要的改进包括：
1. 添加了`keyboardControl()`方法，专门处理键盘输入。
2. 实现了基本的WASD方向控制。
3. 添加了边界检测，防止飞机移出窗口。

这个简单的键盘控制系统为我们的游戏增加了互动性，是游戏开发中的重要一步。在接下来的课程中，我们将继续完善游戏功能，添加射击和敌人等元素。

## 练习

1. 尝试将移动控制改为使用方向键（上下左右）而不是WASD键。

2. 实现可变的移动速度，例如按住Shift键时飞机移动速度加快。

3. 添加平滑的减速效果，当松开按键时，飞机不会立即停止，而是逐渐减速至停止。

4. 实现基于时间的移动，确保飞机在不同性能的设备上以相同的速度移动。
