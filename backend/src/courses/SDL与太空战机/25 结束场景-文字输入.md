# 结束场景-文字输入

<link rel="stylesheet" href="/css/videoStyles.css" />

<div class="video-container">
  <div class="video-tabs">
    <a href="#bilibili" class="video-tab bilibili-tab">哔哩哔哩</a>
    <a href="#youtube" class="video-tab youtube-tab">YouTube</a>
  </div>

  <div id="youtube" class="video-content">
    <iframe 
      class="video-frame"
      src="https://www.youtube.com/embed/l4PlZ8ZGHxQ?si=dq1MLJ9quf5BRtUu" 
      frameborder="0" 
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
      allowfullscreen>
    </iframe>
  </div>

  <div id="bilibili" class="video-content">
    <iframe 
      class="video-frame"
      src="//player.bilibili.com/player.html?bvid=BV1nwcqecEt3&page=1&autoplay=0&danmaku=0&high_quality=1" 
      scrolling="no" 
      border="0" 
      frameborder="no" 
      framespacing="0" 
      allowfullscreen="true">
    </iframe>
  </div>
</div>

在上一课中，我们实现了结束场景的基本框架和延时切换功能，使游戏在玩家死亡后能够自然地过渡到结束场景。然而，一个完整的游戏通常需要记录玩家的得分和名字，以便创建排行榜或保存游戏记录。在本课中，我们将学习如何在结束场景中实现文字输入功能，让玩家能够输入自己的名字。

<img src="https://theorhythm.top/gamedev/SS/25 结束场景-文字输入.PNG" style='width: 800px;' />

## 文字输入的意义

在游戏中实现文字输入功能有以下几个重要作用：

1. **个性化体验**：允许玩家输入自己的名字，增加游戏的个性化体验
2. **记录成就**：将玩家的名字与得分关联，记录游戏成就
3. **社交互动**：通过排行榜展示不同玩家的成绩，增加游戏的社交性
4. **游戏连续性**：保存玩家信息，使游戏体验更加连贯

## 1. 扩展结束场景类

首先，我们需要扩展结束场景类，添加文字输入相关的成员和方法：

```cpp
// SceneEnd.h
#ifndef SCENE_END_H
#define SCENE_END_H

#include "Scene.h"
#include <string>

class SceneEnd : public Scene{
public:
    virtual void init();
    virtual void update(float deltaTime);
    virtual void render();
    virtual void clean();
    virtual void handleEvent(SDL_Event* event);

private:
    bool isTyping = true;
    std::string name = "";

    void renderPhase1();
    void renderPhase2();
};

#endif // SCENE_END_H
```

我们添加了以下成员和方法：
- `isTyping`：标记当前是否处于输入名字阶段
- `name`：存储玩家输入的名字
- `renderPhase1()`：渲染输入名字阶段的界面
- `renderPhase2()`：渲染显示排行榜阶段的界面（将在后续课程实现）

## 2. 实现文字输入功能

### 2.1 初始化文字输入

在`SceneEnd.cpp`的`init()`方法中，我们需要启用SDL的文本输入功能：

```cpp
// SceneEnd.cpp
#include "SceneEnd.h"
#include "Game.h"
#include <string>

void SceneEnd::init()
{
    if (!SDL_IsTextInputActive()){
        SDL_StartTextInput();
    }
    if (!SDL_IsTextInputActive()){
        SDL_LogError(SDL_LOG_PRIORITY_ERROR, "SDL", "Failed to start text input: %s", SDL_GetError());
    }
}
```

`SDL_StartTextInput()`函数启用SDL的文本输入功能，使游戏能够接收键盘输入的文本。我们还添加了错误检查，确保文本输入功能成功启用。

### 2.2 处理文本输入事件

在`handleEvent()`方法中，我们需要处理文本输入事件：

```cpp
// SceneEnd.cpp
void SceneEnd::handleEvent(SDL_Event *event)
{
    if (isTyping){
        if (event->type == SDL_TEXTINPUT){
            name += event->text.text;
        }
        if (event->type == SDL_KEYDOWN){
            if (event->key.keysym.scancode == SDL_SCANCODE_RETURN){
                isTyping = false;
                SDL_StopTextInput();
            }
            if (event->key.keysym.scancode == SDL_SCANCODE_BACKSPACE){
                name.pop_back();
            }
        }
    }
    else{
        // TODO: 处理排行榜阶段的事件（后续课程实现）
    }
}
```

这个方法处理两种类型的事件：
1. `SDL_TEXTINPUT`事件：当玩家输入文本时触发，我们将输入的文本添加到`name`字符串中
2. `SDL_KEYDOWN`事件：当玩家按下键盘按键时触发
   - 如果按下回车键，表示输入完成，我们将`isTyping`设置为false，并停止文本输入
   - 如果按下退格键，我们从`name`字符串中删除最后一个字符

### 2.3 渲染输入界面

在`render()`方法中，我们根据当前阶段调用不同的渲染方法：

```cpp
// SceneEnd.cpp
void SceneEnd::render()
{
    if (isTyping){
        renderPhase1(); 
    }else{
        renderPhase2();
    }
}
```

然后，我们实现`renderPhase1()`方法，渲染输入名字阶段的界面：

```cpp
// SceneEnd.cpp
void SceneEnd::renderPhase1()
{   
    auto score = game.getFinalScore();
    std::string scoreText = "你的得分是：" + std::to_string(score);
    std::string gameOver = "Game Over";
    std::string instrutionText = "请输入你的名字，按回车键确认：";
    game.renderTextCentered(scoreText, 0.1, false);
    game.renderTextCentered(gameOver, 0.4, true);
    game.renderTextCentered(instrutionText, 0.6, false);

    if (name != ""){
        game.renderTextCentered(name, 0.8, false);
    }
}
```

这个方法渲染以下内容：
1. 玩家的最终得分
2. "Game Over"标题
3. 输入名字的提示文本
4. 玩家当前输入的名字（如果有）

### 2.4 清理资源

在`clean()`方法中，我们确保在场景结束时停止文本输入：

```cpp
// SceneEnd.cpp
void SceneEnd::clean()
{
    if (SDL_IsTextInputActive()){
        SDL_StopTextInput();
    }
}
```

## 3. 在主场景中设置最终得分

为了在结束场景中显示玩家的最终得分，我们需要在主场景中设置最终得分。在`SceneMain.cpp`的`updatePlayer()`方法中，我们在玩家死亡时设置最终得分：

```cpp
// SceneMain.cpp
void SceneMain::updatePlayer(float)
{
    if (isDead) {
        return;
    }
    if (player.currentHealth <= 0){
        // 游戏结束逻辑
        auto currentTime = SDL_GetTicks();
        isDead = true;
        auto explosion = new Explosion(explosionTemplate);
        explosion->position.x = player.position.x + player.width / 2 - explosion->width / 2;
        explosion->position.y = player.position.y + player.height / 2 - explosion->height / 2;
        explosion->startTime = currentTime;
        explosions.push_back(explosion);
        Mix_PlayChannel(-1, sounds["player_explode"], 0);
        game.setFinalScore(score);
        return;
    }
    // ...其他代码...
}
```

我们添加了`game.setFinalScore(score)`语句，将玩家的当前得分设置为最终得分。

## 4. 在Game类中添加获取最终得分的方法

在`Game.h`中，我们添加了设置和获取最终得分的方法：

```cpp
// Game.h
class Game
{
public:
    // ...其他方法...

    // setters
    void setFinalScore(int score) { finalScore = score; }

    // getters
    // ...其他getter方法...
    int getFinalScore() { return finalScore; }

private:
    // ...其他成员...
    int finalScore = 0;
    // ...其他成员...
};
```

这些方法允许我们在主场景中设置最终得分，并在结束场景中获取和显示它。

## SDL文本输入机制

SDL提供了一套完整的文本输入机制，使我们能够处理各种语言和输入法的文本输入。以下是SDL文本输入的主要函数：

- `SDL_StartTextInput()`：启用文本输入
- `SDL_StopTextInput()`：停用文本输入
- `SDL_IsTextInputActive()`：检查文本输入是否处于活动状态
- `SDL_SetTextInputRect()`：设置文本输入的区域（用于定位输入法窗口）

当文本输入处于活动状态时，SDL会生成`SDL_TEXTINPUT`事件，其中包含用户输入的文本。这个文本已经经过输入法处理，支持各种语言和特殊字符。

## 完成效果

实现上述代码后，游戏结束场景将显示玩家的最终得分，并允许玩家输入自己的名字。玩家可以使用键盘输入文本，使用退格键删除字符，并使用回车键确认输入。

<img src="https://theorhythm.top/gamedev/SS/25 结束场景-文字输入截图.png" style='width: 800px;' />

## 总结

在本课中，我们实现了结束场景的文字输入功能，使玩家能够在游戏结束后输入自己的名字。我们学习了：

1. 如何启用和停用SDL的文本输入功能
2. 如何处理文本输入事件
3. 如何渲染输入界面
4. 如何在主场景中设置最终得分，并在结束场景中获取和显示它

这些技术为实现更复杂的游戏功能奠定了基础，如排行榜、玩家账户系统等。在下一课中，我们将进一步完善结束场景，实现排行榜功能，让玩家能够查看历史最高分。

## 练习

1. 为文本输入添加光标效果，使玩家能够更清楚地看到输入位置。

2. 实现文本输入的长度限制，防止玩家输入过长的名字。

3. 更改文本输入的颜色，突出其显示。
