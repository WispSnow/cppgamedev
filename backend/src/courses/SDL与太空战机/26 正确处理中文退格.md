# 正确处理中文退格

<link rel="stylesheet" href="/css/videoStyles.css" />

<div class="video-container">
  <div class="video-tabs">
    <a href="#bilibili" class="video-tab bilibili-tab">哔哩哔哩</a>
    <a href="#youtube" class="video-tab youtube-tab">YouTube</a>
  </div>

  <div id="youtube" class="video-content">
    <iframe 
      class="video-frame"
      src="https://www.youtube.com/embed/-8EY7qZExwY?si=8U0bQTehSJB25Vmk" 
      frameborder="0" 
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
      allowfullscreen>
    </iframe>
  </div>

  <div id="bilibili" class="video-content">
    <iframe 
      class="video-frame"
      src="//player.bilibili.com/player.html?bvid=BV12gcBeCEEx&page=1&autoplay=0&danmaku=0&high_quality=1" 
      scrolling="no" 
      border="0" 
      frameborder="no" 
      framespacing="0" 
      allowfullscreen="true">
    </iframe>
  </div>
</div>

在上一课中，我们实现了结束场景的文字输入功能，允许玩家在游戏结束后输入自己的名字。这个功能基本可用，但存在一个潜在的问题：当玩家输入中文字符并尝试使用退格键删除时，可能会出现乱码或不完整的字符。这是因为中文字符在UTF-8编码中占用多个字节，而简单的删除操作只会删除最后一个字节，导致字符不完整。在本课中，我们将学习如何正确处理中文退格操作，确保游戏能够支持多语言输入。

## 1. 理解UTF-8编码

在处理中文退格问题之前，我们需要了解UTF-8编码的基本原理。UTF-8是一种可变长度的字符编码方式，它可以使用1到4个字节表示一个字符，具体取决于字符所属的语言和范围。

<img src="https://theorhythm.top/gamedev/SS/26 正确处理中文退格1.png" style='width: 800px;' />

### 1.1 UTF-8编码规则

UTF-8编码的基本规则如下：

1. **ASCII字符**（如英文字母、数字和常见符号）：使用1个字节，最高位为0
   ```
   0xxxxxxx
   ```

2. **扩展字符**（如欧洲文字、希腊字母等）：使用2个字节
   ```
   110xxxxx 10xxxxxx
   ```

3. **中文、日文、韩文等东亚字符**：通常使用3个字节
   ```
   1110xxxx 10xxxxxx 10xxxxxx
   ```

4. **表情符号、生僻字**：使用4个字节
   ```
   11110xxx 10xxxxxx 10xxxxxx 10xxxxxx
   ```

<img src="https://theorhythm.top/gamedev/SS/26 正确处理中文退格2.png" style='width: 800px;' />

注意两个关键特点：
- 多字节字符的第一个字节以若干个1开头，后跟一个0（如`110xxxxx`、`1110xxxx`等）
- 多字节字符的后续字节都以`10`开头

### 1.2 为什么简单的退格操作会出现问题？

当我们使用简单的`string.pop_back()`操作删除字符串的最后一个字符时，它只会删除最后一个字节。这对于ASCII字符（1字节）没有问题，但对于中文字符（通常是3字节）会有问题：

- 假设有一个中文字符"中"，它在UTF-8中占用3个字节
- 如果我们只删除最后一个字节，剩下的2个字节就成了不完整的字符，导致显示乱码
- 正确的做法应该是一次性删除整个中文字符的所有字节（3个）

<img src="https://theorhythm.top/gamedev/SS/26 正确处理中文退格3.png" style='width: 800px;' />

## 2. 实现正确的UTF-8退格处理

为了解决这个问题，我们需要添加一个新方法，在删除字符时检查它是否是多字节字符，并删除所有相关字节。

### 2.1 添加UTF-8字符删除方法

首先，在`SceneEnd.h`中，我们添加一个新的方法：

```cpp
// SceneEnd.h
class SceneEnd : public Scene{
private:
    // ...现有成员...
    void removeLastUTF8Char(std::string& str);
};
```

然后，在`SceneEnd.cpp`中实现这个方法：

```cpp
// SceneEnd.cpp
void SceneEnd::removeLastUTF8Char(std::string &str)
{
    if (str.empty()) return;
    
    auto lastchar = str.back();
    if ((lastchar & 0b10000000) == 0b10000000) { // 中文字符的后续字节
        str.pop_back();
        while((str.back() & 0b11000000) != 0b11000000) { // 判断是否是中文字符的第一个字节
            str.pop_back();
        }
    }
    str.pop_back();
}
```

这个方法的工作原理如下：

1. 首先检查字符串是否为空，如果是则直接返回
2. 检查最后一个字节的最高位是否为1（`lastchar & 0b10000000`）
   - 如果是，这表示它可能是多字节字符的一部分
   - 我们先删除这个字节（`str.pop_back()`）
   - 然后，我们继续向前检查并删除字节，直到找到字符的第一个字节（前两位为`11`的字节）
3. 最后，我们删除找到的第一个字节，完成整个字符的删除

### 2.2 修改事件处理函数

接下来，我们需要修改`handleEvent()`方法，使用我们的新方法来处理退格键：

```cpp
// SceneEnd.cpp
void SceneEnd::handleEvent(SDL_Event *event)
{
    if (isTyping){
        if (event->type == SDL_TEXTINPUT){
            name += event->text.text;
        }
        if (event->type == SDL_KEYDOWN){
            if (event->key.keysym.scancode == SDL_SCANCODE_RETURN){
                isTyping = false;
                SDL_StopTextInput();
            }
            if (event->key.keysym.scancode == SDL_SCANCODE_BACKSPACE){
                removeLastUTF8Char(name);  // 使用我们的新方法
            }
        }
    }
    else{
        // TODO: 处理后续逻辑
    }
}
```

我们将原来的`name.pop_back()`替换为`removeLastUTF8Char(name)`，这样当玩家按下退格键时，我们就会正确地删除最后一个字符，无论它是ASCII字符还是多字节的中文字符。

## 3. 位运算技巧解析

在`removeLastUTF8Char`方法中，我们使用了一些位运算技巧来检查UTF-8字节的特征：

- `lastchar & 0b10000000`：检查最高位是否为1
  - 如果结果是`0b10000000`，说明最高位是1
  - 这表示这个字节可能是多字节字符的一部分

- `str.back() & 0b11000000`：检查前两位的模式
  - 如果结果是`0b11000000`，说明前两位是11
  - 这表示这个字节是多字节字符的第一个字节
  - 如果结果是`0b10000000`，说明前两位是10
  - 这表示这个字节是多字节字符的后续字节

通过这些位运算，我们可以识别UTF-8编码中的字节模式，并正确地处理多字节字符。

## 总结

在本课中，我们学习了UTF-8编码的基本原理，以及如何正确处理UTF-8编码中的多字节字符删除问题。我们实现了一个`removeLastUTF8Char`方法，可以智能地删除字符串中的最后一个字符，无论它是单字节的ASCII字符还是多字节的中文字符。这样，我们的游戏就能够正确支持多语言输入，提高用户体验。

关键知识点：

1. UTF-8是一种可变长度的字符编码，不同的字符可能占用1到4个字节
2. 简单的字符删除操作可能会导致多字节字符被部分删除，造成乱码
3. 通过检查字节的位模式，我们可以识别UTF-8编码中的字符边界
4. 正确的字符删除应该考虑字符的完整性，删除整个字符的所有字节

这个改进虽然看起来很小，但对于支持多语言的游戏来说非常重要，尤其是当我们希望游戏能够被全球的玩家享用时。

## 练习

1. 扩展`removeLastUTF8Char`方法，添加详细的错误检查和日志记录，以便在开发过程中更容易调试UTF-8相关问题。

2. 实现一个函数，统计UTF-8字符串中的实际字符数（而不是字节数）。

3. 实现一个函数，限制输入文本的字符数（而不是字节数），确保玩家名字不超过指定的长度。
