# UI-得分记录

<link rel="stylesheet" href="/css/videoStyles.css" />

<div class="video-container">
  <div class="video-tabs">
    <a href="#bilibili" class="video-tab bilibili-tab">哔哩哔哩</a>
    <a href="#youtube" class="video-tab youtube-tab">YouTube</a>
  </div>

  <div id="youtube" class="video-content">
    <iframe 
      class="video-frame"
      src="https://www.youtube.com/embed/DSTsHglICq4?si=9DbmkdWh_vjO14VV" 
      frameborder="0" 
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
      allowfullscreen>
    </iframe>
  </div>

  <div id="bilibili" class="video-content">
    <iframe 
      class="video-frame"
      src="//player.bilibili.com/player.html?bvid=BV1cKcEe1EQc&page=1&autoplay=0&danmaku=0&high_quality=1" 
      scrolling="no" 
      border="0" 
      frameborder="no" 
      framespacing="0" 
      allowfullscreen="true">
    </iframe>
  </div>
</div>

在上一课中，我们实现了血量UI图标，使玩家能够直观地了解自己的生命值状态。然而，游戏体验还不够完整，我们需要为玩家提供反馈，让他们知道自己的游戏表现如何。在这一课中，我们将实现得分记录功能，让玩家能够看到自己的得分，从而增加游戏的竞争性和可重玩性。

## 得分系统的意义

得分系统是大多数游戏中的核心机制之一，它有以下几个重要作用：

1. **提供反馈**：让玩家知道自己的游戏表现如何，是否有进步
2. **增加竞争性**：玩家可以与自己或他人的历史得分进行比较
3. **设定目标**：为玩家提供明确的目标，激励他们不断提高
4. **量化进度**：通过分数，玩家可以量化自己的游戏进展

在射击游戏中，得分通常与击败敌人、收集物品和生存时间等相关。我们将在本课中实现一个简单的得分系统，主要基于击败敌机和收集物品来累计分数。

## 1. 添加得分相关成员

首先，我们需要在`SceneMain.h`中添加得分相关的成员变量：

```cpp
// SceneMain.h
#include <SDL_ttf.h>

class SceneMain : public Scene {
private:
    // ...现有成员...
    TTF_Font* scoreFont;
    int score = 0;
};
```

我们添加了两个新成员：
- `scoreFont`：用于渲染得分文本的字体
- `score`：当前得分，初始值为0

## 2. 初始化字体资源

在`SceneMain.cpp`的`init()`方法中，我们需要加载字体资源：

```cpp
// SceneMain.cpp
void SceneMain::init()
{
    // 读取并播放背景音乐
    // ...前面的代码保持不变

    // 读取ui Health
    uiHealth = IMG_LoadTexture(game.getRenderer(), "assets/image/Health UI Black.png");

    // 载入字体
    scoreFont = TTF_OpenFont("assets/font/VonwaonBitmap-12px.ttf", 24);

    // ...后面的代码保持不变
}
```

这段代码使用`TTF_OpenFont()`函数加载字体文件，并指定字体大小为24像素。第一个参数是字体文件的路径，第二个参数是字体的大小。

## 3. 在游戏中累计得分

接下来，我们需要在适当的地方累计得分。我们将在两个地方添加得分逻辑：

### 3.1 击败敌机获得得分

当玩家击败敌机时，我们在`enemyExplode()`方法中添加得分逻辑：

```cpp
// SceneMain.cpp
void SceneMain::enemyExplode(Enemy *enemy)
{
    // ...前面的代码保持不变
    
    score += 10;  // 击败敌机获得10分
    
    delete enemy;
}
```

每当一个敌机被摧毁，玩家将获得10分。

### 3.2 拾取物品获得得分

当玩家拾取物品时，我们在`playerGetItem()`方法中添加得分逻辑：

```cpp
// SceneMain.cpp
void SceneMain::playerGetItem(Item *item)
{
    score += 5;  // 拾取物品获得5分
    
    if (item->type == ItemType::Life){
        player.currentHealth += 1;
        if (player.currentHealth > player.maxHealth){
            player.currentHealth = player.maxHealth;
        }
    }
    Mix_PlayChannel(-1, sounds["get_item"], 0);
}
```

每当玩家拾取一个物品，将获得5分。同时，如果物品是生命道具，还会恢复生命值。

## 4. 渲染得分UI

接下来，我们需要在`renderUI()`方法中添加渲染得分的代码：

```cpp
// SceneMain.cpp
void SceneMain::renderUI()
{
    // 渲染血条
    // ...前面的代码保持不变
    
    // 渲染得分
    auto text = "SCORE:" + std::to_string(score);
    SDL_Color color = {255, 255, 255, 255};  // 白色
    SDL_Surface* surface = TTF_RenderUTF8_Solid(scoreFont, text.c_str(), color);
    SDL_Texture* texture = SDL_CreateTextureFromSurface(game.getRenderer(), surface);
    SDL_Rect rect = {game.getWindowWidth() - 10 - surface->w, 10, surface->w, surface->h};
    SDL_RenderCopy(game.getRenderer(), texture, NULL, &rect);
    SDL_FreeSurface(surface);
    SDL_DestroyTexture(texture);
}
```

这段代码实现了在屏幕右上角显示得分的功能：

1. 首先，创建一个包含"SCORE:"前缀和当前得分的文本字符串
2. 定义文本颜色为白色（RGB值均为255）
3. 使用`TTF_RenderUTF8_Solid()`函数将文本渲染为SDL表面（Surface）
4. 使用`SDL_CreateTextureFromSurface()`函数将表面转换为纹理
5. 计算渲染位置，使文本右对齐于屏幕右上角
6. 使用`SDL_RenderCopy()`函数将文本纹理渲染到屏幕上
7. 最后，释放表面和纹理资源，防止内存泄漏

## 5. 清理字体资源

在`SceneMain.cpp`的`clean()`方法中，我们需要添加清理字体资源的代码：

```cpp
// SceneMain.cpp
void SceneMain::clean()
{
    // ...前面的代码保持不变
    
    // 清理ui
    if (uiHealth != nullptr){
        SDL_DestroyTexture(uiHealth);
    }

    // 清理字体
    if (scoreFont != nullptr){
        TTF_CloseFont(scoreFont);
    }
    
    // ...后面的代码保持不变
}
```

这段代码确保在游戏结束时释放字体资源，防止内存泄漏。

## SDL_ttf库简介

在实现得分显示功能时，我们使用了SDL_ttf库，这是SDL的一个扩展库，专门用于在SDL应用程序中渲染TrueType字体。以下是SDL_ttf的几个主要函数：

- `TTF_OpenFont()`：加载字体文件，返回一个字体对象
- `TTF_RenderText_Solid()`：渲染纯色文本，速度较快但质量较低
- `TTF_RenderText_Shaded()`：渲染带背景色的文本，质量中等
- `TTF_RenderText_Blended()`：渲染高质量文本，支持透明度但速度较慢
- `TTF_RenderUTF8_Solid()`、`TTF_RenderUTF8_Shaded()`、`TTF_RenderUTF8_Blended()`：渲染UTF-8编码的文本，支持中文等非ASCII字符
- `TTF_CloseFont()`：释放字体资源

在游戏中，我们通常使用`TTF_RenderUTF8_Solid()`或`TTF_RenderUTF8_Blended()`函数来渲染文本，前者适用于小字体和频繁更新的文本，后者适用于大字体和静态文本。

## 完成效果

实现上述代码后，游戏屏幕右上角将显示当前得分，当玩家击败敌机或拾取物品时，得分会相应增加。这样，玩家就能直观地了解自己的游戏表现，增加游戏的竞争性和可重玩性。

<img src="https://theorhythm.top/gamedev/SS/22 UI-得分纪录截图.png" style='width: 800px;' />

## 总结

在本课中，我们实现了得分记录功能，使玩家能够看到自己的游戏表现。我们学习了：

1. 如何使用SDL_ttf库渲染文本
2. 如何在游戏中累计和显示得分
3. 如何在适当的位置渲染UI元素
4. 如何正确管理字体资源，防止内存泄漏

这些技术为实现更复杂的游戏UI奠定了基础，你可以在此基础上添加更多UI元素，如排行榜、成就系统等，使游戏更加完整和有趣。

## 练习

1. 实现一个游戏结束界面，显示玩家的最终得分和游戏时间。

2. 添加一个高分榜功能，记录和显示玩家的历史最高分。

3. 为不同的游戏行为设置不同的得分规则，例如，击败不同类型的敌机获得不同的分数。

4. 实现一个得分倍率系统，随着玩家连续击败敌机而提高，被击中则重置，增加游戏的策略性。
