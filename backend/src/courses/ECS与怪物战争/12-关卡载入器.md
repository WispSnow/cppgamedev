# 12 å…³å¡è½½å…¥å™¨

<div class="video-container">
  <div id="bilibili" class="video-content">
    <!-- Bç«™åµŒå…¥ï¼šä½¿ç”¨ https æ˜ç¡®åè®®ï¼ˆé¿å… file:// æˆ– http å¯¼è‡´è¢«æµè§ˆå™¨æ‹¦æˆªï¼‰ -->
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV1762TBwEtR&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

[åœ¨ Bilibili ä¸Šè§‚çœ‹](https://www.bilibili.com/video/BV1762TBwEtR)

## ğŸ“– æ¦‚è¿°

ä¸Šä¸€èŠ‚æˆ‘ä»¬æŠŠæ¡†æ¶ä» `GameObject + Component` åˆ‡æ¢åˆ°äº† ECSï¼ˆ`entt::registry` + ç»„ä»¶ + ç³»ç»Ÿï¼‰ï¼Œä½†æ­¤æ—¶çš„æ¸¸æˆä¸–ç•Œè¿˜æ˜¯â€œç©ºâ€çš„ï¼šæˆ‘ä»¬åªèƒ½åœ¨ `GameScene` é‡Œæ‰‹åŠ¨åˆ›å»ºå‡ ä¸ª entity æµ‹è¯•æ¸²æŸ“ä¸åŠ¨ç”»ã€‚

ä»è¿™ä¸€èŠ‚å¼€å§‹ï¼Œæˆ‘ä»¬è¿›å…¥å¡”é˜²çœŸæ­£çš„â€œæ•°æ®é©±åŠ¨â€åŸºç¡€è®¾æ–½ï¼š**å…³å¡è½½å…¥å™¨ï¼ˆLevelLoaderï¼‰**ã€‚ç›®æ ‡æ˜¯ï¼š

- ç”¨ **Tiled** ç¼–è¾‘åœ°å›¾
- å¯¼å‡º `.tmj/.tsj`ï¼ˆJSONï¼‰
- è¿è¡Œæ—¶è§£æ JSONï¼Œå¹¶æŠŠâ€œåœ°å›¾/èƒŒæ™¯/è£…é¥°/å¯¹è±¡â€è½¬æ¢æˆ ECS çš„å®ä½“ä¸ç»„ä»¶

<img src="https://theorhythm.top/gamedev/MW/æ€ªç‰©æˆ˜äº‰.055.webp" style='width: 800px;' />

> PPT ç¬¬ 55 é¡µï¼šç¬¬ 12 èŠ‚æ ‡é¢˜é¡µ

æœ¬èŠ‚å¯¹åº”ä»£ç æ ‡ç­¾ï¼š`12-å…³å¡è½½å…¥å™¨`ï¼ˆåŸºçº¿ï¼š`11-å¼•å…¥ECSæ¡†æ¶`ï¼‰ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- ç†è§£ Tiled å¯¼å‡ºçš„ `.tmj/.tsj` é‡Œæœ€å…³é”®çš„å­—æ®µï¼š`tilesets / layers / (tile)gid`
- å®ç° `LevelLoader::loadLevel()`ï¼šåŠ è½½ tilesetã€åˆ†å‘ä¸‰ç±»å›¾å±‚è§£æ
- å¼•å…¥å»ºé€ è€…æ¨¡å¼ï¼šç”¨ `BasicEntityBuilder` æŠŠâ€œè§£æâ€ä¸â€œå»ºå®ä½“â€è§£è€¦
- ä¸ºç“¦ç‰‡å±‚æ–°å¢å®¹å™¨ç»„ä»¶ `TileLayerComponent`ï¼Œå¹¶æ”¯æŒç“¦ç‰‡åŠ¨ç”»çš„è§£æ

## ğŸ—ºï¸ å…³å¡æ•°æ®ï¼šTiled çš„ `.tmj/.tsj`ï¼ˆæˆ‘ä»¬è¦è¯»ä»€ä¹ˆï¼‰

### 1) `.tmj`ï¼šåœ°å›¾æ–‡ä»¶ï¼ˆlayers + tilesetsï¼‰

Tiled çš„ `.tmj` æœ¬è´¨æ˜¯ä¸€ä¸ª JSONï¼šé‡Œé¢æœ‰åœ°å›¾å°ºå¯¸ã€ç“¦ç‰‡å°ºå¯¸ã€å¼•ç”¨çš„ tilesetï¼Œä»¥åŠä¸€ä¸ª `layers` æ•°ç»„ã€‚

ä»¥ `assets/maps/level1.tmj` ä¸ºä¾‹ï¼Œå®ƒå¼€å¤´å°±èƒ½çœ‹åˆ°ç¬¬ä¸€ä¸ª `tilelayer` çš„ `data`ï¼ˆä¸€ç»´æ•°ç»„ï¼ŒæŒ‰è¡Œä»å·¦åˆ°å³ï¼‰ï¼š

```json
{ "height":19,
  "layers":[
    {
      "data":[0, 0, 0, 0, ...],
      "name":"ground1",
      "type":"tilelayer",
      "visible":true,
      "width":25
    }
  ]
}
```

è€Œ `objectgroup`ï¼ˆå¯¹è±¡å±‚ï¼‰ä¼šåœ¨ `objects` é‡Œç»™å‡ºæ¯ä¸ªå¯¹è±¡çš„ `x/y/width/height`ï¼Œä»¥åŠå¯é€‰çš„ `gid`ï¼š

```json
{
  "name":"deco1",
  "type":"objectgroup",
  "objects":[
    {
      "gid":2147484301,
      "width":128,
      "height":128,
      "x":778.666666666667,
      "y":878.666666666667
    }
  ]
}
```

æ³¨æ„è¿™é‡Œçš„ `gid`ï¼šå®ƒä¸ä»…ä»…æ˜¯â€œå›¾å— IDâ€ï¼Œé«˜ä½è¿˜å¯èƒ½ç¼–ç äº†ç¿»è½¬/æ—‹è½¬ç­‰ flagï¼ˆä¾‹å¦‚ `2147484301`ï¼‰ã€‚**æœ¬èŠ‚å…ˆä¸å¤„ç†è¿™äº› flag**ï¼Œä¸‹ä¸€èŠ‚ä¼šä¸“é—¨å®Œå–„ã€‚

### 2) `.tsj`ï¼šå›¾å—é›†æ–‡ä»¶ï¼ˆå•å›¾é›† / å¤šå›¾é›†ï¼‰

tileset æœ‰ä¸¤ç±»å¸¸è§å½¢æ€ï¼š

- **å•å›¾é›†**ï¼šæ•´ä¸ª tileset ç”±ä¸€å¼ å¤§å›¾ï¼ˆatlasï¼‰ç»„æˆï¼Œtileset JSON é‡Œæœ‰ `image/columns/tilewidth/tileheight`
- **å¤šå›¾é›†**ï¼šæ¯ä¸ª tile éƒ½æ˜¯ä¸€å¼ ç‹¬ç«‹å›¾ç‰‡ï¼ˆæˆ–å¸¦è£å‰ªä¿¡æ¯ï¼‰ï¼Œtileset JSON é‡Œä¼šæœ‰ `tiles[]`ï¼Œæ¯ä¸ª tile é‡Œæœ‰ `image/imagewidth/imageheight/...`

æœ¬èŠ‚çš„ç“¦ç‰‡åŠ¨ç”»ä¹Ÿæ¥è‡ª tilesetï¼ˆå•å›¾é›†æƒ…å†µä¸‹ï¼‰ï¼Œä¾‹å¦‚ `assets/maps/tileset/Tilemap.tsj`ï¼š

```json
{
  "columns":20,
  "image":"..\/..\/textures\/Terrain\/Tilemap.png",
  "tileheight":64,
  "tiles":[
    {
      "id":81,
      "animation":[
        { "duration":100, "tileid":560 },
        { "duration":100, "tileid":561 }
      ]
    }
  ]
}
```

## ğŸ§± æ¶æ„ï¼šLevelLoader + Builderï¼ˆæŠŠâ€œè§£æâ€ä¸â€œå»ºå®ä½“â€æ‹†å¼€ï¼‰

è¿™èŠ‚å¼•å…¥äº†ä¸€ä¸ªå¾ˆå…³é”®çš„ç»“æ„è®¾è®¡ï¼š**å»ºé€ è€…æ¨¡å¼**ã€‚

<img src="https://theorhythm.top/gamedev/MW/æ€ªç‰©æˆ˜äº‰.056.webp" style='width: 800px;' />

> PPT ç¬¬ 56 é¡µï¼šLevelLoader è´Ÿè´£è§£æä¸‰ç±»å›¾å±‚ä¸ tilesetï¼ŒBasicEntityBuilder è´Ÿè´£é…ç½®å¹¶å»ºé€  ECS å®ä½“ï¼ˆå¯æ›¿æ¢/å¯ç»§æ‰¿æ‰©å±•ï¼‰

å¯¹åº”åˆ°ä»£ç ï¼š

- `src/engine/loader/level_loader.h/.cpp`ï¼šè´Ÿè´£è¯»å– `.tmj/.tsj`ï¼Œå¹¶æŒ‰å›¾å±‚ç±»å‹ç»„ç»‡è§£ææµç¨‹
- `src/engine/loader/basic_entity_builder.h/.cpp`ï¼šæŠŠè§£æå¾—åˆ°çš„ `TileInfo / object_json` è½¬æˆ entity + components

è¿™æ ·åšçš„æ”¶ç›Šæ˜¯ï¼š`LevelLoader` å¯ä»¥ä¿æŒâ€œåªç®¡è§£æâ€ï¼Œè€Œæ¸¸æˆä¾§å¦‚æœè¦â€œçœ‹åˆ°ç‰¹å®šå¯¹è±¡å°±åŠ ç‰¹å®šç»„ä»¶/ç”Ÿæˆç‰¹å®šå®ä½“â€ï¼Œåªéœ€è¦ç»§æ‰¿ä¸€ä¸ª Builder å¹¶é€šè¿‡ `setEntityBuilder()` æ›¿æ¢å³å¯ã€‚

## ğŸ”§ LevelLoaderï¼šæ€»æµç¨‹ï¼ˆloadLevelï¼‰

`LevelLoader` å†…éƒ¨è®°å½•äº† map çš„å…³é”®ä¿¡æ¯ï¼ˆåœ°å›¾è·¯å¾„/å°ºå¯¸/ç“¦ç‰‡å°ºå¯¸ï¼‰ã€åŠ è½½åˆ°çš„ tileset æ•°æ®ï¼Œä»¥åŠä¸€ä¸ªå¯æ›¿æ¢çš„ `entity_builder_`ï¼š

```cpp
// src/engine/loader/level_loader.hï¼ˆèŠ‚é€‰ï¼‰
class LevelLoader final {
private:
    engine::scene::Scene* scene_;
    std::string map_path_;
    glm::ivec2 map_size_;
    glm::ivec2 tile_size_;
    std::map<int, nlohmann::json> tileset_data_; // firstgid -> tileset json
    std::unique_ptr<BasicEntityBuilder> entity_builder_;
    // ...
};
```

`loadLevel()` çš„ä¸»ä½“å¯ä»¥æŒ‰ 5 ä¸ªæ­¥éª¤ç†è§£ï¼š

1) æ ¡éªŒ `scene`ï¼›è‹¥æœªæŒ‡å®š builderï¼Œåˆ™åˆ›å»ºé»˜è®¤ `BasicEntityBuilder`  
2) è¯»å– `.tmj` å¹¶è§£æ JSON  
3) è¯»å–åœ°å›¾åŸºæœ¬ä¿¡æ¯ï¼š`map_size_ / tile_size_ / map_path_`  
4) éå† `tilesets[]`ï¼ŒåŠ è½½æ¯ä¸ª `.tsj`ï¼Œå¹¶æŒ‰ `firstgid` å­˜å…¥ `tileset_data_`  
5) éå† `layers[]`ï¼ŒæŒ‰ `type` åˆ†å‘åˆ°ä¸‰ç§åŠ è½½å‡½æ•°  

å…³é”®åˆ†å‘é€»è¾‘å¦‚ä¸‹ï¼š

```cpp
// src/engine/loader/level_loader.cppï¼ˆèŠ‚é€‰ï¼‰
for (const auto& layer_json : json_data["layers"]) {
    std::string layer_type = layer_json.value("type", "none");
    if (!layer_json.value("visible", true)) {
        spdlog::info("å›¾å±‚ '{}' ä¸å¯è§ï¼Œè·³è¿‡åŠ è½½ã€‚", layer_json.value("name", "Unnamed"));
        continue;
    }
    if (layer_type == "imagelayer") {
        loadImageLayer(layer_json);
    } else if (layer_type == "tilelayer") {
        loadTileLayer(layer_json);
    } else if (layer_type == "objectgroup") {
        loadObjectLayer(layer_json);
    } else {
        spdlog::warn("ä¸æ”¯æŒçš„å›¾å±‚ç±»å‹: {}", layer_type);
    }
}
```

## ğŸ§© ä¸‰ç±»å›¾å±‚å¦‚ä½•è½¬æˆ ECS

### 1) ImageLayerï¼šèƒŒæ™¯å›¾ï¼ˆå«è§†å·®ï¼‰

ImageLayer çš„ç›®æ ‡æ˜¯åˆ›å»ºä¸€ä¸ªå¸¦ `SpriteComponent` çš„å®ä½“ï¼Œå¹¶åŠ ä¸Šè§†å·®ä¿¡æ¯ï¼ˆ`ParallaxComponent`ï¼‰ä¸åç§»ï¼ˆ`TransformComponent`ï¼‰ï¼š

```cpp
// src/engine/loader/level_loader.cppï¼ˆèŠ‚é€‰ï¼‰
registry.emplace<engine::component::NameComponent>(entity, name_id, layer_name);
registry.emplace<engine::component::TransformComponent>(entity, offset);
registry.emplace<engine::component::ParallaxComponent>(entity, scroll_factor, repeat);
registry.emplace<engine::component::SpriteComponent>(entity, sprite);
```

è¿™é‡Œçš„ `sprite` é€šè¿‡ `ResourceManager::getTextureSize(...)` è·å–çº¹ç†å¤§å°åï¼Œä½¿ç”¨â€œæ•´å¼ å›¾ç‰‡â€ä½œä¸ºæºçŸ©å½¢ï¼š

```cpp
auto texture_size = resource_manager.getTextureSize(entt::hashed_string(texture_path.c_str()), texture_path);
auto sprite = engine::component::Sprite(texture_path, engine::utils::Rect{glm::vec2(0.0f), texture_size});
```

### 2) TileLayerï¼šç“¦ç‰‡å›¾å±‚ï¼ˆæ¯ä¸ªç“¦ç‰‡éƒ½æ˜¯ä¸€ä¸ª entityï¼‰

ç“¦ç‰‡å±‚æ˜¯å¡”é˜²åœ°å›¾çš„ä¸»ä½“ã€‚æœ¬èŠ‚çš„åšæ³•æ˜¯ï¼š

- å…ˆåˆ›å»ºä¸€ä¸ªâ€œå›¾å±‚å®ä½“â€ï¼ˆåªè´Ÿè´£æ‰¿è½½å®¹å™¨ç»„ä»¶ä¸åå­—ï¼‰
- å†ä¸ºæ¯ä¸ªé 0 çš„ `gid` åˆ›å»ºä¸€ä¸ªâ€œç“¦ç‰‡å®ä½“â€ï¼ˆæœ‰ `Sprite/Transform`ï¼Œå¯é€‰ `Animation`ï¼‰
- æœ€åæŠŠæ‰€æœ‰ç“¦ç‰‡å®ä½“è£…è¿›å›¾å±‚å®ä½“çš„ `TileLayerComponent`

```cpp
// src/engine/loader/level_loader.cppï¼ˆèŠ‚é€‰ï¼‰
auto layer_entity = registry.create();
registry.emplace<engine::component::NameComponent>(layer_entity, name_id, layer_name);

std::vector<entt::entity> tiles;
for (const int gid : data) {
    if (gid == 0) { index++; continue; }
    auto tile_info = getTileInfoByGid(gid);
    auto tile_entity = entity_builder_->configure(index, &tile_info.value())->build()->getEntityID();
    tiles.push_back(tile_entity);
    index++;
}
registry.emplace<engine::component::TileLayerComponent>(layer_entity, tile_size_, map_size_, tiles);
```

è¿™é‡Œå¼•å…¥äº†ä¸€ä¸ªâ€œä¸´æ—¶ç“¦ç‰‡æ•°æ®â€ç»“æ„ `TileInfo`ï¼ˆåªæ˜¯ LevelLoader è§£æè¿‡ç¨‹çš„ä¸­é—´äº§ç‰©ï¼Œä¸ä¼šè¢«é•¿æœŸä¿å­˜ï¼‰ï¼š

```cpp
// src/engine/component/tilelayer_component.hï¼ˆèŠ‚é€‰ï¼‰
struct TileInfo {
    engine::component::Sprite sprite_;
    engine::component::TileType type_;
    std::optional<engine::component::Animation> animation_;
    std::optional<nlohmann::json> properties_;
};
```

### 3) ObjectLayerï¼šå¯¹è±¡å›¾å±‚ï¼ˆå½¢çŠ¶å¯¹è±¡ / å›¾ç‰‡å¯¹è±¡ï¼‰

å¯¹è±¡å±‚çš„æ¯ä¸ª object éƒ½å¯èƒ½æœ‰ `gid`ï¼š

- `gid == 0`ï¼šä»£è¡¨â€œè‡ªå·±ç”»çš„å½¢çŠ¶â€ï¼ˆæœ¬èŠ‚å…ˆæŒ‰â€œåªæœ‰ Transform/Nameâ€å¤„ç†ï¼‰
- `gid != 0`ï¼šä»£è¡¨â€œå›¾ç‰‡å¯¹è±¡â€ï¼ˆæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ª tile çš„å¼•ç”¨ï¼Œéœ€è¦å…ˆç”¨ `gid -> TileInfo`ï¼‰

```cpp
// src/engine/loader/level_loader.cppï¼ˆèŠ‚é€‰ï¼‰
auto gid = object.value("gid", 0);
if (gid == 0) {
    entity_builder_->configure(&object)->build();
} else {
    auto tile_info = getTileInfoByGid(gid);
    entity_builder_->configure(&object, &tile_info.value())->build();
}
```

## ğŸ§  gid â†’ TileInfoï¼šå¦‚ä½•æ‰¾åˆ°â€œå®ƒå±äºå“ªä¸ª tilesetâ€

### 1) æŒ‰ `firstgid` å­˜ tilesetï¼šloadTileset

åœ°å›¾æ–‡ä»¶åªè®°å½• tileset çš„ `source` ä¸ `firstgid`ï¼Œå› æ­¤æˆ‘ä»¬è¦ï¼š

- è¯»å– `.tsj`
- æŠŠ `tileset_json` å­˜èµ·æ¥
- é¢å¤–æ³¨å…¥ä¸€ä¸ª `file_path`ï¼ˆåç»­è§£æå›¾ç‰‡ç›¸å¯¹è·¯å¾„éœ€è¦ï¼‰

```cpp
// src/engine/loader/level_loader.cppï¼ˆèŠ‚é€‰ï¼‰
ts_json["file_path"] = tileset_path;
tileset_data_[first_gid] = std::move(ts_json);
```

### 2) ç”¨ upper_bound æ‰¾åˆ°æœ€è¿‘çš„ firstgid

ç»™å®šä¸€ä¸ª `gid`ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ»¡è¶³ `firstgid <= gid` çš„é‚£ä¸ª tilesetï¼›å®ç°ä¸Šç”¨ `std::map` çš„ `upper_bound`ï¼š

```cpp
// src/engine/loader/level_loader.cppï¼ˆèŠ‚é€‰ï¼‰
auto tileset_it = tileset_data_.upper_bound(gid);
if (tileset_it == tileset_data_.begin()) return std::nullopt;
--tileset_it;

auto local_id = gid - tileset_it->first; // gid -> tileset local id
```

ç„¶åå°±è¿›å…¥â€œå•å›¾é›† / å¤šå›¾é›†â€ä¸¤ç§è§£æåˆ†æ”¯ã€‚

### 2.5) æµç¨‹å›¾ï¼šgid â†’ TileInfo â†’ ECS å®ä½“

ç”¨ä¸€å¼ â€œä»æ•°æ®åˆ°å®ä½“â€çš„æµç¨‹å›¾ï¼ŒæŠŠæœ¬èŠ‚æœ€å…³é”®çš„é“¾è·¯ä¸²èµ·æ¥ï¼š

```text
Tiled å¯¼å‡ºæ•°æ®ï¼ˆ.tmj/.tsjï¼‰
        |
        |  layer.data[] / object.gid
        v
     gidï¼ˆå…¨å±€ IDï¼‰
        |
        |  (æœ¬èŠ‚æš‚æœªå¤„ç†ç¿»è½¬/æ—‹è½¬ flagï¼›ä¸‹ä¸€èŠ‚è¡¥é½)
        v
tileset_data_ï¼ˆfirstgid -> tileset jsonï¼‰
        |
        |  upper_bound(gid) æ‰¾åˆ°æœ€è¿‘çš„ firstgid
        v
tileset_json + local_id = gid - firstgid
        |
        |  å•å›¾é›†: image/columns/tilewidth -> src_rect
        |  å¤šå›¾é›†: tiles[] é‡ŒæŒ‰ id æ‰¾ image
        v
TileInfo{ Sprite, type, animation?, properties? }
        |
        |  BasicEntityBuilder.configure(...)
        v
buildBase -> buildSprite -> buildTransform -> buildAnimation
        |
        v
ECS entity + componentsï¼ˆäº¤ç»™ç³»ç»Ÿæ¸²æŸ“/æ›´æ–°ï¼‰
```

### 3) å•å›¾é›†ï¼šè®¡ç®—æºçŸ©å½¢ + æ”¯æŒåŠ¨ç”»

å•å›¾é›† tileset æœ‰ `image` å­—æ®µï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ `columns/tilewidth/tileheight` ç›´æ¥ç®—æºçŸ©å½¢ï¼š

```cpp
// src/engine/loader/level_loader.cppï¼ˆèŠ‚é€‰ï¼‰
auto texture_rect = getTextureRect(tileset, local_id);
auto texture_path = resolvePath(tileset["image"].get<std::string>(), file_path);
tile_info.sprite_ = engine::component::Sprite(texture_path, texture_rect);
```

å¦‚æœæŸä¸ª tile æœ‰ `animation[]`ï¼Œæœ¬èŠ‚ä¼šæŠŠå®ƒè§£ææˆ `AnimationFrame` åˆ—è¡¨ï¼Œå¹¶å†™å…¥ `tile_info.animation_`ï¼š

```cpp
// src/engine/loader/level_loader.cppï¼ˆèŠ‚é€‰ï¼‰
if (tile_json.contains("animation") && is_single_image && tile_json["animation"].is_array()) {
    std::vector<engine::component::AnimationFrame> animation_frames;
    for (auto& frame : tile_json["animation"]) {
        float duration_ms = frame.value("duration", 100.0f);
        int id = frame.value("tileid", 0);
        auto frame_rect = getTextureRect(tileset, id);
        animation_frames.push_back(engine::component::AnimationFrame(frame_rect, duration_ms));
    }
    tile_info.animation_ = engine::component::Animation(std::move(animation_frames));
}
```

### 4) å¤šå›¾é›†ï¼šä» tiles[] é‡ŒæŒ‰ id æ‰¾åˆ° image

å¤šå›¾é›† tileset æ²¡æœ‰ `image`ï¼Œè€Œæ˜¯åœ¨ `tiles[]` é‡Œç»™æ¯ä¸ª tile é… `image`ã€‚æœ¬èŠ‚çš„åšæ³•æ˜¯éå† `tiles[]` æŸ¥æ‰¾ `id == local_id`ï¼Œç„¶åç”¨ `image/imagewidth/imageheight` åˆ›å»ºç²¾çµã€‚

## ğŸ§­ resolvePathï¼šæŠŠ Tiled çš„ç›¸å¯¹è·¯å¾„å˜æˆå¯ç”¨çš„æ–‡ä»¶è·¯å¾„

Tiled å¯¼å‡ºçš„ JSON é‡Œç»å¸¸æ˜¯ç›¸å¯¹è·¯å¾„ï¼ˆè¿˜å¸¦ `..`ï¼‰ï¼Œå› æ­¤ LevelLoader ç»Ÿä¸€ç”¨ `resolvePath()` æ¥æ‹¼è·¯å¾„å¹¶ canonical åŒ–ï¼š

```cpp
// src/engine/loader/level_loader.cppï¼ˆèŠ‚é€‰ï¼‰
auto map_dir = std::filesystem::path(file_path).parent_path();
auto final_path = std::filesystem::canonical(map_dir / relative_path);
return final_path.string();
```

## ğŸ—ï¸ BasicEntityBuilderï¼šé…ç½® â†’ æ„å»º â†’ è¿”å›ï¼ˆå¯æ‰©å±•ï¼‰

Builder çš„æ¥å£éå¸¸ç›´ç™½ï¼š`configure(...) -> build() -> getEntityID()`ï¼Œå¹¶ä¸”æä¾›ä¸‰ä¸ª `configure` é‡è½½ï¼Œåˆ†åˆ«å¯¹åº”ï¼š

- å¯¹è±¡å±‚çš„å½¢çŠ¶å¯¹è±¡ï¼š`configure(object_json)`
- å¯¹è±¡å±‚çš„å›¾ç‰‡å¯¹è±¡ï¼š`configure(object_json, tile_info)`
- ç“¦ç‰‡å±‚çš„ tileï¼š`configure(index, tile_info)`

æ„å»ºæ—¶æŒ‰é¡ºåºæ·»åŠ ç»„ä»¶ï¼š

```cpp
// src/engine/loader/basic_entity_builder.cppï¼ˆèŠ‚é€‰ï¼‰
buildBase();
buildSprite();
buildTransform();
buildAnimation();
buildAudio();
```

å…¶ä¸­æœ€â€œå®¹æ˜“è¸©å‘â€çš„æ˜¯ Transformï¼š

- å¯¹è±¡å±‚çš„ `x/y` åœ¨ Tiled é‡Œå¾€å¾€æ˜¯â€œå·¦ä¸‹è§’â€ï¼Œè€Œæˆ‘ä»¬å¸Œæœ›ç»Ÿä¸€æˆâ€œå·¦ä¸Šè§’â€ï¼Œæ‰€ä»¥è¦åš `y - height` çš„ä¿®æ­£
- å›¾ç‰‡å¯¹è±¡è¿˜è¦æŒ‰ç›®æ ‡ `width/height` ä¸æºå›¾å¤§å°è®¡ç®—ç¼©æ”¾
- ç“¦ç‰‡å±‚å®ä½“åˆ™é€šè¿‡ `index` åæ¨ `(col,row)` å†ä¹˜ä»¥ `tile_size`

```cpp
// src/engine/loader/basic_entity_builder.cppï¼ˆèŠ‚é€‰ï¼‰
position_ = glm::vec2(object_json_->value("x", 0.0f), object_json_->value("y", 0.0f));
dst_size_ = glm::vec2(object_json_->value("width", 0.0f), object_json_->value("height", 0.0f));
position_ = glm::vec2(position_.x, position_.y - dst_size_.y);

if (index_ >= 0) {
    position_ = glm::vec2((index_ % map_size.x) * tile_size.x,
                          (index_ / map_size.x) * tile_size.y);
}
registry_.emplace<engine::component::TransformComponent>(entity_id_, position_, scale, rotation);
```

`buildAnimation()` åˆ™æŠŠ `tile_info_` é‡Œè§£æå¥½çš„åŠ¨ç”»å¡è¿› `AnimationComponent`ï¼ˆåŠ¨ç”»åé»˜è®¤ç”¨ `"tile"`ï¼‰ï¼š

```cpp
// src/engine/loader/basic_entity_builder.cppï¼ˆèŠ‚é€‰ï¼‰
auto animation_id = entt::hashed_string("tile");
animations.emplace(animation_id, std::move(tile_info_->animation_.value()));
registry_.emplace<engine::component::AnimationComponent>(entity_id_, std::move(animations), animation_id);
```

## ğŸ® GameScene æ¥å…¥ï¼šçœŸæ­£æŠŠåœ°å›¾â€œæ¬è¿›â€æ¸¸æˆ

æœ€ååœ¨ `GameScene::init()` ä¸­è°ƒç”¨ `loadLevel()`ï¼ŒæŠŠ `assets/maps/level1.tmj` è§£ææˆ ECS å®ä½“ï¼š

```cpp
// src/game/scene/game_scene.cppï¼ˆèŠ‚é€‰ï¼‰
engine::loader::LevelLoader level_loader;
if (!level_loader.loadLevel("assets/maps/level1.tmj", this)) {
    spdlog::error("åŠ è½½å…³å¡å¤±è´¥");
    return false;
}
```

ä»è¿™ä¸€åˆ»èµ·ï¼šåœ°å›¾ç“¦ç‰‡/èƒŒæ™¯/å¯¹è±¡ä¸å†éœ€è¦ç¡¬ç¼–ç åˆ›å»ºï¼Œ`RenderSystem` ä¼šåƒæ¸²æŸ“æ™®é€šå®ä½“ä¸€æ ·æ¸²æŸ“å®ƒä»¬ï¼ˆå› ä¸ºå®ƒä»¬éƒ½æœ‰ `TransformComponent + SpriteComponent`ï¼ŒåŠ¨ç”»ç“¦ç‰‡è¿˜æœ‰ `AnimationComponent`ï¼‰ã€‚

## ğŸ§© é¡ºæ‰‹è°ƒæ•´ï¼šçª—å£ä¸é€»è¾‘åˆ†è¾¨ç‡çš„ç¼©æ”¾ï¼ˆä¸ºäº†æ›´å¥½åœ°çœ‹è§åœ°å›¾ï¼‰

ä¸ºäº†è®©å…³å¡åœ¨å±å¹•é‡Œæ›´â€œåƒåƒç´ æ¸¸æˆâ€ï¼Œé…ç½®æ–‡ä»¶æ–°å¢äº†ä¸¤ä¸ªç¼©æ”¾å‚æ•°ï¼š

- `window_scale`ï¼šå®é™…çª—å£å¤§å°ç¼©æ”¾
- `logical_scale`ï¼šSDL é€»è¾‘åˆ†è¾¨ç‡ç¼©æ”¾ï¼ˆå½±å“åƒç´ å¯†åº¦ä¸ letterboxï¼‰

å¯¹åº”å­—æ®µåœ¨ `assets/config.json`ã€`src/engine/core/config.*` ä¸ `GameApp::initSDL()` ä¸­è¢«ä¸²äº†èµ·æ¥ã€‚

## âœ… æœ¬èŠ‚å°ç»“

- å¼•å…¥ `LevelLoader`ï¼šè¯»å– `.tmj/.tsj`ï¼ŒæŒ‰ `imagelayer/tilelayer/objectgroup` ä¸‰ç±»å›¾å±‚åŠ è½½
- å¼•å…¥ `BasicEntityBuilder`ï¼šæŠŠè§£æä¸â€œå»ºå®ä½“â€è§£è€¦ï¼Œå¯æ›¿æ¢/å¯ç»§æ‰¿æ‰©å±•
- ä¸ºç“¦ç‰‡å±‚æ–°å¢ `TileLayerComponent`ï¼Œæ¯ä¸ªç“¦ç‰‡éƒ½æ˜¯ç‹¬ç«‹ entityï¼ˆå¯é€‰åŠ¨ç”»ï¼‰
- å®ç° `gid -> tileset(firstgid) -> local_id -> TileInfo`ï¼Œå¹¶æ”¯æŒå•å›¾é›†ç“¦ç‰‡åŠ¨ç”»è§£æ

## ğŸ” è‡ªæ£€æ¸…å•

- [ ] è¿è¡Œåæ—¥å¿—å‡ºç° â€œ`å…³å¡åŠ è½½å®Œæˆ: assets/maps/level1.tmj`â€
- [ ] èƒŒæ™¯å›¾å±‚èƒ½æ˜¾ç¤ºï¼Œå¹¶ä¸” `parallaxx/parallaxy` è°ƒæ•´åæœ‰æ•ˆæœï¼ˆæœ‰è§†å·®æ„Ÿï¼‰
- [ ] ç“¦ç‰‡å±‚èƒ½æ­£å¸¸é“ºå‡ºæ¥ï¼ˆ`gid == 0` çš„æ ¼å­ä¸ä¼šåˆ›å»ºå®ä½“ï¼‰
- [ ] å¯¹è±¡å±‚çš„å›¾ç‰‡å¯¹è±¡æ˜¾ç¤ºä½ç½®å¤§ä½“æ­£ç¡®ï¼ˆæ³¨æ„ y æ–¹å‘å·²ç»åšäº†ä¿®æ­£ï¼‰
- [ ] å­˜åœ¨åŠ¨ç”»çš„ç“¦ç‰‡èƒ½åŠ¨èµ·æ¥ï¼ˆä¾‹å¦‚ `Tilemap.tsj` é‡Œå¸¦ `animation` çš„ tileï¼‰

## â¡ï¸ ä¸‹ä¸€èŠ‚é¢„å‘Š

æœ¬èŠ‚æˆ‘ä»¬å·²ç»èƒ½æŠŠå…³å¡â€œè½½å…¥å¹¶æ˜¾ç¤ºå‡ºæ¥â€ï¼Œä½†è¿˜ç•™äº†å‡ ä¸ªå¿…è¡¥çš„å‘ï¼š

- `gid` çš„é«˜ä½ç¿»è½¬/æ—‹è½¬ flagï¼ˆä¾‹å¦‚ `2147484301`ï¼‰ç›®å‰æ²¡æœ‰å¤„ç†
- æ›´ç²¾ç»†çš„æ¸²æŸ“é¡ºåº/èƒŒæ™¯è‰²ç­‰ï¼ˆè®©ç”»é¢æ›´ç¨³å®šã€æ›´å¯æ§ï¼‰

è¿™äº›ä¼šåœ¨ä¸‹ä¸€èŠ‚ï¼ˆç¬¬ 13 èŠ‚ï¼šå®Œå–„å…³å¡è½½å…¥å™¨ï¼‰è¡¥é½ã€‚