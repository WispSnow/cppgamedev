# 14 è®¾å®šç§»åŠ¨è·¯å¾„

<div class="video-container">
  <div id="bilibili" class="video-content">
    <!-- Bç«™åµŒå…¥ï¼šä½¿ç”¨ https æ˜ç¡®åè®®ï¼ˆé¿å… file:// æˆ– http å¯¼è‡´è¢«æµè§ˆå™¨æ‹¦æˆªï¼‰ -->
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV1hUk2BsECV&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

[åœ¨ Bilibili ä¸Šè§‚çœ‹](https://www.bilibili.com/video/BV1hUk2BsECV)

## ğŸ“– æ¦‚è¿°

å‰ä¸¤èŠ‚æˆ‘ä»¬æŠŠå…³å¡ä» Tiled è½½å…¥åˆ° ECS ä¸–ç•Œé‡Œï¼Œå¹¶è¡¥é½äº†èƒŒæ™¯è‰²ã€æ¸²æŸ“é¡ºåºä¸ gid ç¿»è½¬ç­‰ç»†èŠ‚ã€‚åˆ°è¿™é‡Œâ€œåœ°å›¾èƒ½æ˜¾ç¤ºâ€äº†ï¼Œä½†å¡”é˜²ç©æ³•çš„ç¬¬ä¸€ä»¶äº‹å…¶å®æ˜¯ï¼š

> æ•Œäººè¦ä»èµ·ç‚¹å‡ºå‘ï¼Œæ²¿ç€é¢„è®¾è·¯çº¿èµ°åˆ°ç»ˆç‚¹ã€‚

è¿™ä¸€èŠ‚æˆ‘ä»¬å…ˆä¸æ€¥ç€â€œåˆ·æ€ª/æˆ˜æ–—â€ï¼Œè€Œæ˜¯æŠŠ**ç§»åŠ¨è·¯å¾„ï¼ˆPath / Waypointsï¼‰**çš„æ•°æ®ç»“æ„ä¸æœ€å°è¿è¡Œé—­ç¯æ­å‡ºæ¥ï¼š

- åœ¨ Tiled ä¸­ç”¨â€œç‚¹å¯¹è±¡â€ç”»å‡ºè·¯å¾„èŠ‚ç‚¹ï¼Œå¹¶ç”¨å±æ€§æŠŠèŠ‚ç‚¹è¿æˆå›¾ï¼ˆæ”¯æŒåˆ†å‰ï¼‰
- å…³å¡åŠ è½½æ—¶è§£æè¿™äº›ç‚¹å¯¹è±¡ï¼Œç”Ÿæˆ `waypoint_nodes_`ï¼ˆèŠ‚ç‚¹è¡¨ï¼‰ä¸ `start_points_`ï¼ˆèµ·ç‚¹åˆ—è¡¨ï¼‰
- ä¸ºæ•Œäººå¼•å…¥ `EnemyComponent`ï¼ˆç›®æ ‡èŠ‚ç‚¹ id + ç§»åŠ¨é€Ÿåº¦ï¼‰
- æ–°å¢ `FollowPathSystem`ï¼šæ¯å¸§æ ¹æ®è·¯å¾„èŠ‚ç‚¹æ›´æ–°æ•Œäººçš„é€Ÿåº¦ï¼Œè®© `MovementSystem` é©±åŠ¨ä½ç§»

![](../æœ¬æœŸå‚è€ƒ/PPTæˆªå›¾/æ€ªç‰©æˆ˜äº‰.061.png)

> PPT ç¬¬ 61 é¡µï¼šç¬¬ 14 èŠ‚æ ‡é¢˜é¡µ

æœ¬èŠ‚å¯¹åº”ä»£ç æ ‡ç­¾ï¼š`14-è®¾å®šç§»åŠ¨è·¯å¾„`ï¼ˆåŸºçº¿ï¼š`13-å®Œå–„å…³å¡è½½å…¥å™¨`ï¼‰ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- ç†è§£ä¸¤ç§è·¯å¾„è¡¨ç¤ºï¼šå•ä¸€è·¯å¾„ï¼ˆ`vector<point>`ï¼‰ä¸åˆ†å‰è·¯å¾„ï¼ˆèŠ‚ç‚¹å›¾ï¼‰
- å®šä¹‰è·¯å¾„èŠ‚ç‚¹ç»“æ„ `WaypointNode { id, position, next_node_ids }`ï¼Œå¹¶ç»´æŠ¤ `unordered_map<int, WaypointNode>`
- é€šè¿‡è‡ªå®šä¹‰ Builderï¼ˆ`EntityBuilderMW`ï¼‰åœ¨å…³å¡åŠ è½½é˜¶æ®µè§£æè·¯å¾„ç‚¹å¯¹è±¡
- å®ç° `FollowPathSystem`ï¼šåˆ°è¾¾èŠ‚ç‚¹ååˆ‡æ¢ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆè‹¥æœ‰å¤šä¸ªåˆ™éšæœºé€‰æ‹©ï¼‰ï¼Œåˆ°è¾¾ç»ˆç‚¹åˆ™å‘é€äº‹ä»¶å¹¶æ ‡è®°åˆ é™¤
- å¼•å…¥â€œå»¶è¿Ÿåˆ é™¤â€æ¨¡å¼ï¼š`DeadTag` + `RemoveDeadSystem`

## ğŸ§  1) è·¯å¾„æ•°æ®ç»“æ„ï¼šä¸ºä»€ä¹ˆä¸ç”¨ä¸€ä¸ª vector èµ°åˆ°åº•ï¼Ÿ

å¦‚æœåªæœ‰ä¸€æ¡å›ºå®šè·¯çº¿ï¼Œæœ€ç®€å•çš„ç»“æ„ç¡®å®æ˜¯ï¼š

- `std::vector<glm::vec2> waypoints;`
- æ•Œäººä¿å­˜å½“å‰ä¸‹æ ‡ `i`ï¼Œåˆ°ç‚¹äº†å°± `i++`

ä½†å¡”é˜²é‡Œç»å¸¸å‡ºç° **åˆ†å‰è·¯å¾„**ï¼ˆä¾‹å¦‚å¤šæ¡è·¯æ±‡èšåˆ°åŸºåœ°ï¼‰ï¼Œè¿™æ—¶ä»…é â€œä¸‹æ ‡é€’å¢â€å°±ä¸å¤Ÿäº†ã€‚æ›´é€šç”¨çš„æ–¹å¼æ˜¯æŠŠè·¯å¾„çœ‹æˆä¸€å¼ æœ‰å‘å›¾ï¼š

- æ¯ä¸ªèŠ‚ç‚¹æœ‰ä¸€ä¸ª `id`
- èŠ‚ç‚¹çŸ¥é“è‡ªå·±å¯ä»¥èµ°å‘å“ªäº›â€œä¸‹ä¸€èŠ‚ç‚¹â€ï¼ˆåˆ—è¡¨ï¼‰
- å¯èƒ½æœ‰å¤šä¸ªèµ·ç‚¹ï¼ˆå¤šä¸ªå‡ºæ€ªå£ï¼‰

![](../æœ¬æœŸå‚è€ƒ/PPTæˆªå›¾/æ€ªç‰©æˆ˜äº‰.062.png)

> PPT ç¬¬ 62 é¡µï¼šè·¯å¾„ç»“æ„å»ºè®®ï¼šå•ä¸€è·¯å¾„ vs å¸¦åˆ†å‰è·¯å¾„ï¼›æ•Œäººç»„ä»¶ä¿å­˜ç›®æ ‡èŠ‚ç‚¹ id ä¸ç§»åŠ¨é€Ÿåº¦

é¡¹ç›®é‡Œé€‰æ‹©äº†â€œåˆ†å‰å‹å¥½â€çš„è¡¨ç¤ºï¼š

```cpp
// src/game/data/waypoint_node.h
struct WaypointNode {
    int id_;
    glm::vec2 position_;
    std::vector<int> next_node_ids_;
};
```

å¹¶åœ¨ `GameScene` ä¸­ç»´æŠ¤ä¸¤ä»½è¿è¡Œæ—¶æ•°æ®ï¼š

```cpp
// src/game/scene/game_scene.hï¼ˆèŠ‚é€‰ï¼‰
std::unordered_map<int, game::data::WaypointNode> waypoint_nodes_;
std::vector<int> start_points_;
```

## ğŸ—ºï¸ 2) åœ¨ Tiled é‡Œç”»è·¯å¾„ï¼šç”¨â€œç‚¹å¯¹è±¡ + å±æ€§â€è¿æˆå›¾

æœ¬èŠ‚æŠŠè·¯å¾„æ”¾åœ¨åœ°å›¾çš„ä¸€ä¸ªå¯¹è±¡å›¾å±‚é‡Œï¼ˆlayer åå« `path`ï¼‰ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ª **point å¯¹è±¡**ï¼ˆ`.tmj` ä¸­ä¼šå‡ºç° `"point":true`ï¼‰ã€‚

å…³é”®æ˜¯â€œå¦‚ä½•è¿çº¿â€ï¼šæˆ‘ä»¬ç”¨å¯¹è±¡å±æ€§æŠŠä¸€ä¸ªèŠ‚ç‚¹æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚

### 2.1 å•åˆ†æ”¯ï¼š`next` å±æ€§ï¼ˆtype: objectï¼‰

`assets/maps/level1.tmj` ä¸­ï¼Œä¸€ä¸ªæœ€ç®€å•çš„èŠ‚ç‚¹é•¿è¿™æ ·ï¼š

```json
{
  "id":67,
  "point":true,
  "properties":[
    { "name":"next", "type":"object", "value":68 },
    { "name":"start", "type":"bool", "value":true }
  ],
  "x":-54.6666666666667,
  "y":993.333333333333
}
```

è§£é‡Šï¼š

- `id`ï¼šTiled ä¸ºå¯¹è±¡åˆ†é…çš„å”¯ä¸€ç¼–å·ï¼ˆæˆ‘ä»¬ç›´æ¥æ‹¿å®ƒå½“ waypoint idï¼‰
- `next`ï¼šå¯¹è±¡ç±»å‹å±æ€§ï¼Œ`value` ä¼šå¡«â€œç›®æ ‡å¯¹è±¡çš„ idâ€
- `start`ï¼šå¯é€‰ï¼Œæ ‡è®°è¿™ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªèµ·ç‚¹ï¼ˆå‡ºæ€ªå£ï¼‰

### 2.2 å¤šåˆ†æ”¯ï¼š`next / next2 / next3 ...`

ä¸ºäº†æ”¯æŒåˆ†å‰ï¼Œæœ¬èŠ‚çº¦å®šï¼š**å±æ€§ååªè¦ä»¥ `next` å¼€å¤´å°±ç®—ä¸€æ¡å‡ºè¾¹**ã€‚

ä¾‹å¦‚æŸä¸ªèŠ‚ç‚¹åŒæ—¶æœ‰ `next` ä¸ `next2`ï¼š

```json
{
  "id":79,
  "point":true,
  "properties":[
    { "name":"next",  "type":"object", "value":86 },
    { "name":"next2", "type":"object", "value":80 }
  ]
}
```

è¿™æ ·ä¸€ä¸ªèŠ‚ç‚¹å°±èƒ½æŒ‡å‘å¤šä¸ªä¸‹ä¸€èŠ‚ç‚¹ï¼Œç³»ç»Ÿé‡Œå¯ä»¥éšæœºé€‰ä¸€æ¡è·¯ï¼ˆåé¢ä¼šçœ‹åˆ°å®ç°ï¼‰ã€‚

> å°æé†’ï¼šå¯¹è±¡ `id` æ˜¯ Tiled è‡ªåŠ¨ç»´æŠ¤çš„ã€‚ä¸€èˆ¬â€œæ”¹ä½ç½®/æ”¹å±æ€§â€ä¸ä¼šå˜ï¼Œä½†å¦‚æœä½ åˆ é™¤å¯¹è±¡å†æ–°å»ºï¼Œid å¯èƒ½ä¼šå˜åŒ–ï¼›è¿™ä¼šå½±å“ `next` çš„å¼•ç”¨å…³ç³»ã€‚

## ğŸ§± 3) å…³å¡åŠ è½½é˜¶æ®µè§£æè·¯å¾„ï¼šEntityBuilderMWï¼ˆå†æ¬¡ä½¿ç”¨ Builder å¯æ›¿æ¢èƒ½åŠ›ï¼‰

ç¬¬ 12 èŠ‚æˆ‘ä»¬å¼•å…¥äº† Builderï¼š`LevelLoader` è´Ÿè´£â€œè§£æ JSONâ€ï¼ŒBuilder è´Ÿè´£â€œæŠŠæ•°æ®å˜æˆå®ä½“/ç»„ä»¶â€ã€‚

è¿™èŠ‚æˆ‘ä»¬æ›´è¿›ä¸€æ­¥ï¼š**æ¸¸æˆä¾§éœ€è¦è§£æâ€œè‡ªå®šä¹‰çš„å½¢çŠ¶å¯¹è±¡â€ï¼ˆè·¯å¾„ç‚¹ï¼‰**ï¼Œä½†å¼•æ“çš„ `BasicEntityBuilder` å¹¶ä¸çŸ¥é“â€œpoint + next/startâ€æ˜¯ä»€ä¹ˆæ„æ€ã€‚

å› æ­¤æˆ‘ä»¬ä¸ºæ€ªç‰©æˆ˜äº‰å†™äº†ä¸€ä¸ªè‡ªå®šä¹‰ Builderï¼š`EntityBuilderMW`ï¼Œå®ƒç»§æ‰¿ `BasicEntityBuilder` å¹¶é¢å¤–æŒæœ‰ä¸¤ä»½å¼•ç”¨ï¼š

```cpp
// src/game/loader/entity_builder_mw.hï¼ˆèŠ‚é€‰ï¼‰
std::unordered_map<int, game::data::WaypointNode>& waypoint_nodes_;
std::vector<int>& start_points_;
```

### 3.1 override buildï¼šå½¢çŠ¶å¯¹è±¡èµ° buildPathï¼Œå…¶å®ƒå¯¹è±¡èµ°çˆ¶ç±»

`LevelLoader` åœ¨å¯¹è±¡å±‚è§£ææ—¶ï¼Œé‡åˆ° `gid == 0` ä¼šèµ°â€œå½¢çŠ¶å¯¹è±¡â€åˆ†æ”¯ï¼š`configure(&object)->build()`ã€‚

æˆ‘ä»¬çš„ç­–ç•¥æ˜¯ï¼š

- `object_json_ && !tile_info_`ï¼šå½¢çŠ¶å¯¹è±¡ â†’ åªåšè·¯å¾„è§£æï¼ˆä¸åˆ›å»ºå®ä½“ï¼‰
- å¦åˆ™ï¼šå›¾ç‰‡å¯¹è±¡/ç“¦ç‰‡ â†’ ç»§ç»­å¤ç”¨ `BasicEntityBuilder` çš„æ„å»ºé€»è¾‘

```cpp
// src/game/loader/entity_builder_mw.cppï¼ˆèŠ‚é€‰ï¼‰
EntityBuilderMW* EntityBuilderMW::build() {
    if (object_json_ && !tile_info_) {
        buildPath();
    } else {
        BasicEntityBuilder::build();
    }
    return this;
}
```

### 3.2 buildPathï¼šæŠŠ point å¯¹è±¡è½¬æˆ WaypointNode

æ ¸å¿ƒè§£æé€»è¾‘ï¼š

1) åªå¤„ç† `point == true` çš„å¯¹è±¡  
2) å–å¯¹è±¡çš„ `id / x / y`  
3) éå† `properties[]`ï¼š  
   - `type == "object"` ä¸” `name` ä»¥ `next` å¼€å¤´ â†’ è®°å…¥ `next_node_ids`  
   - `name == "start"` ä¸”å€¼ä¸º `true` â†’ æŠŠ id æ”¾è¿› `start_points_`  
4) å†™å…¥ `waypoint_nodes_[id] = WaypointNode{...}`  

```cpp
// src/game/loader/entity_builder_mw.cppï¼ˆèŠ‚é€‰ï¼‰
if (object_json_->value("point", false) != true) return;
auto id = object_json_->value("id", 0);
auto position = glm::vec2(object_json_->value("x", 0.0f), object_json_->value("y", 0.0f));

for (auto& property : object_json_->at("properties")) {
    if (property.value("type", "") == "object" && property.value("name", "").starts_with("next")) {
        next_node_ids.push_back(property.value("value", 0));
    }
    if (property.value("name", "") == "start" && property.value("value", false) == true) {
        start_points_.push_back(id);
    }
}
waypoint_nodes_[id] = game::data::WaypointNode{id, std::move(position), std::move(next_node_ids)};
```

### 3.3 GameScene æ¥å…¥ï¼šæŠŠè‡ªå®šä¹‰ Builder æ³¨å…¥ LevelLoader

`GameScene::loadLevel()` ä¸­é€šè¿‡ `setEntityBuilder()` æŠŠ Builder æ¢æˆæ¸¸æˆä¾§æ‰©å±•ç‰ˆæœ¬ï¼š

```cpp
// src/game/scene/game_scene.cppï¼ˆèŠ‚é€‰ï¼‰
engine::loader::LevelLoader level_loader;
level_loader.setEntityBuilder(std::make_unique<game::loader::EntityBuilderMW>(
    level_loader, context_, registry_, waypoint_nodes_, start_points_));
level_loader.loadLevel("assets/maps/level1.tmj", this);
```

è¿™æ ·å…³å¡åŠ è½½å®Œæ¯•æ—¶ï¼Œæˆ‘ä»¬å°±åŒæ—¶æ‹¥æœ‰ï¼š

- åœ°å›¾/è£…é¥°ç­‰ ECS å®ä½“ï¼ˆç”±å¼•æ“ Builder è´Ÿè´£ï¼‰
- è·¯å¾„èŠ‚ç‚¹è¡¨ `waypoint_nodes_` ä¸èµ·ç‚¹åˆ—è¡¨ `start_points_`ï¼ˆç”±æ¸¸æˆ Builder è´Ÿè´£ï¼‰

## ğŸ§Ÿ 4) æ•Œäººç»„ä»¶ï¼šç›®æ ‡èŠ‚ç‚¹ id + é€Ÿåº¦

æ•Œäººéœ€è¦çŸ¥é“ä¸¤ä»¶äº‹ï¼š

1) å½“å‰è¦èµ°å‘å“ªä¸ªç›®æ ‡èŠ‚ç‚¹  
2) ä»¥å¤šå¿«çš„é€Ÿåº¦ç§»åŠ¨  

äºæ˜¯å¼•å…¥ `EnemyComponent`ï¼š

```cpp
// src/game/component/enemy_component.h
struct EnemyComponent {
    int target_waypoint_id_;
    float speed_;
};
```

## ğŸ§­ 5) FollowPathSystemï¼šæŠŠâ€œè·¯å¾„èŠ‚ç‚¹â€è½¬æ¢æˆ Velocityï¼ˆè®© MovementSystem æ¥ç®¡ä½ç§»ï¼‰

è¿™ä¸€èŠ‚çš„å…³é”®ç³»ç»Ÿæ˜¯ `FollowPathSystem`ï¼šå®ƒä¸ç›´æ¥æ”¹ä½ç½®ï¼Œè€Œæ˜¯è®¡ç®—â€œæœå“ªä¸ªæ–¹å‘èµ°â€ï¼Œå¹¶æ›´æ–° `VelocityComponent`ã€‚

ç­›é€‰æ¡ä»¶ä¹Ÿå¾ˆæ¸…æ™°ï¼šå¿…é¡»åŒæ—¶æ‹¥æœ‰

- `TransformComponent`ï¼ˆå½“å‰ä½ç½®ï¼‰
- `VelocityComponent`ï¼ˆæˆ‘ä»¬è¦å†™çš„é€Ÿåº¦ï¼‰
- `EnemyComponent`ï¼ˆç›®æ ‡èŠ‚ç‚¹ä¸é€Ÿåº¦ï¼‰

```cpp
// src/game/system/followpath_system.cppï¼ˆèŠ‚é€‰ï¼‰
auto view = registry.view<engine::component::VelocityComponent,
                          engine::component::TransformComponent,
                          game::component::EnemyComponent>();
```

æ¯ä¸ªæ•Œäººçš„æ›´æ–°é€»è¾‘ï¼š

1) æ ¹æ® `enemy.target_waypoint_id_` æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹  
2) `direction = target.position - transform.position`  
3) è‹¥è·ç¦»å°äºé˜ˆå€¼ï¼šåˆ°è¾¾èŠ‚ç‚¹  
   - å¦‚æœ `next_node_ids` ä¸ºç©ºï¼šåˆ°è¾¾ç»ˆç‚¹ â†’ å‘é€äº‹ä»¶ + æ ‡è®°æ­»äº¡  
   - å¦åˆ™ï¼šä» `next_node_ids` éšæœºé€‰ä¸€ä¸ªæ–°ç›®æ ‡  
4) é€Ÿåº¦æ›´æ–°ï¼š`velocity = normalize(direction) * speed`  

```cpp
// src/game/system/followpath_system.cppï¼ˆèŠ‚é€‰ï¼‰
if (glm::length(direction) < 5.0f) {
    if (target_node.next_node_ids_.empty()) {
        dispatcher.enqueue<game::defs::EnemyArriveHomeEvent>();
        registry.emplace<game::defs::DeadTag>(entity);
        continue;
    }
    auto target_index = engine::utils::randomInt(0, size - 1);
    enemy.target_waypoint_id_ = target_node.next_node_ids_[target_index];
}
velocity.velocity_ = glm::normalize(direction) * enemy.speed_;
```

æ³¨æ„ä¸¤ç‚¹ï¼š

- **é˜ˆå€¼ä¸è¦å¤ªå°**ï¼šæ•Œäººé€Ÿåº¦å¿«æ—¶å¯èƒ½â€œè¶Šè¿‡ç›®æ ‡ç‚¹æ¥å›æŠ–åŠ¨â€
- åˆ†å‰è·¯å¾„çš„â€œéšæœºé€‰æ‹©â€ç”¨åˆ°äº†æ–°å¢çš„å·¥å…·å‡½æ•° `engine::utils::randomInt(min, max)`

## ğŸ§¹ 6) å»¶è¿Ÿåˆ é™¤ï¼šDeadTag + RemoveDeadSystem

å½“æ•Œäººåˆ°è¾¾ç»ˆç‚¹æ—¶ï¼Œæˆ‘ä»¬åšäº†ä¸¤ä»¶äº‹ï¼š

1) `dispatcher.enqueue<EnemyArriveHomeEvent>()`ï¼šå‘ä¸€ä¸ªäº‹ä»¶ï¼ˆåç»­åŠ åŸºåœ°æ‰£è¡€/å¤±è´¥åˆ¤å®šï¼‰  
2) `registry.emplace<DeadTag>(entity)`ï¼šå…ˆæ‰“ä¸Šâ€œæ­»äº¡æ ‡ç­¾â€ï¼Œä¸è¦ç«‹åˆ» `destroy`  

`DeadTag` æ˜¯ä¸€ä¸ªç©ºç»“æ„ä½“ï¼Œç”¨ä½œ EnTT çš„æ ‡ç­¾ç»„ä»¶ï¼ˆé›¶å¼€é”€ï¼‰ï¼š

```cpp
// src/game/defs/tags.h
struct DeadTag {};
```

ç„¶åä¸“é—¨ç”¨ä¸€ä¸ªç³»ç»Ÿåœ¨â€œä¸‹ä¸€å¸§å¼€å¤´â€æ¸…ç†ï¼š

```cpp
// src/game/system/remove_dead_system.cppï¼ˆèŠ‚é€‰ï¼‰
auto view = registry.view<game::defs::DeadTag>();
for (auto entity : view) {
    registry.destroy(entity);
}
```

è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼š

- é¿å…åœ¨ç³»ç»Ÿéå† view çš„è¿‡ç¨‹ä¸­ç›´æ¥é”€æ¯å®ä½“å¯¼è‡´è¿­ä»£å™¨é—®é¢˜
- äº‹ä»¶æ˜¯ `enqueue` çš„ï¼Œä¼šåœ¨ `dispatcher.update()` æ—¶ç»Ÿä¸€åˆ†å‘ï¼›â€œä¸‹ä¸€å¸§æ¸…ç†â€æ›´ç¬¦åˆäº‹ä»¶é˜Ÿåˆ—çš„æ—¶åº

## ğŸ® 7) GameScene ä¸²èµ·æ¥ï¼šåŠ è½½è·¯å¾„ â†’ åˆ›å»ºæµ‹è¯•æ•Œäºº â†’ ç³»ç»Ÿé¡ºåº

`GameScene::init()` é‡Œæ–°å¢äº†ä¸‰ä»¶äº‹ï¼š

- åˆå§‹åŒ–äº‹ä»¶è¿æ¥ï¼ˆç›‘å¬ `EnemyArriveHomeEvent`ï¼‰
- åˆ›å»ºæµ‹è¯•æ•Œäººï¼ˆæ¯ä¸ªèµ·ç‚¹æ¥ä¸€ä¸ªï¼‰
- æŠŠæ–°ç³»ç»Ÿæ’å…¥ update é“¾è·¯

### 7.1 äº‹ä»¶è¿æ¥ï¼šæ•Œäººåˆ°å®¶äº†å…ˆæ‰“æ—¥å¿—

```cpp
// src/game/scene/game_scene.cppï¼ˆèŠ‚é€‰ï¼‰
dispatcher.sink<game::defs::EnemyArriveHomeEvent>()
          .connect<&GameScene::onEnemyArriveHome>(this);
```

### 7.2 åˆ›å»ºæµ‹è¯•æ•Œäººï¼šä» start_points_ å‡ºå‘

```cpp
// src/game/scene/game_scene.cppï¼ˆèŠ‚é€‰ï¼‰
for (auto start_index : start_points_) {
    auto position = waypoint_nodes_[start_index].position_;
    auto enemy = registry_.create();
    registry_.emplace<engine::component::TransformComponent>(enemy, position);
    registry_.emplace<engine::component::VelocityComponent>(enemy, glm::vec2(0, 0));
    registry_.emplace<game::component::EnemyComponent>(enemy, start_index, 100.0f);
}
```

å¹¶é¡ºæ‰‹ç»™å®ƒè¡¥ä¸Šæ¸²æŸ“æ‰€éœ€çš„ç»„ä»¶ï¼ˆSprite + RenderComponentï¼‰ã€‚å…¶ä¸­ Sprite çš„ `offset` ç”¨æ¥è°ƒæ•´â€œé”šç‚¹â€ï¼Œè®©æ•Œäººçš„é€»è¾‘ä½ç½®æ›´è´´è¿‘è„šåº•/ä¸­å¿ƒï¼ˆæ–¹ä¾¿è·¯å¾„ç‚¹å¯¹é½ï¼‰ï¼š

```cpp
auto sprite = engine::component::Sprite("assets/textures/Enemy/wolf.png", engine::utils::Rect{0, 0, 192, 192});
registry_.emplace<engine::component::SpriteComponent>(enemy, std::move(sprite), glm::vec2(192, 192), glm::vec2(-96, -128));
registry_.emplace<engine::component::RenderComponent>(enemy, 10);
```

### 7.3 ç³»ç»Ÿé¡ºåºï¼šFollowPath â†’ Movement â†’ YSort

è¿™ä¸€èŠ‚æˆ‘ä»¬æŠŠç³»ç»Ÿé¡ºåºæ˜ç¡®ä¸‹æ¥ï¼ˆéå¸¸å…³é”®ï¼‰ï¼š

1) **å…ˆæ¸…ç†æ­»äº¡å®ä½“**ï¼ˆä¸Šä¸€å¸§æ ‡è®°çš„ DeadTagï¼‰  
2) **FollowPathSystem** æ›´æ–°é€Ÿåº¦ï¼ˆä¾èµ–å½“å‰ä½ç½®ï¼‰  
3) **MovementSystem** æ›´æ–°ä½ç½®ï¼ˆä¾èµ–é€Ÿåº¦ï¼‰  
4) **YSortSystem** æ›´æ–°æ·±åº¦ï¼ˆä¾èµ–æ–°ä½ç½®ï¼‰  

```cpp
remove_dead_system_->update(registry_);
follow_path_system_->update(registry_, dispatcher, waypoint_nodes_);
movement_system_->update(registry_, delta_time);
animation_system_->update(registry_, delta_time);
ysort_system_->update(registry_);
```

## âœ… æœ¬èŠ‚å°ç»“

- ç”¨ `WaypointNode + unordered_map` è¡¨ç¤ºåˆ†å‰è·¯å¾„ï¼Œå¹¶ç”¨ `start_points_` æ”¯æŒå¤šèµ·ç‚¹
- åœ¨ Tiled ç”¨ point å¯¹è±¡ç”»èŠ‚ç‚¹ï¼Œç”¨ `next/next2...`ï¼ˆobject ç±»å‹ï¼‰è¡¨ç¤ºè¿çº¿ï¼Œç”¨ `start` æ ‡è®°èµ·ç‚¹
- é€šè¿‡è‡ªå®šä¹‰ Builder `EntityBuilderMW` åœ¨å…³å¡åŠ è½½é˜¶æ®µè§£æè·¯å¾„ç‚¹å¯¹è±¡
- `FollowPathSystem` è®¡ç®—æ–¹å‘å¹¶æ›´æ–° `VelocityComponent`ï¼Œè®© MovementSystem é©±åŠ¨ä½ç§»
- ç”¨ `DeadTag + RemoveDeadSystem` å®ç°å»¶è¿Ÿåˆ é™¤ï¼›ç»ˆç‚¹è§¦å‘ `EnemyArriveHomeEvent`

## ğŸ” è‡ªæ£€æ¸…å•

- [ ] `waypoint_nodes_` æœ‰æ•°æ®ï¼ˆå¯åœ¨æ—¥å¿—é‡Œè§‚å¯Ÿ sizeï¼‰
- [ ] èµ·ç‚¹åˆ—è¡¨ `start_points_` ä¸ä¸ºç©ºï¼ˆä¼šç”Ÿæˆæµ‹è¯•æ•Œäººï¼‰
- [ ] æ•Œäººèƒ½æ²¿è·¯å¾„ç§»åŠ¨ï¼Œå¹¶åœ¨èŠ‚ç‚¹å¤„å¹³æ»‘åˆ‡æ¢ç›®æ ‡
- [ ] åˆ†å‰èŠ‚ç‚¹ä¼šéšæœºé€‰è·¯ï¼ˆå¤šæ¬¡è¿è¡Œè§‚å¯Ÿè·¯çº¿å·®å¼‚ï¼‰
- [ ] æ•Œäººåˆ°è¾¾ç»ˆç‚¹ä¼šè§¦å‘ â€œæ•Œäººåˆ°è¾¾åŸºåœ°â€ æ—¥å¿—ï¼Œå¹¶åœ¨ä¸‹ä¸€å¸§è¢«æ¸…ç†

## â¡ï¸ ä¸‹ä¸€èŠ‚é¢„å‘Š

ä¸‹ä¸€èŠ‚ï¼ˆç¬¬ 15 èŠ‚ï¼šå®ä½“å·¥å‚ä¸è“å›¾ï¼‰ä¼šæŠŠâ€œåˆ›å»ºæ•Œäºº/ç©å®¶/å»ºç­‘â€çš„é€»è¾‘ä» `GameScene` ä¸­æŠ½å‡ºæ¥ï¼Œåšæˆæ•°æ®é©±åŠ¨çš„ **EntityFactory + Blueprint**ï¼šç”¨ JSON å®šä¹‰å•ä½å±æ€§ä¸ç»„ä»¶ç»„åˆï¼Œè®©å¹³è¡¡å’Œæ‰©å±•éƒ½æ›´è½»æ¾ã€‚
