# 19 è¿œç¨‹æ”»å‡»ä¸å¼¹é“

<div class="video-container">
  <div id="bilibili" class="video-content">
    <!-- Bç«™åµŒå…¥ï¼šä½¿ç”¨ https æ˜ç¡®åè®®ï¼ˆé¿å… file:// æˆ– http å¯¼è‡´è¢«æµè§ˆå™¨æ‹¦æˆªï¼‰ -->
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV1aNUbBpEz7&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

[åœ¨ Bilibili ä¸Šè§‚çœ‹](https://www.bilibili.com/video/BV1aNUbBpEz7)

## ğŸ“– æ¦‚è¿°

ä¸Šä¸€èŠ‚æˆ‘ä»¬åšå®Œäº†â€œåŠ¨ç”»äº‹ä»¶é©±åŠ¨æˆ˜æ–—äº¤äº’â€ï¼š

- åœ¨åŠ¨ç”»å…³é”®å¸§è§¦å‘ `AnimationEvent`ï¼ˆå¦‚ `"hit"_hs`ï¼‰
- `AnimationEventSystem` æŠŠ `"hit"` ç¿»è¯‘æˆ `AttackEvent/HealEvent`
- `CombatResolveSystem` ç»Ÿä¸€ç»“ç®—ä¼¤å®³/æ²»ç–—

ä½†å¯¹äº**è¿œç¨‹æ”»å‡»**æ¥è¯´ï¼Œåªé  `"hit"` è¿˜ä¸å¤Ÿï¼šå¼“ç®­/æ³•çƒéœ€è¦â€œå…ˆå‘å°„ã€å†é£è¡Œã€æœ€åå‘½ä¸­â€ã€‚

æ‰€ä»¥æœ¬èŠ‚æŠŠè¿œç¨‹æ”»å‡»ä¹Ÿçº³å…¥åŒä¸€å¥—äº‹ä»¶é“¾è·¯â€”â€”åªä¸è¿‡åŠ¨ç”»äº‹ä»¶ä» `"hit"` æ¢æˆ `"emit"`ï¼š

![](../æœ¬æœŸå‚è€ƒ/PPTæˆªå›¾/æ€ªç‰©æˆ˜äº‰.074.png)

> PPT ç¬¬ 74 é¡µï¼šåŠ¨ç”»äº‹ä»¶ `"emit"` â†’ å‘å°„æŠ•å°„ç‰© â†’ å‘½ä¸­ï¼ˆæ”»å‡»äº‹ä»¶ï¼‰â†’ ç»“ç®—ä¼¤å®³

æœ¬èŠ‚å¯¹åº”ä»£ç æ ‡ç­¾ï¼š`19-è¿œç¨‹æ”»å‡»ä¸å¼¹é“`ï¼ˆåŸºçº¿ï¼š`18-åŠ¨ç”»é©±åŠ¨çš„æˆ˜æ–—äº¤äº’`ï¼‰ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- ç”¨æ•°æ®é©±åŠ¨â€œæŠ•å°„ç‰©é•¿ä»€ä¹ˆæ ·ã€é£å¤šä¹…ã€å¼§çº¿é«˜åº¦æ˜¯å¤šå°‘â€ï¼ˆ`projectile_data.json`ï¼‰
- è®©â€œè¿œç¨‹å•ä½â€æºå¸¦æŠ•å°„ç‰© IDï¼ˆ`ProjectileIDComponent`ï¼‰
- ç”¨åŠ¨ç”» `"emit"` äº‹ä»¶å‘å°„æŠ•å°„ç‰©ï¼ˆ`EmitProjectileEvent`ï¼‰
- ç”¨ `ProjectileSystem` æ›´æ–°æŠ•å°„ç‰©é£è¡Œï¼Œå¹¶åœ¨å‘½ä¸­æ—¶å‘é€ `AttackEvent`
- å¤„ç†â€œç›®æ ‡å·²æ­»äº¡/äº‹ä»¶é‡å¤è§¦å‘â€ç­‰è¾¹ç•Œæƒ…å†µï¼Œä¿è¯ç³»ç»Ÿå¥å£®

## ğŸ§  æ€è·¯ä¸è®¾è®¡

æŠ•å°„ç‰©çš„æ ¸å¿ƒå…¶å®åªæœ‰ä¸¤ä»¶äº‹ï¼š

1) **ç”Ÿæˆ**ï¼šä»€ä¹ˆæ—¶å€™å‘å°„ï¼Ÿä»å“ªå‘å°„ï¼Ÿæœå“ªé£ï¼Ÿä¼¤å®³æ˜¯å¤šå°‘ï¼Ÿ  
2) **æ›´æ–°**ï¼šæ¯å¸§å¦‚ä½•ç§»åŠ¨ï¼Ÿä½•æ—¶ç®—å‘½ä¸­ï¼Ÿå‘½ä¸­åè§¦å‘ä»€ä¹ˆäº‹ä»¶ï¼Ÿ

è¿™é‡Œæˆ‘ä»¬ç»§ç»­è´¯å½»â€œäº‹ä»¶é©±åŠ¨â€çš„æ€è·¯ï¼ŒæŠŠå®ƒæ‹†æˆä¸‰æ®µï¼š

- åŠ¨ç”»å…³é”®å¸§ `"emit"`ï¼šåªè´Ÿè´£â€œæå‡ºå‘å°„è¯·æ±‚â€
- æŠ•å°„ç‰©ç³»ç»Ÿï¼šè´Ÿè´£â€œåˆ›å»ºæŠ•å°„ç‰©å®ä½“ + æ›´æ–°é£è¡Œâ€
- æˆ˜æ–—ç»“ç®—ç³»ç»Ÿï¼šåªå…³å¿ƒ `AttackEvent`ï¼Œä¸å…³å¿ƒæŠ•å°„ç‰©æ€ä¹ˆé£æ¥çš„

è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼š**æŠ•å°„ç‰©åªæ˜¯æˆ˜æ–—äº¤äº’çš„ä¸€ç§è¡¨ç°å½¢å¼**ï¼Œå®ƒæœ€ç»ˆè¿˜æ˜¯å›åˆ° `AttackEvent` è¿™æ¡ä¸»å¹²ä¸Šï¼Œç³»ç»Ÿè¾¹ç•Œæ¸…æ™°ï¼Œæ‰©å±•ä¹Ÿæ›´å®¹æ˜“ã€‚

## ğŸ”§ å®ç°æ­¥éª¤

## ğŸ§¾ 1) æ•°æ®é©±åŠ¨æŠ•å°„ç‰©ï¼š`projectile_data.json`

æœ¬èŠ‚æ–°å¢ `assets/data/projectile_data.json`ï¼Œç”¨æ¥æè¿°æŠ•å°„ç‰©çš„è¡¨ç°å‚æ•°ï¼š

- ä½¿ç”¨å“ªå¼ ç²¾çµå›¾ï¼ˆæˆ–ç²¾çµè¡¨ä¸­çš„å“ªä¸ªåˆ‡ç‰‡ï¼‰
- èµ·å§‹åç§»ï¼ˆ`offset_x/offset_y`ï¼‰
- å¼§çº¿é«˜åº¦ `arc_height`
- æ€»é£è¡Œæ—¶é—´ `total_flight_time`
- å‘½ä¸­éŸ³æ•ˆï¼ˆ`sounds.hit`ï¼‰

ä¾‹å¦‚ç®­çŸ¢ï¼ˆ`arrow`ï¼‰ï¼š

```json
{
  "arrow": {
    "sprite_sheet": "assets/textures/Units/Arrow.png",
    "offset_x": -32,
    "offset_y": -96,
    "arc_height": 80.0,
    "total_flight_time": 0.5,
    "sounds": { "hit": "arrow_hit" }
  }
}
```

> è¿™ä¸€ä»½æ•°æ®ä¼šåœ¨åé¢è¢« `BlueprintManager::loadProjectileBlueprints()` è¯»å…¥ï¼Œå¹¶ç¼“å­˜æˆ `ProjectileBlueprint`ã€‚

## ğŸ§© 2) è®©è¿œç¨‹å•ä½â€œçŸ¥é“è‡ªå·±è¦å‘ä»€ä¹ˆâ€ï¼šProjectileID

è¦å‘å°„æŠ•å°„ç‰©ï¼Œè§’è‰²èº«ä¸Šè‡³å°‘è¦æœ‰ä¸€ä¸ªâ€œæŠ•å°„ç‰©ç±»å‹â€çš„æ ‡è¯†ã€‚

æœ¬èŠ‚æ–°å¢ç»„ä»¶ `ProjectileIDComponent`ï¼ˆæŒ‚åœ¨è¿œç¨‹å•ä½èº«ä¸Šï¼‰ï¼š

```cpp
struct ProjectileIDComponent {
    entt::id_type id_{entt::null}; // æŠ•å°„ç‰©ID
};
```

ç„¶ååœ¨èŒä¸š/æ•Œäººæ•°æ®é‡Œï¼Œç”¨ `projectile` å­—æ®µæŒ‡æ˜å®ƒè¦å‘çš„æŠ•å°„ç‰©ï¼š

- ç©å®¶å¼“ç®­æ‰‹ï¼ˆ`assets/data/player_data.json`ï¼‰ï¼š

```json
{
  "archer": {
    "projectile": "arrow",
    "animation": { "attack": { "events": { "emit": 5 } } },
    "sounds": { "emit": "arrow_shoot" }
  }
}
```

- è¿œç¨‹æ•Œäººé»‘æš—å¥³å·«ï¼ˆ`assets/data/enemy_data.json`ï¼‰ï¼š

```json
{
  "dark_witch": {
    "projectile": "magic_ball",
    "animation": { "ranged_attack": { "events": { "emit": 11 } } },
    "sounds": { "emit": "spell_shoot" }
  }
}
```

å¯¹åº”çš„åŠ è½½é“¾è·¯æ˜¯ï¼š

- `BlueprintManager` å¢åŠ  `parseProjectileID()`ï¼šæŠŠ `"arrow"` è¿™ç§å­—ç¬¦ä¸²å“ˆå¸Œæˆ `entt::id_type`
- `PlayerClassBlueprint / EnemyClassBlueprint` å¢åŠ  `projectile_id_`
- `EntityFactory` åœ¨åˆ›å»ºç©å®¶/æ•Œäººæ—¶è°ƒç”¨ `addProjectileIDComponent()`ï¼ˆ`id == entt::null` åˆ™è·³è¿‡ï¼‰

è¿™æ ·è¿œç¨‹å•ä½å°±èƒ½åœ¨è¿è¡Œæ—¶ç›´æ¥æ‹¿åˆ° â€œæˆ‘è¦å‘ä»€ä¹ˆæŠ•å°„ç‰©â€ã€‚

## ğŸ“¨ 3) åŠ¨ç”» `"emit"` â†’ å‘å°„äº‹ä»¶ `EmitProjectileEvent`

æœ¬èŠ‚åœ¨ `game::defs::events.h` æ–°å¢ `EmitProjectileEvent`ï¼Œç”¨äºæºå¸¦â€œå‘å°„æŠ•å°„ç‰©æ‰€éœ€çš„æœ€å°ä¿¡æ¯â€ï¼š

```cpp
struct EmitProjectileEvent {
    entt::id_type id_{entt::null};   // æŠ•å°„ç‰©ID
    entt::entity target_{entt::null};
    glm::vec2 start_position_{};
    glm::vec2 target_position_{};
    float damage_{};
};
```

ç„¶ååœ¨ `AnimationEventSystem` é‡Œæ–°å¢å¯¹ `"emit"_hs` çš„å¤„ç†ï¼š

- ä»æ”»å‡»è€…èº«ä¸Šå– `Transform + Stats + ProjectileID`
- ä» `TargetComponent` å–é”å®šç›®æ ‡ï¼Œå¹¶è¯»å–ç›®æ ‡ä½ç½®
- `enqueue(EmitProjectileEvent)` äº¤ç»™æŠ•å°„ç‰©ç³»ç»Ÿåˆ›å»ºå®ä½“
- åŒæ—¶ `enqueue(PlaySoundEvent{..., "emit"_hs})` æ’­æ”¾å‘å°„éŸ³æ•ˆ

è¿™æ ·ï¼Œ**å‘å°„æ—¶æœºå®Œå…¨ç”±åŠ¨ç”»çš„å…³é”®å¸§å†³å®š**ï¼Œé€»è¾‘ç³»ç»Ÿä¸å†â€œçŒœæµ‹å“ªä¸€å¸§è¯¥å‡ºç®­â€ã€‚

## ğŸ­ 4) ç”¨å·¥å‚åˆ›å»ºæŠ•å°„ç‰©å®ä½“ï¼š`EntityFactory::createProjectile`

æŠ•å°„ç‰©æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ª ECS å®ä½“ï¼Œæœ¬èŠ‚ä¸ºå®ƒæ–°å¢äº†ï¼š

- `ProjectileComponent`ï¼šé£è¡Œå‚æ•°ï¼ˆèµ·ç‚¹/ç»ˆç‚¹/å¼§çº¿/æ—¶é—´/ä¼¤å®³/ç›®æ ‡ç­‰ï¼‰
- `SpriteComponent / TransformComponent`ï¼šç”¨äºæ¸²æŸ“ä¸ä½ç½®æ›´æ–°
- `AudioComponent`ï¼šç”¨äºæ’­æ”¾æŠ•å°„ç‰©å‘½ä¸­éŸ³æ•ˆ
- `RenderComponent(MAIN_LAYER + 1)`ï¼šè®©æŠ•å°„ç‰©ç»˜åˆ¶åœ¨è§’è‰²ä¹‹ä¸Š

åˆ›å»ºå…¥å£åœ¨ `EntityFactory::createProjectile(...)`ï¼Œç”± `ProjectileSystem` è°ƒç”¨ã€‚

## ğŸ¹ 5) ProjectileSystemï¼šæ›´æ–°å¼¹é“ã€å‘½ä¸­åå‘ AttackEvent

æœ¬èŠ‚æ–°å¢ `ProjectileSystem`ï¼Œåšä¸¤ä»¶äº‹ï¼š

1) ç›‘å¬ `EmitProjectileEvent` â†’ è°ƒ `EntityFactory::createProjectile()` åˆ›å»ºæŠ•å°„ç‰©å®ä½“  
2) æ¯å¸§æ›´æ–°æŠ•å°„ç‰©é£è¡ŒçŠ¶æ€ï¼Œå¹¶åœ¨å‘½ä¸­æ—¶å‘é€ `AttackEvent`

å¼¹é“ç”¨ä¸€ä¸ªéå¸¸ç›´è§‚çš„å…¬å¼å®ç°ï¼š

- æ°´å¹³ä½ç§»ï¼š`mix(start, target, t)`ï¼ˆçº¿æ€§æ’å€¼ï¼‰
- å‚ç›´å¼§çº¿ï¼š`sin(t * pi) * arc_height`ï¼ˆ`t âˆˆ [0,1]`ï¼‰

æ ¸å¿ƒä»£ç ï¼ˆ`src/game/system/projectile_system.cpp`ï¼‰ï¼š

```cpp
float t = projectile.current_flight_time_ / projectile.total_flight_time_;
t = glm::clamp(t, 0.0f, 1.0f);

glm::vec2 horizontal_pos = glm::mix(projectile.start_position_, projectile.target_position_, t);
float arc_offset = glm::sin(t * glm::pi<float>()) * projectile.arc_height_;

transform.position_ = horizontal_pos;
transform.position_.y -= arc_offset; // yè½´å‘ä¸‹ä¸ºæ­£ï¼Œæ‰€ä»¥å‡å»åç§»è®©å®ƒâ€œæ‹±èµ·æ¥â€
```

å½“é£è¡Œæ—¶é—´åˆ°è¾¾ `total_flight_time_` æ—¶ï¼Œè®¤ä¸ºå‘½ä¸­ï¼š

- `enqueue(AttackEvent{projectile_entity, target, damage})`
- `enqueue(PlaySoundEvent{projectile_entity, "hit"_hs})`
- ç»™æŠ•å°„ç‰©åŠ  `DeadTag`ï¼Œäº¤ç»™ `RemoveDeadSystem` å»¶è¿Ÿåˆ é™¤

> æ³¨æ„è¿™é‡Œ `AttackEvent.attacker_` ä¼ çš„æ˜¯â€œæŠ•å°„ç‰©å®ä½“â€ã€‚å½“å‰ `CombatResolveSystem` ä»…ç”¨äºæ—¥å¿—æ‰“å°ï¼Œä¸ä¾èµ–æ”»å‡»è€…ç±»å‹ï¼Œå› æ­¤æ˜¯å®‰å…¨çš„ã€‚

## ğŸ§¯ 6) è¾¹ç•Œæƒ…å†µï¼šç›®æ ‡æå‰æ­»äº¡/é‡å¤äº‹ä»¶

æŠ•å°„ç‰©æœ‰â€œé£è¡Œæ—¶é—´â€ï¼Œå› æ­¤æœ€å¸¸è§çš„ç«æ€æ˜¯ï¼š

- æŠ•å°„ç‰©è¿˜åœ¨é£ï¼Œç›®æ ‡å·²ç»è¢«åˆ«çš„æ”»å‡»æ‰“æ­»äº†

ä¸ºé¿å…å¯¹æ­»äº¡å®ä½“é‡å¤æ‰£è¡€ï¼Œæœ¬èŠ‚åœ¨ `CombatResolveSystem::onAttackEvent()` çš„å¼€å¤´å¢åŠ äº†åˆ¤æ–­ï¼š

- ç›®æ ‡æ— æ•ˆ â†’ return
- ç›®æ ‡å·²æœ‰ `DeadTag` â†’ return

å¹¶å°† `DeadTag` çš„æ·»åŠ ä» `emplace` æ”¹ä¸º `emplace_or_replace`ï¼Œé¿å…é‡å¤æ·»åŠ å¯¼è‡´æ–­è¨€/å¼‚å¸¸ã€‚

## âœ… æœ¬èŠ‚å°ç»“

- æˆ‘ä»¬æŠŠâ€œè¿œç¨‹æ”»å‡»â€çº³å…¥äº†åŠ¨ç”»äº‹ä»¶é©±åŠ¨ä½“ç³»ï¼š`emit` åªæ˜¯æå‡ºè¯·æ±‚ï¼ŒæŠ•å°„ç‰©ç³»ç»Ÿè´Ÿè´£åˆ›å»ºä¸æ›´æ–°
- æŠ•å°„ç‰©çš„é£è¡Œè½¨è¿¹ä½¿ç”¨ `y = AÂ·sin(tÂ·Ï€)` çš„ç®€æ˜“å¼¹é“ï¼Œè¶³å¤Ÿè¡¨ç°â€œæŠ›ç‰©çº¿â€æ•ˆæœ
- å‘½ä¸­æœ€ç»ˆä»ç„¶å›åˆ° `AttackEvent â†’ CombatResolveSystem`ï¼Œä¿è¯æˆ˜æ–—ç»“ç®—é€»è¾‘ç»Ÿä¸€

## ğŸ” è‡ªæ£€æ¸…å•

- [ ] è¿œç¨‹å•ä½æ”»å‡»æ—¶èƒ½å¦è§¦å‘ `"emit"`ï¼ˆçœ‹åˆ°å‘å°„éŸ³æ•ˆ/æ—¥å¿—ï¼‰
- [ ] æŠ•å°„ç‰©æ˜¯å¦æ²¿å¼§çº¿é£è¡Œï¼Œå¹¶æœå‘é£è¡Œæ–¹å‘æ—‹è½¬
- [ ] æŠ•å°„ç‰©å‘½ä¸­åæ˜¯å¦æ‰£è¡€ï¼Œå¹¶æ’­æ”¾ `hit` éŸ³æ•ˆ
- [ ] ç›®æ ‡æå‰æ­»äº¡æ—¶æ˜¯å¦ä¸ä¼šè¢«é‡å¤ç»“ç®—

## â¡ï¸ ä¸‹ä¸€èŠ‚é¢„å‘Š

- ä¸‹ä¸€èŠ‚æˆ‘ä»¬ä¼šåŠ å…¥â€œæ­»äº¡åŠ¨ç”»â€å’Œâ€œè¡€é‡æ ‡ç­¾â€ï¼Œè®©æˆ˜æ–—ä¿¡æ¯æ›´ç›´è§‚ã€æ›´æ˜“è°ƒè¯•ã€‚
