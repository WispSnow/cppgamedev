# 27 完善主场景

<div class="video-container">
  <div id="bilibili" class="video-content">
    <!-- B站嵌入：使用 https 明确协议（避免 file:// 或 http 导致被浏览器拦截） -->
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV171qQBPE7L&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

[在 Bilibili 上观看](https://www.bilibili.com/video/BV171qQBPE7L/)

## 📖 概述

到第 26 节，我们已经把“可玩闭环”的关键模块都补齐了：出击、技能、波次、调试 UI……但主场景仍然像“开发中的游乐场”：

- 一些操作入口缺失（升级、撤退、暂停/倍速、音量）
- 一些交互反馈不够（肖像悬浮信息、头像栏移动）
- 一些表现不连贯（技能动画与攻击动画打架、盾御状态的动画不稳定）
- 场景流程也需要更像“真正的游戏”（重新开始、保存、回标题等事件链路）

这一节就是把这些“碎片化体验”统一整理：让主场景更完整、更顺手、更接近最终可玩的版本。

![](../本期参考/PPT截图/怪物战争.094.png)

> PPT 第 94 页：完善主场景（技能动画覆盖、头像栏移动、肖像悬浮 Tip、以及 ImGui 的信息栏/设置栏/调试栏）

本节对应代码标签：`27-完善主场景`（基线：`26-技能施放与显示`）。

## 🎯 学习目标

- 把“关卡规则操作”补齐：升级、撤退、敌人到家判定（统一由 `GameRuleSystem` 处理）
- 给 UI 肖像加悬浮提示：hover enter/leave 事件 → DebugUI tooltip
- 支持头像栏移动：按键左右平移，避免角色多时挤出屏幕
- 完善技能表现：盾御技能激活时切到 guard 动画，技能结束恢复 idle，并处理动作锁定
- 把 ImGui 面板从“看信息”升级为“能操作”：关卡信息、设置（暂停/倍速/音量）、调试工具（加 cost/通关）
- 引入“场景流程事件”：重新开始/回标题/保存（先把事件与入口打通）

## 🧠 思路与设计

这一节的核心原则是：**把“主场景需要的交互入口”集中到事件与系统里，而不是散落在 Scene 或 UI 里硬写 if**。

- UI/ImGui 负责发事件（Upgrade/Retreat/Restart…）
- `GameRuleSystem` 负责“改变规则状态”（扣 cost、改 stats、触发特效/音效、移除单位）
- `GameScene` 负责“场景切换/重建”（restart 走 replace scene）

同时，把一些“视觉一致性”也交给系统统一处理（例如：攻击动画结束回到 guard 还是 idle）。

## 🔧 实现步骤

## 🧾 1) 新增事件：肖像 hover、升级/撤退、场景控制

在 `src/game/defs/events.h` 新增：

- `UIPortraitHoverEnterEvent{name_id}` / `UIPortraitHoverLeaveEvent`：UI 头像悬浮提示
- `UpgradeUnitEvent{entity, cost}`：升级单位（消耗 cost）
- `RetreatEvent{entity, cost}`：撤退单位（返还 cost）
- `RestartEvent / BackToTitleEvent / SaveEvent / LevelClearEvent`：场景/流程事件（后续逐步落地）

这些事件是后面“ImGui/主场景操作”串起来的关键。

## 🖼️ 2) 头像栏增强：移动 + 悬浮事件

`UnitsPortraitUI`（`src/game/ui/units_portrait_ui.*`）做了两类增强：

### 2.1 头像栏左右移动

每帧检查按键状态：

- `move_left`：向左移动（右端最多对齐窗口右边）
- `move_right`：向右移动（最多回到 x=0）

并根据 `delta_time` 平滑移动（速度约 `400px/s`），同时对“面板宽度小于窗口宽度”的情况直接不移动。

### 2.2 头像悬浮提示

`UIButton` 的 hover enter/leave 回调补齐后，头像按钮会发事件：

- 进入：`UIPortraitHoverEnterEvent{name_id}`
- 离开：`UIPortraitHoverLeaveEvent{}`

后续由 DebugUI 接收并显示 tooltip（下一节）。

## 🧠 3) GameRuleSystem：升级、撤退、敌人到家

`GameRuleSystem` 不再只是“cost 增长”，而是成为主场景的规则中枢：

### 3.1 敌人到家

上一节其实已经有 `EnemyArriveHomeEvent`，但一直没接上。此处在构造函数里 `sink/connect` 后，敌人走到终点就能真正扣基地血量并统计到达数。

### 3.2 升级（Upgrade）

ImGui 点“升级”会发 `UpgradeUnitEvent`，系统收到后：

1) 扣除 cost  
2) `stats.level_++`  
3) 从 `BlueprintManager` 取回“基础 StatsBlueprint”，再用 `statModify(level, rarity)` 重新计算 hp/atk/def（并把 hp/max_hp 回满）  
4) 发 `EffectEvent{"level_up"}` + 播放 `level_up` 音效

> 这样升级不会在原值上反复乘倍率导致漂移，而是始终从“基础蓝图 + 等级/稀有度公式”推导，稳定且可控。

### 3.3 撤退（Retreat）

ImGui 点“撤退”会发 `RetreatEvent`：

- 返还一定比例 cost（当前实现：50%）
- 通过 `RemovePlayerUnitEvent` 走统一移除链路，确保地点占用也会被释放

## 🛡️ 4) 技能与动画一致性：盾御 guard 动画 + 动作锁定

盾御技能（`shield`）需要“激活时进入防御姿态”，这就要求技能系统与动画系统协作：

- `SkillSystem`：盾御激活/结束时，如果单位没有 `ActionLockTag`，就分别播放 `guard` / `idle` 动画
- `AnimationStateSystem`：当玩家动画结束时，如果盾御正在激活（`SkillActiveTag`），回到 `guard` 而不是 `idle`
- `AttackStarterSystem`：玩家开始攻击时也加 `ActionLockTag`，让攻击动画期间不会被别的逻辑抢动画；动画结束后由 `AnimationStateSystem` 移除动作锁定

这样“攻击 → 结束”时，如果盾御技能仍在激活，就能自然回到 guard 姿态，视觉上更连贯。

## 🪟 5) DebugUI 进化：信息/设置/调试 三个面板

`DebugUISystem`（`src/game/system/debug_ui_system.*`）做了大幅扩展：

### 5.1 肖像 hover tooltip

通过监听 `UIPortraitHoverEnter/Leave`，DebugUI 能拿到“悬浮的是哪个角色名 id”。  
由于肖像不是实体，它会从 `SessionData` 拿到 `UnitData`，再从 `BlueprintManager` 拿到职业蓝图，并用 `statModify(level, rarity)` 计算属性后显示 tooltip。

### 5.2 选中单位窗口：升级/撤退/技能

在原有“单位信息 + 技能”基础上新增：

- `U` 升级：cost 足够时按钮可用，发 `UpgradeUnitEvent`
- `R` 撤退：发 `RetreatEvent` 并返还 cost
- `S` 技能：沿用上一节的技能激活入口

### 5.3 关卡信息栏

显示基地血量、cost、剩余波次、下一波倒计时、击杀进度、当前关卡号。

### 5.4 设置工具栏

- `P` 暂停/继续（写入 `GameState`）
- 重新开始/回标题/保存（发对应场景事件）
- 游戏速度（TimeScale）滑条与按钮（0.5/1/2 倍速）
- 音乐/音效音量调节
- 勾选隐藏/显示“调试工具”面板

为了让 DebugUI 能改游戏速度，本节也把 `Time` 注入 `Context`（`Context::getTime()`）。

### 5.5 调试工具栏（可隐藏）

用于开发期快速验证：

- COST +10 / +100
- 触发 `LevelClearEvent`（为后续通关流程预留）

## 🎬 6) 场景控制：restart 流程打通

`GameScene` 新增对 `RestartEvent/BackToTitleEvent/SaveEvent` 的监听，并把 restart 实现落到：

```cpp
requestReplaceScene(std::make_unique<GameScene>(context_, blueprint_manager_, session_data_, ui_config_, level_config_));
```

为了让“重建场景”可以复用加载好的蓝图与数据，本节也把 `GameScene` 构造函数改成可注入 `BlueprintManager/SessionData/UIConfig/LevelConfig` 的共享指针。

另外，`GameScene` 在 `init()` 完成后会把 `GameState` 设置为 Playing；并在 `update()` 中加入“暂停分支”：暂停时仍允许放置系统、选择系统与 UI 更新，但停止战斗/波次等核心逻辑推进。

## ✅ 本节小结

- 主场景交互补齐：升级/撤退/暂停/倍速/音量/重开等入口齐全，并以事件驱动连接到系统
- 肖像栏可移动 + 可悬浮查看信息，出击前的信息获取更顺手
- 盾御技能与动画系统打通：guard 姿态稳定、动作锁定一致性更好
- DebugUI 从“只读面板”升级为“开发期可操作控制台”，加速验证与迭代

## 🔍 自检清单

- [ ] 头像栏在角色多时能左右移动，并不会移出可视范围
- [ ] 悬浮肖像能显示角色基础信息（等级/稀有度/推导属性）
- [ ] 选中玩家后能用 U 升级、R 撤退、S 放技能，并且 cost 限制正确生效
- [ ] 盾御技能激活时能保持 guard 动画，攻击结束后能回到 guard（技能未结束）
- [ ] P 暂停后战斗/刷怪停止，但 UI/选择/放置仍可用
- [ ] 重新开始能重建 GameScene（资源复用、不崩溃）

## ➡️ 下一节预告

下一节我们会做“标题场景”：把游戏从“直接进 GameScene”升级为完整流程（标题 → 进入关卡 → 通关/结束），并为存档/多关切换打好基础。

