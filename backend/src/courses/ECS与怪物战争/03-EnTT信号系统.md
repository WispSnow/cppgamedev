# 03 EnTTä¿¡å·ç³»ç»Ÿ

<div class="video-container">
  <div id="bilibili" class="video-content">
    <!-- Bç«™åµŒå…¥ï¼šä½¿ç”¨ https æ˜ç¡®åè®®ï¼ˆé¿å… file:// æˆ– http å¯¼è‡´è¢«æµè§ˆå™¨æ‹¦æˆªï¼‰ -->
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV1SaWzzTE8f&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

[åœ¨ Bilibili ä¸Šè§‚çœ‹](https://www.bilibili.com/video/BV1SaWzzTE8f)

## ğŸ“– æ¦‚è¿°

ä»ç¬¬ 02 èŠ‚å¼€å§‹ï¼Œæˆ‘ä»¬å·²ç»èƒ½ç”¨ EnTT çš„ `registry + entity + component + view` è·‘é€š ECS çš„æœ€å°é—­ç¯ã€‚

ä½†åªé  â€œview éå† + ç›´æ¥è°ƒç”¨å‡½æ•°â€ è¿˜ä¸å¤Ÿã€‚éšç€ç³»ç»Ÿå˜å¤šï¼Œä½ ä¼šå¾ˆå¿«é‡åˆ°ä¸€ä¸ªç°å®é—®é¢˜ï¼š**æ¨¡å—ä¹‹é—´çš„äº¤äº’ä¼šè¶Šæ¥è¶Šå¤æ‚**ã€‚

ä¸¾ä¸ªå¸¸è§åœºæ™¯ï¼š

- æ•Œäººæ­»äº¡äº†
- åˆ†æ•°ç³»ç»Ÿè¦åŠ åˆ†
- æ‰è½ç³»ç»Ÿè¦ç”Ÿæˆé“å…·
- UI ç³»ç»Ÿè¦åˆ·æ–°é¢æ¿
- éŸ³æ•ˆç³»ç»Ÿè¦æ’­æ”¾éŸ³æ•ˆ

å¦‚æœè¿™äº›é€»è¾‘å…¨éƒ½å†™åœ¨â€œå‡»æ€æ•Œäººâ€çš„é‚£æ®µä»£ç é‡Œï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ª**é«˜åº¦è€¦åˆ**çš„â€œä¸Šå¸å‡½æ•°â€ã€‚è¿™èŠ‚è¯¾æˆ‘ä»¬å¼•å…¥ **EnTT çš„ä¿¡å·/äº‹ä»¶æœºåˆ¶**ï¼Œç”¨â€œå‘å¸ƒäº‹ä»¶ â†’ å¤šå¤„è®¢é˜…å“åº”â€çš„æ–¹å¼ï¼ŒæŠŠè¿™äº›åç»­é€»è¾‘æ‹†å¼€ã€‚

æœ¬èŠ‚å¯¹åº”ä»£ç çŠ¶æ€ï¼š`03-EnTTä¿¡å·ç³»ç»Ÿ`ï¼Œæ ¸å¿ƒç¤ºä¾‹ä»ç„¶é›†ä¸­åœ¨ `src/main.cpp`ã€‚

![](../æœ¬æœŸå‚è€ƒ/PPTæˆªå›¾/æ€ªç‰©æˆ˜äº‰.023.png)

> PPT ç¬¬ 23 é¡µï¼š`entt::dispatcher` æ˜¯â€œäº‹ä»¶ä¸­å¿ƒâ€ï¼ŒæŒ‰äº‹ä»¶ç±»å‹ç®¡ç†ä¿¡å·ï¼Œå¹¶æ”¯æŒäº‹ä»¶é˜Ÿåˆ—

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- çŸ¥é“ EnTT ä¿¡å·ç³»ç»Ÿçš„ä¸‰å—ç§¯æœ¨ï¼š`entt::delegate` / `entt::sigh + entt::sink` / `entt::dispatcher`
- ç†è§£ `dispatcher` çš„å·¥ä½œæ–¹å¼ï¼š**è¿æ¥ç›‘å¬å™¨ â†’ å‘å¸ƒäº‹ä»¶ï¼ˆenqueue/triggerï¼‰â†’ update ç»Ÿä¸€å¤„ç†**
- å­¦ä¼šç”¨ `registry.ctx()` å­˜æ”¾â€œéç»„ä»¶â€çš„å…¨å±€æ•°æ®ï¼ˆæœ¬èŠ‚ç¤ºä¾‹ï¼šåˆ†æ•° `game_state`ï¼‰
- äº†è§£äº‹ä»¶å¯¹è±¡åº”è¯¥æºå¸¦å“ªäº›ä¿¡æ¯ï¼Œé¿å…â€œå®ä½“é”€æ¯åå–ä¸åˆ°æ•°æ®â€çš„å‘

## ğŸ§  æ€è·¯ä¸è®¾è®¡

### 1) ä»â€œç›´æ¥è°ƒç”¨â€èµ°å‘â€œå‘å¸ƒ-è®¢é˜…â€

äº‹ä»¶é©±åŠ¨çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**å‘ç”Ÿäº†ä»€ä¹ˆï¼ˆäº‹ä»¶ï¼‰** ä¸ **è¦åšä»€ä¹ˆï¼ˆå“åº”ï¼‰** è§£è€¦ã€‚

åœ¨æ¸¸æˆé‡Œï¼Œä¸€ä¸ªç³»ç»Ÿç»å¸¸åªè´Ÿè´£â€œäº§ç”Ÿäº‹ä»¶â€ï¼Œä½†ä¸å…³å¿ƒâ€œè°ä¼šå¤„ç†å®ƒâ€ã€‚ä¾‹å¦‚ï¼š

- æˆ˜æ–—ç³»ç»Ÿåªè´Ÿè´£å‘å¸ƒ `enemy_destroyed_event`
- åˆ†æ•°ç³»ç»Ÿç›‘å¬å®ƒå¹¶åŠ åˆ†
- æ‰è½ç³»ç»Ÿç›‘å¬å®ƒå¹¶ç”Ÿæˆæ‰è½

è¿™æ ·åšçš„æ”¶ç›Šæ˜¯ï¼šåç»­ä½ åŠ ä¸€ä¸ªæ–°ç³»ç»Ÿï¼ˆæ¯”å¦‚æˆå°±ç³»ç»Ÿï¼‰ï¼Œé€šå¸¸åªæ˜¯â€œå†è¿ä¸€ä¸ªç›‘å¬å™¨â€ï¼Œä¸éœ€è¦å›å»æ”¹æˆ˜æ–—ç³»ç»Ÿã€‚

### 2) delegate / sigh / dispatcherï¼šä¸‰å±‚å·¥å…·çš„å…³ç³»

- `entt::delegate`ï¼šå•æ’­å›è°ƒï¼ˆåªç»‘å®šä¸€ä¸ªå‡½æ•°ï¼‰ï¼Œå¯ä»¥ç†è§£ä¸ºè½»é‡çº§çš„ `std::function` æ›¿ä»£å“
- `entt::sigh`ï¼šå¤šæ’­ä¿¡å·ï¼ˆä¸€ä¸ªä¿¡å·ç»‘å®šå¤šä¸ªå›è°ƒï¼‰
- `entt::sink`ï¼šä¿¡å·çš„â€œå…¥å£â€ï¼Œæä¾›å®‰å…¨çš„ `connect/disconnect` æ¥å£ï¼ˆä¸€èˆ¬é€šè¿‡ sink æ¥è¿å›è°ƒï¼‰

![](../æœ¬æœŸå‚è€ƒ/PPTæˆªå›¾/æ€ªç‰©æˆ˜äº‰.022.png)

> PPT ç¬¬ 22 é¡µï¼š`sigh` ä¿å­˜å›è°ƒåˆ—è¡¨å¹¶å‘å¸ƒäº‹ä»¶ï¼›`sink` æä¾›è¿æ¥/æ–­å¼€ç›‘å¬å™¨çš„å®‰å…¨æ¥å£

`entt::dispatcher` åˆ™å¯ä»¥ç†è§£ä¸ºâ€œæ›´ä¸Šå±‚çš„äº‹ä»¶ä¸­å¿ƒâ€ï¼šå®ƒæŒ‰äº‹ä»¶ç±»å‹ç®¡ç†ä¸€ç»„ `sigh`ï¼Œå¹¶é¢å¤–æä¾› **äº‹ä»¶é˜Ÿåˆ—**ï¼Œè®©ä½ èƒ½æŠŠäº‹ä»¶åœ¨ä¸»å¾ªç¯ä¸­â€œé›†ä¸­å…¥é˜Ÿã€ç»Ÿä¸€å‡ºé˜Ÿå¤„ç†â€ã€‚

## ğŸ”§ å®ç°æ­¥éª¤

### 1) ç”¨ `registry.ctx()` å­˜æ”¾â€œéç»„ä»¶â€çš„å…¨å±€çŠ¶æ€

è¿™èŠ‚è¯¾æˆ‘ä»¬ç”¨æœ€ç®€å•çš„ä¾‹å­ï¼šåˆ†æ•°ã€‚åˆ†æ•°ä¸æ˜¯æŸä¸ªå®ä½“çš„ç»„ä»¶ï¼Œè€Œæ˜¯å…¨å±€çŠ¶æ€ï¼Œæ›´é€‚åˆæ”¾åœ¨ `registry.ctx()` é‡Œï¼š

![](../æœ¬æœŸå‚è€ƒ/PPTæˆªå›¾/æ€ªç‰©æˆ˜äº‰.018.png)

> PPT ç¬¬ 18 é¡µï¼š`registry.ctx()` ç”¨æ¥å­˜æ”¾â€œé componentâ€çš„æ•°æ®ï¼ˆå¦‚åˆ†æ•°ã€æ—¶é—´ã€é‡è¦å®ä½“å¼•ç”¨ç­‰ï¼‰

å¯¹åº”ä»£ç ï¼š

```cpp
struct game_state {
    int score = 0;
};

// åˆå§‹åŒ–ä¸Šä¸‹æ–‡å˜é‡
registry.ctx().emplace<game_state>();
```

ä¹‹åä»»ä½•æ‹¿åˆ° `registry` çš„ç³»ç»Ÿï¼Œéƒ½å¯ä»¥é€šè¿‡ `registry.ctx().get<game_state>()` å–åˆ°å¹¶ä¿®æ”¹å®ƒã€‚

### 2) å®šä¹‰äº‹ä»¶ç±»å‹ï¼šäº‹ä»¶å°±æ˜¯ä¸€ä¸ªâ€œæ•°æ®ç»“æ„â€

åœ¨ EnTT çš„ `dispatcher` é‡Œï¼Œäº‹ä»¶ç±»å‹é€šå¸¸æ˜¯ä¸€ä¸ªç»“æ„ä½“ã€‚ç»“æ„ä½“é‡Œæ”¾â€œç›‘å¬è€…å¤„ç†äº‹ä»¶æ‰€éœ€çš„ä¿¡æ¯â€ï¼š

```cpp
struct enemy_destroyed_event {
    entt::entity enemy_entity;
    // å¯ä»¥åœ¨æ­¤æ·»åŠ æ›´å¤šä¿¡æ¯ï¼Œæ¯”å¦‚æ•Œäººç±»å‹ã€æ‰è½ç‰©å“ç­‰
};
```

æ³¨æ„è¿™é‡Œçš„æ³¨é‡Šéå¸¸å…³é”®ï¼š**å¦‚æœä½ åœ¨å‘å¸ƒäº‹ä»¶å‰å°±æŠŠå®ä½“é”€æ¯äº†ï¼Œé‚£ä¹ˆç›‘å¬å™¨é‡Œå°±ä¸ä¸€å®šè¿˜èƒ½é€šè¿‡ registry æ‹¿åˆ°è¯¥å®ä½“çš„ç»„ä»¶æ•°æ®**ã€‚

å› æ­¤ï¼Œäº‹ä»¶é‡Œåº”è¯¥æºå¸¦â€œå¤„ç†æ‰€éœ€çš„æœ€å°ä¿¡æ¯â€ï¼ˆä¾‹å¦‚æ•Œäººç±»å‹ã€å¥–åŠ±å€¼ã€æ‰è½è¡¨ keyâ€¦â€¦ï¼‰ï¼Œè€Œä¸æ˜¯åªå¡ä¸€ä¸ª entity å¥æŸ„ã€‚

### 3) ç¼–å†™ç›‘å¬å™¨ï¼šæ—¢å¯ä»¥æ˜¯ç±»æˆå‘˜å‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯æ™®é€šå‡½æ•°

æœ¬èŠ‚æ¼”ç¤ºä¸¤ç§ç›‘å¬å™¨å†™æ³•ï¼š

1) ç”¨ç±»ç»„ç»‡é€»è¾‘ï¼ˆæ›´åƒçœŸå®é¡¹ç›®ä¸­çš„ç³»ç»Ÿï¼‰ï¼š

```cpp
class ScoreSystem {
    entt::registry& registry;   // éœ€è¦ registry çš„å¼•ç”¨ï¼Œä»¥ä¾¿è·å–ä¸Šä¸‹æ–‡
public:
    ScoreSystem(entt::registry& reg) : registry(reg) {}

    void on_enemy_destroyed(const enemy_destroyed_event& event) {
        auto& state = registry.ctx().get<game_state>();
        state.score += 10;

        spdlog::info("æ€æ­»æ•Œäºº {}ï¼Œåˆ†æ•°å¢åŠ ï¼å½“å‰åˆ†æ•°: {}", entt::to_integral(event.enemy_entity), state.score);
            /* entt::entity çš„åº•å±‚æ˜¯ entt::id_typeï¼Œå³ uint32_tï¼Œä½†ä¸å¯ç›´æ¥å½“æˆæ•´æ•°ç”¨ï¼ˆä¿è¯ç±»å‹å®‰å…¨ï¼‰ï¼Œ
                                                    å¯ä»¥ç”¨ entt::to_integral æ˜¾å¼è½¬æ¢ä¸º uint32_t */
    }
};
```

2) ç›´æ¥ç”¨å‡½æ•°ç›‘å¬ï¼ˆé€‚åˆå¿«é€ŸéªŒè¯/ä¸´æ—¶é€»è¾‘ï¼‰ï¼š

```cpp
void dummy_listener(const enemy_destroyed_event& event) {
    spdlog::info("DummyListener æ”¶åˆ°äº‹ä»¶ï¼šæ•Œäºº {} è¢«æ‘§æ¯ï¼", entt::to_integral(event.enemy_entity));
}
```

> å°æç¤ºï¼š`entt::entity` æ˜¯å¼ºç±»å‹å¥æŸ„ï¼Œæ‰“å°æ—¶å»ºè®®ç”¨ `entt::to_integral(...)` æ˜¾å¼è½¬æ¢ã€‚

### 4) åˆ›å»º `dispatcher` å¹¶è¿æ¥ç›‘å¬å™¨

`dispatcher.sink<Event>()` ä¼šè¿”å›è¯¥äº‹ä»¶ç±»å‹å¯¹åº”çš„ `sink`ï¼Œé€šè¿‡å®ƒè¿æ¥ç›‘å¬å™¨ï¼š

```cpp
entt::dispatcher dispatcher{};
ScoreSystem score_system(registry);

dispatcher.sink<enemy_destroyed_event>()
    .connect<&ScoreSystem::on_enemy_destroyed>(score_system);

dispatcher.sink<enemy_destroyed_event>()
    .connect<&dummy_listener>();
```

è¿™æ®µä»£ç è¡¨è¾¾çš„æ˜¯ï¼š

- `enemy_destroyed_event` å‘ç”Ÿæ—¶ï¼Œè°ƒç”¨ `ScoreSystem::on_enemy_destroyed`
- åŒä¸€ä¸ªäº‹ä»¶å¯ä»¥è¿æ¥å¤šä¸ªç›‘å¬å™¨ï¼ˆä»£ç é‡Œä¹Ÿæç¤ºäº†ï¼š**åè¿›å…ˆè°ƒ**ï¼Œé¡ºåºä¼šå½±å“ç»“æœæ—¶è¦ç•™æ„ï¼‰

### 5) å‘å¸ƒäº‹ä»¶ï¼š`enqueue` å…¥é˜Ÿï¼Œ`update` ç»Ÿä¸€å¤„ç†

æ¼”ç¤ºæµç¨‹æ˜¯ï¼š

1) åˆ›å»ºä¸€ä¸ªæ•Œäººå®ä½“
2) â€œæˆ˜æ–—å‘ç”Ÿâ€åæ‘§æ¯æ•Œäºº
3) å‘å¸ƒäº‹ä»¶
4) `update()` è§¦å‘ç›‘å¬å™¨

```cpp
entt::entity enemy_to_destroy = registry.create();
registry.emplace<tag>(enemy_to_destroy, "enemy"_hs, "enemy");

spdlog::info("åˆå§‹åˆ†æ•°: {}", registry.ctx().get<game_state>().score);

// ... æˆ˜æ–—å‘ç”Ÿ ...
registry.destroy(enemy_to_destroy);

dispatcher.enqueue(enemy_destroyed_event{enemy_to_destroy});
dispatcher.update();
```

è¿™é‡Œæœ‰ä¸¤ä¸ªå¸¸ç”¨é€‰æ‹©ï¼š

- `enqueue + update`ï¼šäº‹ä»¶å…ˆå…¥é˜Ÿï¼Œç­‰åˆ°ä½ é€‰å®šçš„â€œä¸»å¾ªç¯æŸä¸€é˜¶æ®µâ€å†ç»Ÿä¸€å¤„ç†ï¼ˆæ›´é€‚åˆæ¸¸æˆå¾ªç¯ï¼‰
- `trigger`ï¼šç«‹å³è§¦å‘ï¼ˆå³æ—¶å“åº”ï¼Œç®€å•ä½†æ›´å®¹æ˜“é€ æˆâ€œä¸­é€”è§¦å‘å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´â€ï¼‰

æœ¬èŠ‚å…ˆç”¨ `enqueue + update` å»ºç«‹æ›´ç¨³çš„ä¹ æƒ¯ï¼š**äº‹ä»¶çš„å¤„ç†ç‚¹è¦å›ºå®šï¼Œé¿å…åˆ°å¤„æ’å…¥â€œå³æ—¶å›è°ƒâ€**ã€‚

## ğŸ§© å…³é”®ä»£ç ï¼ˆåªè´´å…³é”®ç‰‡æ®µï¼‰

- äº‹ä»¶ç±»å‹ï¼š`enemy_destroyed_event`
- ä¸Šä¸‹æ–‡å˜é‡ï¼š`game_state` + `registry.ctx()`
- äº‹ä»¶ä¸­å¿ƒï¼š`entt::dispatcher`
- è¿æ¥ç›‘å¬å™¨ï¼š`dispatcher.sink<Event>().connect<...>()`
- å‘å¸ƒä¸å¤„ç†ï¼š`dispatcher.enqueue(...)` + `dispatcher.update()`

ä»¥ä¸Šä»£ç å‡æ¥è‡ª `src/main.cpp`ï¼ˆtagï¼š`03-EnTTä¿¡å·ç³»ç»Ÿ`ï¼‰ã€‚

## âœ… æœ¬èŠ‚å°ç»“

- EnTT çš„ä¿¡å·/äº‹ä»¶ä½“ç³»å¯ä»¥æŠŠâ€œå‘ç”Ÿä»€ä¹ˆâ€ä¸â€œæ€ä¹ˆå“åº”â€æ‹†å¼€ï¼Œé™ä½ç³»ç»Ÿè€¦åˆ
- `entt::dispatcher` æ˜¯æ›´ä¸Šå±‚çš„äº‹ä»¶ä¸­å¿ƒï¼šæŒ‰äº‹ä»¶ç±»å‹ç®¡ç†å›è°ƒï¼Œå¹¶æ”¯æŒäº‹ä»¶é˜Ÿåˆ—
- `registry.ctx()` å¾ˆé€‚åˆå­˜æ”¾å…¨å±€å…±äº«çŠ¶æ€ï¼ˆåˆ†æ•°/æ—¶é—´/æœåŠ¡å¯¹è±¡ç­‰ï¼‰ï¼Œé¿å…åˆ°å¤„ä¼ å‚æˆ–å†™å•ä¾‹

## ğŸ” è‡ªæ£€æ¸…å•

- [ ] èƒ½è§£é‡Š `delegate / sigh+sink / dispatcher` ä¸‰è€…çš„å®šä½
- [ ] èƒ½å†™å‡ºä¸€ä¸ªäº‹ä»¶ç»“æ„ä½“ï¼Œå¹¶ç”¨ `dispatcher.sink<Event>().connect(...)` è¿æ¥ç›‘å¬å™¨
- [ ] èƒ½è¯´æ¸… `enqueue + update` ä¸ `trigger` çš„å·®å¼‚
- [ ] çŸ¥é“ä¸ºä»€ä¹ˆâ€œå®ä½“é”€æ¯åå†å‘äº‹ä»¶â€æ—¶ï¼Œäº‹ä»¶é‡Œå¯èƒ½éœ€è¦æºå¸¦æ›´å¤šä¿¡æ¯

## â¡ï¸ ä¸‹ä¸€èŠ‚é¢„å‘Š

ä¸‹ä¸€èŠ‚è¿›å…¥ **ImGui åŸºç¡€**ï¼šæˆ‘ä»¬ä¼šæŠŠ UI çš„é›†æˆæµç¨‹è·‘é€šï¼ˆåˆå§‹åŒ–/äº‹ä»¶å¤„ç†/ç”Ÿæˆç»˜å›¾æ•°æ®/æ¸²æŸ“/æ¸…ç†ï¼‰ï¼Œå¹¶ä¸ºåé¢åšâ€œè°ƒè¯•é¢æ¿â€æ‰“åŸºç¡€ã€‚