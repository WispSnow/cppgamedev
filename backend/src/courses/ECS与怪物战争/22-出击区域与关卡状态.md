# 22 å‡ºå‡»åŒºåŸŸä¸å…³å¡çŠ¶æ€

<div class="video-container">
  <div id="bilibili" class="video-content">
    <!-- Bç«™åµŒå…¥ï¼šä½¿ç”¨ https æ˜ç¡®åè®®ï¼ˆé¿å… file:// æˆ– http å¯¼è‡´è¢«æµè§ˆå™¨æ‹¦æˆªï¼‰ -->
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV1KUShBREoJ&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

[åœ¨ Bilibili ä¸Šè§‚çœ‹](https://www.bilibili.com/video/BV1KUShBREoJ/)

## ğŸ“– æ¦‚è¿°

ä¸Šä¸€èŠ‚æˆ‘ä»¬å·²ç»æœ‰äº†â€œå‡ºå‡»è‚–åƒæ¡â€ï¼Œä½†å®ƒè¿˜åªæ˜¯å±•ç¤ºï¼šç©å®¶å¹¶æ²¡æœ‰çœŸæ­£è¿›å…¥â€œé€‰æ‹©è§’è‰² â†’ æ‰¾åˆ°å¯å‡ºå‡»çš„ä½ç½® â†’ éƒ¨ç½²å•ä½â€çš„å®Œæ•´å¾ªç¯ã€‚

è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬å…ˆæŠŠä¸¤ä¸ªåŸºç¡€è®¾æ–½è¡¥é½ï¼š

1) **å‡ºå‡»åŒºåŸŸ**ï¼šåœ¨åœ°å›¾ä¸Šæ ‡è®°â€œå“ªäº›æ ¼å­èƒ½æ”¾è¿‘æˆ˜ã€å“ªäº›æ ¼å­èƒ½æ”¾è¿œç¨‹â€ï¼Œå¹¶æŠŠè¿™äº›ä¿¡æ¯å˜æˆ ECS å¯ç­›é€‰çš„æ ‡ç­¾ã€‚  
2) **å…³å¡çŠ¶æ€ï¼ˆGameStatsï¼‰**ï¼šæŠŠ cost / åŸºåœ°è¡€é‡ / æ€æ•Œæ•°ç­‰â€œå…¨å±€æ•°æ®â€æ”¶æ‹¢åˆ°ä¸€ä¸ªåœ°æ–¹ï¼Œç”±ç³»ç»Ÿç»Ÿä¸€æ›´æ–°ï¼Œå†è®© UI ç”¨å®ƒæ¥åšåé¦ˆï¼ˆä¾‹å¦‚ cost ä¸è¶³æ—¶ç»™è‚–åƒç›–ç°ï¼‰ã€‚

![](../æœ¬æœŸå‚è€ƒ/PPTæˆªå›¾/æ€ªç‰©æˆ˜äº‰.081.png)

> PPT ç¬¬ 81 é¡µï¼šå‡ºå‡»åŒºåŸŸä¸å…³å¡çŠ¶æ€ï¼ˆåœ°ç‚¹ç±»å‹å®ä½“ + GameStats + æ ¹æ® cost æ§åˆ¶ç°è‰²é®ç½©ï¼‰

æœ¬èŠ‚å¯¹åº”ä»£ç æ ‡ç­¾ï¼š`22-å‡ºå‡»åŒºåŸŸä¸å…³å¡çŠ¶æ€`ï¼ˆåŸºçº¿ï¼š`21-å‡ºå‡»é€‰æ‹©è§’è‰²è‚–åƒ`ï¼‰ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- ç”¨ `GameStats` ç»Ÿä¸€ç®¡ç†å…³å¡å†…èµ„æºä¸ç»Ÿè®¡æ•°æ®ï¼ˆcost/è¡€é‡/å‡»æ€/åˆ°è¾¾ç­‰ï¼‰
- ç”¨ `registry.ctx()` å­˜æ”¾â€œéç»„ä»¶æ•°æ®â€ï¼Œè®©ç³»ç»Ÿä¸ UI éƒ½èƒ½æ–¹ä¾¿æ‹¿åˆ°å…±äº«çŠ¶æ€
- æ–°å¢ `GameRuleSystem`ï¼šæ¯å¸§æ›´æ–° costï¼Œå¹¶ä¸ºâ€œæ•Œäººåˆ°è¾¾åŸºåœ°â€ç­‰è§„åˆ™ç•™å¥½å…¥å£
- åœ¨ Tiled ä¸­ç”¨ tile properties æ ‡è®°â€œå‡ºå‡»åŒºåŸŸç±»å‹â€ï¼Œå¹¶åœ¨ Builder ä¸­æ‰“ä¸Š `MeleePlaceTag/RangedPlaceTag`
- æŠŠè‚–åƒæ¡ UI ä» `GameScene` æŠ½æˆç‹¬ç«‹ç±»ï¼Œå¹¶ç”¨ `GameStats.cost_` é©±åŠ¨â€œç°è‰²é®ç½©â€æ˜¾ç¤º

## ğŸ§  æ€è·¯ä¸è®¾è®¡

è¿™ä¸€èŠ‚çš„æ ¸å¿ƒæ€è·¯æ˜¯ï¼š**æŠŠâ€œå…³å¡è§„åˆ™/èµ„æº/çŠ¶æ€â€ä»æ•£è½çš„ if/ä¸´æ—¶å˜é‡ï¼Œå‡çº§ä¸ºå¯å¤ç”¨çš„æ•°æ®ç»“æ„ + ç³»ç»Ÿæ›´æ–°**ã€‚

- **GameStats æ˜¯â€œå…³å¡çº§â€çš„æ•°æ®**ï¼šå®ƒä¸å±äºæŸä¸ªå®ä½“ï¼Œæ‰€ä»¥ä¸é€‚åˆåš componentï¼›ä½†å®ƒåˆéœ€è¦è¢«å¤šä¸ª system/UI è¯»å†™ã€‚
- **registry.ctx() æ­£å¥½è§£å†³â€œé component æ•°æ®å…±äº«â€**ï¼šæˆ‘ä»¬å¯ä»¥æŠŠ `UIConfig/SessionData/BlueprintManager` è¿™ç±»å¯¹è±¡ï¼Œä»¥åŠ `GameStats` çš„å¼•ç”¨ï¼Œéƒ½æ”¾è¿› ctx é‡Œã€‚

![](../æœ¬æœŸå‚è€ƒ/PPTæˆªå›¾/æ€ªç‰©æˆ˜äº‰.082.png)

> PPT ç¬¬ 82 é¡µï¼š`registry.ctx()` å¯ä»¥ä¿å­˜â€œé componentâ€çš„å…±äº«æ•°æ®

ä¸æ­¤åŒæ—¶ï¼Œå‡ºå‡»åŒºåŸŸçš„è®¾è®¡ä¹Ÿéµå¾ªåŒæ ·çš„åŸåˆ™ï¼š**æ•°æ®åœ¨åœ°å›¾é‡Œï¼Œé€»è¾‘åœ¨ Builder/ç³»ç»Ÿé‡Œ**ã€‚

- åœ°å›¾ï¼ˆTiledï¼‰è´Ÿè´£â€œå“ªé‡Œèƒ½æ”¾ä»€ä¹ˆâ€
- Builder æŠŠåœ°å›¾ä¿¡æ¯å˜æˆâ€œå®ä½“ + Tagâ€
- åç»­å‡ºå‡»ç³»ç»Ÿåªéœ€è¦ `view<MeleePlaceTag>` æˆ– `view<RangedPlaceTag>` å°±èƒ½æ‰¾åˆ°åˆæ³•ä½ç½®

## ğŸ”§ å®ç°æ­¥éª¤

## ğŸ’¾ 1) å…³å¡çŠ¶æ€ï¼šæ–°å¢ `GameStats`

æœ¬èŠ‚æ–°å¢ `src/game/data/game_stats.h`ï¼ŒæŠŠå…³å¡å†…å¸¸ç”¨èµ„æº/ç»Ÿè®¡å€¼æ”¶æ‹¢åˆ°ä¸€èµ·ï¼š

```cpp
struct GameStats {
    float cost_{10.0f};
    float cost_gen_per_second_{1.0f};
    int home_hp_{5};
    int enemy_count_{0};
    int enemy_arrived_count_{0};
    int enemy_killed_count_{0};
};
```

è¿™æ ·ä¹‹åä¸ç®¡æ˜¯ UI è¿˜æ˜¯ç³»ç»Ÿï¼Œéƒ½ä¸éœ€è¦â€œå„è‡ªç»´æŠ¤ä¸€ä»½ cost/è¡€é‡â€ï¼Œè€Œæ˜¯å›´ç»•åŒä¸€ä¸ªæ•°æ®æºå·¥ä½œã€‚

## ğŸ§º 2) ç”¨ `registry.ctx()` åˆ†å‘å…±äº«æ•°æ®

ä¸ºäº†è®©ç³»ç»Ÿå’Œ UI éƒ½èƒ½æ‹¿åˆ°è¿™äº›å¯¹è±¡ï¼Œæˆ‘ä»¬åœ¨ `GameScene` é‡Œæ–°å¢ `initRegistryContext()`ï¼š

```cpp
registry_.ctx().emplace<std::shared_ptr<game::factory::BlueprintManager>>(blueprint_manager_);
registry_.ctx().emplace<std::shared_ptr<game::data::SessionData>>(session_data_);
registry_.ctx().emplace<std::shared_ptr<game::data::UIConfig>>(ui_config_);
registry_.ctx().emplace<game::data::GameStats&>(game_stats_);
```

å…¶ä¸­ `GameStats` ç”¨å¼•ç”¨å­˜å…¥ ctxï¼ˆæŒ‡å‘ `GameScene` çš„æˆå‘˜ `game_stats_`ï¼‰ï¼Œå¯ä»¥é¿å…â€œctx é‡Œå¤åˆ¶ä¸€ä»½çŠ¶æ€â€å¯¼è‡´ä¸åŒæ­¥ã€‚

## â±ï¸ 3) æ–°å¢ `GameRuleSystem`ï¼šæ›´æ–° costã€æ‰¿è½½å…³å¡è§„åˆ™

åœ¨ `src/game/system/game_rule_system.*` ä¸­ï¼Œæˆ‘ä»¬æ–°å¢ä¸€ä¸ªè§„åˆ™ç³»ç»Ÿï¼š

- `update()`ï¼šæ¯å¸§æ¨è¿› `cost_ += cost_gen_per_second_ * dt`
- `onEnemyArriveHome()`ï¼šæ•Œäººåˆ°è¾¾åŸºåœ°æ—¶æ‰£è¡€ã€ç´¯è®¡åˆ°è¾¾æ•°ï¼ˆç›®å‰ä»æ˜¯ TODO/é¢„ç•™ï¼‰

```cpp
void GameRuleSystem::update(float delta_time) {
    auto& game_stats = registry_.ctx().get<game::data::GameStats&>();
    game_stats.cost_ += game_stats.cost_gen_per_second_ * delta_time;
}
```

> æ³¨æ„ï¼šå½“å‰ tag é‡Œ `onEnemyArriveHome()` è¿˜æ²¡æœ‰åƒ `CombatResolveSystem` é‚£æ ·åœ¨æ„é€ å‡½æ•°é‡Œ `sink/connect` æ¥åˆ°äº‹ä»¶ä¸Šï¼ˆä»£ç é‡Œä¹Ÿä¿ç•™äº† TODOï¼‰ã€‚åç»­è¡¥ä¸Šè¿æ¥åï¼Œ`FollowPathSystem` å‘å‡ºçš„ `EnemyArriveHomeEvent` æ‰ä¼šçœŸæ­£æ”¹å˜åŸºåœ°è¡€é‡ã€‚

## ğŸ—ºï¸ 4) å‡ºå‡»åŒºåŸŸï¼šTiled æ ‡è®° + Builder æ‰“ Tag

### 4.1 åœ¨ tileset ä¸­ä¸ºâ€œå‡ºå‡»ç‚¹â€è®¾ç½®å±æ€§

æœ¬èŠ‚ä¿®æ”¹ `assets/maps/tileset/buildings.tsj`ï¼Œæ–°å¢ä¸¤ç§ 64Ã—64 çš„å°å›¾å—ï¼š

- `melee_place.png`ï¼šproperties `place = "melee"`
- `range_place.png`ï¼šproperties `place = "range"`

å¹¶åœ¨åœ°å›¾ `assets/maps/level1.tmj` é‡Œæ–°å¢ object layerï¼š`placement`ï¼ŒæŠŠè¿™äº›æ ‡è®°æ‘†åˆ°åœ°å›¾ä¸Šã€‚

### 4.2 åœ¨ Builder ä¸­è§£æå±æ€§å¹¶æ·»åŠ æ ‡ç­¾

åœ¨ `src/game/defs/tags.h` æ–°å¢ä¸¤ä¸ªæ ‡ç­¾ï¼š

- `MeleePlaceTag`
- `RangedPlaceTag`

ç„¶ååœ¨ `src/game/loader/entity_builder_mw.cpp` é‡Œæ–°å¢ `buildPlace()`ï¼šè¯»å– tile çš„ `place` å±æ€§å¹¶ç»™å®ä½“æ‰“æ ‡ç­¾ï¼š

```cpp
if (property.value("name", "") == "place") {
    auto type = property.value("value", "");
    if (type == "melee") {
        registry_.emplace<game::defs::MeleePlaceTag>(entity_id_);
    } else if (type == "range") {
        registry_.emplace<game::defs::RangedPlaceTag>(entity_id_);
    }
}
```

è¿™æ ·ï¼Œâ€œåœ°å›¾ä¸Šçš„ä¸€ä¸ªæ ‡è®°â€å°±å˜æˆäº† ECS é‡Œçš„ä¸€ä¸ªâ€œåœ°ç‚¹ç±»å‹å®ä½“â€ï¼Œåç»­ç³»ç»Ÿå¯ä»¥éå¸¸è‡ªç„¶åœ°åšç­›é€‰ä¸åˆ¤å®šã€‚

## ğŸ§© 5) è‚–åƒæ¡å‡çº§ï¼šå°è£…ç±» + cost é®ç½©

ä¸ºäº†è®© `GameScene` ä¸è¢« UI ç»†èŠ‚æ·¹æ²¡ï¼Œæœ¬èŠ‚æŠŠåº•éƒ¨è‚–åƒæ¡ä» `GameScene::createUnitsPortraitUI()` æŠ½æˆäº†ç‹¬ç«‹ç±»ï¼š

- `src/game/ui/units_portrait_ui.h/.cpp`

å…¶ä¸­æœ€å…³é”®çš„æ›´æ–°ç‚¹æ˜¯ï¼š**æ ¹æ® `GameStats.cost_` å†³å®šæ˜¯å¦æ˜¾ç¤ºç°è‰²é®ç½©**ã€‚

å®ç°æ–¹å¼ä¹Ÿå¾ˆâ€œECS/UI æ ‘å‘³é“â€ï¼š

- æ¯ä¸ª `frame_panel` çš„ `order_index_` ç»§ç»­ä¿å­˜â€œè¯¥è§’è‰²çš„ costâ€
- é®ç½©æ˜¯ `frame_panel` çš„å­ panelï¼Œid ä¸º `"cover_panel"_hs`
- æ¯å¸§åªè¦æ¯”è¾ƒ `game_stats.cost_ < frame_panel->getOrderIndex()` å³å¯æ§åˆ¶é®ç½©æ˜¾ç¤º

```cpp
auto& game_stats = registry_.ctx().get<game::data::GameStats&>();
for (auto& frame_panel : anchor_panel_->getChildren()) {
    auto cover_panel = frame_panel->getChildById("cover_panel"_hs);
    if (cover_panel) {
        cover_panel->setVisible(game_stats.cost_ < frame_panel->getOrderIndex());
    }
}
```

å¯¹åº” PPT çš„æ•ˆæœå°±æ˜¯ï¼šcost ä¸å¤Ÿæ—¶ï¼Œè‚–åƒä¼šâ€œç›–ç°â€ï¼Œæç¤ºå½“å‰æ— æ³•å‡ºå‡»ã€‚

## ğŸ“ˆ 6) è¡¥é½ç»Ÿè®¡ï¼šå‡»æ€æ•°æ›´æ–°ï¼ˆä¸ºé€šå…³åˆ¤å®šé“ºå«ï¼‰

åœ¨ `CombatResolveSystem` é‡Œï¼Œæ•Œäººæ­»äº¡æ—¶ä¼šæ›´æ–° `enemy_killed_count_`ï¼Œå¹¶é¢„ç•™â€œæ•Œäººå…¨éƒ¨å¤„ç†å®Œ â†’ åˆ‡åœºæ™¯â€çš„é€»è¾‘ï¼š

```cpp
auto& game_stats = registry_.ctx().get<game::data::GameStats&>();
game_stats.enemy_killed_count_++;
if ((game_stats.enemy_killed_count_ + game_stats.enemy_arrived_count_) >= game_stats.enemy_count_) {
    // TODO: åˆ‡æ¢åœºæ™¯é€»è¾‘
}
```

`enemy_count_` ç›®å‰è¿˜æ²¡æœ‰åœ¨â€œåˆ·æ€ª/æ³¢æ¬¡ç³»ç»Ÿâ€é‡Œæ­£å¼èµ‹å€¼ï¼Œå› æ­¤è¿™é‡Œå…ˆå½“ä½œâ€œé€šå…³åˆ¤å®šæ¥å£â€é¢„åŸ‹ï¼Œä¸‹ä¸€èŠ‚ä¸åç»­æ³¢æ¬¡ç³»ç»Ÿä¼šæŠŠå®ƒä¸²èµ·æ¥ã€‚

## âœ… æœ¬èŠ‚å°ç»“

- ç”¨ `GameStats` æŠŠå…³å¡èµ„æº/ç»Ÿè®¡æ•°æ®é›†ä¸­ç®¡ç†ï¼Œå¹¶é€šè¿‡ `registry.ctx()` å…±äº«ç»™ç³»ç»Ÿä¸ UI
- æ–°å¢ `GameRuleSystem` æ¨è¿› costï¼ˆå¹¶ä¸ºâ€œæ•Œäººåˆ°è¾¾åŸºåœ°/åŸºåœ°è¡€é‡â€ç­‰è§„åˆ™é¢„ç•™å…¥å£ï¼‰
- åœ¨åœ°å›¾ä¸­æ ‡è®°â€œè¿‘æˆ˜/è¿œç¨‹å‡ºå‡»ç‚¹â€ï¼Œå¹¶åœ¨ Builder ä¸­æŠŠ tile property è½¬æˆ `MeleePlaceTag/RangedPlaceTag`
- è‚–åƒæ¡ UI æŠ½æˆ `UnitsPortraitUI`ï¼Œå¹¶ç”¨ `GameStats.cost_` é©±åŠ¨â€œç°è‰²é®ç½©â€åé¦ˆ
- åœ¨æˆ˜æ–—ç»“ç®—é‡Œè¡¥ä¸Šå‡»æ€ç»Ÿè®¡ï¼Œä¸ºåç»­å…³å¡ç»“æŸåˆ¤å®šåšå‡†å¤‡

## ğŸ” è‡ªæ£€æ¸…å•

- [ ] `GameStats` æ˜¯å¦å·²æˆåŠŸæ”¾å…¥ `registry.ctx()`ï¼ˆç³»ç»Ÿä¸ UI èƒ½æ‹¿åˆ°å¼•ç”¨ï¼‰
- [ ] cost æ˜¯å¦ä¼šéšæ—¶é—´å¢é•¿ï¼Œè‚–åƒé®ç½©æ˜¯å¦ä¼šéš cost å˜åŒ–è€Œæ¶ˆå¤±
- [ ] `placement` å›¾å±‚çš„å®ä½“æ˜¯å¦èƒ½æ­£ç¡®è·å¾— `MeleePlaceTag/RangedPlaceTag`

## â¡ï¸ ä¸‹ä¸€èŠ‚é¢„å‘Š

ä¸‹ä¸€èŠ‚æˆ‘ä»¬ä¼šæŠŠâ€œé€‰æ‹©è‚–åƒâ€çœŸæ­£æ¨è¿›åˆ°â€œå‡ºå‡»â€ï¼š

- ç‚¹å‡»è‚–åƒè¿›å…¥â€œå‡ºå‡»å‡†å¤‡â€çŠ¶æ€ï¼ˆå‡†å¤‡æ”¾ç½®çš„å•ä½ä¿¡æ¯ï¼‰
- åœ¨åœ°å›¾ä¸Šåªå…è®¸æ”¾åˆ°åˆæ³•çš„å‡ºå‡»åŒºåŸŸï¼Œå¹¶å¤„ç†å ç”¨/æ‰£ cost/å‡ºå‡»å®Œæˆ
- é¢„è§ˆæ”»å‡»èŒƒå›´ï¼ˆæ”¾ç½®å‰æç¤ºï¼Œæ”¾ç½®åä¹Ÿèƒ½æ˜¾ç¤ºï¼‰

