# 18 åŠ¨ç”»é©±åŠ¨çš„æˆ˜æ–—äº¤äº’

<div class="video-container">
  <div id="bilibili" class="video-content">
    <!-- Bç«™åµŒå…¥ï¼šä½¿ç”¨ https æ˜ç¡®åè®®ï¼ˆé¿å… file:// æˆ– http å¯¼è‡´è¢«æµè§ˆå™¨æ‹¦æˆªï¼‰ -->
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV1LDUGBmEGv&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

[åœ¨ Bilibili ä¸Šè§‚çœ‹](https://www.bilibili.com/video/BV1LDUGBmEGv)

## ğŸ“– æ¦‚è¿°

ä¸Šä¸€èŠ‚æˆ‘ä»¬å·²ç»å®ç°äº†ï¼š

- ç›®æ ‡é”å®šï¼ˆ`TargetComponent` + `SetTargetSystem`ï¼‰
- æ”»å‡»å¯åŠ¨ï¼ˆ`AttackStarterSystem` è§¦å‘æ”»å‡»åŠ¨ç”»ï¼‰
- åŠ¨ç”»æ”¶å°¾ï¼ˆ`AnimationFinishedEvent` â†’ `AnimationStateSystem` å›åˆ° idle/walkï¼‰

ä½†è¿˜æœ‰ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜æ²¡æœ‰è§£å†³ï¼š**ä»€ä¹ˆæ—¶å€™çœŸæ­£é€ æˆä¼¤å®³/æ²»ç–—ï¼Ÿ**

å¦‚æœåœ¨â€œå‘èµ·æ”»å‡»â€çš„é‚£ä¸€åˆ»ç«‹åˆ»æ‰£è¡€ï¼ŒåŠ¨ä½œä¼šæ˜¾å¾—éå¸¸çªå…€ï¼šè§’è‰²è¿˜æ²¡æŒ¥åˆ€/ç‰¹æ•ˆè¿˜æ²¡å‡ºç°ï¼Œè¡€æ¡å°±æ‰äº†ã€‚

è¿™ä¸€èŠ‚æˆ‘ä»¬æŠŠâ€œæˆ˜æ–—äº¤äº’â€å®Œå…¨äº¤ç»™åŠ¨ç”»æ¥é©±åŠ¨ï¼š

1) **æ”»å‡»/æ²»ç–—åŠ¨ç”»æ’­æ”¾åˆ°å…³é”®å¸§** â†’ è§¦å‘â€œåŠ¨ç”»äº‹ä»¶â€ï¼ˆAnimation Eventï¼‰  
2) åŠ¨ç”»äº‹ä»¶å†è½¬æ¢æˆâ€œæˆ˜æ–—äº‹ä»¶â€ï¼ˆAttack/Heal Eventï¼‰  
3) æˆ˜æ–—äº‹ä»¶ç”±ç»“ç®—ç³»ç»Ÿç»Ÿä¸€å¤„ç†ï¼Œå®Œæˆæ‰£è¡€/å›è¡€/æ­»äº¡/å—ä¼¤æ ‡è®°ç­‰é€»è¾‘  

<img src="https://theorhythm.top/gamedev/MW/æ€ªç‰©æˆ˜äº‰.071.webp" style='width: 800px;' />

> PPT ç¬¬ 71 é¡µï¼šåŠ¨ç”»äº‹ä»¶é©±åŠ¨æˆ˜æ–—äº¤äº’ï¼ˆå‘½ä¸­/æ²»ç–—/å…¶å®ƒäº‹ä»¶ï¼‰

æœ¬èŠ‚å¯¹åº”ä»£ç æ ‡ç­¾ï¼š`18-åŠ¨ç”»é©±åŠ¨çš„æˆ˜æ–—äº¤äº’`ï¼ˆåŸºçº¿ï¼š`17-ç›®æ ‡é”å®šä¸æ”»å‡»`ï¼‰ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- ç»™åŠ¨ç”»ç³»ç»ŸåŠ å…¥â€œäº‹ä»¶ç‚¹â€ï¼šåœ¨æŒ‡å®šå¸§è§¦å‘äº‹ä»¶ï¼ˆ`AnimationEvent`ï¼‰
- åœ¨è“å›¾æ•°æ®é‡Œé…ç½®äº‹ä»¶ç‚¹ï¼šç”¨ JSON çš„ `events` å­—æ®µæŠŠäº‹ä»¶åä¸å¸§ç´¢å¼•å…³è”
- ç”¨ `AnimationEventSystem` æŠŠåŠ¨ç”»äº‹ä»¶ç¿»è¯‘ä¸ºæˆ˜æ–—äº‹ä»¶ï¼ˆ`AttackEvent` / `HealEvent`ï¼‰ï¼Œå¹¶é¡ºæ‰‹è§¦å‘éŸ³æ•ˆ
- ç”¨ `CombatResolveSystem` ç»Ÿä¸€ç»“ç®—ä¼¤å®³ä¸æ²»ç–—ï¼šæ‰£è¡€/å›è¡€ã€æ­»äº¡æ ‡è®°ã€å—ä¼¤æ ‡è®°ã€é˜»æŒ¡è®¡æ•°å›æ”¶
- å¼•å…¥å¼•æ“çº§ `AudioSystem`ï¼šç›‘å¬ `PlaySoundEvent`ï¼ŒæŠŠâ€œæ’­æ”¾éŸ³æ•ˆâ€ä¹Ÿäº‹ä»¶åŒ–

## ğŸ§© 1) åœ¨åŠ¨ç”»é‡ŒåŸ‹â€œäº‹ä»¶ç‚¹â€ï¼šAnimation.events_

æ ¸å¿ƒæ”¹åŠ¨å‘ç”Ÿåœ¨å¼•æ“å±‚çš„åŠ¨ç”»ç»“æ„ä½“ `engine::component::Animation`ï¼š

```cpp
struct Animation {
    std::vector<AnimationFrame> frames_;
    std::unordered_map<int, entt::id_type> events_; // key: å¸§ç´¢å¼•, value: äº‹ä»¶ID
    ...
};
```

ä½ å¯ä»¥æŠŠ `events_` ç†è§£ä¸ºâ€œæ—¶é—´è½´ä¸Šçš„æ ‡è®°ç‚¹â€ï¼š

- å½“åŠ¨ç”»æ’­æ”¾åˆ°ç¬¬ N å¸§æ—¶ï¼Œè§¦å‘ä¸€ä¸ªåä¸º `"hit"_hs` æˆ– `"emit"_hs` çš„äº‹ä»¶ã€‚

è¿™ä¸ªè®¾è®¡æœ‰ä¸¤ä¸ªä¼˜ç‚¹ï¼š

1) **æ•°æ®é©±åŠ¨**ï¼šäº‹ä»¶ç‚¹å®Œå…¨ç”±åŠ¨ç”»é…ç½®å†³å®šï¼Œé€»è¾‘ç³»ç»Ÿä¸å…³å¿ƒâ€œç¬¬å‡ å¸§å‘½ä¸­â€ã€‚  
2) **å¯æ‰©å±•**ï¼šé™¤äº† hitï¼Œè¿˜èƒ½æ‰©å±• emitï¼ˆå‘å°„ï¼‰ã€shakeï¼ˆéœ‡å±ï¼‰ã€fxï¼ˆç‰¹æ•ˆï¼‰ç­‰ã€‚  

## ğŸ“¨ 2) AnimationSystemï¼šå¸§æ¨è¿›æ—¶å‘é€ AnimationEvent

ä¸Šä¸€èŠ‚ `AnimationSystem` å·²ç»è´Ÿè´£æ¨è¿›å¸§ç´¢å¼•ï¼›è¿™ä¸€èŠ‚åœ¨â€œå¸§ç´¢å¼• +1â€ä¹‹åæ’å…¥ä¸€æ¬¡äº‹ä»¶æ£€æŸ¥ï¼š

```cpp
if (current_animation.events_.find(anim_component.current_frame_index_) != current_animation.events_.end()) {
    dispatcher_.enqueue(engine::utils::AnimationEvent{
        entity,
        current_animation.events_.at(anim_component.current_frame_index_),
        anim_component.current_animation_id_
    });
}
```

äº‹ä»¶ç»“æ„ä½“å®šä¹‰åœ¨ `src/engine/utils/events.h`ï¼š

```cpp
struct AnimationEvent {
    entt::entity entity_;
    entt::id_type event_name_id_;     // hit / emit ...
    entt::id_type animation_name_id_; // attack / heal / ...
};
```

è¿™é‡Œé¢å¤–æºå¸¦äº† `animation_name_id_`ï¼Œå°†æ¥åš debug æˆ–åˆ†åŠ¨ç”»åˆ†æ”¯æ—¶ä¼šæ›´æ–¹ä¾¿ã€‚

> æ³¨æ„ï¼šåŠ¨ç”»ç³»ç»Ÿåªæ˜¯â€œå‘äº‹ä»¶â€ï¼Œå®ƒä¸åšä»»ä½•æˆ˜æ–—é€»è¾‘ã€‚è¿™æ ·æ‰èƒ½ä¿æŒå¼•æ“å±‚ä¸æ¸¸æˆé€»è¾‘å±‚çš„è¾¹ç•Œæ¸…æ™°ã€‚

## ğŸ§¾ 3) åœ¨ JSON é‡Œé…ç½®åŠ¨ç”»äº‹ä»¶ï¼ševents å­—æ®µ

ä¸ºäº†è®©äº‹ä»¶ç‚¹çœŸæ­£å¯é…ç½®ï¼Œæœ¬èŠ‚åœ¨ `enemy_data.json` ä¸ `player_data.json` çš„åŠ¨ç”»é…ç½®é‡ŒåŠ å…¥ `events`ï¼š

- è¿‘æˆ˜æ”»å‡»åŠ¨ç”»ï¼š`"events": {"hit": 6}`  
- æ²»ç–—åŠ¨ç”»ï¼š`"events": {"hit": 19}`  
- è¿œç¨‹æ”»å‡»åŠ¨ç”»ï¼š`"events": {"emit": 11}`ï¼ˆä¸ºä¸‹ä¸€èŠ‚â€œæŠ•å°„ç‰©â€é“ºå«ï¼‰

ä¾‹å¦‚ç©å®¶æˆ˜å£«çš„æ”»å‡»åŠ¨ç”»ï¼š

```json
"attack": { "row": 2, "frames": [0,1,2,3], "events": {"hit": 2} }
```

æ•Œäººæ”»å‡»åŠ¨ç”»ï¼š

```json
"attack": { "duration": 50, "row": 3, "frames": [...], "events": {"hit": 10} }
```

è¿™æ ·ä¸€æ¥ï¼Œâ€œå‘½ä¸­å‘ç”Ÿåœ¨ç¬¬å‡ å¸§â€å°±å®Œå…¨ç”±ç¾æœ¯/åŠ¨ç”»èŠ‚å¥å†³å®šï¼Œç¨‹åºåªè´Ÿè´£å“åº”äº‹ä»¶ã€‚

## ğŸ“š 4) BlueprintManager / EntityFactoryï¼šæŠŠäº‹ä»¶é…ç½®å¸¦è¿›è¿è¡Œæ—¶ Animation

### 4.1 è“å›¾ç»“æ„æ‰©å±•ï¼šAnimationBlueprint å¢åŠ  events_

`src/game/data/entity_blueprint.h` çš„ `AnimationBlueprint` å¢åŠ ï¼š

```cpp
std::unordered_map<int, entt::id_type> events_;
```

### 4.2 BlueprintManager è§£æ events

`parseAnimationsMap()` åœ¨è§£ææ¯ä¸ªåŠ¨ç”»æ—¶ï¼Œå¦‚æœå‘ç° `events` å­—æ®µï¼Œå°±æŠŠäº‹ä»¶åå“ˆå¸Œæˆ idï¼Œå¹¶æŠŠâ€œå¸§ç´¢å¼• â†’ äº‹ä»¶IDâ€å­˜è¿› mapï¼š

```cpp
for (auto& [event_name, event_frame] : anim_data["events"].items()) {
    events.emplace(event_frame.get<int>(), entt::hashed_string(event_name.c_str()));
}
```

### 4.3 EntityFactory åˆ›å»º Animation æ—¶æŠŠ events_ ä¼ è¿›å»

åŸæ¥åˆ›å»ºåŠ¨ç”»åªä¼  framesï¼Œç°åœ¨å¤šä¼ ä¸€ä¸ª eventsï¼š

```cpp
animations.emplace(anim_id, engine::component::Animation(std::move(frames), anim_blueprint.events_));
```

è¿™æ ·ä» JSON â†’ è“å›¾ â†’ å®ä½“ç»„ä»¶çš„äº‹ä»¶é“¾è·¯å°±å®Œæ•´æ‰“é€šäº†ã€‚

## ğŸ§  5) AnimationEventSystemï¼šåŠ¨ç”»äº‹ä»¶ â†’ æˆ˜æ–—äº‹ä»¶ï¼ˆAttack/Healï¼‰

æœ‰äº† `AnimationEvent`ï¼Œæ¥ä¸‹æ¥å°±æ˜¯â€œè°æ¥æ¶ˆè´¹å®ƒâ€ã€‚æœ¬èŠ‚æ–°å¢ `AnimationEventSystem` ä¸“é—¨åšè¿™ä»¶äº‹ï¼š

- ç›‘å¬ `engine::utils::AnimationEvent`
- æ ¹æ® `event_name_id_` åˆ†å‘å¤„ç†ï¼ˆç›®å‰åªå®ç° `hit`ï¼‰

`hit` çš„é€»è¾‘éå¸¸ç›´è§‚ï¼š

### 5.1 ç©å®¶ hitï¼šæ”»å‡»æˆ–æ²»ç–—å½“å‰ Target

```cpp
if (registry_.all_of<PlayerComponent>(event.entity_)) {
    if (auto target = registry_.try_get<TargetComponent>(event.entity_)) {
        if (registry_.all_of<HealerTag>(event.entity_)) {
            dispatcher_.enqueue(HealEvent{event.entity_, target->entity_, stats.atk_});
        } else {
            dispatcher_.enqueue(AttackEvent{event.entity_, target->entity_, stats.atk_});
        }
        dispatcher_.enqueue(PlaySoundEvent{event.entity_, "hit"_hs});
    }
}
```

æ³¨æ„è¿™é‡Œç”¨çš„æ˜¯ `try_get`ï¼šå› ä¸ºç›®æ ‡å¯èƒ½åœ¨åŠ¨ç”»è¿‡ç¨‹ä¸­å¤±æ•ˆï¼ˆæ­»äº¡/ç¦»å¼€èŒƒå›´/è¢«æ¸…ç†ï¼‰ï¼Œæ‰€ä»¥ä¸èƒ½å‡è®¾ç›®æ ‡æ°¸è¿œå­˜åœ¨ã€‚

### 5.2 æ•Œäºº hitï¼šæ”»å‡»é˜»æŒ¡è€…

æ•Œäººçš„è¿‘æˆ˜å‘½ä¸­ç›®æ ‡å°±æ˜¯é˜»æŒ¡è€…ï¼ˆ`BlockedByComponent`ï¼‰ï¼š

```cpp
if (auto blocked_by = registry_.try_get<BlockedByComponent>(event.entity_)) {
    dispatcher_.enqueue(AttackEvent{event.entity_, blocked_by->entity_, stats.atk_});
}
```

è¿œç¨‹æ•Œäººçš„ `emit` æš‚æ—¶ä¸åœ¨æœ¬èŠ‚å¤„ç†â€”â€”ä¸‹ä¸€èŠ‚ä¼šç”¨å®ƒå‘å°„æŠ•å°„ç‰©ã€‚

## âœ… 6) CombatResolveSystemï¼šç»Ÿä¸€ç»“ç®—ï¼ˆæ‰£è¡€/å›è¡€/æ­»äº¡/é˜»æŒ¡å›æ”¶ï¼‰

å‰é¢æˆ‘ä»¬åªæ˜¯â€œå‘å‡º Attack/Heal äº‹ä»¶â€ï¼ŒçœŸæ­£æ”¹å˜æ¸¸æˆçŠ¶æ€çš„æ˜¯ `CombatResolveSystem`ï¼š

- ç›‘å¬ `AttackEvent` / `HealEvent`
- è®¡ç®—æœ€ç»ˆä¼¤å®³ï¼ˆæˆ–æ²»ç–—é‡ï¼‰
- ä¿®æ”¹ `StatsComponent.hp_`
- æ‰“ä¸Š `DeadTag / InjuredTag`ï¼Œæˆ–ç§»é™¤ `InjuredTag`

<img src="https://theorhythm.top/gamedev/MW/æ€ªç‰©æˆ˜äº‰.073.webp" style='width: 800px;' />

> PPT ç¬¬ 73 é¡µï¼šä¼¤å®³/æ²»ç–—äº‹ä»¶ â†’ ç»“ç®—ï¼ˆå…¬å¼ã€å—ä¼¤ã€æ­»äº¡ï¼‰

### 6.1 ä¼¤å®³å…¬å¼

æœ¬èŠ‚å…ˆç”¨ä¸€ä¸ªâ€œå¤Ÿç”¨ä¸”æ˜“è°ƒæ•´â€çš„å…¬å¼ï¼š

- `damage = atk - def`
- æœ€å°ä¼¤å®³ä¸º `atk * 10%`

```cpp
float damage = attacker_atk - target_def;
damage = std::max(damage, 0.1f * attacker_atk);
```

### 6.2 æ­»äº¡ä¸å—ä¼¤

- `hp_ <= 0`ï¼šç½® 0ï¼Œæ‰“ `DeadTag`
- `hp_ < max_hp_`ï¼šæ‰“ï¼ˆæˆ–æ›¿æ¢ï¼‰`InjuredTag`ï¼Œç”¨äºæ²»ç–—ç³»ç»Ÿé€‰æ‹©ç›®æ ‡

### 6.3 é˜»æŒ¡è®¡æ•°å›æ”¶ï¼ˆå¾ˆå…³é”®ï¼‰

å½“æ•Œäººæ­»äº¡æ—¶ï¼Œå¦‚æœå®ƒæ›¾è¢«é˜»æŒ¡ï¼Œéœ€è¦æŠŠé˜»æŒ¡è€…çš„ `current_count_` å‡ 1ï¼Œå¦åˆ™é˜»æŒ¡è€…ä¼šâ€œæ°¸è¿œæ»¡å‘˜â€ï¼Œå¯¼è‡´åç»­æ•Œäººæ— æ³•è¢«é˜»æŒ¡ï¼š

```cpp
if (auto blocked_by = registry_.try_get<BlockedByComponent>(dead_enemy); blocked_by) {
    auto& blocker = registry_.get<BlockerComponent>(blocked_by->entity_);
    blocker.current_count_ = glm::max(0, blocker.current_count_ - 1);
}
```

è¿™å°±æ˜¯æŠŠâ€œé˜»æŒ¡â€ä»çº¯ç§»åŠ¨é€»è¾‘ï¼ŒçœŸæ­£è¿æ¥åˆ°æˆ˜æ–—ç»“ç®—åçš„å¿…è¦ä¸€æ­¥ã€‚

## ğŸ”Š 7) éŸ³æ•ˆä¹Ÿäº‹ä»¶åŒ–ï¼šPlaySoundEvent + AudioSystem

ä¸ºäº†è®©â€œå‘½ä¸­éŸ³æ•ˆâ€ä¸è¢«å†™æ­»åœ¨æˆ˜æ–—é€»è¾‘é‡Œï¼Œæœ¬èŠ‚æ–°å¢å¼•æ“çº§ `PlaySoundEvent`ï¼š

```cpp
struct PlaySoundEvent {
    entt::entity entity_;
    entt::id_type sound_id_;
};
```

ä»¥åŠ `AudioSystem`ï¼š

- ç›‘å¬ `PlaySoundEvent`
- å¦‚æœå®ä½“æœ‰ `AudioComponent`ï¼Œä¼˜å…ˆä»å®ä½“çš„ `sounds_` æ˜ å°„é‡Œæ‰¾çœŸæ­£èµ„æº id
- å¦åˆ™å›é€€åˆ°â€œå…¨å±€éŸ³æ•ˆ idâ€æ’­æ”¾

è¿™æ ·â€œè°æ¥æ’­æ”¾éŸ³æ•ˆâ€å°±ä»æ¸¸æˆç³»ç»Ÿé‡Œè§£è€¦å‡ºæ¥äº†ï¼›åé¢åšæ›´å¤šéŸ³æ•ˆï¼ˆemitã€deathã€hurtï¼‰æ—¶ä¼šå¾ˆé¡ºæ»‘ã€‚

## ğŸ§© 8) GameScene æ¥å…¥ï¼šåªè¦æ„é€ ç³»ç»Ÿå³å¯

`AnimationEventSystem / CombatResolveSystem / AudioSystem` éƒ½æ˜¯â€œäº‹ä»¶ç›‘å¬å‹ç³»ç»Ÿâ€ï¼Œæ²¡æœ‰ update å‡½æ•°ï¼Œåªè¦åœ¨ `GameScene` æ„é€ æ—¶åˆ›å»ºå®ƒä»¬å¹¶ä¿æŒç”Ÿå‘½å‘¨æœŸå³å¯ï¼š

```cpp
audio_system_ = std::make_unique<AudioSystem>(registry_, context_);
animation_event_system_ = std::make_unique<AnimationEventSystem>(registry_, dispatcher);
combat_resolve_system_ = std::make_unique<CombatResolveSystem>(registry_, dispatcher);
```

ä»è¿™ä¸€èŠ‚å¼€å§‹ï¼Œæˆ˜æ–—é—­ç¯çœŸæ­£è·‘é€šï¼š

æ”»å‡»å¯åŠ¨ â†’ æ’­åŠ¨ç”» â†’ å…³é”®å¸§ hit â†’ å‘ Attack/Heal äº‹ä»¶ â†’ ç»“ç®—æ‰£è¡€/å›è¡€ â†’ æ­»äº¡/å—ä¼¤çŠ¶æ€æ›´æ–°ã€‚

## âœ… æœ¬èŠ‚å°ç»“

- åŠ¨ç”»ç»„ä»¶å¢åŠ  `events_`ï¼Œæ”¯æŒåœ¨â€œæŒ‡å®šå¸§â€è§¦å‘äº‹ä»¶ï¼ˆå®Œå…¨æ•°æ®é©±åŠ¨ï¼‰
- JSON åŠ¨ç”»é…ç½®æ–°å¢ `events`ï¼ŒæŠŠ hit/emit ç­‰äº‹ä»¶ç‚¹å†™è¿›æ•°æ®
- `AnimationSystem` æ¨è¿›å¸§æ—¶å‘é€ `AnimationEvent`
- `AnimationEventSystem` æŠŠåŠ¨ç”»äº‹ä»¶ç¿»è¯‘æˆ `AttackEvent/HealEvent`ï¼Œå¹¶è§¦å‘ `PlaySoundEvent`
- `CombatResolveSystem` ç»Ÿä¸€åšä¼¤å®³/æ²»ç–—ç»“ç®—ï¼Œå¹¶è¡¥é½æ­»äº¡ã€å—ä¼¤ä¸é˜»æŒ¡è®¡æ•°å›æ”¶
- `AudioSystem` ç›‘å¬ `PlaySoundEvent`ï¼ŒæŠŠéŸ³æ•ˆæ’­æ”¾ä¹Ÿäº‹ä»¶åŒ–

## â¡ï¸ ä¸‹ä¸€èŠ‚é¢„å‘Š

è¿™ä¸€èŠ‚æˆ‘ä»¬å·²ç»è®©â€œå‘½ä¸­â€é€šè¿‡åŠ¨ç”»äº‹ä»¶é©±åŠ¨æˆç«‹ã€‚

ä¸‹ä¸€èŠ‚æˆ‘ä»¬ä¼šæŠŠ `"emit"` äº‹ä»¶çœŸæ­£ç”¨èµ·æ¥ï¼š**è¿œç¨‹æ”»å‡»ä¸å¼¹é“**ã€‚åŠ¨ç”»äº‹ä»¶ä¸å†ç›´æ¥é€ æˆä¼¤å®³ï¼Œè€Œæ˜¯ï¼š

`emit` â†’ ç”ŸæˆæŠ•å°„ç‰©å®ä½“ â†’ æŠ•å°„ç‰©ç³»ç»Ÿæ›´æ–°è¿åŠ¨ â†’ å‘½ä¸­æ—¶å†å‘é€ä¼¤å®³äº‹ä»¶ã€‚