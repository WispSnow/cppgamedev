# 07 è¾“å…¥æ¨¡å—çš„ä¿¡å·åŠŸèƒ½

<div class="video-container">
  <div id="bilibili" class="video-content">
    <!-- Bç«™åµŒå…¥ï¼šä½¿ç”¨ https æ˜ç¡®åè®®ï¼ˆé¿å… file:// æˆ– http å¯¼è‡´è¢«æµè§ˆå™¨æ‹¦æˆªï¼‰ -->
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV1D8s1zdEyn&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

[åœ¨ Bilibili ä¸Šè§‚çœ‹](https://www.bilibili.com/video/BV1D8s1zdEyn)

## ğŸ“– æ¦‚è¿°

åœ¨ä¸Šä¸€æœŸã€Šé˜³å…‰å²›ã€‹çš„æ¡†æ¶é‡Œï¼Œè¾“å…¥å¤§å¤šé€šè¿‡â€œè½®è¯¢â€ä½¿ç”¨ï¼šæ¯ä¸€å¸§ä½ éƒ½å»é—® `InputManager` â€”â€”â€œæŸä¸ªåŠ¨ä½œæ˜¯å¦æŒ‰ä¸‹/æ˜¯å¦æŠ¬èµ·/æ˜¯å¦æŒç»­æŒ‰ç€â€ã€‚è¿™å¥—æ–¹å¼èƒ½è·‘ï¼Œä½†ä¼šæŠŠè¾“å…¥å¤„ç†é€»è¾‘æ‹†æ•£åˆ°å„å¤„ï¼Œå¹¶ä¸”å®¹æ˜“å½¢æˆä¸€æ¡â€œæ¯å¸§éƒ½è¦èµ°ä¸€éâ€çš„ `handleInput()` è°ƒç”¨é“¾ã€‚

è¿™ä¸€èŠ‚æˆ‘ä»¬æŠŠè¾“å…¥æ¨¡å—å‡çº§ä¸ºâ€œä¿¡å·é©±åŠ¨â€ï¼š

- `InputManager::update()` é‡Œè´Ÿè´£**æ£€æµ‹çŠ¶æ€å˜åŒ–**
- ä¸€æ—¦æŸä¸ªåŠ¨ä½œè¿›å…¥ `PRESSED/HELD/RELEASED` çŠ¶æ€ï¼Œå°±é€šè¿‡ EnTT çš„ `sigh/sink` **å‘å¸ƒä¿¡å·**
- éœ€è¦å“åº”è¾“å…¥çš„ç³»ç»Ÿ/åœºæ™¯åªè¦è®¢é˜…å³å¯ï¼Œä¸å¿…æ¯å¸§è½®è¯¢

æœ¬èŠ‚å¯¹åº”ä»£ç æ ‡ç­¾ï¼š`07-è¾“å…¥æ¨¡å—çš„ä¿¡å·åŠŸèƒ½`ï¼ˆåŸºçº¿ï¼š`06-ä»£ç çš„å¤ç”¨ä¸æ•´ç†`ï¼‰ã€‚

![](../æœ¬æœŸå‚è€ƒ/PPTæˆªå›¾/æ€ªç‰©æˆ˜äº‰.037.png)

> PPT ç¬¬ 37 é¡µï¼šæŠŠâ€œå…·ä½“æŒ‰é”®/é¼ æ ‡æŒ‰é’®â€æ˜ å°„ä¸ºâ€œæŠ½è±¡åŠ¨ä½œâ€ï¼Œæ¯ä¸ªåŠ¨ä½œéƒ½æœ‰â€œæŒ‰ä¸‹/æŒç»­/æŠ¬èµ·â€çš„çŠ¶æ€

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- ç†è§£è¾“å…¥æ˜ å°„çš„ä¸¤å±‚ç»“æ„ï¼š`Config`ï¼ˆåŠ¨ä½œ â†’ æŒ‰é”®åï¼‰â†’ `InputManager`ï¼ˆè¾“å…¥ â†’ åŠ¨ä½œåˆ—è¡¨ï¼‰
- å­¦ä¼šä¸ºåŠ¨ä½œæ³¨å†Œå›è°ƒï¼š`onAction(action, state).connect(...)`
- ç†è§£ `InputManager::update()` çš„ä¸‰æ®µå¼æµç¨‹ï¼š**çŠ¶æ€æ¨è¿› â†’ äº‹ä»¶å¤„ç† â†’ å‘å¸ƒå›è°ƒ**
- è®¤è¯†â€œè½®è¯¢ + ä¿¡å·â€å¯ä»¥å…±å­˜ï¼šéœ€è¦æ—¶ä»å¯ç”¨ `isActionPressed/Down/Released`

## ğŸ§  æ€è·¯ä¸è®¾è®¡

### 1) ä¸ºä»€ä¹ˆè¦åšæˆä¿¡å·ï¼Ÿ

å¯¹è¾“å…¥æ¥è¯´ï¼Œç»å¤§å¤šæ•°é€»è¾‘æ˜¯â€œå˜åŒ–è§¦å‘â€çš„ï¼šåªæœ‰å‘ç”ŸæŒ‰ä¸‹/æ¾å¼€æ—¶ï¼Œæ‰éœ€è¦åšäº‹ã€‚æŠŠå®ƒå†™æˆä¿¡å·æœ‰ä¸‰ä¸ªç›´æ¥æ”¶ç›Šï¼š

- **å‡å°‘æ— æ„ä¹‰è°ƒç”¨**ï¼šæ²¡æœ‰è¾“å…¥å˜åŒ–æ—¶ï¼Œä¸å¿…è®©å„å¤„ `if (isActionPressed(...))` éƒ½è·‘ä¸€é
- **é™ä½è€¦åˆ**ï¼šåœºæ™¯/ç³»ç»Ÿåªå…³å¿ƒâ€œåŠ¨ä½œå‘ç”Ÿäº†â€ï¼Œä¸å…³å¿ƒæŒ‰é”®æ¥è‡ªé”®ç›˜è¿˜æ˜¯é¼ æ ‡
- **æ›´ç¬¦åˆåç»­æ¶æ„**ï¼šä¸‹ä¸€èŠ‚ä¼šå¼•å…¥äº‹ä»¶æ€»çº¿ä¸åœºæ™¯åˆ‡æ¢ï¼Œè¾“å…¥ä¿¡å·å°±æ˜¯æœ€è‡ªç„¶çš„â€œäº‹ä»¶æºâ€ä¹‹ä¸€

### 2) ä¸¤ç§ç”¨æ³•åŒæ—¶ä¿ç•™ï¼šè½®è¯¢ & è®¢é˜…

è¿™èŠ‚çš„å®ç°å¹¶æ²¡æœ‰æŠŠâ€œè½®è¯¢æ¥å£â€åˆ æ‰ï¼Œè€Œæ˜¯æŠŠå®ƒå˜æˆ**å¯é€‰é¡¹**ï¼š

- è‹¥ä½ éœ€è¦â€œæŸåŠ¨ä½œæ˜¯å¦æŒç»­æŒ‰ä¸‹â€è¿™ç±»çŠ¶æ€æŸ¥è¯¢ï¼šç»§ç»­ç”¨ `isActionDown(...)`
- è‹¥ä½ åªå…³å¿ƒâ€œæŒ‰ä¸‹/æŠ¬èµ·â€è¿™ä¸€ç¬é—´ï¼šç”¨ `onAction(...).connect(...)` æ›´ç›´æ¥

![](../æœ¬æœŸå‚è€ƒ/PPTæˆªå›¾/æ€ªç‰©æˆ˜äº‰.038.png)

> PPT ç¬¬ 38 é¡µï¼šInputManager ä¿ç•™æŸ¥è¯¢æ¥å£ï¼ˆè½®è¯¢ï¼‰ï¼ŒåŒæ—¶åœ¨åŠ¨ä½œè§¦å‘æ—¶å‘é€ä¿¡å·å¹¶ç»‘å®šå¤–éƒ¨å‡½æ•°

### 3) API è®¾è®¡ï¼šä¸ºä»€ä¹ˆè¿”å› `entt::sink`ï¼Ÿ

æœ¬èŠ‚å¯¹å¤–æä¾›çš„æ¥å£æ˜¯ï¼š

```cpp
entt::sink<entt::sigh<void()>> onAction(std::string_view action_name,
                                       ActionState action_state = ActionState::PRESSED);
```

`sink` çš„æ„ä¹‰æ˜¯â€œåªç»™ä½ è¿æ¥/æ–­å¼€â€çš„æƒé™ï¼Œè€Œä¸æ˜¯æŠŠ `sigh` æœ¬ä½“æš´éœ²å‡ºå»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š

- å¤–éƒ¨ï¼šåªèƒ½ `connect / disconnect`
- `InputManager` å†…éƒ¨ï¼šè´Ÿè´£ `publish()`

è¿™æ ·â€œè°æ˜¯äº‹ä»¶æºâ€éå¸¸æ˜ç¡®ï¼Œä¹Ÿæ›´ä¸å®¹æ˜“è¢«è¯¯ç”¨ã€‚

## ğŸ”§ å®ç°æ­¥éª¤

### 1) ä» `Config` å»ºç«‹æ˜ å°„ï¼šåŠ¨ä½œ â†’ è¾“å…¥

è¾“å…¥æ¨¡å—çš„ç¬¬ä¸€å±‚æŠ½è±¡ä»ç„¶æ¥è‡ªé…ç½®ï¼š`Config::input_mappings_` æ˜¯â€œåŠ¨ä½œå â†’ æŒ‰é”®ååˆ—è¡¨â€çš„æ˜ å°„ï¼ˆé»˜è®¤å€¼åœ¨å¤´æ–‡ä»¶é‡Œç»™äº†ä¸€å¥—ï¼‰ã€‚

ä¾‹å¦‚ï¼ˆèŠ‚é€‰ï¼‰ï¼š

```cpp
// src/engine/core/config.h
std::unordered_map<std::string, std::vector<std::string>> input_mappings_ = {
    {"jump", {"J", "Space"}},
    {"attack", {"K", "MouseLeft"}},
};
```

`InputManager::initializeMappings()` ä¼šæŠŠè¿™ä»½é…ç½®è½¬æ¢ä¸ºè¿è¡Œæ—¶æ›´å¥½ç”¨çš„ç»“æ„ï¼š

- `action_states_`ï¼šåŠ¨ä½œå½“å‰çŠ¶æ€ï¼ˆ`PRESSED/HELD/RELEASED/INACTIVE`ï¼‰
- `input_to_actions_`ï¼šè¾“å…¥ï¼ˆ`SDL_Scancode` æˆ– `MouseButton`ï¼‰â†’ åŠ¨ä½œåˆ—è¡¨

å¦å¤–å®ƒè¿˜è¡¥å……äº† UI å¸¸ç”¨çš„é»˜è®¤åŠ¨ä½œï¼ˆå¦‚æœé…ç½®é‡Œæ²¡å†™å°±è‡ªåŠ¨åŠ ï¼‰ï¼š

- `mouse_left` â†’ `MouseLeft`
- `mouse_right` â†’ `MouseRight`

### 2) å¢åŠ â€œåŠ¨ä½œå›è°ƒè¡¨â€ï¼šä¸€ä¸ªåŠ¨ä½œä¸‰ç§ä¿¡å·

æ ¸å¿ƒæ•°æ®ç»“æ„æ˜¯ï¼š

```cpp
// src/engine/input/input_manager.h
std::unordered_map<std::string, std::array<entt::sigh<void()>, 3>> actions_to_func_;
```

å«ä¹‰æ˜¯ï¼šæ¯ä¸ªåŠ¨ä½œåéƒ½å¯¹åº” 3 ä¸ªä¿¡å·æ§½ä½ï¼Œåˆ†åˆ«ä»£è¡¨ï¼š

- `PRESSED`ï¼ˆæœ¬å¸§åˆšæŒ‰ä¸‹ï¼‰
- `HELD`ï¼ˆæŒç»­æŒ‰ä¸‹ï¼‰
- `RELEASED`ï¼ˆæœ¬å¸§åˆšæŠ¬èµ·ï¼‰

`ActionState::INACTIVE` è¢«æ”¾åœ¨æšä¸¾æœ«å°¾ï¼Œå¹¶ä¸”ä¸å‚ä¸æ•°ç»„ç´¢å¼•ï¼ˆæ•°ç»„åªæœ‰ 3 ä¸ªæ§½ä½ï¼‰ã€‚

### 3) æä¾›å¯¹å¤–æ¥å£ï¼š`InputManager::onAction(...)`

å¯¹å¤–æ³¨å†Œå›è°ƒæ—¶ï¼Œ`InputManager` è¿”å›ä¸€ä¸ª `sink`ï¼š

```cpp
// src/engine/input/input_manager.cpp
entt::sink<entt::sigh<void()>> InputManager::onAction(std::string_view action_name,
                                                      ActionState action_state) {
    // å¦‚æœ action_name ä¸å­˜åœ¨ï¼Œoperator[] ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ç»„ sighï¼ˆæ‡’åŠ è½½ï¼‰
    return actions_to_func_[std::string(action_name)].at(static_cast<size_t>(action_state));
}
```

### 4) åœ¨ `update()` é‡Œå‘å¸ƒä¿¡å·ï¼ˆæœ€å…³é”®ï¼‰

`InputManager::update()` è¢«æ‹†æˆä¸‰æ®µï¼š

1. æ¨è¿›çŠ¶æ€ï¼š`PRESSED â†’ HELD`ï¼Œ`RELEASED â†’ INACTIVE`
2. å¤„ç† SDL äº‹ä»¶ï¼šæŒ‰é”®/é¼ æ ‡äº‹ä»¶ä¼šè°ƒç”¨ `updateActionState(...)` æ›´æ–° `action_states_`
3. å‘å¸ƒå›è°ƒï¼šå¯¹é `INACTIVE` çš„åŠ¨ä½œå‘å¸ƒå¯¹åº”ä¿¡å·

ï¼ˆèŠ‚é€‰ï¼‰

```cpp
// src/engine/input/input_manager.cpp
void InputManager::update() {
    for (auto& [action_name_id, state] : action_states_) {
        if (state == ActionState::PRESSED) state = ActionState::HELD;
        else if (state == ActionState::RELEASED) state = ActionState::INACTIVE;
    }

    SDL_Event event;
    while (SDL_PollEvent(&event)) {
        processEvent(event);
    }

    for (auto& [action_name_id, state] : action_states_) {
        if (state != ActionState::INACTIVE) {
            if (auto it = actions_to_func_.find(action_name_id); it != actions_to_func_.end()) {
                it->second.at(static_cast<size_t>(state)).publish();
            }
        }
    }
}
```

è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆâ€œä¿¡å·é©±åŠ¨â€ä¸ä¼šç ´åæ—§é€»è¾‘ï¼š`action_states_` ä»ç„¶å­˜åœ¨ï¼ŒæŸ¥è¯¢æ¥å£ä¹Ÿä»ç„¶æœ‰æ•ˆã€‚

### 5) åœ¨åœºæ™¯ä¸­è®¢é˜…/è§£é™¤è®¢é˜…

æœ¬èŠ‚ç”¨ `GameScene` åšäº†ä¸€ä¸ªæœ€å°æ¼”ç¤ºï¼šæŠŠ `attack` çš„æŒ‰ä¸‹ã€`jump` çš„æŠ¬èµ·åˆ†åˆ«ç»‘å®šåˆ°ä¸¤ä¸ªæˆå‘˜å‡½æ•°ã€‚

```cpp
// src/game/scene/game_scene.cpp
void GameScene::init() {
    auto& input_manager = context_.getInputManager();
    input_manager.onAction("attack").connect<&GameScene::onAttack>(this);
    input_manager.onAction("jump", engine::input::ActionState::RELEASED).connect<&GameScene::onJump>(this);
}

void GameScene::clean() {
    auto& input_manager = context_.getInputManager();
    input_manager.onAction("attack").disconnect<&GameScene::onAttack>(this);
    input_manager.onAction("jump", engine::input::ActionState::RELEASED).disconnect<&GameScene::onJump>(this);
}
```

è¿™é‡Œçš„çº¦å®šéå¸¸é‡è¦ï¼š**è° connectï¼Œè° disconnect**ã€‚å¦åˆ™åœºæ™¯é€€å‡ºåå›è°ƒè¿˜åœ¨ï¼Œä¼šå¯¼è‡´â€œè®¿é—®å·²é”€æ¯å¯¹è±¡â€çš„é£é™©ã€‚

ä¸ºäº†çœ‹åˆ°æ—¥å¿—è¾“å‡ºï¼Œ`main.cpp` é‡ŒæŠŠæ—¥å¿—çº§åˆ«è°ƒæ•´ä¸ºäº† `info`ï¼š

- `spdlog::set_level(spdlog::level::info);`

## âœ… æœ¬èŠ‚å°ç»“

- è¾“å…¥ç³»ç»Ÿä»ç„¶ä»¥â€œåŠ¨ä½œï¼ˆActionï¼‰â€ä¸ºæŠ½è±¡å•ä½ï¼šé…ç½®å®šä¹‰æ˜ å°„ï¼Œè¿è¡Œæ—¶æŠŠå…·ä½“æŒ‰é”®/é¼ æ ‡äº‹ä»¶è½¬æ¢ä¸ºåŠ¨ä½œçŠ¶æ€
- åœ¨æ­¤åŸºç¡€ä¸Šæ–°å¢â€œä¿¡å·æ¥å£â€ï¼š`onAction(action, state)`ï¼ŒæŠŠâ€œå˜åŒ–è§¦å‘â€çš„é€»è¾‘å†™æˆè®¢é˜…å›è°ƒ
- è½®è¯¢æ¥å£ä»è¢«ä¿ç•™ï¼Œç”¨äºå°‘é‡éœ€è¦â€œæŒç»­çŠ¶æ€æŸ¥è¯¢â€çš„åœ°æ–¹

## ğŸ” è‡ªæ£€æ¸…å•

- [ ] è¿è¡Œç¨‹åºåæŒ‰ä¸‹ `K` æˆ–ç‚¹å‡»é¼ æ ‡å·¦é”®ï¼šæ§åˆ¶å°è¾“å‡º `onAttack`
- [ ] æ¾å¼€ `J` æˆ– `Space`ï¼šæ§åˆ¶å°è¾“å‡º `onJump`ï¼ˆå› ä¸ºç¤ºä¾‹ç»‘å®šçš„æ˜¯ `RELEASED`ï¼‰
- [ ] æ²¡æœ‰ä»»ä½•è¾“å…¥æ—¶ï¼šä¸ä¼šè§¦å‘å›è°ƒï¼Œä½†ä»ä¼šæ¨è¿› `ActionState`ï¼ˆ`PRESSED â†’ HELD` ç­‰ï¼‰

## â¡ï¸ ä¸‹ä¸€èŠ‚é¢„å‘Š

ä¸‹ä¸€èŠ‚ï¼ˆç¬¬ 08 èŠ‚ï¼‰æˆ‘ä»¬ä¼šæŠŠâ€œè¾“å…¥ä¿¡å·â€è¿›ä¸€æ­¥æå‡ä¸ºâ€œäº‹ä»¶æ€»çº¿â€ï¼Œå¹¶åœ¨å¼•æ“å±‚å®ç°**åœºæ™¯åˆ‡æ¢**ï¼š

- äº‹ä»¶æºä¸åªæ¥è‡ªè¾“å…¥ï¼Œä¹Ÿå¯ä»¥æ¥è‡ªä»»æ„ç³»ç»Ÿï¼ˆä¾‹å¦‚ UI æŒ‰é’®ã€æ¸¸æˆé€»è¾‘ï¼‰
- åœºæ™¯åˆ‡æ¢ä¸å†ä¾èµ–ç›´æ¥è°ƒç”¨ï¼Œè€Œæ˜¯é€šè¿‡äº‹ä»¶è¯·æ±‚ï¼ˆPush/Pop/Replaceï¼‰