# 13 å®Œå–„å…³å¡è½½å…¥å™¨

<div class="video-container">
  <div id="bilibili" class="video-content">
    <!-- Bç«™åµŒå…¥ï¼šä½¿ç”¨ https æ˜ç¡®åè®®ï¼ˆé¿å… file:// æˆ– http å¯¼è‡´è¢«æµè§ˆå™¨æ‹¦æˆªï¼‰ -->
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV1ZqkZBhEEG&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

[åœ¨ Bilibili ä¸Šè§‚çœ‹](https://www.bilibili.com/video/BV1ZqkZBhEEG)

## ğŸ“– æ¦‚è¿°

ç¬¬ 12 èŠ‚æˆ‘ä»¬å·²ç»èƒ½æŠŠ Tiled çš„åœ°å›¾ï¼ˆ`.tmj/.tsj`ï¼‰è§£ææˆ ECS å®ä½“å¹¶æ˜¾ç¤ºå‡ºæ¥ï¼Œä½†å¾ˆå¿«ä¼šé‡åˆ°ä¸‰ä¸ªâ€œçœ‹èµ·æ¥ä¸åƒ bugã€å´éå¸¸å½±å“è§‚æ„Ÿâ€çš„é—®é¢˜ï¼š

1) **èƒŒæ™¯è‰²ä¸å¯¹**ï¼šTiled é‡Œè®¾ç½®äº†èƒŒæ™¯è‰²ï¼Œä½†æ¸¸æˆé‡Œä»ç„¶æ˜¯é»‘åº•ã€‚  
2) **æ¸²æŸ“é¡ºåºä¸ç¨³å®š**ï¼šåŒä¸€å¼ åœ°å›¾ï¼Œä¸åŒå…ƒç´ çš„å‰åé®æŒ¡å¯èƒ½ä¸ç¬¦åˆé¢„æœŸã€‚  
3) **å¥‡æ€ªçš„ gid ç¼–å·**ï¼šå¯¹è±¡å±‚é‡Œå‡ºç° `2147484xxx` è¿™ç§è¶…å¤§çš„ gidï¼Œå®é™…ä¸Šæ˜¯â€œç¿»è½¬/æ—‹è½¬ flagâ€ç¼–ç åœ¨ gid çš„é«˜ä½ã€‚  

è¿™ä¸€èŠ‚æˆ‘ä»¬æŠŠå…³å¡è½½å…¥å™¨â€œè¡¥é½å·¥ç¨‹åŒ–ç»†èŠ‚â€ï¼šè®©ç”»é¢èƒ½æ­£ç¡®å‘ˆç°å‡º Tiled é‡Œçœ‹åˆ°çš„ç»“æœã€‚

![](../æœ¬æœŸå‚è€ƒ/PPTæˆªå›¾/æ€ªç‰©æˆ˜äº‰.057.png)

> PPT ç¬¬ 57 é¡µï¼šç¬¬ 13 èŠ‚æ ‡é¢˜é¡µ

æœ¬èŠ‚å¯¹åº”ä»£ç æ ‡ç­¾ï¼š`13-å®Œå–„å…³å¡è½½å…¥å™¨`ï¼ˆåŸºçº¿ï¼š`12-å…³å¡è½½å…¥å™¨`ï¼‰ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- è¯»å– `.tmj` çš„ `backgroundcolor`ï¼Œå¹¶æŠŠå®ƒåº”ç”¨åˆ° `Renderer::clearScreen()` çš„æ¸…å±é¢œè‰²
- ä¸ºæ¸²æŸ“é¡ºåºå¼•å…¥ `RenderComponent{layer, depth}`ï¼Œå¹¶åœ¨ `RenderSystem` ä¸­æŒ‰å®ƒæ’åº
- å¢åŠ  `YSortSystem`ï¼šæ¯å¸§æŠŠ `depth` æ›´æ–°ä¸º `TransformComponent` çš„ y åæ ‡ï¼ˆå®ç°åŒä¸€å›¾å±‚å†…çš„ y-orderï¼‰
- è§£æ Tiled gid çš„ç¿»è½¬ flagï¼ˆå…ˆæ”¯æŒæ°´å¹³ç¿»è½¬ï¼‰ï¼š`gid` è§£ç  â†’ è¿˜åŸçœŸæ­£çš„ tile id â†’ æŠŠç¿»è½¬ä¿¡æ¯ä¼ ç»™ `Sprite`

## ğŸ¨ 1) Tiled èƒŒæ™¯è‰²ï¼šä» `"#RRGGBB"` åˆ°æ¸…å±é¢œè‰²

Tiled çš„åœ°å›¾æ–‡ä»¶é‡Œå¯ä»¥ç›´æ¥é…ç½®èƒŒæ™¯è‰²ï¼Œä¾‹å¦‚ `assets/maps/level1.tmj` é¡¶éƒ¨æ–°å¢ï¼š

```json
{ "backgroundcolor":"#47aba9",
  "compressionlevel":-1,
  ...
}
```

PPT é‡Œä¹Ÿå¤ä¹ äº†åå…­è¿›åˆ¶é¢œè‰²å­—ç¬¦ä¸²çš„æ ¼å¼ï¼š`#RRGGBB`ï¼ˆä¸å¸¦é€æ˜åº¦ï¼‰ä¸ `#RRGGBBAA`ï¼ˆå¸¦é€æ˜åº¦ï¼‰ã€‚

![](../æœ¬æœŸå‚è€ƒ/PPTæˆªå›¾/æ€ªç‰©æˆ˜äº‰.058.png)

> PPT ç¬¬ 58 é¡µï¼šåå…­è¿›åˆ¶é¢œè‰²å­—ç¬¦ä¸²ï¼ˆRGB / RGBAï¼‰ç¤ºæ„

è½åˆ°ä»£ç ï¼Œæˆ‘ä»¬åšäº†ä¸‰ä»¶äº‹ï¼š

### 1.1 `parseHexColor()`ï¼šæŠŠåå…­è¿›åˆ¶å­—ç¬¦ä¸²è§£æä¸º 0~1 çš„æµ®ç‚¹é¢œè‰²

```cpp
// src/engine/utils/math.hï¼ˆèŠ‚é€‰ï¼‰
constexpr FColor parseHexColor(std::string_view hex_color) {
    // æ”¯æŒ "#RRGGBB" / "#RRGGBBAA"
    // è¿”å›å½’ä¸€åŒ–åˆ° 0.0f~1.0f çš„ r/g/b/a
}
```

### 1.2 `Renderer` è®°ä½â€œèƒŒæ™¯è‰²â€ï¼Œæ¸…å±æ—¶ä½¿ç”¨å®ƒ

`Renderer` æ–°å¢äº† `background_color_` å­—æ®µï¼Œå¹¶æä¾› `setBgColorFloat(...)`ï¼š

```cpp
// src/engine/render/renderer.hï¼ˆèŠ‚é€‰ï¼‰
engine::utils::FColor background_color_{0.0f, 0.0f, 0.0f, 1.0f};
void setBgColorFloat(float r, float g, float b, float a = 1.0f);
```

æ¸…å±æ—¶æŠŠå®ƒå†™å…¥ SDL æ¸²æŸ“å™¨å† `SDL_RenderClear`ï¼š

```cpp
// src/engine/render/renderer.cppï¼ˆèŠ‚é€‰ï¼‰
void Renderer::clearScreen() {
    setDrawColorFloat(background_color_.r, background_color_.g, background_color_.b, background_color_.a);
    SDL_RenderClear(renderer_);
}
```

### 1.3 `LevelLoader::loadLevel()`ï¼šè¯»å– `backgroundcolor` å¹¶è®¾ç½®ç»™ Renderer

```cpp
// src/engine/loader/level_loader.cppï¼ˆèŠ‚é€‰ï¼‰
if (json_data.contains("backgroundcolor")) {
    auto color_string = json_data["backgroundcolor"].get<std::string>();
    auto color = engine::utils::parseHexColor(color_string);
    scene_->getContext().getRenderer().setBgColorFloat(color.r, color.g, color.b, color.a);
}
```

è¿™æ ·ä¸€æ¥ï¼šå…³å¡çš„èƒŒæ™¯è‰²å°±ä¸å†é ç¡¬ç¼–ç ï¼Œè€Œæ˜¯å®Œå…¨ç”± Tiled é…ç½®é©±åŠ¨ã€‚

## ğŸ§± 2) æ¸²æŸ“é¡ºåºï¼šRenderComponent + æ’åº + y-order

â€œæ¸²æŸ“é¡ºåºâ€å…¶å®åˆ†ä¸¤å±‚ï¼š

1) **å›¾å±‚é¡ºåº**ï¼šèƒŒæ™¯å±‚å…ˆç”»ã€è£…é¥°å±‚åç”»ï¼ˆTiled å›¾å±‚çš„é¡ºåº/è‡ªå®šä¹‰é¡ºåºï¼‰ã€‚  
2) **åŒä¸€å›¾å±‚å†…é¡ºåº**ï¼šå…¸å‹ top-down æ¸¸æˆé‡Œï¼Œy è¶Šå¤§çš„ç‰©ä½“è¶Šé è¿‘é•œå¤´ï¼Œåº”è¯¥åç”»ï¼ˆè¦†ç›–å‰é¢çš„ï¼‰ã€‚  

![](../æœ¬æœŸå‚è€ƒ/PPTæˆªå›¾/æ€ªç‰©æˆ˜äº‰.059.png)

> PPT ç¬¬ 59 é¡µï¼šå›¾å±‚é¡ºåº + åŒå±‚ y-orderï¼ˆRenderComponentï¼š`layer_ / depth_`ï¼‰

### 2.1 æ–°å¢ `RenderComponent{layer, depth}`ï¼šè®©â€œé¡ºåºâ€å˜æˆæ•°æ®

```cpp
// src/engine/component/render_component.h
struct RenderComponent {
    int layer{};
    float depth{};
    bool operator<(const RenderComponent& other) const {
        if (layer == other.layer) return depth < other.depth;
        return layer < other.layer;
    }
};
```

æ³¨æ„æ¯”è¾ƒé€»è¾‘ï¼š**å…ˆæŒ‰ layerï¼Œå†æŒ‰ depth**ã€‚æ•°å­—è¶Šå°è¶Šå…ˆç»˜åˆ¶ï¼›å› æ­¤åªè¦æŠŠ `depth` è®¾ç½®ä¸º y åæ ‡ï¼Œå°±èƒ½å®ç°â€œé ä¸‹çš„åç»˜åˆ¶â€ã€‚

### 2.2 LevelLoader ç»´æŠ¤å½“å‰å›¾å±‚åºå·ï¼š`current_layer_`

`LevelLoader` æ–°å¢ `current_layer_`ï¼Œå¹¶åœ¨æ¯è½½å…¥ä¸€ä¸ª layer åé€’å¢ã€‚

æ›´è¿›ä¸€æ­¥ï¼šå¦‚æœæŸä¸ª layer è®¾ç½®äº†è‡ªå®šä¹‰å±æ€§ `order`ï¼Œä¼šè¦†ç›–å½“å‰å›¾å±‚åºå·ï¼ˆæ–¹ä¾¿å¼ºåˆ¶æŒ‡å®šæ¸²æŸ“å±‚çº§ï¼‰ï¼š

```cpp
// src/engine/loader/level_loader.cppï¼ˆèŠ‚é€‰ï¼‰
if (layer_json.contains("properties")) {
    for (auto& property : layer_json["properties"]) {
        if (property.contains("name") && property["name"] == "order") {
            current_layer_ = property["value"].get<int>();
        }
    }
}
```

åœ¨ `assets/maps/level1.tmj` é‡Œå°±èƒ½çœ‹åˆ°è¿™ä¸ªè‡ªå®šä¹‰å±æ€§ï¼ˆç¤ºä¾‹ï¼‰ï¼š

```json
"properties":[
  { "name":"order", "type":"int", "value":10 }
]
```

### 2.3 Builder è‡ªåŠ¨ç»™å®ä½“è¡¥ RenderComponentï¼šlayer æ¥è‡ª loaderï¼Œdepth æ¥è‡ª y

æœ¬èŠ‚æŠŠ `BasicEntityBuilder` çš„æ„å»ºé“¾è·¯è¡¥ä¸Šäº† `buildRender()`ï¼š

```cpp
// src/engine/loader/basic_entity_builder.cppï¼ˆèŠ‚é€‰ï¼‰
int layer = level_loader_.getCurrentLayer();
float depth = position_.y;
registry_.emplace<engine::component::RenderComponent>(entity_id_, layer, depth);
```

è¿™æ ·ä»å…³å¡é‡Œç”Ÿæˆçš„ç“¦ç‰‡/å¯¹è±¡éƒ½ä¼šå¤©ç„¶å¸¦ä¸Šæ¸²æŸ“æ’åºä¿¡æ¯ã€‚

ï¼ˆ`imagelayer` ä¸èµ° builderï¼Œæ‰€ä»¥ `LevelLoader::loadImageLayer()` é‡Œä¹Ÿæ˜¾å¼ `emplace<RenderComponent>(..., current_layer_)`ã€‚ï¼‰

### 2.4 RenderSystemï¼šæ¸²æŸ“å‰å…ˆ sortï¼Œå†æŒ‰æ’åºåçš„ view éå†

æ¸²æŸ“ç³»ç»Ÿä¹Ÿè¦â€œåˆ‡æ¢è§†è§’â€ï¼šä»â€œæœ‰ Sprite å°±ç”»â€å˜æˆâ€œå‚ä¸æ’åºçš„æ‰ç”»â€ï¼š

```cpp
// src/engine/system/render_system.cppï¼ˆèŠ‚é€‰ï¼‰
registry.sort<component::RenderComponent>([](const auto& lhs, const auto& rhs) {
    return lhs < rhs;
});

auto view = registry.view<component::RenderComponent,
                           component::TransformComponent,
                           component::SpriteComponent>();
```

è¿™é‡Œæœ‰ä¸ª EnTT çš„å°ç»†èŠ‚ï¼š**æ’åºç”¨çš„ç»„ä»¶è¦æ”¾åœ¨ view çš„ç¬¬ä¸€ä¸ªæ¨¡æ¿å‚æ•°**ï¼Œå¦åˆ™éå†é¡ºåºä¸ä¸€å®šæŒ‰æ’åºç»“æœèµ°ï¼ˆä»£ç é‡Œä¹Ÿå†™äº†æç¤ºï¼‰ã€‚

### 2.5 YSortSystemï¼šæ¯å¸§æ ¹æ® Transform çš„ y æ›´æ–° depthï¼ˆåŒå±‚ y-orderï¼‰

å¦‚æœä¸€ä¸ªå®ä½“ä¼šç§»åŠ¨ï¼Œé‚£ä¹ˆ `depth` ä¹Ÿè¦è·Ÿç€æ›´æ–°ã€‚äºæ˜¯æ–°å¢ `YSortSystem`ï¼š

```cpp
// src/engine/system/ysort_system.cppï¼ˆèŠ‚é€‰ï¼‰
auto view = registry.view<component::RenderComponent, const component::TransformComponent>();
for (auto entity : view) {
    view.get<component::RenderComponent>(entity).depth =
        view.get<const component::TransformComponent>(entity).position_.y;
}
```

`GameScene::update()` é‡ŒæŠŠå®ƒæ”¾åœ¨ `MovementSystem` ä¹‹åè°ƒç”¨ï¼š

```cpp
// src/game/scene/game_scene.cppï¼ˆèŠ‚é€‰ï¼‰
movement_system_->update(registry_, delta_time);
animation_system_->update(registry_, delta_time);
ysort_system_->update(registry_);   // è°ƒç”¨é¡ºåºè¦åœ¨MovementSystemä¹‹å
```

> å°æç¤ºï¼šæ›´çœŸå®çš„ top-down é®æŒ¡é€šå¸¸ç”¨â€œè„šåº•â€æ’åºï¼ˆ`y + height`ï¼‰è€Œä¸æ˜¯å·¦ä¸Šè§’ yï¼›æœ¬èŠ‚å…ˆç”¨ y åæ ‡æŠŠæœºåˆ¶è·‘é€šï¼Œåç»­éœ€è¦æ—¶å¯ä»¥å†ç²¾ç»†åŒ–ã€‚

## ğŸª 3) å›¾å—ç¿»è½¬ï¼šTiled gid çš„é«˜ä½ flag

å¦‚æœä½ åœ¨ `.tmj` é‡Œçœ‹åˆ°è¿™ç§è¶…å¤§çš„ gidï¼š

```json
{ "gid":2147484438, "width":192, "height":192, ... }
```

å¾ˆå¯èƒ½ä¸æ˜¯â€œçœŸçš„æœ‰ä¸¤åäº¿ä¸ª tileâ€ï¼Œè€Œæ˜¯ **Tiled æŠŠç¿»è½¬/æ—‹è½¬ä¿¡æ¯ç¼–ç åœ¨ gid çš„é«˜ä½ flag ä¸­**ã€‚

![](../æœ¬æœŸå‚è€ƒ/PPTæˆªå›¾/æ€ªç‰©æˆ˜äº‰.060.png)

> PPT ç¬¬ 60 é¡µï¼šgid é«˜ 3 ä½ä¸º flagï¼šæ°´å¹³/å‚ç›´/å¯¹è§’çº¿ç¿»è½¬ï¼ˆå¯¹è§’çº¿å¸¸ç”¨äºå®ç°æ—‹è½¬ï¼‰

æœ¬èŠ‚åœ¨ `LevelLoader::getTileInfoByGid(int gid)` ä¸­åšäº†ä¸¤æ­¥å…³é”®å¤„ç†ï¼š

### 3.1 æ£€æµ‹ flagï¼ˆå…ˆæ”¯æŒæ°´å¹³ç¿»è½¬ï¼‰

```cpp
// src/engine/loader/level_loader.cppï¼ˆèŠ‚é€‰ï¼‰
bool is_flipped_horizontally = gid & 0x80000000;
```

å‚ç›´ç¿»è½¬ä¸å¯¹è§’çº¿ç¿»è½¬åœ¨ä»£ç é‡Œç•™äº†æ³¨é‡Šå…¥å£ï¼ˆä¸‹ä¸€æ­¥æ‰©å±•æ—¶å†åšï¼‰ã€‚

### 3.2 è¿˜åŸçœŸå® gidï¼šæŠŠé«˜ 3 ä½æ¸…é›¶

```cpp
gid = gid & 0x1FFFFFFF;
```

`0x1FFFFFFF` çš„å«ä¹‰å°±æ˜¯ï¼šâ€œä½ 29 ä½ä¿ç•™ï¼Œé«˜ 3 ä½æ¸…é›¶â€ã€‚è¿™æ ·æ‰èƒ½ç»§ç»­èµ°ç¬¬ 12 èŠ‚é‚£å¥— `gid -> tileset(firstgid) -> local_id` çš„æŸ¥è¡¨é€»è¾‘ã€‚

### 3.3 æŠŠç¿»è½¬ä¿¡æ¯ä¼ ç»™ Spriteï¼Œå¹¶åœ¨ Renderer é‡Œè½åœ°

`TileInfo` æ„å»º Sprite æ—¶å¸¦ä¸Š flip æ ‡å¿—ï¼š

```cpp
tile_info.sprite_ = engine::component::Sprite(texture_path, texture_rect, is_flipped_horizontally);
```

è€Œ `Renderer::drawSprite()` æœ€ç»ˆæŠŠå®ƒå˜æˆ SDL çš„ç»˜åˆ¶å‚æ•°ï¼š

```cpp
// src/engine/render/renderer.cppï¼ˆèŠ‚é€‰ï¼‰
SDL_RenderTextureRotated(...,
    sprite.is_flipped_ ? SDL_FLIP_HORIZONTAL : SDL_FLIP_NONE);
```

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±èƒ½æ­£ç¡®å¤„ç† Tiled ä¸­â€œæ°´å¹³ç¿»è½¬â€çš„ tile/object äº†ã€‚

## âœ… æœ¬èŠ‚å°ç»“

- ä» `.tmj` è¯»å– `backgroundcolor`ï¼Œé€šè¿‡ `parseHexColor` è½¬æˆæµ®ç‚¹é¢œè‰²å¹¶è®¾ç½®æ¸…å±è‰²
- å¼•å…¥ `RenderComponent{layer, depth}`ï¼Œç”¨â€œæ•°æ®â€è¡¨è¾¾æ¸²æŸ“é¡ºåºï¼›`RenderSystem` æ¸²æŸ“å‰å…ˆæŒ‰å®ƒæ’åº
- æ–°å¢ `YSortSystem`ï¼šæ¯å¸§ç”¨ Transform çš„ y æ›´æ–° depthï¼Œä¿è¯åŒå±‚ y-orderï¼ˆä¸‹æ–¹åç»˜åˆ¶ï¼‰
- è§£æ gid é«˜ä½ flagï¼šå…ˆæ”¯æŒæ°´å¹³ç¿»è½¬ï¼ˆ`0x80000000`ï¼‰ï¼Œå¹¶ç”¨æ©ç è¿˜åŸçœŸå® gidï¼ˆ`0x1FFFFFFF`ï¼‰

## ğŸ” è‡ªæ£€æ¸…å•

- [ ] åœ°å›¾èƒŒæ™¯è‰²å’Œ Tiled ä¸­ä¸€è‡´ï¼ˆæ¥è‡ª `.tmj` çš„ `backgroundcolor`ï¼‰
- [ ] åŒä¸€å›¾å±‚é‡Œï¼Œy è¶Šå¤§çš„å¯¹è±¡è¶Šé å‰ï¼ˆä¸ä¼šå‡ºç°â€œæ ‘å¹²å‹ä½äººç‰©è„šâ€çš„åç›´è§‰é®æŒ¡ï¼‰
- [ ] `.tmj` ä¸­å¸¦ `2147484xxx` çš„ gid ä¸å†å¯¼è‡´è§£æå¤±è´¥ï¼Œå¹¶èƒ½çœ‹åˆ°æ­£ç¡®çš„æ°´å¹³ç¿»è½¬æ•ˆæœ
- [ ] è‡ªå®šä¹‰å›¾å±‚å±æ€§ `order` èƒ½æ”¹å˜æ¸²æŸ“å±‚çº§ï¼ˆä¾‹å¦‚æŠŠæŸä¸ªå¯¹è±¡å±‚å¼ºåˆ¶ç”»åœ¨æœ€ä¸Šï¼‰

## â¡ï¸ ä¸‹ä¸€èŠ‚é¢„å‘Š

ä¸‹ä¸€èŠ‚ï¼ˆç¬¬ 14 èŠ‚ï¼šè®¾å®šç§»åŠ¨è·¯å¾„ï¼‰å¼€å§‹è¿›å…¥æ ¸å¿ƒç©æ³•ï¼šæˆ‘ä»¬ä¼šä¸ºæ•Œäººå»ºç«‹â€œè·¯å¾„èŠ‚ç‚¹â€çš„æ•°æ®ç»“æ„ï¼Œå¹¶è®©æ•Œäººæ²¿ç€è·¯å¾„ç§»åŠ¨ã€‚