# 08 äº‹ä»¶æ€»çº¿ä¸åœºæ™¯åˆ‡æ¢

<div class="video-container">
  <div id="bilibili" class="video-content">
    <!-- Bç«™åµŒå…¥ï¼šä½¿ç”¨ https æ˜ç¡®åè®®ï¼ˆé¿å… file:// æˆ– http å¯¼è‡´è¢«æµè§ˆå™¨æ‹¦æˆªï¼‰ -->
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV1xGyCBgENW&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

[åœ¨ Bilibili ä¸Šè§‚çœ‹](https://www.bilibili.com/video/BV1xGyCBgENW)

## ğŸ“– æ¦‚è¿°

ç¬¬ 07 èŠ‚æˆ‘ä»¬å·²ç»æŠŠè¾“å…¥åšæˆäº†â€œä¿¡å·é©±åŠ¨â€ï¼š`InputManager` è´Ÿè´£æ£€æµ‹è¾“å…¥å˜åŒ–ï¼Œå¹¶é€šè¿‡ `entt::sigh/sink` é€šçŸ¥å¤–éƒ¨å›è°ƒã€‚

ä½†å¦‚æœä½ ç»§ç»­æŠŠè¿™äº›è¾“å…¥å›è°ƒ**ç›´æ¥å†™åœ¨ Scene é‡Œ**ï¼Œå¾ˆå¿«ä¼šé‡åˆ°ä¸€ä¸ªè€é—®é¢˜ï¼š**åœºæ™¯å’Œåœºæ™¯ç®¡ç†å™¨è€¦åˆ**ã€‚

- ä½ æƒ³â€œåˆ‡æ¢åœºæ™¯â€ï¼Œå°±å¿…é¡»æ‹¿åˆ° `SceneManager` çš„å¼•ç”¨/æŒ‡é’ˆ
- Scene çš„æ„é€ å‡½æ•°è¢«è¿«æºå¸¦ `SceneManager&`
- æœªæ¥å¦‚æœ UIã€ç³»ç»Ÿã€ç”šè‡³ç½‘ç»œé€»è¾‘ä¹Ÿæƒ³è§¦å‘åˆ‡åœºæ™¯ï¼Œä½ ä¼šå‘ç°â€œåˆ°å¤„éƒ½åœ¨ä¼  SceneManagerâ€

è¿™ä¸€èŠ‚æˆ‘ä»¬å¼•å…¥â€œäº‹ä»¶æ€»çº¿â€æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼šæŠŠâ€œæƒ³åšä»€ä¹ˆï¼ˆäº‹ä»¶ï¼‰â€ä¸â€œè°æ¥åšï¼ˆè®¢é˜…è€…ï¼‰â€åˆ†ç¦»ã€‚

åšæ³•æ˜¯ï¼šåœ¨å¼•æ“æ ¸å¿ƒé‡Œæ–°å¢ `entt::dispatcher`ï¼ŒæŠŠå®ƒæ”¾è¿› `Context`ï¼Œè®©ä»»ä½•æŒæœ‰ `Context` çš„æ¨¡å—éƒ½èƒ½å‘é€äº‹ä»¶ï¼›è€Œ `SceneManager` åªéœ€è¦è®¢é˜…â€œåˆ‡æ¢åœºæ™¯äº‹ä»¶â€ï¼Œåœ¨åˆé€‚çš„æ—¶æœºç»Ÿä¸€æ‰§è¡Œå³å¯ã€‚

![](../æœ¬æœŸå‚è€ƒ/PPTæˆªå›¾/æ€ªç‰©æˆ˜äº‰.043.png)

> PPT ç¬¬ 43 é¡µï¼šInputManagerï¼ˆå³æ—¶è§¦å‘ä¿¡å·ï¼‰ + GameAppï¼ˆäº‹ä»¶æ€»çº¿ï¼Œå¯å»¶æ—¶è§¦å‘ï¼‰ç»„åˆå‡ºæ›´å®Œæ•´çš„äº‹ä»¶ç³»ç»Ÿ

æœ¬èŠ‚å¯¹åº”ä»£ç æ ‡ç­¾ï¼š`08-äº‹ä»¶æ€»çº¿ä¸åœºæ™¯åˆ‡æ¢`ï¼ˆåŸºçº¿ï¼š`07-è¾“å…¥æ¨¡å—çš„ä¿¡å·åŠŸèƒ½`ï¼‰ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- ç†è§£ `entt::dispatcher` çš„è§’è‰²ï¼š**äº‹ä»¶ä¸­å¿ƒ** + **äº‹ä»¶é˜Ÿåˆ—ï¼ˆenqueue + updateï¼‰**
- è®¾è®¡â€œåˆ‡åœºæ™¯äº‹ä»¶â€çš„æ•°æ®ç»“æ„ï¼Œå¹¶ç”¨ `unique_ptr` ä¼ é€’æ‰€æœ‰æƒ
- æŠŠ dispatcher æ³¨å…¥åˆ° `Context`ï¼Œå½¢æˆâ€œå…¨å±€å¯ç”¨ä½†ä¸å†™å•ä¾‹â€çš„äº‹ä»¶æ€»çº¿
- è®© Scene é€šè¿‡â€œå‘äº‹ä»¶â€è¯·æ±‚åˆ‡æ¢ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¾èµ– `SceneManager`
- è®© `SceneManager` é€šè¿‡è®¢é˜…äº‹ä»¶æ¥åš `Push/Pop/Replace`ï¼Œå¹¶ä¿æŒâ€œå»¶è¿Ÿæ‰§è¡Œâ€ä¿è¯å®‰å…¨

## ğŸ§  æ€è·¯ä¸è®¾è®¡

### 1) `sigh` vs `dispatcher`ï¼šä¸ºä»€ä¹ˆä¸¤è€…éƒ½éœ€è¦ï¼Ÿ

`entt::sigh` æ›´åƒâ€œä¿¡å·æ§½â€ï¼šç®€å•ã€ç›´æ¥ï¼Œé€‚åˆè¾“å…¥è¿™ç§**å³æ—¶**å›è°ƒã€‚

`entt::dispatcher` æ›´åƒâ€œäº‹ä»¶æ€»çº¿â€ï¼š

- ä¸º**æ¯ä¸€ç§äº‹ä»¶ç±»å‹**ç®¡ç†ä¸€ä¸ªç‹¬ç«‹çš„ä¿¡å·ï¼ˆ`sink<Event>()`ï¼‰
- æ”¯æŒäº‹ä»¶é˜Ÿåˆ—ï¼š`enqueue<Event>()` å…¥é˜Ÿï¼Œ`dispatcher.update()` ç»Ÿä¸€å‡ºé˜Ÿè§¦å‘

è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥é€‰æ‹©ï¼š

- **ç«‹å³è§¦å‘**ï¼ˆ`trigger`ï¼‰ï¼šäº‹ä»¶é©¬ä¸Šè¢«å¤„ç†ï¼ˆé€‚åˆåªæ”¹ä¸€ä¸ªâ€œæŒ‚èµ·æ ‡è®°â€ï¼‰
- **å»¶æ—¶è§¦å‘**ï¼ˆ`enqueue + update`ï¼‰ï¼šæŠŠäº‹ä»¶æ”¾åˆ°â€œæœ¬å¸§æœ«å°¾â€æˆ–â€œä¸‹ä¸€å¸§â€å†å¤„ç†ï¼ˆé€‚åˆéœ€è¦ç¨³å®šæ—¶åºçš„æ“ä½œï¼‰

![](../æœ¬æœŸå‚è€ƒ/PPTæˆªå›¾/æ€ªç‰©æˆ˜äº‰.042.png)

> PPT ç¬¬ 42 é¡µï¼šdispatcher çš„â€œäº‹ä»¶ç±»å‹ â†’ ä¿¡å·â€æ˜ å°„ + â€œäº‹ä»¶é˜Ÿåˆ—â€

### 2) ç”¨äº‹ä»¶æ€»çº¿è§£è€¦ Scene ä¸ SceneManager

æ ¸å¿ƒæ€è·¯å¾ˆç®€å•ï¼š

- Scene ä¸å†æŒæœ‰ `SceneManager&`
- Scene éœ€è¦åˆ‡åœºæ™¯æ—¶ï¼Œåªåšä¸€ä»¶äº‹ï¼š**å‘é€äº‹ä»¶**
- SceneManager è®¢é˜…äº‹ä»¶ï¼Œå¹¶æŠŠâ€œçœŸæ­£çš„åˆ‡æ¢åŠ¨ä½œâ€æ”¾åˆ° `update()` æœ«å°¾æ‰§è¡Œï¼ˆé¿å…åœ¨æ›´æ–°è¿‡ç¨‹ä¸­ä¿®æ”¹ scene stackï¼‰

![](../æœ¬æœŸå‚è€ƒ/PPTæˆªå›¾/æ€ªç‰©æˆ˜äº‰.044.png)

> PPT ç¬¬ 44 é¡µï¼šé€šè¿‡â€œå‘é€ä¿¡å·â€è¯·æ±‚åˆ‡æ¢åœºæ™¯ï¼Œè®© Scene ä¸å¿…ä¾èµ– SceneManager

## ğŸ”§ å®ç°æ­¥éª¤

### 1) å®šä¹‰äº‹ä»¶ç±»å‹ï¼šæŠŠâ€œæ„å›¾â€åšæˆç»“æ„ä½“

æœ¬èŠ‚æ–°å¢äº† `src/engine/utils/events.h`ï¼Œå®šä¹‰äº† 4 ç±»äº‹ä»¶ï¼š

```cpp
// src/engine/utils/events.h
struct QuitEvent {};
struct PopSceneEvent {};
struct PushSceneEvent { std::unique_ptr<engine::scene::Scene> scene; };
struct ReplaceSceneEvent { std::unique_ptr<engine::scene::Scene> scene; };
```

è¿™é‡Œç”¨ `std::unique_ptr` çš„ç†ç”±æ˜¯ï¼šåœºæ™¯å¯¹è±¡çš„æ‰€æœ‰æƒåº”è¯¥éšç€äº‹ä»¶ä¸€èµ·â€œç§»åŠ¨â€ç»™ SceneManagerï¼Œè€Œä¸æ˜¯å¤åˆ¶æˆ–å…±äº«ã€‚

> å°æç¤ºï¼šå› ä¸ºè¦ `std::move` æ‰ `unique_ptr`ï¼Œå¤„ç†å‡½æ•°çš„å‚æ•°ä¸€èˆ¬è¦ç”¨éå¸¸é‡å¼•ç”¨ `Event&`ï¼ˆè€Œä¸æ˜¯ `const Event&`ï¼‰ã€‚

### 2) åœ¨ GameApp åˆå§‹åŒ– dispatcherï¼Œå¹¶æ”¾è¿› Context

äº‹ä»¶æ€»çº¿åº”è¯¥æ˜¯â€œå¼•æ“æ ¸å¿ƒèƒ½åŠ›â€ï¼Œå› æ­¤ç”± `GameApp` åˆ›å»ºã€æ§åˆ¶ç”Ÿå‘½å‘¨æœŸï¼š

- `GameApp` å¢åŠ  `std::unique_ptr<entt::dispatcher> dispatcher_`
- `init()` é‡Œå…ˆ `initDispatcher()`ï¼Œå† `initContext()`
- `Context` å¢åŠ  `entt::dispatcher& dispatcher_` ä¸ `getDispatcher()`

å¹¶ä¸”åœ¨ä¸»å¾ªç¯é‡Œï¼Œ`GameApp::update()` ä¼šåœ¨åœºæ™¯æ›´æ–°åè°ƒç”¨ï¼š

```cpp
// src/engine/core/game_app.cpp
void GameApp::update(float delta_time) {
    scene_manager_->update(delta_time);
    dispatcher_->update();   // åˆ†å‘ enqueue() è¿›é˜Ÿåˆ—çš„äº‹ä»¶
}
```

æ­¤å¤–ï¼ŒGameApp è‡ªå·±ä¹Ÿè®¢é˜…ä¸€ä¸ª `QuitEvent`ï¼Œç”¨äºç»Ÿä¸€é€€å‡ºï¼š

- `dispatcher_->sink<utils::QuitEvent>().connect<&GameApp::onQuitEvent>(this);`

### 3) Scene å‘äº‹ä»¶ï¼šæä¾›â€œè¯·æ±‚åˆ‡æ¢åœºæ™¯â€çš„ç»Ÿä¸€æ¥å£

æœ¬èŠ‚æŠŠ Scene çš„æ„é€ å‡½æ•°æ”¹ä¸ºåªä¾èµ– `Context`ï¼š

- ä»¥å‰ï¼š`Scene(name, context, scene_manager)`
- ç°åœ¨ï¼š`Scene(name, context)`

å¹¶åœ¨ `Scene` åŸºç±»é‡Œæ–°å¢ 4 ä¸ªâ€œè¯·æ±‚æ¥å£â€ï¼š

- `requestPopScene()`
- `requestPushScene(std::unique_ptr<Scene>&&)`
- `requestReplaceScene(std::unique_ptr<Scene>&&)`
- `quit()`

å®ç°ä¸Šå®ƒä»¬éƒ½å¾ˆè–„â€”â€”å°±æ˜¯æŠŠäº‹ä»¶ä¸¢è¿› dispatcherï¼š

```cpp
// src/engine/scene/scene.cpp
void Scene::requestPopScene() {
    context_.getDispatcher().trigger<engine::utils::PopSceneEvent>();
}
```

> è¿™é‡Œç”¨çš„æ˜¯ `trigger()`ï¼šç«‹å³è°ƒç”¨è®¢é˜…è€…ã€‚å› ä¸ºè®¢é˜…è€…åªä¼šè®¾ç½®â€œæŒ‚èµ·åŠ¨ä½œâ€ï¼Œä¸ä¼šç«‹åˆ»æ”¹ scene stackï¼Œæ‰€ä»¥æ˜¯å®‰å…¨çš„ã€‚

### 4) SceneManager è®¢é˜…äº‹ä»¶ï¼Œå¹¶åœ¨ update æœ«å°¾ç»Ÿä¸€æ‰§è¡Œ

`SceneManager` åœ¨æ„é€ æ—¶æ³¨å†Œäº‹ä»¶å›è°ƒï¼š

- `PopSceneEvent` â†’ `onPopScene()`
- `PushSceneEvent` â†’ `onPushScene(event)`
- `ReplaceSceneEvent` â†’ `onReplaceScene(event)`

è¿™äº›å›è°ƒä¸åšå®é™…åˆ‡æ¢ï¼Œåªè®¾ç½® `pending_action_` å’Œ `pending_scene_`ï¼š

```cpp
// src/engine/scene/scene_manager.cpp
void SceneManager::onPushScene(engine::utils::PushSceneEvent& event) {
    pending_action_ = PendingAction::Push;
    pending_scene_ = std::move(event.scene);
}
```

çœŸæ­£çš„åˆ‡æ¢å‘ç”Ÿåœ¨ `update()` çš„æœ«å°¾ï¼š`processPendingActions()`ã€‚

å¦å¤–è¿˜æœ‰ä¸€ä¸ªå¾ˆå®ç”¨çš„å°ç»†èŠ‚ï¼šå¦‚æœå¼¹å‡ºäº†æœ€åä¸€ä¸ªåœºæ™¯ï¼Œå°±è‡ªåŠ¨é€€å‡ºæ¸¸æˆï¼š

```cpp
// src/engine/scene/scene_manager.cpp
if (scene_stack_.empty()) {
    context_.getDispatcher().enqueue<engine::utils::QuitEvent>();
}
```

è¿™é‡Œé€‰æ‹© `enqueue()` çš„åŸå› æ˜¯ï¼šæˆ‘ä»¬æ­£åœ¨æ‰§è¡Œ `popScene()`ï¼ˆå±äº SceneManager æ›´æ–°æµç¨‹ï¼‰ï¼Œæ›´ç¨³å¦¥çš„æ–¹å¼æ˜¯æŠŠâ€œé€€å‡ºâ€å»¶è¿Ÿåˆ°æœ¬å¸§æœ«å°¾ç”± `dispatcher_->update()` ç»Ÿä¸€å¤„ç†ã€‚

### 5) ç”¨ GameScene åšä¸€ä¸ªâ€œäº‹ä»¶é©±åŠ¨åˆ‡åœºæ™¯â€çš„æœ€å°æ¼”ç¤º

ä¸ºäº†éªŒè¯æ•´å¥—é“¾è·¯ï¼Œæœ¬èŠ‚æŠŠ `GameScene` å˜æˆä¸€ä¸ªâ€œåœºæ™¯åˆ‡æ¢æµ‹è¯•å™¨â€ï¼š

- `J`ï¼šReplaceï¼ˆæ›¿æ¢å½“å‰åœºæ™¯ï¼‰
- é¼ æ ‡å·¦é”®ï¼šPushï¼ˆå‹æ ˆï¼‰
- é¼ æ ‡å³é”®ï¼šPopï¼ˆå‡ºæ ˆï¼‰
- `P`ï¼šQuitï¼ˆé€€å‡ºæ¸¸æˆï¼‰

å¯¹åº”å®ç°æ˜¯ï¼šè¾“å…¥ä¿¡å· â†’ è°ƒç”¨ `requestPushScene/...` â†’ dispatcher åˆ†å‘ â†’ SceneManager æŒ‚èµ· â†’ update æœ«å°¾æ‰§è¡Œåˆ‡æ¢ã€‚

## âœ… æœ¬èŠ‚å°ç»“

- ç”¨ `entt::dispatcher` å»ºç«‹äº†å¼•æ“çº§äº‹ä»¶æ€»çº¿ï¼Œå¹¶æ”¾è¿› `Context` ä½œä¸ºâ€œå…±äº«èƒ½åŠ›â€
- Scene ä¸å†ä¾èµ– SceneManagerï¼šåˆ‡åœºæ™¯æ”¹ä¸ºâ€œå‘äº‹ä»¶â€
- SceneManager åªè´Ÿè´£è®¢é˜…äº‹ä»¶å¹¶åœ¨å®‰å…¨æ—¶æœºæ‰§è¡Œ `Push/Pop/Replace`
- `enqueue + dispatcher.update()` è®©æˆ‘ä»¬å¯ä»¥æŠŠæŸäº›æ“ä½œå»¶è¿Ÿåˆ°â€œå¸§æœ«å°¾ç»Ÿä¸€å¤„ç†â€ï¼Œæ—¶åºæ›´ç¨³å®š

## ğŸ” è‡ªæ£€æ¸…å•

- [ ] å¯åŠ¨åæŒ‰ `J`ï¼šå‡ºç° â€œåˆ‡æ¢åœºæ™¯â€ æ—¥å¿—ï¼ˆReplaceï¼‰
- [ ] é¼ æ ‡å·¦é”®ç‚¹å‡»ï¼šä¸æ–­å‹å…¥åœºæ™¯ï¼Œçœ‹åˆ°åœºæ™¯ç¼–å·é€’å¢ï¼ˆPushï¼‰
- [ ] é¼ æ ‡å³é”®ç‚¹å‡»ï¼šå¼¹å‡ºåœºæ™¯ï¼Œç›´åˆ°æœ€åä¸€ä¸ªåœºæ™¯å¼¹å‡ºåè‡ªåŠ¨é€€å‡ºï¼ˆPop + QuitEventï¼‰
- [ ] æŒ‰ `P`ï¼šæ— è®ºå½“å‰æ ˆé‡Œæœ‰å¤šå°‘åœºæ™¯éƒ½èƒ½é€€å‡ºï¼ˆQuitEventï¼‰

## â¡ï¸ ä¸‹ä¸€èŠ‚é¢„å‘Š

ä¸‹ä¸€èŠ‚ï¼ˆç¬¬ 09 èŠ‚ï¼‰ä¼šè§£å†³â€œä¿¡å·ç©¿é€â€çš„é—®é¢˜ï¼šå½“åœºæ™¯æ ˆé‡Œæœ‰å¤šä¸ªåœºæ™¯æ—¶ï¼Œè¾“å…¥ä¿¡å·å¯èƒ½ä¼šè§¦å‘**æ‰€æœ‰**åœºæ™¯çš„å›è°ƒã€‚æˆ‘ä»¬ä¼šå¼•å…¥â€œæ•è·ä¸ä¸­æ–­â€çš„æœºåˆ¶ï¼Œè®©ä¿¡å·åªä½œç”¨äºå½“å‰åœºæ™¯ï¼Œæˆ–è€…å¯ä»¥è¢«æŸä¸ªå±‚çº§æ‹¦æˆªæ‰ã€‚