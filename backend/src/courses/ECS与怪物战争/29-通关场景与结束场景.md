# 29 通关场景与结束场景

<div class="video-container">
  <div id="bilibili" class="video-content">
    <!-- B站嵌入：使用 https 明确协议（避免 file:// 或 http 导致被浏览器拦截） -->
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV1A9BVBMEvL&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

[在 Bilibili 上观看](https://www.bilibili.com/video/BV1A9BVBMEvL/)

## 📖 概述

上一节我们已经有了“标题 → 进入关卡”的入口流程；但一个完整的游戏流程还缺最后一环：**关卡打完之后怎么办**？

这一节我们会把“胜利/失败”的结果串成真正可用的场景流转：

- 胜利：延迟几秒 → 进入“通关结算场景”（显示统计、奖励点数、存档、下一关）
- 失败：进入“结束场景”（失败提示、回标题/退出）
- 如果是最后一关胜利：直接进入“结束场景”（胜利提示）

![](../本期参考/PPT截图/怪物战争.096.png)

> PPT 第 96 页：通关场景与结束场景

本节对应代码标签：`29-通关场景与结束场景`（基线：`28-标题场景`）。

## 🎯 学习目标

- 用“事件 + 场景栈”实现胜利/失败的流程切换，而不是在系统里硬跳转
- 引入 `LevelClearDelayedEvent`：让通关切场景延迟几秒（给死亡动画/音效留时间）
- 新增 `LevelClearScene`（通关结算）与 `EndScene`（结束界面），并用 DebugUI 快速做可交互的 UI
- 把奖励点数、关卡推进、存档入口与背景音乐切换完整串起来

## 🧠 思路与设计

把“关卡结束”做成稳定的流程，关键在于两点：

1) **判定在系统里，切场景在 Scene 里**  
战斗系统（`CombatResolveSystem`）和规则系统（`GameRuleSystem`）负责判断“赢/输”，但它们不直接创建场景；它们只发送事件：`LevelClearDelayedEvent / GameEndEvent`。  
真正的场景切换由 `GameScene` 统一处理（监听 `LevelClearEvent/GameEndEvent`）。

2) **用“延迟事件”减少观感与逻辑冲突**  
如果最后一只怪刚死就立刻切场景，往往会打断死亡动画、音效、特效回收等链路。  
因此我们把“通关成功”分成两步：先发 `LevelClearDelayedEvent`，由 `GameRuleSystem` 倒计时，时间到再发 `LevelClearEvent`。

## 🔧 实现步骤

## 🧾 1) 补齐关卡结束事件：延迟通关 + 游戏结束

在 `src/game/defs/events.h` 新增：

- `LevelClearDelayedEvent{delay_time}`：延迟通关（默认 3 秒）
- `GameEndEvent{is_win}`：游戏结束（胜利/失败）

```cpp
struct LevelClearDelayedEvent {
    float delay_time_{3.0f};
};
struct GameEndEvent {
    bool is_win_{false};
};
```

## ⏳ 2) GameRuleSystem：接住延迟通关，并在计时结束后真正触发 LevelClear

在 `src/game/system/game_rule_system.*`：

- 监听 `LevelClearDelayedEvent`，把 `is_level_clear_` 置为 true，并设置 `level_clear_timer_`
- 在 `update(delta_time)` 中倒计时，归零后 `enqueue(LevelClearEvent)`，并重置标志避免重复触发
- 在 `onEnemyArriveHome()` 里补齐输赢逻辑：
  - 基地血量归零：`enqueue(GameEndEvent{false})`
  - 敌人“击杀 + 到家”总数达到总数：`enqueue(LevelClearDelayedEvent{})`

这使得“最后一个敌人到家/死亡”这类边界情况也能走同一条通关链路。

## 🧨 3) CombatResolveSystem：最后一只敌人死亡 → 延迟通关

在 `src/game/system/combat_resolve_system.cpp`，敌人死亡时递增 `enemy_killed_count_`，如果：

```
enemy_killed_count_ + enemy_arrived_count_ >= enemy_count_
```

就 `enqueue(LevelClearDelayedEvent{})`，让“通关”从战斗系统自然触发，但切场景仍然由 `GameScene` 统一负责。

## 🧭 4) GameScene：监听结果事件，push 结算/结束场景

在 `src/game/scene/game_scene.*`：

- `init()` 开始播放战斗 BGM：`context_.getAudioPlayer().playMusic("battle_bgm"_hs);`
- 监听 `LevelClearEvent` 与 `GameEndEvent`
- 通关处理（`onLevelClear()`）：
  - 奖励点数公式：`击杀数 + 基地血量 * 5`
  - 设置 `session_data_->setLevelClear(true)` 并 `addPoint(point)`
  - 如果是最后一关：`requestPushScene(EndScene(win=true))`
  - 否则：`requestPushScene(LevelClearScene(..., game_stats_))`
- 失败处理（`onGameEndEvent()`）：`requestPushScene(EndScene(is_win_))`

同时，为避免“场景栈上层有 UI 时 ImGui 冲突”，`GameScene::render()` 只在 `Playing/Paused` 时渲染 `debug_ui_system_`（上层有结算/结束场景时交由它们渲染自己的 UI）。

## 🏁 5) 新增 LevelClearScene：结算表格 + 下一关/保存/回标题

本节新增文件：

- `src/game/scene/level_clear_scene.h`
- `src/game/scene/level_clear_scene.cpp`

它的定位是“通关后的暂停层”：

- `init()` 把 `GameState` 设置为 `LevelClear`，并播放 `win` 音乐
- 通过 `registry_.ctx()` 注入 `SessionData/BlueprintManager/UIConfig`，复用上一节做好的“角色表格 UI”
- 在 `render()` 中调用 `debug_ui_system_->updateLevelClear(*this)`：
  - 显示“通关成功”文本
  - 显示角色表格（可排序）+ 统计信息（击杀/基地血量/奖励点数/剩余点数）
  - 提供按钮：下一关 / 保存 / 返回标题

“下一关”按钮会把 `level_number + 1` 并清除 `level_clear` 标志，然后 `replace` 回 `GameScene`。

## 🧾 6) 新增 EndScene：胜/负提示 + 回标题/退出

本节新增文件：

- `src/game/scene/end_scene.h`
- `src/game/scene/end_scene.cpp`

EndScene 很轻量：

- 构造函数传入 `is_win`
- `init()` 按胜/负播放 `win/lose` 音乐，并把 `GameState` 设置为 `GameOver`
- `render()` 调用 `debug_ui_system_->updateEnd(*this)` 渲染提示与按钮

## ✅ 本节小结

- 用事件把“判定输赢”与“切换场景”解耦：系统发事件，`GameScene` 统一做流程跳转
- 引入延迟通关：`LevelClearDelayedEvent` + 计时器，避免通关切场景打断表现
- 新增两类 UI 场景：`LevelClearScene`（结算/下一关/存档）与 `EndScene`（胜负结束）
- 音乐与 UI 流程完整串联：标题/战斗/胜利/失败的 BGM 切换更像正式游戏

## 🔍 自检清单

- [ ] 敌人全部死亡或全部到家后，会延迟几秒再进入通关结算
- [ ] 基地血量为 0 时会进入失败结束场景
- [ ] 通关结算能显示击杀/基地血量/奖励点数/剩余点数，并可点击“下一关/保存/返回标题”
- [ ] 最后一关通关会直接进入胜利结束场景
- [ ] 结算/结束场景出现时，GameScene 的 DebugUI 不再渲染（无 ImGui 冲突）

## 🎉 课程完结

到这里，“怪物战争”的主线功能已经完整闭环：标题 → 关卡 → 通关/失败 → 存档/下一关/返回标题。  
如果你想继续完善，可以把 ImGui 的临时 UI 逐步替换成游戏内 UI，并补齐多存档、更多关卡与更丰富的关卡结算表现。

