# æœåŠ¡å®šä½å™¨æ¨¡å¼ (Service Locator) - å…¨å±€æœåŠ¡çš„ä¼˜é›…è®¿é—®

<div class="video-container">
  <div id="bilibili" class="video-content">
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV1pfniz3Ecq&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

**æœåŠ¡å®šä½å™¨æ¨¡å¼ (Service Locator)**æ˜¯ä¸€ä¸ªåœ¨æ¸¸æˆå¼•æ“æ¶æ„ä¸­éå¸¸å¸¸è§çš„è®¾è®¡æ¨¡å¼ï¼Œå®ƒæ—¨åœ¨è§£å†³ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•åœ¨é¡¹ç›®çš„å„ä¸ªè§’è½æ–¹ä¾¿åœ°è®¿é—®åƒéŸ³é¢‘æ’­æ”¾å™¨è¿™æ ·çš„**å…¨å±€å•ä¾‹æœåŠ¡**ï¼ŒåŒæ—¶åˆä¸å¤±çµæ´»æ€§å’Œå¯æµ‹è¯•æ€§ï¼Ÿ

æœ¬èŠ‚è¯¾æˆ‘ä»¬å°†é‡æ„éŸ³é¢‘ç³»ç»Ÿçš„è®¿é—®æ–¹å¼ï¼Œå½»åº•å‘Šåˆ«ç¹ççš„ä¾èµ–æ³¨å…¥é“¾æ¡ã€‚

## ğŸ¯ è¯¾ç¨‹ç›®æ ‡

*   **ç†è§£â€œä¾èµ–æ³¨å…¥åœ°ç‹±â€**ï¼šè®¤è¯†åˆ°é€šè¿‡æ„é€ å‡½æ•°æˆ– `Context` å¯¹è±¡å±‚å±‚ä¼ é€’å…¨å±€æœåŠ¡ï¼ˆå¦‚ `AudioPlayer`ï¼‰æ‰€å¸¦æ¥çš„ä»£ç å†—ä½™å’Œç´§è€¦åˆé—®é¢˜ã€‚
*   **æŒæ¡æœåŠ¡å®šä½å™¨æ¨¡å¼**ï¼šå­¦ä¹ å¦‚ä½•é€šè¿‡ä¸€ä¸ªé™æ€çš„ä¸­å¿ƒæ³¨å†Œç‚¹ï¼ˆ`AudioLocator`ï¼‰æ¥æä¾›å¯¹æœåŠ¡çš„å…¨å±€è®¿é—®ã€‚
*   **è§£è€¦å…·ä½“å®ç°**ï¼šé€šè¿‡å¼•å…¥æœåŠ¡æ¥å£ (`IAudioPlayer`)ï¼Œè®©å®¢æˆ·ç«¯ä»£ç ä¾èµ–äºæŠ½è±¡è€Œä¸æ˜¯å…·ä½“å®ç°ï¼Œä»è€Œå¯ä»¥è½»æ¾æ›¿æ¢æˆ–ç¦ç”¨æœåŠ¡ï¼ˆå¦‚é™éŸ³æ¨¡å¼ï¼‰ã€‚
*   **å®è·µä¸é‡æ„**ï¼š
    *   åˆ›å»ºä¸€ä¸ª `IAudioPlayer` æ¥å£å’Œä¸€ä¸ªä»€ä¹ˆéƒ½ä¸åšçš„ `NullAudioPlayer` å®ç°ã€‚
    *   åˆ›å»ºä¸€ä¸ªé™æ€çš„ `AudioLocator` ç±»æ¥æä¾›å¯¹ `IAudioPlayer` æœåŠ¡çš„è®¿é—®ã€‚
    *   åœ¨ `GameApp` ä¸­â€œæ³¨å†Œâ€çœŸæ­£çš„ `AudioPlayer` æœåŠ¡ã€‚
    *   é‡æ„æ‰€æœ‰éœ€è¦æ’­æ”¾éŸ³é¢‘çš„ä»£ç ï¼Œè®©å®ƒä»¬é€šè¿‡ `AudioLocator::get()` æ¥è®¿é—®éŸ³é¢‘æœåŠ¡ã€‚

## ğŸ¤” å½“å‰ä»£ç çš„é—®é¢˜åœ¨å“ªé‡Œï¼Ÿ

ç›®å‰ï¼Œå¦‚æœä¸€ä¸ªç»„ä»¶ï¼ˆæ¯”å¦‚ `AudioComponent` æˆ– `UIInteractive`ï¼‰æƒ³è¦æ’­æ”¾å£°éŸ³ï¼Œå®ƒå¿…é¡»ä»¥æŸç§æ–¹å¼è·å¾— `AudioPlayer` çš„å®ä¾‹ã€‚æˆ‘ä»¬ä¹‹å‰çš„åšæ³•æ˜¯é€šè¿‡ `Context` å¯¹è±¡è¿›è¡Œä¼ é€’ï¼š

`GameApp` -> `Context` -> `Scene` -> `UIInteractive` -> `playSound()`

è¿™ä¸ªä¾èµ–é“¾æ¡éå¸¸é•¿ï¼š
1.  `GameApp` åˆ›å»º `AudioPlayer` å®ä¾‹ã€‚
2.  `GameApp` å°† `AudioPlayer` çš„å¼•ç”¨æ³¨å…¥ `Context`ã€‚
3.  `Scene` æŒæœ‰ `Context` çš„å¼•ç”¨ã€‚
4.  `UIInteractive` åœ¨æ„é€ æ—¶æ¥æ”¶ `Context` çš„å¼•ç”¨ã€‚
5.  `UIInteractive` æœ€ç»ˆé€šè¿‡ `context_.getAudioPlayer()` æ¥è°ƒç”¨æ’­æ”¾æ–¹æ³•ã€‚

è¿™ç§**ä¾èµ–æ³¨å…¥ (Dependency Injection)** æ–¹å¼è™½ç„¶æ˜ç¡®ï¼Œä½†åœ¨å¤„ç†åƒéŸ³é¢‘ã€æ—¥å¿—ã€è¾“å…¥è¿™æ ·çš„å…¨å±€æ€§æœåŠ¡æ—¶ï¼Œä¼šæ˜¾å¾—éå¸¸ç¬¨é‡ï¼š
*   **å†—é•¿çš„å‚æ•°åˆ—è¡¨**ï¼šå‡ ä¹æ¯ä¸ªæ ¸å¿ƒç±»çš„æ„é€ å‡½æ•°éƒ½éœ€è¦æ¥æ”¶ä¸€ä¸ª `Context&`ï¼Œå³ä½¿å®ƒè‡ªå·±å¯èƒ½ç”¨ä¸ä¸Šï¼Œåªæ˜¯ä¸ºäº†æŠŠå®ƒä¼ é€’ç»™å­å¯¹è±¡ã€‚
*   **ç´§è€¦åˆ**ï¼šæ‰€æœ‰ä¸­é—´ç¯èŠ‚ï¼ˆ`Context`, `Scene` ç­‰ï¼‰éƒ½ä¸ `AudioPlayer` è¿™ä¸ªå…·ä½“ç±»äº§ç”Ÿäº†è€¦åˆã€‚å¦‚æœæˆ‘ä»¬æƒ³æ›´æ¢éŸ³é¢‘å¼•æ“ï¼Œæˆ–è€…åœ¨æµ‹è¯•æ—¶ç¦ç”¨éŸ³é¢‘ï¼Œä¼šéå¸¸å›°éš¾ã€‚
*   **è®¿é—®ä¸ä¾¿**ï¼šåœ¨é¡¹ç›®çš„æŸä¸ªæ·±å±‚è§’è½ï¼Œå¦‚æœä¸€ä¸ªæ–°ç±»çªç„¶éœ€è¦æ’­æ”¾å£°éŸ³ï¼Œæˆ‘ä»¬å°±å¾—ä¸€è·¯ä» `GameApp` å¼€å§‹ï¼ŒæŠŠ `Context` æˆ– `AudioPlayer` çš„å¼•ç”¨å±‚å±‚â€œé’»â€ä¸‹å»ï¼Œè¿™éå¸¸ç—›è‹¦ã€‚

<img src="https://theorhythm.top/gamedev/opt/OPT.035.webp" alt="æœåŠ¡å®šä½å™¨" style="display: block; margin: auto; width: 800px;" />

## ğŸ“– ç¬¬ä¸€æ­¥ï¼šå®šä¹‰æœåŠ¡æ¥å£ `IAudioPlayer`

è¦è§£è€¦å®¢æˆ·ç«¯ä¸å…·ä½“å®ç°ï¼Œç¬¬ä¸€æ­¥æ€»æ˜¯å¼•å…¥ä¸€ä¸ª**æŠ½è±¡æ¥å£**ã€‚æˆ‘ä»¬å°† `AudioPlayer` çš„æ‰€æœ‰å…¬å…±æ–¹æ³•æå–åˆ°ä¸€ä¸ªçº¯è™šåŸºç±» `IAudioPlayer` ä¸­ã€‚

**`src/engine/audio/iaudio_player.h` (æ–°å»º)**
```cpp
#pragma once
#include <string_view>

namespace engine::audio {

class IAudioPlayer {
public:
    virtual ~IAudioPlayer() = default;
    virtual int playSound(std::string_view sound_path, int channel = -1) = 0;
    virtual bool playMusic(std::string_view music_path, int loops = -1, int fade_in_ms = 0) = 0;
    // ... å…¶ä»–æ‰€æœ‰éŸ³é¢‘æ–¹æ³•çš„çº¯è™šå£°æ˜ ...
};
```
æ¥ç€ï¼Œè®©æˆ‘ä»¬çš„ `AudioPlayer` å®ç°è¿™ä¸ªæ¥å£ã€‚

**`src/engine/audio/audio_player.h` (ä¿®æ”¹)**
```cpp
#pragma once
#include "iaudio_player.h"
// ...
class AudioPlayer final : public IAudioPlayer {
public:
    // ...
    int playSound(std::string_view sound_path, int channel = -1) override;
    bool playMusic(std::string_view music_path, int loops = -1, int fade_in_ms = 0) override;
    // ... æ ‡è®°æ‰€æœ‰æ–¹æ³•ä¸º override
};
```

## ğŸ“– ç¬¬äºŒæ­¥ï¼šå¼•å…¥ç©ºå¯¹è±¡æ¨¡å¼ (Null Object Pattern)

æœåŠ¡å®šä½å™¨æ¨¡å¼çš„ä¸€ä¸ªæœ€ä½³å®è·µæ˜¯ï¼š**æ°¸è¿œä¸è¦è¿”å› `nullptr`**ã€‚å¦‚æœå®¢æˆ·ç«¯æ¯æ¬¡è°ƒç”¨ `AudioLocator::get()` åéƒ½éœ€è¦æ£€æŸ¥æŒ‡é’ˆæ˜¯å¦ä¸ºç©ºï¼Œé‚£å°†éå¸¸ç¹çä¸”å®¹æ˜“å‡ºé”™ã€‚

è§£å†³æ–¹æ¡ˆæ˜¯æä¾›ä¸€ä¸ªâ€œ**ç©ºæœåŠ¡**â€ã€‚è¿™æ˜¯ä¸€ä¸ªå®ç°äº†æœåŠ¡æ¥å£ä½†æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯ç©ºæ“ä½œçš„ç±»ã€‚å½“æ²¡æœ‰å®é™…æœåŠ¡è¢«æ³¨å†Œæ—¶ï¼Œå®šä½å™¨å°±è¿”å›è¿™ä¸ªç©ºæœåŠ¡ã€‚

**`src/engine/audio/iaudio_player.h` (ä¿®æ”¹)**
```cpp
// ... (IAudioPlayer æ¥å£å®šä¹‰ä¹‹å) ...

/**
 * @brief ç©ºéŸ³é¢‘æ’­æ”¾å™¨ï¼Œä»€ä¹ˆéƒ½ä¸åš
 */
class NullAudioPlayer final : public IAudioPlayer {
public:
    int playSound(std::string_view, int) override { return -1; }
    bool playMusic(std::string_view, int, int) override { return false; }
    void stopMusic(int) override {}
    // ... æ‰€æœ‰æ–¹æ³•çš„ç©ºå®ç° ...
};
```
æœ‰äº† `NullAudioPlayer`ï¼Œå®¢æˆ·ç«¯ä»£ç å°±å¯ä»¥æ— å¿§æ— è™‘åœ°è°ƒç”¨ `AudioLocator::get().playSound(...)`ï¼Œå³ä½¿éŸ³é¢‘ç³»ç»Ÿæ²¡æœ‰åˆå§‹åŒ–ï¼Œç¨‹åºä¹Ÿä¸ä¼šå´©æºƒï¼Œåªæ˜¯ä¸ä¼šæœ‰ä»»ä½•å£°éŸ³æ’­æ”¾è€Œå·²ã€‚

## ğŸ“– ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºæœåŠ¡å®šä½å™¨ `AudioLocator`

`AudioLocator` æ˜¯æ•´ä¸ªæ¨¡å¼çš„æ ¸å¿ƒã€‚å®ƒæ˜¯ä¸€ä¸ª**çº¯é™æ€ç±»**ï¼Œä¸èƒ½è¢«å®ä¾‹åŒ–ã€‚å®ƒæä¾›ä¸¤ä¸ªæ ¸å¿ƒé™æ€æ–¹æ³•ï¼š
*   `provide()`ï¼šç”¨äºåœ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œæ³¨å†Œä¸€ä¸ªå…·ä½“çš„æœåŠ¡å®ä¾‹ã€‚
*   `get()`ï¼šç”¨äºåœ¨ç¨‹åºçš„ä»»ä½•åœ°æ–¹ï¼Œè·å–å½“å‰æ³¨å†Œçš„æœåŠ¡å®ä¾‹ã€‚

**`src/engine/audio/audio_locator.h` (æ–°å»º)**
```cpp
#pragma once
#include "iaudio_player.h"

namespace engine::audio {

class AudioLocator final {
private:
    static IAudioPlayer* service_;      // æŒ‡å‘å½“å‰æœåŠ¡çš„æŒ‡é’ˆ
    static NullAudioPlayer null_service_; // å¤‡ç”¨çš„ç©ºæœåŠ¡å®ä¾‹

public:
    AudioLocator() = delete; // ç¦æ­¢å®ä¾‹åŒ–

    // è·å–å½“å‰æœåŠ¡
    static IAudioPlayer& get() { return *service_; }

    // æ³¨å†Œä¸€ä¸ªæœåŠ¡
    static void provide(IAudioPlayer* service) {
        if (service == nullptr) {
            service_ = &null_service_; // å¦‚æœä¼ å…¥ç©ºï¼Œåˆ™ä½¿ç”¨ç©ºæœåŠ¡
        } else {
            service_ = service;
        }
    }
};

} // namespace engine::audio
```
**`src/engine/audio/audio_locator.cpp` (æ–°å»º)**
```cpp
#include "audio_locator.h"

namespace engine::audio {
// åˆå§‹åŒ–é™æ€æˆå‘˜
NullAudioPlayer AudioLocator::null_service_;
IAudioPlayer* AudioLocator::service_ = &AudioLocator::null_service_;
}
```
æ³¨æ„ï¼Œ`service_` é»˜è®¤å°±æŒ‡å‘ `null_service_`ã€‚è¿™æ„å‘³ç€å³ä½¿æˆ‘ä»¬å¿˜è®°è°ƒç”¨ `provide()`ï¼Œ`get()` æ–¹æ³•ä¹Ÿæ€»æ˜¯èƒ½å®‰å…¨åœ°è¿”å›ä¸€ä¸ªå¯ç”¨çš„ï¼ˆå°½ç®¡æ˜¯æ— æ“ä½œçš„ï¼‰æœåŠ¡ã€‚

## ğŸ“– ç¬¬å››æ­¥ï¼šæ³¨å†ŒæœåŠ¡å¹¶é‡æ„å®¢æˆ·ç«¯ä»£ç 

### 1. åœ¨ `GameApp` ä¸­æ³¨å†ŒæœåŠ¡

`GameApp` æ˜¯åˆ›å»º `AudioPlayer` å®ä¾‹çš„åœ°æ–¹ï¼Œå› æ­¤å®ƒä¹Ÿæ˜¯è°ƒç”¨ `provide()` æ¥æ³¨å†ŒæœåŠ¡çš„æœ€ä½³ä½ç½®ã€‚

**`src/engine/core/game_app.cpp` (ä¿®æ”¹)**
```cpp
#include "../audio/audio_locator.h"
// ...
bool GameApp::initAudioPlayer()
{
    try {
        audio_player_ = std::make_unique<engine::audio::AudioPlayer>(...);
        // ...
        // å°†åˆ›å»ºå¥½çš„ AudioPlayer å®ä¾‹æ³¨å†Œåˆ°å®šä½å™¨ä¸­ï¼
        engine::audio::AudioLocator::provide(audio_player_.get());
    } catch (...) {
        // ...
    }
    return true;
}

void GameApp::close() {
    // ...
    // åœ¨ç¨‹åºå…³é—­æ—¶ï¼Œæ³¨é”€æœåŠ¡ï¼ˆé€šè¿‡æä¾› nullptrï¼‰
    engine::audio::AudioLocator::provide(nullptr);
    // ...
}
```
åŒæ—¶ï¼Œå› ä¸º `AudioPlayer` ä¸å†éœ€è¦é€šè¿‡ `Context` ä¼ é€’ï¼Œæˆ‘ä»¬å¯ä»¥ä» `Context` çš„æ„é€ å‡½æ•°å’Œæˆå‘˜ä¸­ç§»é™¤å®ƒã€‚

**`src/engine/core/context.h` (ä¿®æ”¹)**
```cpp
// ...
// ç§»é™¤ #include "../audio/audio_player.h"
// ç§»é™¤ private æˆå‘˜ audio_player_
// ä»æ„é€ å‡½æ•°å‚æ•°ä¸­ç§»é™¤ audio_player
// ç§»é™¤ getAudioPlayer() æ–¹æ³•
// ...
```

### 2. é‡æ„æ‰€æœ‰å®¢æˆ·ç«¯ä»£ç 

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹æ¸…ç†é‚£äº›å†—é•¿çš„ä¾èµ–é“¾äº†ã€‚æ‰€æœ‰éœ€è¦æ’­æ”¾éŸ³é¢‘çš„åœ°æ–¹ï¼Œç°åœ¨éƒ½å¯ä»¥ç›´æ¥é€šè¿‡ `AudioLocator` è®¿é—®æœåŠ¡ã€‚

**`src/engine/ui/ui_interactive.cpp` (ä¿®æ”¹)**
```cpp
#include "../audio/audio_locator.h" // åŒ…å«å¤´æ–‡ä»¶

// ...

void UIInteractive::playSound(std::string_view name)
{
    if (sounds_.find(std::string(name)) != sounds_.end()) {
        // ç›´æ¥é€šè¿‡é™æ€æ–¹æ³•è·å–æœåŠ¡ï¼
        engine::audio::AudioLocator::get().playSound(sounds_[std::string(name)]);
    } else {
        // ...
    }
}
```

**`src/game/scene/game_scene.cpp` (ä¿®æ”¹)**
```cpp
#include "../../engine/audio/audio_locator.h"

// ...

void GameScene::init() {
    // ...
    // ç›´æ¥è°ƒç”¨
    engine::audio::AudioLocator::get().playMusic("assets/audio/hurry_up_and_run.ogg", ...);
    // ...
}
```

**`src/engine/component/audio_component.cpp` (ä¿®æ”¹)**
```cpp
#include "../audio/audio_locator.h"

// ...
// æ„é€ å‡½æ•°ä¸å†éœ€è¦æ¥æ”¶ AudioPlayer*
AudioComponent::AudioComponent(engine::render::Camera *camera) : camera_(camera) {}

void AudioComponent::playSound(...)
{
    // ...
    // ç›´æ¥è°ƒç”¨
    engine::audio::AudioLocator::get().playSound(sound_path, channel);
    // ...
}
```
ç»è¿‡è¿™ä¸€ç³»åˆ—ä¿®æ”¹ï¼Œä»£ç å˜å¾—æ— æ¯”æ¸…çˆ½ã€‚`AudioComponent`ã€`UIInteractive`ã€`GameScene` ç­‰ç±»ä¸å†éœ€è¦çŸ¥é“ `Context` æˆ– `AudioPlayer` çš„å­˜åœ¨ã€‚å®ƒä»¬åªéœ€è¦çŸ¥é“ä¸€ä¸ªå…¨å±€å¯è®¿é—®çš„ `AudioLocator` å³å¯ï¼Œ**è€¦åˆåº¦å¤§å¤§é™ä½**ã€‚

## âœ¨ æ€»ç»“

é€šè¿‡å¼•å…¥æœåŠ¡å®šä½å™¨æ¨¡å¼ï¼Œæˆ‘ä»¬å½»åº•é‡æ„äº†éŸ³é¢‘ç³»ç»Ÿçš„è®¿é—®æ–¹å¼ï¼Œå¸¦æ¥äº†è¯¸å¤šå¥½å¤„ï¼š

*   **å…¨å±€è®¿é—®**ï¼šä»»ä½•ä»£ç éƒ½å¯ä»¥é€šè¿‡ `AudioLocator::get()` è½»æ¾è®¿é—®éŸ³é¢‘æœåŠ¡ï¼Œæ— éœ€ç¹ççš„ä¾èµ–æ³¨å…¥ã€‚
*   **è§£è€¦**ï¼šå®¢æˆ·ç«¯ä»£ç ï¼ˆå¦‚ `UIInteractive`ï¼‰ä¾èµ–äº `IAudioPlayer` æ¥å£ï¼Œè€Œä¸æ˜¯ `AudioPlayer` è¿™ä¸ªå…·ä½“ç±»ã€‚è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥è½»æ¾æ›¿æ¢éŸ³é¢‘å¼•æ“çš„å®ç°ã€‚
*   **å¯æµ‹è¯•æ€§**ï¼šåœ¨å•å…ƒæµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `AudioLocator::provide(new MockAudioPlayer())` æ³¨å…¥ä¸€ä¸ªæ¨¡æ‹Ÿçš„éŸ³é¢‘æœåŠ¡ï¼Œä»è€Œå¯ä»¥åœ¨æ²¡æœ‰çœŸå®éŸ³é¢‘ç¡¬ä»¶çš„ç¯å¢ƒä¸‹æµ‹è¯•ä¾èµ–éŸ³é¢‘çš„ä»£ç ã€‚
*   **å®‰å…¨æ€§**ï¼šé€šè¿‡å†…ç½®çš„ `NullAudioPlayer`ï¼Œæˆ‘ä»¬ç¡®ä¿äº† `AudioLocator::get()` æ°¸è¿œä¸ä¼šå¯¼è‡´ç©ºæŒ‡é’ˆè§£å¼•ç”¨ï¼Œä½¿å®¢æˆ·ç«¯ä»£ç æ›´å¥å£®ã€‚

æœåŠ¡å®šä½å™¨æ˜¯ç®¡ç†å…¨å±€å•ä¾‹æœåŠ¡ï¼ˆå¦‚éŸ³é¢‘ã€æ—¥å¿—ã€è¾“å…¥ã€ç‰©ç†ä¸–ç•Œã€æ–‡ä»¶ç³»ç»Ÿç­‰ï¼‰çš„å¼ºå¤§æ¨¡å¼ã€‚è™½ç„¶å®ƒæœ‰æ—¶ä¼šè¢«æ‰¹è¯„ä¸ºâ€œå…¨å±€å˜é‡çš„åä¸½åŒ…è£…â€ï¼Œä½†åªè¦ä½¿ç”¨å¾—å½“ï¼ˆå³ä»…ç”¨äºçœŸæ­£çš„å…¨å±€æœåŠ¡ï¼Œå¹¶å§‹ç»ˆé€šè¿‡æ¥å£è®¿é—®ï¼‰ï¼Œå®ƒå°±èƒ½æå¤§åœ°ç®€åŒ–å¼•æ“æ¶æ„ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚