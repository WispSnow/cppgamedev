# è§‚å¯Ÿè€…æ¨¡å¼ (Observer)

<div class="video-container">
  <div id="bilibili" class="video-content">
    <iframe
      class="video-frame"
      src="https://player.bilibili.com/player.html?bvid=BV1pEWwzHEYk&page=1&autoplay=0&danmaku=0&high_quality=1"
      width="100%"
      height="480"
      scrolling="no"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>
</div>

**è§‚å¯Ÿè€…æ¨¡å¼**æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„è¡Œä¸ºå‹è®¾è®¡æ¨¡å¼ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§å¯¹è±¡é—´çš„**ä¸€å¯¹å¤š**ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡ï¼ˆè¢«è§‚å¯Ÿè€…ï¼‰çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡ï¼ˆè§‚å¯Ÿè€…ï¼‰éƒ½ä¼šå¾—åˆ°é€šçŸ¥å¹¶è‡ªåŠ¨æ›´æ–°ã€‚

è¿™èŠ‚è¯¾åŒæ ·åˆ†ä¸¤éƒ¨åˆ†ã€‚åœ¨ç¬¬ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†é‡æ„æ¸¸æˆä¸­çš„UIæ›´æ–°é€»è¾‘ï¼Œå½»åº•æ¶ˆé™¤ `GameScene` ä¸­æ‰‹åŠ¨è°ƒç”¨ `updateHealthWithUI` å’Œ `addScoreWithUI` çš„ä»£ç ï¼Œå®ç°UIçš„è‡ªåŠ¨ã€å“åº”å¼æ›´æ–°ã€‚

---

# Part 1: è§£è€¦UIæ›´æ–°

## ğŸ¯ è¯¾ç¨‹ç›®æ ‡

*   **è¯†åˆ«â€œä¸»åŠ¨è½®è¯¢â€çš„å¼Šç«¯**ï¼šåˆ†æå½“å‰ `GameScene` æ‰‹åŠ¨ç®¡ç†UIæ›´æ–°é€»è¾‘ï¼ˆå¦‚ `handlePlayerDamage` åè°ƒç”¨ `updateHealthWithUI`ï¼‰æ‰€å¸¦æ¥çš„ç´§è€¦åˆå’Œç»´æŠ¤é—®é¢˜ã€‚
*   **ç†è§£è§‚å¯Ÿè€…æ¨¡å¼**ï¼šå­¦ä¹ â€œå‘å¸ƒ-è®¢é˜…â€æ¨¡å‹çš„æ ¸å¿ƒæ€æƒ³ï¼Œå³**è¢«è§‚å¯Ÿè€… (Subject)** ç»´æŠ¤ä¸€ä¸ª**è§‚å¯Ÿè€… (Observer)** åˆ—è¡¨ï¼Œå¹¶åœ¨çŠ¶æ€å˜åŒ–æ—¶ä¸»åŠ¨é€šçŸ¥å®ƒä»¬ã€‚

<img src="https://theorhythm.top/gamedev/opt/OPT.026.webp" alt=è§‚å¯Ÿè€…æ¨¡å¼1" style="display: block; margin: auto; width: 800px;" />

*   **å®è·µè§‚å¯Ÿè€…æ¨¡å¼**ï¼š
    *   åˆ›å»ºé€šç”¨çš„ `Observer` å’Œ `Subject` æ¥å£ã€‚
    *   è®© `HealthComponent` å’Œ `SessionData` æˆä¸º `Subject`ã€‚
    *   è®© `GameScene` å’Œ `UILabel` æˆä¸º `Observer`ã€‚
*   **å®ç°è‡ªåŠ¨æ›´æ–°**ï¼šé€šè¿‡å»ºç«‹è®¢é˜…å…³ç³»ï¼Œå®ç°å½“ç©å®¶ç”Ÿå‘½å€¼æˆ–åˆ†æ•°å˜åŒ–æ—¶ï¼Œç›¸å…³çš„UIå…ƒç´ èƒ½è‡ªåŠ¨æ”¶åˆ°é€šçŸ¥å¹¶æ›´æ–°è‡ªèº«æ˜¾ç¤ºï¼Œæ— éœ€ `GameScene` ä½œä¸ºä¸­ä»‹æ‰‹åŠ¨å¹²é¢„ã€‚

## ğŸ¤” å½“å‰ä»£ç çš„é—®é¢˜åœ¨å“ªé‡Œï¼Ÿ

ç›®å‰ï¼Œ`GameScene` æ‰®æ¼”ç€ä¸€ä¸ªâ€œå¤§ç®¡å®¶â€çš„è§’è‰²ã€‚å®ƒéœ€è¦æ—¶åˆ»å…³å¿ƒç©å®¶çš„çŠ¶æ€ï¼Œå¹¶æ‰‹åŠ¨æ›´æ–°UIã€‚

**`src/game/scene/game_scene.cpp` (æ—§ä»£ç )**
```cpp
// ç©å®¶å—ä¼¤æ—¶
void GameScene::handlePlayerDamage(int damage)
{
    auto player_component = player_->getComponent<game::component::PlayerComponent>();
    if (!player_component->takeDamage(damage)) return;
    
    // GameScene å¿…é¡»æ‰‹åŠ¨è°ƒç”¨ UI æ›´æ–°å‡½æ•°
    updateHealthWithUI();
}

// ç©å®¶åƒåˆ°åŠ åˆ†é“å…·æ—¶
void GameScene::playerVSItemCollision(engine::object::GameObject*, engine::object::GameObject * item)
{
    // ...
    if (item->getName() == "gem") {
        // GameScene å¿…é¡»æ‰‹åŠ¨è°ƒç”¨ UI æ›´æ–°å‡½æ•°
        addScoreWithUI(5);
    }
    // ...
}
```
è¿™ç§è®¾è®¡çš„é—®é¢˜åœ¨äºï¼š
1.  **ç´§è€¦åˆ**ï¼š`GameScene` å¿…é¡»çŸ¥é“å“ªäº›æ“ä½œä¼šå½±å“UIï¼Œå¹¶äº†è§£å…·ä½“çš„UIæ›´æ–°å‡½æ•°ï¼ˆ`updateHealthWithUI`, `addScoreWithUI`ï¼‰ã€‚`GameScene` ä¸ `HealthComponent`ã€`SessionData` ä»¥åŠå…·ä½“çš„UIå…ƒç´ ï¼ˆ`UILabel`, `UIPanel`ï¼‰ç´§å¯†åœ°è€¦åˆåœ¨äº†ä¸€èµ·ã€‚
2.  **èŒè´£æ‰©æ•£**ï¼š`GameScene` çš„èŒè´£åº”è¯¥æ˜¯ç®¡ç†åœºæ™¯ä¸­çš„å¯¹è±¡å’Œæ¸¸æˆæµç¨‹ï¼Œè€Œä¸æ˜¯å¤„ç†å…·ä½“çš„UIæ›´æ–°ç»†èŠ‚ã€‚è¿™äº›ç»†èŠ‚é€»è¾‘åˆ†æ•£åœ¨ `GameScene` çš„å„ä¸ªè§’è½ï¼Œä½¿å…¶è¶Šæ¥è¶Šè‡ƒè‚¿ã€‚
3.  **æ‰©å±•æ€§å·®**ï¼šå¦‚æœæœªæ¥æˆ‘ä»¬æƒ³æ·»åŠ ä¸€ä¸ªæ–°çš„UIå…ƒç´ æ¥æ˜¾ç¤ºç©å®¶çš„æ— æ•ŒçŠ¶æ€å€’è®¡æ—¶ï¼Œæˆ‘ä»¬å°±å¿…é¡»å›åˆ° `GameScene`ï¼Œåœ¨ `update` ä¸­æ·»åŠ æ–°çš„ `if` åˆ¤æ–­å’Œæ›´æ–°é€»è¾‘ï¼Œè¿™éå¸¸ä¸ä¾¿ã€‚

## ğŸ“– ç¬¬ä¸€æ­¥ï¼šå®šä¹‰ `Observer` å’Œ `Subject` æ¥å£

<img src="https://theorhythm.top/gamedev/opt/OPT.023.webp" alt=è§‚å¯Ÿè€…æ¨¡å¼2" style="display: block; margin: auto; width: 800px;" />

è§‚å¯Ÿè€…æ¨¡å¼çš„æ ¸å¿ƒæ˜¯**æŠ½è±¡**ã€‚æˆ‘ä»¬å®šä¹‰ä¸¤ä¸ªæ¥å£ï¼š`Observer`ï¼ˆè§‚å¯Ÿè€…ï¼‰å’Œ `Subject`ï¼ˆè¢«è§‚å¯Ÿè€…/ä¸»é¢˜ï¼‰ã€‚

*   `Subject`ï¼šä»»ä½•æƒ³æˆä¸ºâ€œè¢«è§‚å¯Ÿå¯¹è±¡â€çš„ç±»éƒ½åº”ç»§æ‰¿å®ƒã€‚å®ƒå†…éƒ¨ç»´æŠ¤ä¸€ä¸ª `Observer*` åˆ—è¡¨ï¼Œå¹¶æä¾› `addObserver`, `removeObserver` å’Œ `notifyObservers` æ–¹æ³•ã€‚
*   `Observer`ï¼šä»»ä½•æƒ³â€œè§‚å¯Ÿâ€æŸä¸ª `Subject` çš„ç±»éƒ½åº”ç»§æ‰¿å®ƒã€‚å®ƒå¿…é¡»å®ç°ä¸€ä¸ª `onNotify` æ–¹æ³•ï¼Œå½“ `Subject` å‘å‡ºé€šçŸ¥æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚

æˆ‘ä»¬å°†è¿™ä¸¤ä¸ªæ¥å£æ”¾åœ¨ `engine/interface/` ç›®å½•ä¸‹ã€‚

**`src/engine/interface/observer.h` (æ–°å»º)**
```cpp
#pragma once
#include <any>

namespace engine::interface {

enum class EventType {
    HEALTH_CHANGED,
    MAX_HEALTH_CHANGED,
    SCORE_CHANGED,
};

class Observer {
public:
    virtual ~Observer() = default;
    virtual void onNotify(const EventType event, const std::any& data) = 0;
};

} // namespace engine::interface 
```
`onNotify` æ¥æ”¶ä¸€ä¸ª `EventType` æ¥åŒºåˆ†æ˜¯å“ªç§äº‹ä»¶ï¼Œä»¥åŠä¸€ä¸ª `std::any` ç±»å‹çš„ `data` æ¥ä¼ é€’å…·ä½“çš„æ•°æ®ï¼ˆå¦‚æ–°çš„ç”Ÿå‘½å€¼ã€åˆ†æ•°ï¼‰ã€‚`std::any` æ˜¯ C++17 å¼•å…¥çš„ç±»å‹å®‰å…¨çš„å®¹å™¨ï¼Œå¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹çš„å€¼ã€‚

**`src/engine/interface/subject.h` (æ–°å»º)**
```cpp
#pragma once
#include "observer.h"
#include <vector>
#include <algorithm>
#include <any>

namespace engine::interface {

class Subject {
private:
    std::vector<Observer*> observers_;  
public:
    virtual ~Subject() = default;
    void addObserver(Observer* observer) { observers_.push_back(observer); }
    void removeObserver(Observer* observer) { /* ... */ }
protected:
    void notifyObservers(const EventType& event, const std::any& data) {
        for (auto* observer : observers_) {
            if (observer) {
                observer->onNotify(event, data);
            }
        }
    }
};

} // namespace engine::interface 
```
`notifyObservers` æ–¹æ³•ä¼šéå†æ‰€æœ‰æ³¨å†Œçš„è§‚å¯Ÿè€…ï¼Œå¹¶è°ƒç”¨å®ƒä»¬çš„ `onNotify` æ–¹æ³•ã€‚

> **æ³¨æ„ï¼š** `Subject` ä¸­å­˜å‚¨çš„æ˜¯ `Observer*` è£¸æŒ‡é’ˆã€‚è¿™æ„å‘³ç€ `Subject` **ä¸ç®¡ç†** è§‚å¯Ÿè€…çš„ç”Ÿå‘½å‘¨æœŸã€‚æ³¨å†Œè§‚å¯Ÿè€…çš„ä¸€æ–¹æœ‰è´£ä»»ç¡®ä¿åœ¨è§‚å¯Ÿè€…è¢«é”€æ¯å‰ï¼Œå°†å…¶ä»æ‰€æœ‰è®¢é˜…çš„ `Subject` ä¸­ç§»é™¤ï¼Œå¦åˆ™ä¼šå¯¼è‡´**æ‚¬å‚æŒ‡é’ˆ**é—®é¢˜ã€‚

## ğŸ“– ç¬¬äºŒæ­¥ï¼šæ”¹é€ æ•°æ®æºï¼Œä½¿å…¶æˆä¸º `Subject`

ç°åœ¨ï¼Œæˆ‘ä»¬å°†éœ€è¦è¢«è§‚å¯Ÿçš„æ•°æ®æºç±»ç»§æ‰¿è‡ª `Subject`ã€‚

### 1. æ”¹é€  `HealthComponent`

`HealthComponent` æ˜¯ç”Ÿå‘½å€¼çš„æƒå¨æ¥æºã€‚å½“ç”Ÿå‘½å€¼å˜åŒ–æ—¶ï¼Œå®ƒåº”è¯¥ä¸»åŠ¨é€šçŸ¥å…³å¿ƒå®ƒçš„å¯¹è±¡ã€‚

**`src/engine/component/health_component.h` (ä¿®æ”¹)**
```cpp
#pragma once
#include "../../engine/component/component.h"
#include "../../engine/interface/subject.h" // åŒ…å«å¤´æ–‡ä»¶

class HealthComponent final : public engine::component::Component, public engine::interface::Subject { // å¤šé‡ç»§æ‰¿
    // ...
};
```
**`src/engine/component/health_component.cpp` (ä¿®æ”¹)**
```cpp
bool HealthComponent::takeDamage(int damage_amount) {
    // ...
    current_health_ -= damage_amount;
    current_health_ = glm::max(0, current_health_);

    // çŠ¶æ€å·²æ”¹å˜ï¼Œé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ï¼
    notifyObservers(engine::interface::EventType::HEALTH_CHANGED, current_health_);
    
    // ...
    return true;
}

int HealthComponent::heal(int heal_amount) {
    // ...
    current_health_ += heal_amount;
    current_health_ = std::min(max_health_, current_health_);

    // çŠ¶æ€å·²æ”¹å˜ï¼Œé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ï¼
    notifyObservers(engine::interface::EventType::HEALTH_CHANGED, current_health_);

    // ...
    return current_health_;
}
```
ç°åœ¨ï¼Œæ¯å½“ `takeDamage` æˆ– `heal` è¢«è°ƒç”¨æ—¶ï¼Œ`HealthComponent` éƒ½ä¼šå¹¿æ’­ä¸€ä¸ª `HEALTH_CHANGED` äº‹ä»¶ï¼Œå¹¶é™„å¸¦ä¸Šæ–°çš„ç”Ÿå‘½å€¼ã€‚

### 2. æ”¹é€  `SessionData`

åŒç†ï¼Œ`SessionData` æ˜¯åˆ†æ•°çš„æƒå¨æ¥æºã€‚

**`src/game/data/session_data.h` (ä¿®æ”¹)**
```cpp
#pragma once
#include "../../engine/interface/subject.h" // åŒ…å«å¤´æ–‡ä»¶
#include <string>
// ...
class SessionData final : public engine::interface::Subject { // ç»§æ‰¿ Subject
    // ...
};
```
**`src/game/data/session_data.cpp` (ä¿®æ”¹)**
```cpp
void SessionData::addScore(int score_to_add) {
    current_score_ += score_to_add;
    // ...
    
    // åˆ†æ•°å·²æ”¹å˜ï¼Œé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ï¼
    notifyObservers(engine::interface::EventType::SCORE_CHANGED, current_score_);
}
```

## ğŸ“– ç¬¬ä¸‰æ­¥ï¼šæ”¹é€ UIå’Œåœºæ™¯ï¼Œä½¿å…¶æˆä¸º `Observer`

ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦è®©å…³å¿ƒè¿™äº›æ•°æ®çš„ç±»ç»§æ‰¿è‡ª `Observer`ï¼Œå¹¶å®ç° `onNotify` æ–¹æ³•æ¥å“åº”é€šçŸ¥ã€‚

### 1. æ”¹é€  `UILabel` (ç”¨äºæ˜¾ç¤ºåˆ†æ•°)

æˆ‘ä»¬çš„åˆ†æ•°æ ‡ç­¾ `UILabel` åªå…³å¿ƒ `SCORE_CHANGED` äº‹ä»¶ã€‚

**`src/engine/ui/ui_label.h` (ä¿®æ”¹)**
```cpp
#pragma once
#include "ui_element.h"
#include "../interface/observer.h" // åŒ…å«å¤´æ–‡ä»¶
// ...
class UILabel final : public UIElement, public engine::interface::Observer { // å¤šé‡ç»§æ‰¿
public:
    // ...
    // å®ç° Observer æ¥å£
    void onNotify(const engine::interface::EventType event, const std::any& data) override;
    // ...
};
```
**`src/engine/ui/ui_label.cpp` (ä¿®æ”¹)**
```cpp
void UILabel::onNotify(const engine::interface::EventType event, const std::any& data) {
    // åªå…³å¿ƒ SCORE_CHANGED äº‹ä»¶
    if (event == engine::interface::EventType::SCORE_CHANGED) {
        // å®‰å…¨åœ°ä» std::any ä¸­æå–æ•°æ®
        if (const int* score = std::any_cast<int>(&data)) {
            setText("Score: " + std::to_string(*score));
        }
    }
}
```

### 2. æ”¹é€  `GameScene` (ç”¨äºæ›´æ–°ç”Ÿå‘½æ¡)

ç”±äºæˆ‘ä»¬çš„ç”Ÿå‘½æ¡UI (`health_panel_`) æ˜¯ä¸€ç»„ `UIImage` çš„é›†åˆï¼Œé€»è¾‘ç›¸å¯¹å¤æ‚ï¼Œæˆ‘ä»¬æš‚æ—¶è®© `GameScene` ä½œä¸ºè§‚å¯Ÿè€…æ¥å¤„ç†ã€‚

**`src/game/scene/game_scene.h` (ä¿®æ”¹)**
```cpp
#pragma once
#include "../../engine/scene/scene.h"
#include "../../engine/interface/observer.h" // åŒ…å«å¤´æ–‡ä»¶
// ...
class GameScene final : public engine::scene::Scene, public engine::interface::Observer { // å¤šé‡ç»§æ‰¿
public:
    // ...
    // å®ç° Observer æ¥å£
    void onNotify(const engine::interface::EventType event, const std::any& data) override;
    // ...
};
```
**`src/game/scene/game_scene.cpp` (ä¿®æ”¹)**
```cpp
void GameScene::onNotify(const engine::interface::EventType event, const std::any&) {
    if (event == engine::interface::EventType::HEALTH_CHANGED) {
        updateHealthWithUI();
    } else if (event == engine::interface::EventType::MAX_HEALTH_CHANGED) {
        // å¦‚æœæœ€å¤§ç”Ÿå‘½å€¼å˜äº†ï¼Œéœ€è¦é‡æ–°åˆ›å»ºæ•´ä¸ªç”Ÿå‘½æ¡UI
        createHealthUI();
    }
}
```

## ğŸ“– ç¬¬å››æ­¥ï¼šå»ºç«‹â€œè®¢é˜…â€å…³ç³»å¹¶ç§»é™¤æ—§ä»£ç 

æœ€åä¸€æ­¥ï¼Œä¹Ÿæ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼Œæ˜¯åœ¨åˆå§‹åŒ–æ—¶å»ºç«‹ `Subject` å’Œ `Observer` ä¹‹é—´çš„è®¢é˜…å…³ç³»ã€‚

**`src/game/scene/game_scene.cpp` (ä¿®æ”¹)**
```cpp
// åœ¨åˆ›å»ºåˆ†æ•°UIæ—¶
void GameScene::createScoreUI() {
    // ... åˆ›å»º score_label ...
    ui_manager_->addElement(std::move(score_label));

    // å»ºç«‹è®¢é˜…å…³ç³»ï¼šè®© score_label_ è§‚å¯Ÿ session_data_
    game_session_data_->addObserver(score_label_);
}

// åœ¨åˆå§‹åŒ–ç©å®¶æ—¶
bool GameScene::initPlayer() {
    // ...
    if (auto health_component = player_->getComponent<engine::component::HealthComponent>(); health_component) {
        // ...
        // å»ºç«‹è®¢é˜…å…³ç³»ï¼šè®© GameScene (this) è§‚å¯Ÿ health_component
        health_component->addObserver(this);
    }
    // ...
    return true;
}
```

ç°åœ¨ï¼Œè®¢é˜…å…³ç³»å·²ç»å»ºç«‹ã€‚å½“ `SessionData::addScore` è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨é€šçŸ¥ `score_label_`ï¼Œ`score_label_` çš„ `onNotify` ä¼šè¢«è§¦å‘ï¼Œä»è€Œæ›´æ–°æ–‡æœ¬ã€‚åŒç†ï¼Œå½“ `HealthComponent` çš„ç”Ÿå‘½å€¼å˜åŒ–æ—¶ï¼Œå®ƒä¼šé€šçŸ¥ `GameScene`ï¼Œ`GameScene` çš„ `onNotify` ä¼šè§¦å‘ `updateHealthWithUI`ã€‚

æœ€åï¼Œæˆ‘ä»¬å¯ä»¥å®‰å¿ƒåœ°åˆ é™¤ `GameScene` ä¸­æ‰€æœ‰æ‰‹åŠ¨çš„UIæ›´æ–°è°ƒç”¨äº†ï¼
```cpp
// src/game/scene/game_scene.cpp (ä¿®æ”¹)

// ä» handlePlayerDamage ä¸­ç§»é™¤æ‰‹åŠ¨è°ƒç”¨
void GameScene::handlePlayerDamage(int damage)
{
    // ...
    // updateHealthWithUI(); // åˆ é™¤ï¼
}

// ä» playerVSItemCollision ä¸­ç§»é™¤æ‰‹åŠ¨è°ƒç”¨
void GameScene::playerVSItemCollision(...)
{
    // ...
    if (item->getName() == "gem") {
        // addScoreWithUI(5); // åˆ é™¤ï¼æ”¹ä¸ºç›´æ¥æ“ä½œæ•°æ®æº
        game_session_data_->addScore(5);
    }
    // ...
}

// playerVSEnemyCollision ä¹Ÿä¸€æ ·
void GameScene::playerVSEnemyCollision(...)
{
    if (/* è¸©è¸åˆ¤æ–­ */) {
        // ...
        // addScoreWithUI(10); // åˆ é™¤ï¼æ”¹ä¸ºç›´æ¥æ“ä½œæ•°æ®æº
        game_session_data_->addScore(10);
    } else {
        // ...
    }
}
```
æˆ‘ä»¬ç”šè‡³å¯ä»¥åˆ é™¤ `addScoreWithUI` å’Œ `healWithUI` è¿™ä¸¤ä¸ªè¾…åŠ©æ–¹æ³•ï¼Œå› ä¸ºå®ƒä»¬çš„ä½œç”¨å·²ç»è¢«è§‚å¯Ÿè€…æ¨¡å¼å®Œå…¨å–ä»£ã€‚

## âœ¨ å°ç»“ (Part 1)

é€šè¿‡å¼•å…¥è§‚å¯Ÿè€…æ¨¡å¼ï¼Œæˆ‘ä»¬çš„ä»£ç ç»“æ„å‘ç”Ÿäº†è´¨çš„é£è·ƒï¼š

*   **å®Œå…¨è§£è€¦**ï¼š`GameScene` ä¸å†éœ€è¦çŸ¥é“ `UILabel` æˆ– `HealthComponent` çš„å­˜åœ¨ã€‚`HealthComponent` ä¹Ÿä¸çŸ¥é“æ˜¯è°åœ¨è§‚å¯Ÿå®ƒã€‚å®ƒä»¬ä¹‹é—´é€šè¿‡æŠ½è±¡çš„ `Observer` å’Œ `Subject` æ¥å£é€šä¿¡ï¼Œå®ç°äº†é«˜åº¦è§£è€¦ã€‚
*   **èŒè´£å•ä¸€**ï¼š`HealthComponent` å’Œ `SessionData` åªè´Ÿè´£ç»´æŠ¤è‡ªå·±çš„æ•°æ®å’Œåœ¨æ•°æ®å˜åŒ–æ—¶å‘å‡ºé€šçŸ¥ã€‚UIå…ƒç´ åªè´Ÿè´£åœ¨æ”¶åˆ°é€šçŸ¥æ—¶æ›´æ–°è‡ªå·±çš„æ˜¾ç¤ºã€‚`GameScene` åˆ™ä»ç¹ççš„UIæ›´æ–°é€»è¾‘ä¸­è§£æ”¾å‡ºæ¥ã€‚
*   **å“åº”å¼ç¼–ç¨‹**ï¼šæˆ‘ä»¬ä»â€œå‘½ä»¤å¼â€çš„â€œåœ¨Aå¤„ä¿®æ”¹æ•°æ®ï¼Œç„¶åå»Bå¤„æ›´æ–°UIâ€è½¬å˜ä¸ºäº†â€œå“åº”å¼â€çš„â€œæ•°æ®æºAå˜åŒ–äº†ï¼Œæ‰€æœ‰è®¢é˜…äº†Açš„è§‚å¯Ÿè€…è‡ªåŠ¨å“åº”â€ã€‚è¿™æ˜¯ä¸€ç§æ›´ç°ä»£ã€æ›´å¥å£®çš„ç¼–ç¨‹èŒƒå¼ã€‚
*   **æ˜“äºæ‰©å±•**ï¼šæœªæ¥å¦‚æœæƒ³æ·»åŠ ä¸€ä¸ªæ˜¾ç¤ºå½“å‰åˆ†æ•°çš„ç‰¹æ•ˆï¼Œæˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ `ScoreEffect` ç±»ï¼Œè®©å®ƒç»§æ‰¿ `Observer`ï¼Œç„¶åè®©å®ƒè®¢é˜… `SessionData` å³å¯ï¼Œå®Œå…¨ä¸éœ€è¦ä¿®æ”¹ç°æœ‰ä»£ç ã€‚

åœ¨ä¸‹ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†åšä¸€ä¸ªå°å°çš„æ‹“å±•ï¼Œè®© `SessionData` ä¹Ÿæˆä¸º `HealthComponent` çš„è§‚å¯Ÿè€…ï¼Œå®ç°æ•°æ®çš„è‡ªåŠ¨åŒæ­¥ï¼Œè¿›ä¸€æ­¥å±•ç¤ºè§‚å¯Ÿè€…æ¨¡å¼çš„å¨åŠ›ã€‚

---

# Part 2: æ•°æ®çš„åŒå‘åŒæ­¥

## ğŸ¯ è¯¾ç¨‹ç›®æ ‡

*   **è¯†åˆ«æ•°æ®åŒæ­¥é—®é¢˜**ï¼šå‘ç°åœ¨åœºæ™¯åˆ‡æ¢å’Œè¯»æ¡£æ—¶ï¼Œ`HealthComponent` å’Œ `SessionData` ä¹‹é—´ç”Ÿå‘½å€¼æ•°æ®éœ€è¦æ‰‹åŠ¨åŒæ­¥çš„é—®é¢˜ã€‚
*   **æ‹“å±•è§‚å¯Ÿè€…è§’è‰²**ï¼šè®© `SessionData` åŒæ—¶æ‰®æ¼” `Subject` (å¯¹åˆ†æ•°è€Œè¨€) å’Œ `Observer` (å¯¹ç”Ÿå‘½å€¼è€Œè¨€) çš„åŒé‡è§’è‰²ã€‚
*   **å®ç°è‡ªåŠ¨æ•°æ®åŒæ­¥**ï¼šé€šè¿‡è®© `SessionData` è§‚å¯Ÿ `HealthComponent`ï¼Œå®ç°å½“ç©å®¶åœ¨æ¸¸æˆä¸­å—ä¼¤æˆ–å›è¡€æ—¶ï¼Œ`SessionData` ä¸­çš„ `current_health_` è‡ªåŠ¨æ›´æ–°ï¼Œä¸ºå­˜æ¡£å’Œè·¨åœºæ™¯æ•°æ®ä¼ é€’åšå¥½å‡†å¤‡ã€‚

## ğŸ¤” å½“å‰ä»£ç çš„é—®é¢˜åœ¨å“ªé‡Œï¼Ÿ

åœ¨ç¬¬ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬æˆåŠŸåœ°è®© `HealthComponent` (ç”Ÿå‘½å€¼ç»„ä»¶) æˆä¸ºäº†ä¸€ä¸ª `Subject` (è¢«è§‚å¯Ÿè€…)ï¼Œå½“å®ƒçš„ç”Ÿå‘½å€¼å˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥ `GameScene` (è§‚å¯Ÿè€…) æ¥æ›´æ–°UIã€‚

åŒæ—¶ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª `SessionData` ç±»ï¼Œå®ƒçš„èŒè´£æ˜¯å­˜å‚¨**è·¨åœºæ™¯**çš„æ¸¸æˆæ•°æ®ï¼Œæ¯”å¦‚ç©å®¶çš„æ€»åˆ†å’Œ**è¿›å…¥ä¸‹ä¸€å…³æ—¶çš„ç”Ÿå‘½å€¼**ã€‚

è¿™é‡Œå­˜åœ¨ä¸€ä¸ªæ•°æ®åŒæ­¥çš„ç¼ºå£ï¼š
*   å½“ç©å®¶åœ¨ `GameScene` ä¸­æˆ˜æ–—ï¼Œ`HealthComponent` çš„ç”Ÿå‘½å€¼ä¸‹é™äº†ã€‚
*   æ­¤æ—¶ `SessionData` ä¸­çš„ `current_health_` å¹¶æ²¡æœ‰æ”¹å˜ã€‚
*   å¦‚æœè¿™æ—¶ç©å®¶è¿‡å…³æˆ–è€…ä¿å­˜æ¸¸æˆï¼Œ`GameScene` å°±éœ€è¦æ‰‹åŠ¨ä» `HealthComponent` è¯»å–å½“å‰ç”Ÿå‘½å€¼ï¼Œç„¶åå†å†™å…¥ `SessionData`ã€‚

**ä¼ªä»£ç  (ä¸å¥½çš„è®¾è®¡)**
```cpp
// ä¼ªä»£ç ï¼šåœ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå…³å¡å‰
void GameScene::goToNextLevel() {
    int currentHealth = player->getComponent<HealthComponent>()->getCurrentHealth();
    session_data_->setCurrentHealth(currentHealth); // æ‰‹åŠ¨åŒæ­¥
    
    // ... åˆ‡æ¢åœºæ™¯ ...
}
```
è¿™åˆå›åˆ°äº†æˆ‘ä»¬ä¹‹å‰ä¸€ç›´è¯•å›¾è§£å†³çš„é—®é¢˜ï¼š`GameScene` æˆä¸ºäº†ä¸€ä¸ªâ€œå¤§ç®¡å®¶â€ï¼Œå®ƒå¿…é¡»è®°ä½åœ¨ç‰¹å®šæ—¶æœºå»åè°ƒä¸åŒæ¨¡å—ä¹‹é—´çš„æ•°æ®åŒæ­¥ã€‚è¿™å¢åŠ äº† `GameScene` çš„å¤æ‚æ€§å’Œå‡ºé”™çš„å¯èƒ½æ€§ã€‚

## ğŸ“– è§£å†³æ–¹æ¡ˆï¼šè®© `SessionData` ä¹Ÿæˆä¸ºè§‚å¯Ÿè€…

<img src="https://theorhythm.top/gamedev/opt/OPT.025.webp" alt=è§‚å¯Ÿè€…æ¨¡å¼3" style="display: block; margin: auto; width: 800px;" />

è§‚å¯Ÿè€…æ¨¡å¼çš„ä¼˜é›…ä¹‹å¤„åœ¨äºï¼Œä¸€ä¸ªå¯¹è±¡å¯ä»¥åŒæ—¶æ˜¯ `Subject` å’Œ `Observer`ï¼Œä¹Ÿå¯ä»¥åŒæ—¶è§‚å¯Ÿå¤šä¸ª `Subject`ã€‚

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ï¼šå½“ `HealthComponent` çš„ç”Ÿå‘½å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¸ä»… `GameScene` (ä¸ºäº†æ›´æ–°UI) éœ€è¦çŸ¥é“ï¼Œ`SessionData` (ä¸ºäº†æ•°æ®åŒæ­¥) ä¹Ÿåº”è¯¥çŸ¥é“ã€‚

### Step 1: è®© `SessionData` ç»§æ‰¿ `Observer`

æˆ‘ä»¬ä¿®æ”¹ `SessionData` çš„å®šä¹‰ï¼Œè®©å®ƒåŒæ—¶ç»§æ‰¿ `Subject` (ä¸ºäº†é€šçŸ¥åˆ†æ•°å˜åŒ–) å’Œ `Observer` (ä¸ºäº†æ¥æ”¶ç”Ÿå‘½å€¼å˜åŒ–é€šçŸ¥)ã€‚

**`src/game/data/session_data.h` (ä¿®æ”¹)**
```cpp
#pragma once
#include "../../engine/interface/subject.h"
#include "../../engine/interface/observer.h" // åŒ…å«å¤´æ–‡ä»¶
// ...
class SessionData final : public engine::interface::Subject, public engine::interface::Observer { // å¤šé‡ç»§æ‰¿
public:
    // ...
    // å®ç° Observer æ¥å£
    void onNotify(const engine::interface::EventType event, const std::any& data) override;
    // ...
};
```

### Step 2: å®ç° `onNotify` æ¥åŒæ­¥æ•°æ®

åœ¨ `SessionData::onNotify` æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åªå…³å¿ƒ `HEALTH_CHANGED` å’Œ `MAX_HEALTH_CHANGED` äº‹ä»¶ï¼Œå¹¶ç”¨æ¥æ”¶åˆ°çš„æ•°æ®æ¥æ›´æ–°è‡ªå·±çš„æˆå‘˜å˜é‡ã€‚

**`src/game/data/session_data.cpp` (ä¿®æ”¹)**
```cpp
void SessionData::onNotify(const engine::interface::EventType event, const std::any& data) {
    if (event == engine::interface::EventType::HEALTH_CHANGED) {
        if (const int* health = std::any_cast<int>(&data)) {
            setCurrentHealth(*health); // ç”¨æ”¶åˆ°çš„æ–°ç”Ÿå‘½å€¼æ›´æ–°è‡ªå·±
        }
    } else if (event == engine::interface::EventType::MAX_HEALTH_CHANGED) {
        if (const int* max_health = std::any_cast<int>(&data)) {
            setMaxHealth(*max_health); // ç”¨æ”¶åˆ°çš„æ–°æœ€å¤§ç”Ÿå‘½å€¼æ›´æ–°è‡ªå·±
        }
    }
}
```
`setCurrentHealth` å’Œ `setMaxHealth` å†…éƒ¨ä¼šåšè¾¹ç•Œæ£€æŸ¥ï¼Œä¿è¯æ•°æ®çš„æœ‰æ•ˆæ€§ã€‚

### Step 3: åœ¨ `GameScene` ä¸­å»ºç«‹æ–°çš„è®¢é˜…å…³ç³»

ç°åœ¨ï¼Œåªéœ€è¦åœ¨ `GameScene::initPlayer` ä¸­ï¼Œå¤šåŠ ä¸€è¡Œä»£ç ï¼Œè®© `SessionData` ä¹Ÿâ€œè®¢é˜…â€ `HealthComponent` çš„é€šçŸ¥ã€‚

**`src/game/scene/game_scene.cpp` (ä¿®æ”¹)**
```cpp
bool GameScene::initPlayer() {
    // ...
    if (auto health_component = player_->getComponent<engine::component::HealthComponent>(); health_component) {
        // ...
        // æ³¨å†Œè®¢é˜…å…³ç³»ï¼ˆGameScene è§‚å¯Ÿ HealthComponentï¼‰
        health_component->addObserver(this);
        // æ–°å¢è®¢é˜…å…³ç³»ï¼ˆSessionData ä¹Ÿè§‚å¯Ÿ HealthComponentï¼‰
        health_component->addObserver(game_session_data_.get());
    } else {
        // ...
    }
    return true;
}
```
`.get()` æ–¹æ³•å¯ä»¥ä» `std::shared_ptr` ä¸­è·å–åˆ°åº•å±‚çš„è£¸æŒ‡é’ˆã€‚

å®Œæˆäº†ï¼ç°åœ¨ï¼Œæ¯å½“ç©å®¶å—ä¼¤æˆ–å›è¡€ï¼Œ`HealthComponent` ä¼šåŒæ—¶é€šçŸ¥ `GameScene` å’Œ `SessionData`ã€‚
*   `GameScene` æ”¶åˆ°é€šçŸ¥åï¼Œä¼šæ›´æ–°å±å¹•ä¸Šçš„å¿ƒå½¢UIã€‚
*   `SessionData` æ”¶åˆ°é€šçŸ¥åï¼Œä¼šé»˜é»˜åœ°æ›´æ–°è‡ªå·±å†…éƒ¨çš„ `current_health_` å˜é‡ã€‚

æ•´ä¸ªè¿‡ç¨‹æ˜¯è‡ªåŠ¨çš„ã€å¹¶è¡Œçš„ï¼Œ`GameScene` ä¸å†éœ€è¦å……å½“ä¸­é—´äººã€‚å½“æ¸¸æˆéœ€è¦ä¿å­˜æˆ–åˆ‡æ¢å…³å¡æ—¶ï¼Œ`SessionData` ä¸­å·²ç»å­˜å‚¨äº†æœ€å‡†ç¡®çš„ç©å®¶ç”Ÿå‘½å€¼ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

## âœ¨ æ€»ç»“ (Part 2)

è¿™ä¸ªå°å°çš„æ‹“å±•ï¼Œå……åˆ†ä½“ç°äº†è§‚å¯Ÿè€…æ¨¡å¼çš„å¼ºå¤§ä¹‹å¤„ï¼š
*   **å¤šå¯¹ä¸€çš„ä¾èµ–**ï¼šä¸€ä¸ª `Subject` (`HealthComponent`) å¯ä»¥è¢«å¤šä¸ª `Observer` (`GameScene`, `SessionData`) åŒæ—¶è®¢é˜…ï¼Œå¹¶ä¸” `Subject` æ— éœ€çŸ¥é“è§‚å¯Ÿè€…çš„æ•°é‡å’Œå…·ä½“èº«ä»½ã€‚
*   **åŒé‡è§’è‰²**ï¼š`SessionData` æ—¢æ˜¯åˆ†æ•°çš„å‘å¸ƒè€… (`Subject`)ï¼Œåˆæ˜¯ç”Ÿå‘½å€¼çš„è®¢é˜…è€… (`Observer`)ï¼Œè¿™ç§çµæ´»çš„è§’è‰²è½¬æ¢èƒ½åŠ›ä½¿å¾—æ„å»ºå¤æ‚çš„é€šçŸ¥ç½‘ç»œæˆä¸ºå¯èƒ½ã€‚
*   **æ¶ˆé™¤æ‰‹åŠ¨åŒæ­¥**ï¼šæˆ‘ä»¬é€šè¿‡å»ºç«‹ä¸€ä¸ªæŒä¹…çš„â€œè®¢é˜…â€å…³ç³»ï¼Œå½»åº•æ¶ˆé™¤äº†åœ¨ç‰¹å®šæ—¶æœºéœ€è¦æ‰‹åŠ¨åŒæ­¥æ•°æ®çš„ä»£ç ï¼Œé™ä½äº†é€»è¾‘å¤æ‚åº¦å’Œå‡ºé”™çš„é£é™©ã€‚

è§‚å¯Ÿè€…æ¨¡å¼æ˜¯æ„å»ºæ¾è€¦åˆã€äº‹ä»¶é©±åŠ¨ç³»ç»Ÿçš„æ ¸å¿ƒæ¨¡å¼ã€‚åœ¨æ¸¸æˆå¼€å‘ä¸­ï¼Œå®ƒè¢«å¹¿æ³›åº”ç”¨äºUIæ›´æ–°ã€æˆå°±ç³»ç»Ÿã€å£°éŸ³è§¦å‘ã€æ¸¸æˆäº‹ä»¶å¹¿æ’­ç­‰å„ç§åœºæ™¯ã€‚ç†Ÿç»ƒæŒæ¡å®ƒï¼Œèƒ½è®©ä½ çš„ä»£ç æ¶æ„æå‡ä¸€ä¸ªæ¡£æ¬¡ï¼Œå˜å¾—æ›´åŠ æ¸…æ™°ã€å¥å£®å’Œæ˜“äºæ‰©å±•ã€‚